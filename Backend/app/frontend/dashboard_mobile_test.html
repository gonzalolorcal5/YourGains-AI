  <!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>YourGains AI - Mobile Test</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              background-color: black;
              height: 100vh;
              color: white;
              font-family: Arial, sans-serif;
              position: relative;
          }
          
          .logo {
              position: absolute;
              top: 60px;
              left: 100px;
              display: flex;
              align-items: center;
              gap: 6px;
          }
          
          .dna-icon {
              width: 50px;
              height: 50px;
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
          }
          
          .dna-icon img, .dna-icon svg {
              width: 100%;
              height: 100%;
              object-fit: contain;
              filter: drop-shadow(0 0 4px rgba(132, 204, 22, 0.45));
          }
          
          .logo-text {
              font-size: 28px;
              font-weight: bold;
          }
          
          .your-gains {
              color: white;
          }
          
          .ai {
              color: #a3e635;
          }
          
          .chat-container {
              position: absolute;
            top: 60%;
            left: 35%;
              transform: translate(-50%, -50%);
            width: 45%;
            max-width: 450px;
            height: 45%;
            border: 2px solid #84cc16;
            border-radius: 16px;
              display: flex;
              flex-direction: column;
              overflow: hidden;
              box-shadow: 0 8px 32px rgba(132, 204, 22, 0.15);
              backdrop-filter: blur(10px);
              background: rgba(255, 255, 255, 0.95);
          }
          
          .chat-header {
              padding: 14px 20px;
              text-align: center;
              background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
              color: white;
              border-radius: 14px 14px 0 0;
          }
          
          .chat-header h2 {
              font-size: 18px;
              margin-bottom: 4px;
              font-weight: 600;
          }
          
          .chat-header p {
              font-size: 12px;
              opacity: 0.9;
              margin: 0;
          }
          
          .chat-messages {
              flex: 1;
            padding: 16px;
              overflow-y: auto;
              color: black;
              background: white;
          }
          
          .chat-input-area {
            padding: 14px 18px;
              display: flex;
              gap: 10px;
              background: #f8f9fa;
              border-radius: 0 0 14px 14px;
              border-top: 1px solid #e9ecef;
          }
          
          .chat-input {
              flex: 1;
              padding: 12px 16px;
              border: 2px solid #e9ecef;
            border-radius: 18px;
              outline: none;
              color: #333;
              font-size: 13px;
              transition: all 0.3s ease;
              background: white;
          }
          
          .chat-input:focus {
              border-color: #84cc16;
              box-shadow: 0 0 0 3px rgba(132, 204, 22, 0.1);
          }
          
          .send-btn {
            padding: 12px 16px;
              background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
              color: white;
              border: none;
            border-radius: 18px;
              cursor: pointer;
              font-weight: 600;
              font-size: 13px;
              transition: all 0.3s ease;
              min-width: 70px;
          }
          
          .send-btn:hover {
              background: linear-gradient(135deg, #65a30d 0%, #4d7c0f 100%);
              transform: translateY(-1px);
              box-shadow: 0 4px 12px rgba(132, 204, 22, 0.3);
          }
          
          .send-btn:disabled {
              background: #e9ecef;
              color: #6c757d;
              cursor: not-allowed;
              transform: none;
              box-shadow: none;
          }
          
          .message {
            margin: 10px 0;
              padding: 10px 15px;
            border-radius: 15px;
              max-width: 90%;
              word-wrap: break-word;
          }
          
          .user-message {
              background: #84cc16;
              color: white;
              margin-left: auto;
              text-align: right;
          }
          
          .ai-message {
              background: #f0f0f0;
              color: black;
          }
          
          .placeholder {
              text-align: center;
            color: #999;
              padding: 40px 20px;
              font-style: italic;
          }
          
          .navigation {
              position: absolute;
            top: 60px;
            right: 100px;
              display: flex;
            gap: 20px;
              align-items: center;
              color: white;
              white-space: nowrap;
          }
          
          .nav-item {
            padding: 8px 16px;
              border-radius: 8px;
              transition: all 0.3s ease;
          }
          
          .nav-item:hover {
              color: #84cc16;
              background: rgba(132, 204, 22, 0.1);
          }

          .nav-text {
              font-size: 14px;
              font-weight: 500;
          }
          
          .overlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: none;
              align-items: center;
              justify-content: center;
              z-index: 1000;
          }
          
          .overlay-content {
              background: white;
            color: black;
            padding: 30px;
            border-radius: 15px;
            max-width: 80%;
              max-height: 80%;
              overflow-y: auto;
              position: relative;
          }
          
          .close-btn {
              position: absolute;
              top: 15px;
              right: 20px;
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #666;
          }
          
          .close-btn:hover {
              color: #84cc16;
          }
          
          .overlay h2 {
              color: #84cc16;
              margin-bottom: 20px;
              font-size: 24px;
          }
          
          .overlay h3 {
            color: #333;
              margin-top: 20px;
              margin-bottom: 10px;
          }
          
          .premium-lock {
            position: relative;
              opacity: 0.5;
              pointer-events: none;
          }
          
          .upgrade-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
              border-radius: 10px;
              margin: 20px 0;
          }
          
          .upgrade-btn {
              background: #84cc16;
              color: white;
              border: none;
            padding: 10px 20px;
            border-radius: 5px;
              cursor: pointer;
              font-weight: bold;
              margin-top: 10px;
          }
          
          .download-btn {
            background: #3b82f6;
              color: white;
              border: none;
            padding: 8px 16px;
            border-radius: 6px;
              cursor: pointer;
            display: flex;
              align-items: center;
              gap: 8px;
              font-size: 14px;
          }
          
          .download-btn:hover {
              background: #1d4ed8;
          }
          
          .download-btn:disabled {
              background: #9ca3af;
              cursor: not-allowed;
          }
          
          .nav-separator {
              color: #666;
              font-size: 18px;
          }
          
          .logout-btn {
            background: #dc2626;
              color: white;
              border: none;
            padding: 6px 12px;
            border-radius: 6px;
              cursor: pointer;
              font-size: 12px;
              font-weight: bold;
          }
          
          .logout-btn:hover {
              background: #dc2626;
          }

          /* Gym Image Container */
          .gym-image-container {
              position: absolute;
              top: 50%;
              right: 20px;
              transform: translateY(-50%);
              width: 500px;
              height: 450px;
              border-radius: 20px;
              overflow: hidden;
              box-shadow: 0 15px 50px rgba(132, 204, 22, 0.25);
              backdrop-filter: blur(15px);
              background: rgba(0, 0, 0, 0.9);
              border: 3px solid rgba(132, 204, 22, 0.4);
          }

          .gym-image {
              width: 100%;
              height: 100%;
              object-fit: contain;
              border-radius: 17px;
              filter: brightness(1.0) contrast(1.4) saturate(1.2);
              transition: all 0.4s ease;
              background: transparent;
              mix-blend-mode: screen;
          }

          .gym-image:hover {
              transform: scale(1.08);
              filter: brightness(1.2) contrast(1.6) saturate(1.4);
              box-shadow: 0 0 40px rgba(132, 204, 22, 0.5);
          }

          /* Responsive adjustments */
          @media (max-width: 1600px) {
              .gym-image-container {
                  width: 400px;
                  height: 360px;
                  right: 15px;
              }
          }

          @media (max-width: 1400px) {
              .gym-image-container {
                  width: 350px;
                  height: 320px;
                  right: 10px;
              }
          }

          @media (max-width: 1200px) {
              .gym-image-container {
                  display: none;
              }
          }
          
          .overlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: none;
              justify-content: center;
              align-items: center;
              z-index: 1000;
          }

          .overlay-content {
              background: #1a1a1a;
              border-radius: 12px;
              padding: 2rem;
              max-width: 800px;
              max-height: 80vh;
              overflow-y: auto;
              border: 1px solid #333;
              position: relative;
          }

          .overlay-content.large {
              max-width: 1200px;
              max-height: 85vh;
          }

          .tab-content-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 2rem;
              margin-top: 1.5rem;
          }

          .content-column {
              background: rgba(255, 255, 255, 0.03);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 12px;
              padding: 1.5rem;
          }

          .content-column h3 {
              color: #84cc16;
              margin-bottom: 1rem;
              font-size: 1.2rem;
              font-weight: 600;
              border-bottom: 1px solid rgba(132, 204, 22, 0.2);
              padding-bottom: 0.5rem;
          }

          .close-btn {
              position: absolute;
              top: 1rem;
              right: 1rem;
              background: none;
              border: none;
              color: #fff;
              font-size: 1.5rem;
              cursor: pointer;
              padding: 0.5rem;
              border-radius: 50%;
              transition: background 0.3s ease;
          }

          .close-btn:hover {
              background: rgba(255, 255, 255, 0.1);
          }

          .overlay-content h2 {
              color: #84cc16;
              margin-bottom: 1rem;
              font-size: 1.5rem;
          }

          .overlay-content p {
              color: #ccc;
              line-height: 1.6;
          }

          /* Estilos para contenido de rutina */
          .routine-item {
              background: rgba(132, 204, 22, 0.05);
              border: 1px solid rgba(132, 204, 22, 0.2);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .routine-day {
              color: #84cc16;
              font-weight: 600;
              margin-bottom: 0.5rem;
          }

          .exercise {
              margin: 0.5rem 0;
              padding: 0.5rem;
              background: rgba(255, 255, 255, 0.05);
              border-radius: 6px;
          }

          .exercise-name {
              font-weight: 500;
              margin-bottom: 0.25rem;
          }

          .exercise-details {
              font-size: 0.9rem;
              color: rgba(255, 255, 255, 0.7);
          }

          /* Estilos para contenido de dieta */
          .macros-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 1rem;
              margin-bottom: 1.5rem;
          }

          .macro-card {
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 8px;
              padding: 1rem;
              text-align: center;
          }

          .macro-value {
              font-size: 1.5rem;
              font-weight: 700;
              color: #84cc16;
              display: block;
          }

          .macro-label {
              font-size: 0.8rem;
              color: rgba(255, 255, 255, 0.7);
              text-transform: uppercase;
              letter-spacing: 0.5px;
          }

          .meal-card {
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .meal-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.5rem;
          }

          .meal-time {
              font-size: 0.8rem;
              color: #84cc16;
              background: rgba(132, 204, 22, 0.1);
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
          }

          .meal-name {
              font-weight: 500;
          }

          .food-item {
              display: flex;
              justify-content: space-between;
              padding: 0.25rem 0;
              font-size: 0.9rem;
          }

          /* Estilos para consejos */
          .advice-card {
              background: rgba(132, 204, 22, 0.05);
              border: 1px solid rgba(132, 204, 22, 0.2);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .advice-title {
              color: #84cc16;
              font-weight: 600;
              margin-bottom: 0.5rem;
          }

          .advice-content {
              color: rgba(255, 255, 255, 0.9);
              line-height: 1.6;
          }

          /* Estilos para estudios */
          .study-card {
              background: rgba(59, 130, 246, 0.05);
              border: 1px solid rgba(59, 130, 246, 0.2);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .study-title {
              color: #3b82f6;
              font-weight: 600;
              margin-bottom: 0.5rem;
          }

          .study-content {
              color: rgba(255, 255, 255, 0.9);
              line-height: 1.6;
              margin-bottom: 0.75rem;
          }

          .study-meta {
              border-top: 1px solid rgba(59, 130, 246, 0.2);
              padding-top: 0.75rem;
              font-size: 0.8rem;
          }

          .study-author {
              color: #84cc16;
              font-weight: 600;
              display: block;
              margin-bottom: 0.25rem;
          }

          .study-journal {
              color: rgba(255, 255, 255, 0.6);
              font-style: italic;
          }

          /* Premium overlay */
          .premium-overlay {
              position: relative;
              overflow: hidden;
          }

          .premium-overlay::after {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.8);
              backdrop-filter: blur(4px);
              border-radius: 8px;
          }

          .premium-badge {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
              color: white;
              padding: 1rem 2rem;
              border-radius: 8px;
              font-weight: 600;
              z-index: 2;
              text-align: center;
              box-shadow: 0 8px 32px rgba(132, 204, 22, 0.3);
          }

          .premium-badge h4 {
              margin-bottom: 0.5rem;
          }

          .premium-badge p {
              font-size: 0.9rem;
              opacity: 0.9;
              margin-bottom: 1rem;
          }

          .premium-btn {
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              padding: 0.5rem 1rem;
              border-radius: 6px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
          }

          .premium-btn:hover {
              background: rgba(255, 255, 255, 0.3);
              transform: translateY(-1px);
          }

          /* Responsive Mobile Design */
          @media (max-width: 768px) {
              /* Layout principal - Stack vertical */
              body {
                  height: auto;
                  min-height: 100vh;
              }

              /* Logo responsive */
              .logo {
                  position: relative;
                  top: auto;
                  left: auto;
                  padding: 20px;
                  justify-content: center;
                  margin-bottom: 10px;
              }

              .logo-text {
                  font-size: 24px;
              }

              /* Navigation responsive - Stack horizontal scrollable */
              .navigation {
                  position: relative;
                  top: auto;
                  right: auto;
                  padding: 0 20px 20px;
                  flex-wrap: nowrap;
                  overflow-x: auto;
                  gap: 15px;
                  -webkit-overflow-scrolling: touch;
              }

              .nav-item {
                  flex-shrink: 0;
                  padding: 12px 16px;
                  font-size: 14px;
                  min-height: 44px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid rgba(132, 204, 22, 0.3);
              }

              .nav-separator {
                  display: none;
              }

              /* Botones touch-friendly */
              .upgrade-btn, .logout-btn {
                  min-height: 44px;
                  min-width: 44px;
                  padding: 12px 16px;
                  font-size: 14px;
                  border-radius: 8px;
              }

              /* Chat Container responsive */
              .chat-container {
                  position: relative;
                  top: auto;
                  left: auto;
                  transform: none;
                  width: calc(100% - 40px);
                  max-width: none;
                  height: 60vh;
                  min-height: 400px;
                  margin: 0 20px 20px;
                  border-radius: 12px;
              }

              .chat-header {
                  padding: 16px 20px;
                  border-radius: 12px 12px 0 0;
              }

              .chat-header h2 {
                  font-size: 16px;
                  margin-bottom: 6px;
              }

              .chat-header p {
                  font-size: 13px;
              }

              .chat-messages {
                  padding: 16px;
              }

              .chat-input-area {
                  padding: 16px 20px;
                  border-radius: 0 0 12px 12px;
              }

              .chat-input {
                  padding: 14px 16px;
                  font-size: 16px; /* Previene zoom en iOS */
                  border-radius: 20px;
              }

              .send-btn {
                  padding: 14px 20px;
                  min-width: 80px;
                  min-height: 44px;
                  font-size: 14px;
                  border-radius: 20px;
              }

              /* Mensajes responsive */
              .message {
                  padding: 12px 16px;
                  margin: 12px 0;
                  border-radius: 18px;
                  max-width: 85%;
                  font-size: 15px;
                  line-height: 1.4;
              }

              /* Overlays responsive */
              .overlay {
                  padding: 20px;
                  align-items: flex-start;
                  padding-top: 60px;
              }

              .overlay-content {
                  max-width: 100%;
                  max-height: 90vh;
                  margin: 0;
                  padding: 20px;
                  border-radius: 12px;
              }

              .overlay-content.large {
                  max-width: 100%;
                  max-height: 85vh;
              }

              .close-btn {
                  top: 15px;
                  right: 15px;
                  font-size: 24px;
                  min-width: 44px;
                  min-height: 44px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
              }

              /* Grid layouts responsive */
              .tab-content-grid {
                  grid-template-columns: 1fr;
                  gap: 1rem;
                  margin-top: 1rem;
              }

              .macros-grid {
                  grid-template-columns: repeat(2, 1fr);
                  gap: 12px;
              }

              /* Cards responsive */
              .content-column {
                  padding: 16px;
                  border-radius: 8px;
              }

              .content-column h3 {
                  font-size: 16px;
                  margin-bottom: 12px;
                  padding-bottom: 8px;
              }

              /* Routine items responsive */
              .routine-item {
                  padding: 12px;
                  margin-bottom: 12px;
              }

              .routine-day {
                  font-size: 14px;
                  margin-bottom: 8px;
              }

              .exercise {
                  padding: 8px 12px;
                  margin: 8px 0;
              }

              .exercise-name {
                  font-size: 14px;
                  margin-bottom: 4px;
              }

              .exercise-details {
                  font-size: 12px;
              }

              /* Macro cards responsive */
              .macro-card {
                  padding: 12px 8px;
                  text-align: center;
              }

              .macro-value {
                  font-size: 18px;
              }

              .macro-label {
                  font-size: 10px;
              }

              /* Meal cards responsive */
              .meal-card {
                  padding: 12px;
                  margin-bottom: 12px;
              }

              .meal-header {
                  flex-direction: column;
                  align-items: flex-start;
                  gap: 8px;
              }

              .meal-time {
                  font-size: 11px;
                  padding: 4px 8px;
              }

              .meal-name {
                  font-size: 14px;
              }

              .food-item {
                  padding: 6px 0;
                  font-size: 13px;
              }

              /* Advice cards responsive */
              .advice-card {
                  padding: 12px;
                  margin-bottom: 12px;
              }

              .advice-title {
                  font-size: 14px;
                  margin-bottom: 8px;
              }

              .advice-content {
                  font-size: 13px;
                  line-height: 1.5;
              }

              /* Study cards responsive */
              .study-card {
                  padding: 12px;
                  margin-bottom: 12px;
              }

              .study-title {
                  font-size: 14px;
                  margin-bottom: 8px;
              }

              .study-content {
                  font-size: 13px;
                  line-height: 1.5;
                  margin-bottom: 10px;
              }

              .study-meta {
                  padding-top: 8px;
                  font-size: 11px;
              }

              .study-author {
                  font-size: 11px;
                  margin-bottom: 4px;
              }

              .study-journal {
                  font-size: 10px;
              }

              /* Premium badges responsive */
              .premium-badge {
                  padding: 16px 20px;
                  border-radius: 8px;
                  font-size: 14px;
              }

              .premium-badge h4 {
                  font-size: 14px;
                  margin-bottom: 8px;
              }

              .premium-badge p {
                  font-size: 12px;
                  margin-bottom: 12px;
              }

              .premium-btn {
                  padding: 10px 16px;
                  font-size: 14px;
                  min-height: 44px;
                  border-radius: 8px;
              }

              /* Ocultar imagen del gimnasio en móvil */
              .gym-image-container {
                  display: none;
              }

              /* Scroll suave para navegación */
              .navigation::-webkit-scrollbar {
                  height: 4px;
              }

              .navigation::-webkit-scrollbar-track {
                  background: rgba(255, 255, 255, 0.1);
                  border-radius: 2px;
              }

              .navigation::-webkit-scrollbar-thumb {
                  background: rgba(132, 204, 22, 0.5);
                  border-radius: 2px;
              }

              .navigation::-webkit-scrollbar-thumb:hover {
                  background: rgba(132, 204, 22, 0.7);
              }
          }

          /* Responsive para pantallas muy pequeñas */
          @media (max-width: 480px) {
              .logo {
                  padding: 15px;
              }

              .logo-text {
                  font-size: 20px;
              }

              .navigation {
                  padding: 0 15px 15px;
                  gap: 10px;
              }

              .nav-item {
                  padding: 10px 12px;
                  font-size: 13px;
                  min-height: 40px;
              }

              .chat-container {
                  width: calc(100% - 30px);
                  margin: 0 15px 15px;
                  height: 65vh;
                  min-height: 350px;
              }

              .chat-header {
                  padding: 14px 16px;
              }

              .chat-header h2 {
                  font-size: 15px;
              }

              .chat-header p {
                  font-size: 12px;
              }

              .chat-input-area {
                  padding: 14px 16px;
              }

              .chat-input {
                  padding: 12px 14px;
                  font-size: 16px;
              }

              .send-btn {
                  padding: 12px 16px;
                  min-width: 70px;
                  min-height: 40px;
                  font-size: 13px;
              }

              .overlay {
                  padding: 15px;
                  padding-top: 50px;
              }

              .overlay-content {
                  padding: 16px;
              }

              .macros-grid {
                  grid-template-columns: 1fr;
                  gap: 8px;
              }

              .macro-card {
                  padding: 10px;
              }

              .macro-value {
                  font-size: 16px;
              }

              .macro-label {
                  font-size: 9px;
              }
          }

      </style>
  </head>
  <body>
    <div class="logo">
        <div class="dna-icon">
            <svg viewBox="0 0 800 800" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
            </svg>
        </div>
        <div class="logo-text">
            <span class="your-gains">Your</span><span class="ai">Gains</span>
        </div>
    </div>

    <div class="navigation">
        <div class="nav-item" id="rutinaDieta">Rutina y Dieta</div>
        <div class="nav-separator">|</div>
        <div class="nav-item" id="consejosEstudios">Consejos y Estudios</div>
        <div class="nav-separator">|</div>
        <div class="nav-item" id="terminosPrivacidad">Términos y Privacidad</div>
        <div class="nav-separator">|</div>
        <button class="upgrade-btn" onclick="window.location.href='./tarifas.html'">Upgrade</button>
        <div class="nav-separator">|</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h2>¡Hola! Soy tu entrenador personal de IA</h2>
            <p>Pregúntame lo que necesites sobre tu rutina, nutrición o consejos de fitness</p>
                  </div>
        <div class="chat-messages" id="chatMessages">
            <div class="placeholder">Escribe tu primera pregunta aquí...</div>
              </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Escribe tu pregunta aquí..." maxlength="500">
            <button id="sendBtn" class="send-btn">Enviar</button>
          </div>
      </div>

    <!-- Overlay para Rutina y Dieta -->
    <div class="overlay" id="rutinaDietaOverlay">
          <div class="overlay-content large">
            <button class="close-btn" onclick="closeOverlay('rutinaDietaOverlay')">&times;</button>
            <h2>Tu Plan Personalizado</h2>
            <div class="tab-content-grid">
                <div class="content-column">
                    <h3>Rutina de Entrenamiento</h3>
                    <div id="rutinaContent">
                        <p>Cargando rutina...</p>
                    </div>
                </div>
                <div class="content-column">
                    <h3>Plan Nutricional</h3>
                    <div id="dietaContent">
                        <p>Cargando dieta...</p>
                    </div>
                </div>
            </div>
          </div>
      </div>

    <!-- Overlay para Consejos y Estudios -->
    <div class="overlay" id="consejosEstudiosOverlay">
        <div class="overlay-content large">
            <button class="close-btn" onclick="closeOverlay('consejosEstudiosOverlay')">&times;</button>
            <h2>Consejos y Estudios</h2>
            <div class="tab-content-grid">
                <div class="content-column">
                    <h3>Consejos Técnicos</h3>
                    <div id="consejosContent">
                        <p>Cargando consejos...</p>
                    </div>
                </div>
                <div class="content-column">
                    <h3>Evidencia Científica</h3>
                    <div id="estudiosContent">
                        <p>Cargando estudios...</p>
                    </div>
                </div>
            </div>
          </div>
      </div>

    <!-- Overlay para Términos y Privacidad -->
    <div class="overlay" id="terminosPrivacidadOverlay">
        <div class="overlay-content">
            <button class="close-btn" onclick="closeOverlay('terminosPrivacidadOverlay')">&times;</button>
            <h2>Términos y Privacidad</h2>
            <div id="terminosContent">
                <p>Contenido de términos y condiciones...</p>
            </div>
          </div>
      </div>

      <!-- Gym Image Container -->
      <div class="gym-image-container">
          <img src="./images/gym-training-new.jpg" alt="Gimnasio moderno con persona entrenando - Your Gains AI" class="gym-image">
      </div>

      <script type="module">
          import { API_BASE } from "./config.js";
          import { checkAuthOrRedirect, getAuthHeaders, logout, isTokenExpired, decodeJwt } from "./auth.js";

        // Freemium helpers (frontend-only)
        function isPremiumUser() {
            const token = localStorage.getItem('accessToken');
            if (token) {
                const payload = decodeJwt(token) || {};
                if (payload.plan === 'premium' || payload.tier === 'premium' || payload.premium === true) {
                    return true;
                }
            }
            const storedPlan = localStorage.getItem('plan');
            return storedPlan === 'premium';
        }

        function getChatUsageKey() {
            const email = localStorage.getItem('email') || 'anonymous';
            return `chat_usage_count_${email}`;
        }

        function getChatUsageCount() {
            const raw = localStorage.getItem(getChatUsageKey());
            const n = parseInt(raw || '0', 10);
            return Number.isFinite(n) ? n : 0;
        }

        function incrementChatUsage() {
            const next = getChatUsageCount() + 1;
            localStorage.setItem(getChatUsageKey(), String(next));
            return next;
        }

        function canUseChat() {
            if (isPremiumUser()) return true;
            return getChatUsageCount() < 2; // 2 prompts for free tier
        }
        
        // Función principal
        function initDashboard() {
            // Verificar autenticación al cargar la página
            checkAuthOrRedirect();
          
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            function addMessage(content, isUser = false) {
                // Remove placeholder if it exists
                const placeholder = chatMessages.querySelector('.placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                messageDiv.textContent = content;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // RATE LIMITING: Prevenir envío excesivo de mensajes
                const now = Date.now();
                const lastMessageTime = window.lastMessageTime || 0;
                const timeSinceLastMessage = now - lastMessageTime;
                
                if (timeSinceLastMessage < 2000) { // 2 segundos de debounce
                    console.log('⚠️ Rate limit: Espera 2 segundos entre mensajes');
                    return;
                }
                
                // Verificar si ya hay un mensaje procesándose
                if (window.isProcessingMessage) {
                    console.log('⚠️ Ya hay un mensaje procesándose, espera...');
                    return;
                }
                
                window.lastMessageTime = now;
                window.isProcessingMessage = true;

                // Verificar autenticación antes de enviar
                if (!checkAuthOrRedirect()) {
                    window.location.href = './login.html';
                    window.isProcessingMessage = false;
                    return;
                }

                // Freemium limit: block after 2 prompts if not premium
                if (!isPremiumUser() && !canUseChat()) {
                    addMessage('Has alcanzado el límite gratuito de 2 mensajes. Mejora a Pro para continuar.');
                    return;
                }

                addMessage(message, true);
                chatInput.value = '';
                
                sendBtn.disabled = true;
                sendBtn.textContent = 'Enviando...';

                try {
                    // Preparar payload para logging
                    const userId = getCurrentUserId();
                    const conversationHistory = getConversationHistory();
                    const token = localStorage.getItem('accessToken');
                    
                    const payload = {
                        message: message,
                        user_id: userId,
                        conversation_history: conversationHistory
                    };

                    console.log('=== PAYLOAD ENVIADO ===');
                    console.log('Payload:', JSON.stringify(payload, null, 2));
                    console.log('User ID:', userId);
                    console.log('Message:', message);
                    console.log('Conversation History:', conversationHistory);
                    console.log('Token exists:', !!token);
                    console.log('======================');

                    // Usar nuevo endpoint de function calling
                    const response = await fetch(`${API_BASE}/api/chat/modify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    // Logging del error 422
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('=== ERROR HTTP ===');
                        console.error('Status:', response.status);
                        console.error('Status Text:', response.statusText);
                        console.error('Error detail:', errorData);
                        console.error('================');
                        
                        if (response.status === 422) {
                            addMessage(`Error de validación: ${JSON.stringify(errorData)}`);
                        } else if (response.status === 401) {
                            addMessage('Sesión expirada. Redirigiendo al login...');
                            setTimeout(() => {
                                localStorage.clear();
                                window.location.href = './login.html';
                            }, 2000);
                        } else {
                            addMessage(`Error del servidor: ${errorData.detail || 'Error desconocido'}`);
                        }
                        return;
                    }

                    const data = await response.json();

                    // Añadir respuesta del chat
                    addMessage(data.response);
                    
                    // Si se realizaron modificaciones, mostrar notificación
                    if (data.modified) {
                        showModificationNotification({
                            modified: true,
                            changes: data.changes || [],
                            function_used: data.function_used || 'unknown'
                        });
                        
                        // Añadir badge visual al mensaje
                        addModificationBadge();
                        
                        // ✨ NUEVO: Recargar plan después de modificación
                        console.log('🔄 Plan modificado, recargando dashboard...');
                        setTimeout(async () => {
                            await reloadPlanFromServer();
                        }, 1000); // Esperar 1 segundo para que la IA termine de guardar
                    }
                    
                    if (!isPremiumUser()) {
                        incrementChatUsage();
                            if (!canUseChat()) {
                                addMessage('Has llegado al máximo de mensajes gratis. Sube a Pro para seguir chateando.');
                            }
                        }
                    } else {
                        if (response.status === 401) {
                            addMessage('Sesión expirada. Redirigiendo al login...');
                            setTimeout(() => {
                                localStorage.clear();
                                window.location.href = './login.html';
                            }, 2000);
                        } else {
                            addMessage(`Error: ${data.detail || 'Error desconocido'}`);
                        }
                    }
                } catch (error) {
                    console.error('Error en chat:', error);
                    addMessage('Error de conexión. Verifica que el servidor esté funcionando.');
                } finally {
                    // Resetear rate limiting
                    window.isProcessingMessage = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Enviar';
                }
            }

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Cargar planes del usuario al iniciar
            loadUserPlans();

            // Event listeners para los overlays
            document.getElementById('rutina').addEventListener('click', () => openOverlay('rutinaOverlay'));
            document.getElementById('consejos').addEventListener('click', () => openOverlay('consejosOverlay'));
            document.getElementById('terminos').addEventListener('click', () => openOverlay('terminosOverlay'));

            // Hacer logout disponible globalmente
            window.logout = logout;
        }

        // ✨ NUEVA FUNCIÓN: Recargar plan desde servidor después de modificación
        async function reloadPlanFromServer() {
            try {
                console.log('🔄 Recargando plan desde servidor...');
                
                const userId = getCurrentUserId();
                if (!userId) {
                    console.error('❌ No se pudo obtener user_id para recargar plan');
                    return;
                }

                // Obtener datos actualizados del servidor
                const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    console.error('❌ Error obteniendo plan actualizado:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('📊 Datos recibidos del servidor:', data);

                if (data.success && data.current_routine) {
                    // Crear objeto plan compatible con displayPlan
                    const plan = {
                        rutina: data.current_routine,
                        dieta: data.current_diet,
                        motivacion: "Rutina actualizada dinámicamente"
                    };

                    // Actualizar visualización con datos frescos
                    const isPremium = data.is_premium || false;
                    console.log('🎨 Actualizando visualización con isPremium:', isPremium);
                    
                    displayPlan(plan, isPremium);
                    
                    console.log('✅ Plan recargado exitosamente');
                    
                    // Mostrar notificación de éxito
                    showReloadNotification('Plan actualizado correctamente');
                } else {
                    console.error('❌ No se pudo obtener plan actualizado');
                }
            } catch (error) {
                console.error('❌ Error recargando plan:', error);
            }
        }

        // ✨ NUEVA FUNCIÓN: Mostrar notificación de recarga
        function showReloadNotification(message) {
            // Crear notificación temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #39ff14;
                color: #000000;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 700;
                z-index: 10000;
                animation: slideInNotification 0.3s ease;
                box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
                border: 2px solid #000000;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remover después de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOutNotification 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Función para cargar planes del usuario - CORREGIDA PARA USAR current_routine
        async function loadUserPlans() {
            try {
                // Obtener user_id del token
                const userId = getCurrentUserId();
                if (!userId) {
                    console.error('No se pudo obtener user_id');
                    return;
                }

                // Usar el endpoint corregido que devuelve current_routine
                const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.current_routine) {
                        // Crear un plan compatible con el formato esperado
                        const plan = {
                            rutina: data.current_routine,
                            dieta: data.current_diet || {},
                            motivacion: "Rutina actualizada dinámicamente"
                        };
                        
                        // Guardar en localStorage para futuras consultas
                        localStorage.setItem("userPlan", JSON.stringify(plan));
                        const premium = isPremiumUser();
                        
                        // Mostrar el plan actualizado
                        displayPlan(plan);
                        return;
                    }
                } else {
                    console.error('Error al cargar rutina actual:', response.status);
                }
            } catch (error) {
                console.error('Error al cargar rutina actual:', error);
            }
        }

        // Función para mostrar el plan en los overlays - DISEÑO MINIMALISTA
        function displayPlan(plan, userPremiumStatus = null) {
            console.log('🎨 displayPlan() llamado con:', plan);
            console.log('🎨 userPremiumStatus:', userPremiumStatus);
            
            const rutinaContent = document.getElementById('rutinaContent');
            const dietaContent = document.getElementById('dietaContent');
            const isPremium = userPremiumStatus !== null ? userPremiumStatus : isPremiumUser();
            
            if (plan.rutina && plan.rutina.exercises) {
                // RUTINA - DISEÑO MINIMALISTA
                let rutinaHtml = `
                    <style>
                        #rutinaContent, #dietaContent {
                            background: #000000;
                            color: #ffffff;
                            padding: 30px;
                            font-family: 'Inter', -apple-system, sans-serif;
                        }
                        .section-title {
                            font-size: 32px;
                            font-weight: 700;
                            margin-bottom: 10px;
                            color: #ffffff;
                        }
                        .section-subtitle {
                            font-size: 18px;
                            color: #888888;
                            margin-bottom: 30px;
                            font-weight: 500;
                        }
                        .day-title {
                            font-size: 20px;
                            font-weight: 600;
                            margin-top: 25px;
                            margin-bottom: 15px;
                            color: #ffffff;
                        }
                        .exercise-item {
                            font-size: 16px;
                            color: #cccccc;
                            margin-left: 20px;
                            margin-bottom: 8px;
                            line-height: 1.5;
                        }
                        .meal-title {
                            font-size: 20px;
                            font-weight: 600;
                            margin-top: 25px;
                            margin-bottom: 15px;
                            color: #ffffff;
                        }
                        .food-item {
                            font-size: 16px;
                            color: #cccccc;
                            margin-left: 20px;
                            margin-bottom: 6px;
                        }
                        .censored-content {
                            filter: blur(8px);
                            background: #1a1a1a;
                            padding: 20px;
                            margin: 20px 0;
                            border-radius: 8px;
                            pointer-events: none;
                            user-select: none;
                        }
                        .upgrade-overlay {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            padding: 30px;
                            border-radius: 12px;
                            text-align: center;
                            margin: 30px 0;
                        }
                        .upgrade-overlay h3 {
                            color: white;
                            font-size: 24px;
                            margin-bottom: 10px;
                        }
                        .upgrade-overlay p {
                            color: rgba(255,255,255,0.9);
                            font-size: 16px;
                            margin-bottom: 20px;
                        }
                        .upgrade-button {
                            background: white;
                            color: #667eea;
                            padding: 12px 30px;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 16px;
                        }
                    </style>
                    <h1 class="section-title">Rutina</h1>
                    <p class="section-subtitle">${plan.rutina.titulo || 'Plan personalizado'}</p>
                `;
                
                // Agrupar ejercicios por día
                const exercisesByDay = {};
                plan.rutina.exercises.forEach(exercise => {
                    const day = exercise.day || 'Sin día';
                    if (!exercisesByDay[day]) {
                        exercisesByDay[day] = [];
                    }
                    exercisesByDay[day].push(exercise);
                });
                
                const days = Object.keys(exercisesByDay);
                let upgradeShown = false;
                
                days.forEach((day, index) => {
                    // Primer día siempre visible
                    if (index === 0) {
                        rutinaHtml += `<div class="day-title">${day}</div>`;
                        exercisesByDay[day].forEach(ej => {
                            rutinaHtml += `<div class="exercise-item">• ${ej.name} ${ej.sets}x${ej.reps}</div>`;
                        });
                    } 
                    // Resto censurado para FREE
                    else if (!isPremium) {
                        if (index === 1 && !upgradeShown) {
                            rutinaHtml += `
                                <div class="censored-content">
                                    <div class="day-title">${day}</div>
                                    ${exercisesByDay[day].map(ej => 
                                        `<div class="exercise-item">• ${ej.name} ${ej.sets}x${ej.reps}</div>`
                                    ).join('')}
                                </div>
                            `;
                            
                            // Overlay de upgrade después del primer día censurado
                            rutinaHtml += `
                                <div style="
                                    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                                    border: 2px solid #39ff14;
                                    padding: 40px 30px;
                                    border-radius: 16px;
                                    text-align: center;
                                    margin: 30px 0;
                                    box-shadow: 0 0 30px rgba(57, 255, 20, 0.15);
                                ">
                                    <h3 style="color: #39ff14; font-size: 24px; font-weight: 700; margin-bottom: 12px;">
                                        Desbloquea la Rutina Completa
                                    </h3>
                                    <p style="color: #cccccc; font-size: 15px; margin-bottom: 25px;">
                                        Accede a todos los días, modificaciones ilimitadas con IA y seguimiento de progreso
                                    </p>
                                    <button onclick="window.location.href='./tarifas.html'" style="
                                        background: #39ff14;
                                        color: #000000;
                                        padding: 14px 40px;
                                        border: none;
                                        border-radius: 10px;
                                        font-weight: 700;
                                        cursor: pointer;
                                        font-size: 16px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        transition: all 0.3s ease;
                                    ">
                                        Mejorar a Premium - €9.99/mes
                                    </button>
                                </div>
                            `;
                            upgradeShown = true;
                        } else if (index > 1) {
                            rutinaHtml += `
                                <div class="censored-content">
                                    <div class="day-title">${day}</div>
                                    <div class="exercise-item">• ████████ ████</div>
                                    <div class="exercise-item">• ████████ ████</div>
                                </div>
                            `;
                        }
                    }
                    // Todo visible para PREMIUM
                    else {
                        rutinaHtml += `<div class="day-title">${day}</div>`;
                        exercisesByDay[day].forEach(ej => {
                            rutinaHtml += `<div class="exercise-item">• ${ej.name} ${ej.sets}x${ej.reps}</div>`;
                        });
                    }
                });
                
                // Insertar rutina
                if (rutinaContent) {
                    rutinaContent.style.display = 'block';
                    rutinaContent.style.visibility = 'visible';
                    rutinaContent.style.opacity = '1';
                    rutinaContent.innerHTML = rutinaHtml;
                    console.log('✅ Rutina insertada con diseño minimalista');
                }
            }
            
            // DIETA - DISEÑO MINIMALISTA
            console.log('🍽️ Verificando dieta:', plan.dieta);
            console.log('🍽️ Tiene meals?', plan.dieta?.meals);
            console.log('🍽️ Meals count:', plan.dieta?.meals?.length);
            
            if (dietaContent && plan.dieta && plan.dieta.meals && plan.dieta.meals.length > 0) {
                const totalKcal = (typeof plan.dieta.total_kcal === 'number')
                    ? plan.dieta.total_kcal
                    : (Array.isArray(plan.dieta.meals)
                        ? plan.dieta.meals.reduce((acc, m) => acc + (Number(m.kcal) || 0), 0)
                        : 0);
                let dietaHtml = `
                    <h1 class="section-title" style="margin-top: 50px;">Dieta</h1>
                    <p class="section-subtitle">${plan.dieta.titulo || 'Plan personalizado'} - ${totalKcal} kcal diarias</p>
                `;
                
                let upgradeShown = false;
                
                plan.dieta.meals.forEach((comida, index) => {
                    console.log(`🍽️ Comida ${index}:`, comida);
                    // Primera comida siempre visible
                    if (index === 0) {
                        dietaHtml += `<div class="meal-title">${comida.nombre}</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                if (typeof alimento === 'string') {
                                    dietaHtml += `<div class="food-item">• ${alimento}</div>`;
                                } else if (typeof alimento === 'object' && alimento.alimento) {
                                    dietaHtml += `<div class="food-item">• ${alimento.alimento} - ${alimento.cantidad}</div>`;
                                } else {
                                    dietaHtml += `<div class="food-item">• ${alimento}</div>`;
                                }
                            });
                        }
                    }
                    // Resto censurado para FREE
                    else if (!isPremium) {
                        dietaHtml += `
                            <div class="censored-content">
                                <div class="meal-title">${comida.nombre}</div>
                                <div class="food-item">• ████████ ████</div>
                                <div class="food-item">• ████████ ████</div>
                            </div>
                        `;
                        
                        // Mostrar overlay después de la primera comida censurada
                        if (index === 1 && !upgradeShown) {
                            dietaHtml += `
                                <div style="
                                    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                                    border: 2px solid #39ff14;
                                    padding: 40px 30px;
                                    border-radius: 16px;
                                    text-align: center;
                                    margin: 30px 0;
                                    box-shadow: 0 0 30px rgba(57, 255, 20, 0.15);
                                ">
                                    <h3 style="color: #39ff14; font-size: 24px; font-weight: 700; margin-bottom: 12px;">
                                        Desbloquea la Dieta Completa
                                    </h3>
                                    <p style="color: #cccccc; font-size: 15px; margin-bottom: 25px;">
                                        Accede a todas las comidas, ajustes personalizados según tu progreso y recetas exclusivas
                                    </p>
                                    <button onclick="window.location.href='./tarifas.html'" style="
                                        background: #39ff14;
                                        color: #000000;
                                        padding: 14px 40px;
                                        border: none;
                                        border-radius: 10px;
                                        font-weight: 700;
                                        cursor: pointer;
                                        font-size: 16px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        transition: all 0.3s ease;
                                    ">
                                        Mejorar a Premium - €9.99/mes
                                    </button>
                                </div>
                            `;
                            upgradeShown = true;
                        }
                    }
                    // Todo visible para PREMIUM
                    else {
                        dietaHtml += `<div class="meal-title">${comida.nombre}</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                if (typeof alimento === 'string') {
                                    dietaHtml += `<div class="food-item">• ${alimento}</div>`;
                                } else if (typeof alimento === 'object' && alimento.alimento) {
                                    dietaHtml += `<div class="food-item">• ${alimento.alimento} - ${alimento.cantidad}</div>`;
                                } else {
                                    dietaHtml += `<div class="food-item">• ${alimento}</div>`;
                                }
                            });
                        }
                    }
                });
                
                // Insertar dieta
                if (dietaContent) {
                    // 🔥 LIMPIAR MENSAJES DE ERROR QUE TAPAN LA DIETA
                    const noContentMessages = dietaContent.querySelectorAll('p');
                    noContentMessages.forEach(p => {
                        if (p.textContent.includes('No tienes') || p.textContent.includes('nutricional')) {
                            p.style.display = 'none';
                            p.remove(); // Eliminarlo completamente
                            console.log('🚫 Eliminando mensaje de error que tapa la dieta');
                        }
                    });
                    
                    // 🔥 FORZAR VISIBILIDAD
                    dietaContent.style.display = 'block';
                    dietaContent.style.visibility = 'visible';
                    dietaContent.style.opacity = '1';
                    dietaContent.style.zIndex = '10';
                    dietaContent.style.position = 'relative';
                    
                    // 🔥 INSERTAR DIETA
                    dietaContent.innerHTML = dietaHtml;
                    console.log('✅ Dieta insertada con diseño minimalista');
                }
            } else {
                console.error('❌ No se pudo renderizar dieta:');
                console.error('  - dietaContent existe:', !!dietaContent);
                console.error('  - plan.dieta existe:', !!plan.dieta);
                console.error('  - plan.dieta.meals existe:', !!plan.dieta?.meals);
                console.error('  - plan.dieta.meals.length:', plan.dieta?.meals?.length);
                
                // Forzar mostrar mensaje de error
                if (dietaContent) {
                    dietaContent.innerHTML = `
                        <h1 class="section-title" style="margin-top: 50px;">Dieta</h1>
                        <p style="color: #ff4444;">Error: No se pudo cargar el plan nutricional</p>
                        <pre style="color: #888; font-size: 12px;">${JSON.stringify(plan.dieta, null, 2)}</pre>
                    `;
                }
            }

            // Mostrar consejos (aplicar recorte si es free)
            const consejosContent = document.getElementById('consejosContent');
            if (plan.rutina && plan.rutina.consejos) {
                const consejos = plan.rutina.consejos;
                const total = consejos.length;
                const premium = isPremiumUser();
                const visibles = premium ? total : Math.max(2, Math.ceil(total * 0.33)); // Mostrar 33% (mínimo 2)

                let consejosHTML = '<h3>Consejos de Entrenamiento</h3>';
                
                // Consejos visibles expandidos
                const consejosExpandidos = [
                    "SOBRECARGA PROGRESIVA: El principio fundamental del crecimiento muscular. Debes aumentar gradualmente el peso, repeticiones o series cada 1-2 semanas. Si puedes hacer 3 series de 10 repeticiones con 50kg, la próxima semana intenta 3x10 con 52.5kg o 3x12 con 50kg. Esta progresión constante es lo que estimula la adaptación muscular.",
                    "CALENTAMIENTO COMPLETO: Nunca saltes el calentamiento. Dedica 10-15 minutos a activar tu sistema cardiovascular y preparar tus músculos. Comienza con 5 minutos de cardio ligero, luego realiza movimientos dinámicos como círculos de brazos, sentadillas sin peso y estiramientos activos. Esto reduce el riesgo de lesiones y mejora tu rendimiento."
                ];

                consejosExpandidos.forEach(consejo => {
                    consejosHTML += `<div style=\"margin-bottom: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #84cc16;\">`;
                    consejosHTML += `<div style=\"font-weight: 600; color: #2d5016; margin-bottom: 8px;\">${consejo.split(':')[0]}:</div>`;
                    consejosHTML += `<div style=\"color: #365314; line-height: 1.5;\">${consejo.split(':').slice(1).join(':').trim()}</div>`;
                    consejosHTML += `</div>`;
                });

                // Consejos censurados para usuarios no premium
                if (!premium && visibles < total) {
                    const ocultos = total - visibles;
                    const consejosCensurados = [
                        "NUTRICIÓN PRE-ENTRENAMIENTO: Consume carbohidratos complejos 2-3 horas antes del entrenamiento para tener energía sostenida. Avena, arroz integral o patata son excelentes opciones. Evita comidas pesadas que puedan causar molestias digestivas durante el ejercicio.",
                        "PROTEÍNA POST-ENTRENAMIENTO: La ventana anabólica es real. Consume 20-30g de proteína de alta calidad (suero de leche, pollo, pescado) en los primeros 30-60 minutos post-entreno. Esto maximiza la síntesis de proteína muscular y acelera la recuperación.",
                        "La hidratación adecuada es fundamental para el rendimiento muscular. Bebe al menos 2-3 litros de agua diarios, especialmente antes y después del entrenamiento.",
                        "El descanso entre series debe ser progresivo: 60-90 segundos para hipertrofia, 2-3 minutos para fuerza máxima.",
                        "La técnica correcta siempre prevalece sobre el peso. Es mejor hacer 8 repeticiones perfectas que 12 mal ejecutadas.",
                        "La nutrición post-entrenamiento es crucial. Consume proteínas y carbohidratos en los primeros 30-60 minutos después del ejercicio."
                    ];

                    consejosCensurados.slice(0, Math.min(ocultos, 6)).forEach(consejo => {
                        consejosHTML += `<div style=\"margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; position: relative; overflow: hidden; border-left: 4px solid #cbd5e1;\">`;
                        consejosHTML += `<div style=\"filter: blur(2px); color: #64748b; user-select: none; pointer-events: none; line-height: 1.5;\">`;
                        if (consejo.includes(':')) {
                            consejosHTML += `<div style=\"font-weight: 600; color: #475569; margin-bottom: 8px;\">${consejo.split(':')[0]}:</div>`;
                            consejosHTML += `<div style=\"color: #64748b;\">${consejo.split(':').slice(1).join(':').trim()}</div>`;
                        } else {
                            consejosHTML += `• ${consejo}`;
                        }
                        consejosHTML += `</div>`;
                        consejosHTML += `<div style=\"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(132, 204, 22, 0.95); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(132, 204, 22, 0.3);\">PRO</div>`;
                        consejosHTML += `</div>`;
                    });

                    consejosHTML += `<div style=\"margin-top: 10px; padding: 14px; border: 1px dashed #94a3b8; border-radius: 8px; background: rgba(148,163,184,0.08); color: #cbd5e1;\">`;
                    consejosHTML += `${ocultos} consejo(s) adicionales disponibles en Pro. `;
                    consejosHTML += `<a href=\"./tarifas.html\" style=\"color:#84cc16; font-weight:600; text-decoration: underline;\">Mejora a Pro</a> para desbloquear todos los consejos.`;
                    consejosHTML += `</div>`;
                }

                consejosContent.innerHTML = consejosHTML;
            }
        }

        // Función para abrir overlays
        function openOverlay(overlayId) {
            document.getElementById(overlayId).style.display = 'flex';
        }

        // Función para cerrar overlays
        function closeOverlay(overlayId) {
            document.getElementById(overlayId).style.display = 'none';
        }

        // Función para cargar contenido de rutina y dieta
        function loadRoutineAndDietContent() {
            const storedPlan = localStorage.getItem('userPlan');
            const premium = isPremiumUser();
            
            if (storedPlan) {
                try {
                    const plan = JSON.parse(storedPlan);
                    displayRoutineContent(plan, premium);
                    displayDietContent(plan, premium);
                } catch (e) {
                    console.error('Error parsing stored plan:', e);
                    showNoContentMessages();
                }
            } else {
                showNoContentMessages();
            }
        }

        // Función para mostrar contenido de rutina
        function displayRoutineContent(plan, premium) {
            const contentArea = document.getElementById('rutinaContent');
            
            if (plan.rutina && plan.rutina.dias) {
                const dias = plan.rutina.dias;
                const total = dias.length;
                const visibles = premium ? total : Math.max(1, Math.ceil(total * 0.2)); // 20% para usuarios básicos

                let routineHTML = '';
                
                // Mostrar días visibles
                dias.slice(0, visibles).forEach(dia => {
                    routineHTML += `<div class="routine-item">`;
                    routineHTML += `<div class="routine-day">${dia.dia}</div>`;
                    (dia.ejercicios || []).forEach(ejercicio => {
                        routineHTML += `<div class="exercise">`;
                        routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                        routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                        routineHTML += `</div>`;
                    });
                    routineHTML += `</div>`;
                });

                // Mostrar días censurados para usuarios no premium
                if (!premium && visibles < total) {
                    const ocultos = total - visibles;
                    
                    // Agregar días censurados
                    dias.slice(visibles, visibles + Math.min(ocultos, 2)).forEach(dia => {
                        routineHTML += `<div class="routine-item premium-overlay">`;
                        routineHTML += `<div class="routine-day">${dia.dia}</div>`;
                        (dia.ejercicios || []).forEach(ejercicio => {
                            routineHTML += `<div class="exercise">`;
                            routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                            routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                            routineHTML += `</div>`;
                        });
                        routineHTML += `<div class="premium-badge">`;
                        routineHTML += `<h4>Desbloquea contenido completo con Pro</h4>`;
                        routineHTML += `<p>${ocultos} días adicionales disponibles</p>`;
                        routineHTML += `<button class="premium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                        routineHTML += `</div>`;
                        routineHTML += `</div>`;
                    });
                }

                contentArea.innerHTML = routineHTML;
            } else {
                contentArea.innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
            }
        }

        // Función para mostrar contenido de dieta
        function displayDietContent(plan, premium) {
            const contentArea = document.getElementById('dietaContent');
            
            if (plan.dieta && plan.dieta.comidas) {
                const comidas = plan.dieta.comidas;
                const total = comidas.length;
                const visibles = premium ? total : Math.max(2, Math.ceil(total * 0.5)); // 50% para usuarios básicos

                let dietHTML = '';
                
                // Mostrar macros si están disponibles
                if (plan.dieta.macros) {
                    dietHTML += `<div class="macros-grid">`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.proteinas}g</span><span class="macro-label">Proteínas</span></div>`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.carbohidratos}g</span><span class="macro-label">Carbohidratos</span></div>`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.grasas}g</span><span class="macro-label">Grasas</span></div>`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.calorias}</span><span class="macro-label">Calorías</span></div>`;
                    dietHTML += `</div>`;
                }

                // Mostrar comidas visibles
                comidas.slice(0, visibles).forEach(comida => {
                    dietHTML += `<div class="meal-card">`;
                    dietHTML += `<div class="meal-header">`;
                    dietHTML += `<span class="meal-time">${comida.hora}</span>`;
                    dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                    dietHTML += `</div>`;
                    if (comida.alimentos) {
                        comida.alimentos.forEach(alimento => {
                            dietHTML += `<div class="food-item">`;
                            dietHTML += `<span>${alimento.nombre}</span>`;
                            dietHTML += `<span>${alimento.cantidad}</span>`;
                            dietHTML += `</div>`;
                        });
                    }
                    dietHTML += `</div>`;
                });

                // Mostrar comidas censuradas para usuarios no premium
                if (!premium && visibles < total) {
                    const ocultos = total - visibles;
                    
                    // Agregar comidas censuradas
                    comidas.slice(visibles, visibles + Math.min(ocultos, 2)).forEach(comida => {
                        dietHTML += `<div class="meal-card premium-overlay">`;
                        dietHTML += `<div class="meal-header">`;
                        dietHTML += `<span class="meal-time">${comida.hora}</span>`;
                        dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                        dietHTML += `</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                dietHTML += `<div class="food-item">`;
                                dietHTML += `<span>${alimento.nombre}</span>`;
                                dietHTML += `<span>${alimento.cantidad}</span>`;
                                dietHTML += `</div>`;
                            });
                        }
                        dietHTML += `<div class="premium-badge">`;
                        dietHTML += `<h4>Desbloquea contenido completo con Pro</h4>`;
                        dietHTML += `<p>${ocultos} comidas adicionales disponibles</p>`;
                        dietHTML += `<button class="premium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                        dietHTML += `</div>`;
                        dietHTML += `</div>`;
                    });
                }

                contentArea.innerHTML = dietHTML;
            } else {
                contentArea.innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
            }
        }

        // Función para cargar contenido de consejos y estudios
        function loadAdviceAndStudiesContent() {
            const storedPlan = localStorage.getItem('userPlan');
            const premium = isPremiumUser();
            
            loadAdviceContent(storedPlan, premium);
            loadStudiesContent();
        }

        // Función para mostrar consejos
        function loadAdviceContent(storedPlan, premium) {
            const contentArea = document.getElementById('consejosContent');
            
            const consejosTecnicos = [
                {
                    title: "SOBRECARGA PROGRESIVA SISTEMÁTICA",
                    content: "Implementa un sistema de progresión basado en el rendimiento. Aumenta el peso cuando puedas completar todas las series con 2-3 repeticiones en reserva. Para ejercicios de fuerza, incrementa 2.5-5kg; para hipertrofia, 1.25-2.5kg. Documenta cada sesión para asegurar progresión consistente."
                },
                {
                    title: "OPTIMIZACIÓN DEL VOLUMEN DE ENTRENAMIENTO",
                    content: "Mantén 10-20 series por grupo muscular por semana para maximizar la hipertrofia. Distribuye el volumen a lo largo de la semana, evitando sesiones excesivamente largas. Monitorea la fatiga acumulada y ajusta el volumen según tu capacidad de recuperación."
                }
            ];

            let adviceHTML = '';
            consejosTecnicos.forEach(consejo => {
                adviceHTML += `<div class="advice-card">`;
                adviceHTML += `<div class="advice-title">${consejo.title}</div>`;
                adviceHTML += `<div class="advice-content">${consejo.content}</div>`;
                adviceHTML += `</div>`;
            });

            // Consejos censurados para usuarios no premium
            if (!premium) {
                const consejosCensurados = [
                    {
                        title: "TÉCNICA Y ACTIVACIÓN MUSCULAR",
                        content: "La ejecución técnica correcta es fundamental para la activación óptima del músculo objetivo. Realiza movimientos controlados con rango completo de movimiento, manteniendo tensión constante durante la fase excéntrica y concéntrica."
                    },
                    {
                        title: "TIMING DE NUTRIENTES ESTRATÉGICO",
                        content: "Consume 20-40g de proteína de alta calidad dentro de 2 horas post-entrenamiento. Combina con 30-60g de carbohidratos de rápida absorción para maximizar la síntesis de proteínas musculares y la reposición de glucógeno."
                    }
                ];

                consejosCensurados.forEach(consejo => {
                    adviceHTML += `<div class="advice-card premium-overlay">`;
                    adviceHTML += `<div class="advice-title">${consejo.title}</div>`;
                    adviceHTML += `<div class="advice-content">${consejo.content}</div>`;
                    adviceHTML += `<div class="premium-badge">`;
                    adviceHTML += `<h4>Consejos Avanzados Disponibles</h4>`;
                    adviceHTML += `<p>Contenido técnico adicional para usuarios Pro</p>`;
                    adviceHTML += `<button class="premium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                    adviceHTML += `</div>`;
                    adviceHTML += `</div>`;
                });
            }

            contentArea.innerHTML = adviceHTML;
        }

        // Función para mostrar estudios
        function loadStudiesContent() {
            const contentArea = document.getElementById('estudiosContent');
            
            const estudios = [
                {
                    title: "Progresión Lineal en Entrenamiento de Fuerza",
                    content: "Estudio longitudinal que demuestra la efectividad de la sobrecarga progresiva sistemática en el desarrollo de la fuerza muscular. Los participantes que siguieron un protocolo de progresión lineal mostraron aumentos del 23% en fuerza máxima comparado con el grupo control.",
                    author: "Schoenfeld, B.J., Grgic, J., Ogborn, D., & Krieger, J.W. (2017)",
                    journal: "Journal of Strength and Conditioning Research, 31(12), 3508-3523"
                },
                {
                    title: "Timing de Proteínas y Síntesis Muscular",
                    content: "Investigación que evalúa el momento óptimo de consumo de proteínas post-entrenamiento. Los resultados indican que la ventana anabólica se extiende hasta 4 horas post-ejercicio, con beneficios máximos en los primeros 2 horas.",
                    author: "Areta, J.L., Burke, L.M., Ross, M.L., et al. (2013)",
                    journal: "Journal of the International Society of Sports Nutrition, 10(1), 5"
                },
                {
                    title: "Volumen de Entrenamiento y Hipertrofia",
                    content: "Meta-análisis de 15 estudios que examina la relación entre volumen de entrenamiento y crecimiento muscular. Los hallazgos sugieren que 10-20 series por grupo muscular por semana optimizan la hipertrofia en entrenados.",
                    author: "Schoenfeld, B.J., Ogborn, D., & Krieger, J.W. (2017)",
                    journal: "Sports Medicine, 47(8), 1681-1696"
                }
            ];

            let studiesHTML = '';
            estudios.forEach(estudio => {
                studiesHTML += `<div class="study-card">`;
                studiesHTML += `<div class="study-title">${estudio.title}</div>`;
                studiesHTML += `<div class="study-content">${estudio.content}</div>`;
                studiesHTML += `<div class="study-meta">`;
                studiesHTML += `<span class="study-author">${estudio.author}</span>`;
                studiesHTML += `<span class="study-journal">${estudio.journal}</span>`;
                studiesHTML += `</div>`;
                studiesHTML += `</div>`;
            });

            contentArea.innerHTML = studiesHTML;
        }

        // Función para cargar contenido de términos
        function loadTermsContent() {
            const contentArea = document.getElementById('terminosContent');
            
            const termsHTML = `
                <h3>Términos de Servicio</h3>
                <p>Al utilizar YourGains AI, aceptas estos términos de servicio. Si no estás de acuerdo con alguna parte de estos términos, no debes usar nuestros servicios.</p>
                
                <h4>Descripción del Servicio</h4>
                <p>YourGains AI es una plataforma de inteligencia artificial que proporciona planes de entrenamiento personalizados, recomendaciones nutricionales y consejos de fitness basados en tus objetivos y preferencias.</p>
                
                <h4>Limitaciones de Responsabilidad</h4>
                <p><strong>Importante:</strong> Los planes de entrenamiento y recomendaciones nutricionales son sugerencias generales. Siempre consulta con un profesional médico o de fitness antes de comenzar cualquier programa de ejercicios o dieta.</p>
                
                <h3>Política de Privacidad</h3>
                <p>Recopilamos información para proporcionarte un servicio personalizado, incluyendo datos de perfil, historial de entrenamiento y preferencias. Utilizamos esta información para generar planes personalizados y mejorar nuestros algoritmos de IA.</p>
                
                <h4>Protección de Datos</h4>
                <p>Implementamos medidas de seguridad técnicas y organizativas para proteger tu información personal contra acceso no autorizado, alteración, divulgación o destrucción.</p>
                
                <h4>Contacto</h4>
                <p>Si tienes preguntas sobre estos términos y políticas, puedes contactarnos en: legal@yourgainsai.com</p>
            `;
            
            contentArea.innerHTML = termsHTML;
        }

        // Función para mostrar mensajes de no contenido
        function showNoContentMessages() {
            document.getElementById('rutinaContent').innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
            document.getElementById('dietaContent').innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
        }

        // Hacer funciones globales
        window.openOverlay = openOverlay;
        window.closeOverlay = closeOverlay;

        // Event listeners para los botones de navegación
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('rutinaDieta').addEventListener('click', function() {
                openOverlay('rutinaDietaOverlay');
                loadRoutineAndDietContent();
            });
            
            document.getElementById('consejosEstudios').addEventListener('click', function() {
                openOverlay('consejosEstudiosOverlay');
                loadAdviceAndStudiesContent();
            });
            
            document.getElementById('terminosPrivacidad').addEventListener('click', function() {
                openOverlay('terminosPrivacidadOverlay');
                loadTermsContent();
            });
        });

        // Inicializar el dashboard cuando se carga la página
        initDashboard();

        // FUNCIONES AUXILIARES PARA FUNCTION CALLING
        // =========================================

        /**
         * Obtiene el ID del usuario actual
         */
        function getCurrentUserId() {
            try {
                // Buscar token con la clave correcta (accessToken, no token)
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('❌ No se encontró accessToken en localStorage');
                    return null;
                }
                
                // Decodificar JWT para obtener user_id
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userId = payload.user_id || payload.sub;
                console.log('✅ User ID obtenido:', userId);
                return userId;
            } catch (error) {
                console.error('❌ Error obteniendo user ID:', error);
                return null;
            }
        }

        /**
         * Obtiene el historial de conversación actual
         */
        function getConversationHistory() {
            const messages = document.querySelectorAll('.message');
            const history = [];
            
            messages.forEach(msg => {
                const isUser = msg.classList.contains('user-message');
                const content = msg.textContent.trim();
                
                if (content) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content
                    });
                }
            });
            
            return history;
        }

        /**
         * Añade badge visual a mensaje que generó modificaciones
         */
        function addModificationBadge() {
            const lastMessage = document.querySelector('.ai-message:last-child');
            if (lastMessage) {
                const badge = document.createElement('div');
                badge.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 600;
                    margin-top: 8px;
                    animation: pulse 2s infinite;
                `;
                badge.innerHTML = '✓ Plan modificado';
                lastMessage.appendChild(badge);
            }
        }

        // SISTEMA DE NOTIFICACIONES INLINE
        // =================================
        // Evita el error 404 del archivo externo

        // Configuración de la API
        const NOTIFICATION_API_BASE = 'http://127.0.0.1:8000';

        // Elementos del DOM
        let notificationContainer = null;

        /**
         * Inicializa el sistema de notificaciones
         */
        function initNotificationSystem() {
            // Crear contenedor de notificaciones si no existe
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                `;
                document.body.appendChild(notificationContainer);
            }
        }

        /**
         * Muestra notificación de modificación de plan
         * @param {Object} result - Resultado de la modificación
         * @param {boolean} result.modified - Si se realizaron modificaciones
         * @param {Array} result.changes - Lista de cambios realizados
         * @param {string} result.function_used - Función utilizada
         */
        function showModificationNotification(result) {
            if (!result.modified) return;
            
            initNotificationSystem();
            
            // Crear notificación
            const notification = document.createElement('div');
            notification.className = 'modification-notification';
            notification.style.cssText = `
                background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
                color: #ffffff;
                padding: 20px;
                border-radius: 16px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), 0 4px 16px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(0px);
                border: 2px solid rgba(255, 255, 255, 0.15);
                animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                position: relative;
                overflow: hidden;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-weight: 500;
                letter-spacing: 0.025em;
                text-rendering: optimizeLegibility;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            `;
            
            // Contenido de la notificación
            notification.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="
                        width: 24px;
                        height: 24px;
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-right: 12px;
                        font-size: 14px;
                    ">✓</div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">Plan Actualizado</h3>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: none;
                        border: none;
                        color: white;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: auto;
                        opacity: 0.7;
                        transition: opacity 0.2s;
                    " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <p style="margin: 0 0 12px 0; font-size: 15px; color: #e5e5e5; font-weight: 500; line-height: 1.4;">
                        Tu plan ha sido modificado automáticamente:
                    </p>
                    <div id="changes-list-${Date.now()}" style="max-height: 120px; overflow-y: auto;">
                        ${result.changes.map(change => `
                            <div style="
                                background: rgba(255, 255, 255, 0.08);
                                padding: 10px 14px;
                                margin: 6px 0;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 500;
                                color: #f0f0f0;
                                border-left: 3px solid #84cc16;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'">• ${change}</div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button onclick="goToRoutineAndDiet()" style="
                        background: rgba(255, 255, 255, 0.12);
                        border: 2px solid rgba(255, 255, 255, 0.25);
                        color: #ffffff;
                        padding: 12px 20px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        flex: 1;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    " onmouseover="this.style.background='#84cc16'; this.style.borderColor='#84cc16'; this.style.color='#000000'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(132, 204, 22, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                        Ver Rutina
                    </button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: rgba(255, 255, 255, 0.12);
                        border: 2px solid rgba(255, 255, 255, 0.25);
                        color: #ffffff;
                        padding: 12px 20px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        flex: 1;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    " onmouseover="this.style.background='#ef4444'; this.style.borderColor='#ef4444'; this.style.color='#ffffff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                        Descartar
                    </button>
                </div>
                
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    height: 3px;
                    background: rgba(255, 255, 255, 0.3);
                    animation: progressBar 8s linear forwards;
                    border-radius: 0 0 12px 12px;
                "></div>
            `;
            
            // Añadir al contenedor
            notificationContainer.appendChild(notification);
            
            // Auto-dismiss después de 8 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
            
            // Añadir animaciones CSS si no existen
            addNotificationStyles();
        }

        /**
         * Añade estilos CSS para las animaciones
         */
        function addNotificationStyles() {
            if (document.getElementById('notification-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOutRight {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
                
                @keyframes progressBar {
                    from {
                        width: 100%;
                    }
                    to {
                        width: 0%;
                    }
                }
                
                @keyframes slideInNotification {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOutNotification {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
                
                .modification-notification {
                    transition: all 0.3s ease;
                }
                
                .modification-notification:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 12px 40px rgba(132, 204, 22, 0.4);
                }
            `;
            document.head.appendChild(style);
        }

        /**
         * Muestra modal con detalles de los cambios
         * @param {string} functionUsed - Función utilizada
         * @param {Array} changes - Lista de cambios
         */
        // Event listener para botones de ver cambios
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-changes-btn')) {
                const functionUsed = e.target.getAttribute('data-function');
                const changes = JSON.parse(e.target.getAttribute('data-changes'));
                showChangesModal(functionUsed, changes);
            }
        });

        // Funciones para recargar secciones de rutina y dieta
        async function reloadRoutineSection() {
            console.log('🔄 Recargando sección de rutina...');
            
            try {
                // Obtener token JWT
                const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                if (!token) {
                    console.error('No hay token para recargar rutina');
                    return;
                }
                
                // Fetch nueva rutina desde backend
                const response = await fetch('http://127.0.0.1:8000/user/current-routine?user_id=' + userId, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    console.error('Error al obtener rutina:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('Nueva rutina obtenida:', data);
                
                // Buscar contenedor de rutina en el DOM
                const routineContainer = document.querySelector('#routine-content') || 
                                         document.querySelector('.routine-section') ||
                                         document.querySelector('[data-section="routine"]') ||
                                         document.querySelector('.routine-container');
                
                if (routineContainer) {
                    // Renderizar nueva rutina
                    routineContainer.innerHTML = renderRoutine(data.current_routine);
                    console.log('✅ Rutina actualizada en DOM');
                } else {
                    console.warn('No se encontró contenedor de rutina');
                    // Si estamos en otra página, marcar para recargar cuando vuelvan
                    sessionStorage.setItem('routineNeedsReload', 'true');
                }
                
            } catch (error) {
                console.error('Error recargando rutina:', error);
            }
        }

        async function reloadDietSection() {
            console.log('🔄 Recargando sección de dieta...');
            
            try {
                const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                if (!token) {
                    console.error('No hay token para recargar dieta');
                    return;
                }
                
                const response = await fetch('http://127.0.0.1:8000/api/user/current-diet', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('Error al obtener dieta:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('Nueva dieta obtenida:', data);
                
                const dietContainer = document.querySelector('#diet-content') || 
                                      document.querySelector('.diet-section') ||
                                      document.querySelector('[data-section="diet"]') ||
                                      document.querySelector('.diet-container');
                
                if (dietContainer) {
                    dietContainer.innerHTML = renderDiet(data.current_diet);
                    console.log('✅ Dieta actualizada en DOM');
                } else {
                    console.warn('No se encontró contenedor de dieta');
                    sessionStorage.setItem('dietNeedsReload', 'true');
                }
                
            } catch (error) {
                console.error('Error recargando dieta:', error);
            }
        }

        // Helper para obtener cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Funciones para renderizar rutina y dieta
        function renderRoutine(routine) {
            if (!routine || !routine.exercises) {
                return '<div class="no-routine">No hay rutina disponible</div>';
            }
            
            let html = '<div class="routine-display">';
            html += '<h3>Tu Rutina Actualizada</h3>';
            
            // Agrupar ejercicios por día si hay schedule
            if (routine.schedule) {
                Object.keys(routine.schedule).forEach(day => {
                    html += `<div class="day-section"><h4>${day}</h4>`;
                    routine.schedule[day].forEach(exercise => {
                        html += `<div class="exercise-item">${exercise}</div>`;
                    });
                    html += '</div>';
                });
            } else {
                // Mostrar ejercicios sin agrupar
                routine.exercises.forEach(exercise => {
                    if (typeof exercise === 'object') {
                        html += `<div class="exercise-item">${exercise.name || exercise}</div>`;
                    } else {
                        html += `<div class="exercise-item">${exercise}</div>`;
                    }
                });
            }
            
            html += '</div>';
            return html;
        }

        function renderDiet(diet) {
            if (!diet || !diet.meals) {
                return '<div class="no-diet">No hay dieta disponible</div>';
            }
            
            let html = '<div class="diet-display">';
            html += '<h3>Tu Dieta Actualizada</h3>';
            
            diet.meals.forEach(meal => {
                html += `<div class="meal-section">`;
                html += `<h4>${meal.name || 'Comida'}</h4>`;
                if (meal.alimentos) {
                    meal.alimentos.forEach(food => {
                        html += `<div class="food-item">${food}</div>`;
                    });
                }
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }

        // Función para ir a rutina y dieta
        function goToRoutineAndDiet() {
            console.log('🔄 Ejecutando goToRoutineAndDiet...');
            
            try {
                // Remover la notificación
                const notification = document.querySelector('.modification-notification');
                if (notification) {
                    notification.remove();
                    console.log('✅ Notificación removida');
                }
                
                // Recargar las secciones con datos actualizados
                if (typeof reloadRoutineSection === 'function') {
                    reloadRoutineSection();
                    console.log('✅ Rutina recargada');
                }
                
                if (typeof reloadDietSection === 'function') {
                    reloadDietSection();
                    console.log('✅ Dieta recargada');
                }
                
                // Intentar navegar a las secciones
                const routineSection = document.getElementById('routine-section');
                const dietSection = document.getElementById('diet-section');
                
                if (routineSection) {
                    console.log('✅ Navegando a sección de rutina');
                    routineSection.scrollIntoView({ behavior: 'smooth' });
                } else if (dietSection) {
                    console.log('✅ Navegando a sección de dieta');
                    dietSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.log('⚠️ No se encontraron secciones, recargando página');
                    window.location.reload();
                }
                
            } catch (error) {
                console.error('❌ Error en goToRoutineAndDiet:', error);
                // Fallback: recargar la página
                window.location.reload();
            }
        }

        function showChangesModal(functionUsed, changes) {
            // Crear modal si no existe
            let modal = document.getElementById('changes-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'changes-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 20000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(modal);
            }
            
            // Función de mapeo de funciones a nombres legibles
            const functionNames = {
                'modify_routine_injury': 'Adaptación por Lesión',
                'modify_routine_focus': 'Enfoque en Área Específica',
                'adjust_routine_difficulty': 'Ajuste de Dificultad',
                'adjust_for_menstrual_cycle': 'Adaptación Menstrual',
                'recalculate_diet_macros': 'Recálculo de Macros',
                'substitute_disliked_food': 'Sustitución de Alimentos',
                'generate_meal_alternatives': 'Alternativas de Comidas',
                'simplify_diet_plan': 'Simplificación de Dieta',
                'revert_last_modification': 'Reversión de Cambios'
            };
            
            const functionName = functionNames[functionUsed] || functionUsed;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    color: #333;
                    padding: 24px;
                    border-radius: 16px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    transform: scale(0.9);
                    transition: transform 0.3s ease;
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 16px;
                            color: white;
                            font-size: 18px;
                        ">✓</div>
                        <div>
                            <h2 style="margin: 0; font-size: 20px; color: #333;">${functionName}</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">
                                Cambios realizados automáticamente
                            </p>
                        </div>
                        <button onclick="closeChangesModal()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            color: #999;
                            cursor: pointer;
                            margin-left: auto;
                            padding: 4px;
                            transition: color 0.2s;
                        " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">Cambios Realizados:</h3>
                        <div style="
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border-left: 4px solid #84cc16;
                        ">
                            ${changes.map(change => `
                                <div style="
                                    padding: 8px 0;
                                    border-bottom: 1px solid #e9ecef;
                                    font-size: 14px;
                                    color: #333;
                                ">• ${change}</div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeChangesModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            Cerrar
                        </button>
                        <button onclick="revertLastModification(); closeChangesModal();" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            Deshacer Cambios
                        </button>
                    </div>
                </div>
            `;
            
            // Mostrar modal
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('div').style.transform = 'scale(1)';
            }, 10);
        }

        /**
         * Cierra el modal de cambios
         */
        function closeChangesModal() {
            const modal = document.getElementById('changes-modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.querySelector('div').style.transform = 'scale(0.9)';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        /**
         * Revierte la última modificación
         */
        async function revertLastModification() {
            try {
                console.log('🔄 Revirtiendo última modificación...');
                
                // Obtener token JWT
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No hay token para revertir cambios');
                    return;
                }
                
                const response = await fetch('http://127.0.0.1:8000/api/chat/modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        message: "deshaz el último cambio",
                        user_id: getCurrentUserId(),
                        conversation_history: []
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success !== false) {
                    console.log('✅ Cambios deshechos correctamente');
                    
                    // Recargar secciones afectadas
                    reloadRoutineSection();
                    reloadDietSection();
                    
                    // Mostrar notificación de éxito
                    alert('Cambios deshechos correctamente');
                } else {
                    throw new Error(result.message || 'Error deshaciendo cambios');
                }
            } catch (error) {
                console.error('Error reverting modification:', error);
                alert('Error deshaciendo cambios: ' + error.message);
            }
        }

        /**
         * Recarga las secciones afectadas por modificaciones
         */
        async function reloadAffectedSections() {
            try {
                // Recargar rutina si es necesario
                await reloadRoutineSection();
                
                // Recargar dieta si es necesario
                await reloadDietSection();
            } catch (error) {
                console.error('Error reloading sections:', error);
            }
        }


        /**
         * Muestra notificación de loading
         */
        function showLoadingNotification(message) {
            showSimpleNotification(message, 'loading');
        }

        /**
         * Muestra notificación de éxito
         */
        function showSuccessNotification(message) {
            showSimpleNotification(message, 'success');
        }

        /**
         * Muestra notificación de error
         */
        function showErrorNotification(message) {
            showSimpleNotification(message, 'error');
        }

        /**
         * Muestra notificación simple
         */
        function showSimpleNotification(message, type = 'info') {
            initNotificationSystem();
            
            const colors = {
                loading: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                info: '#84cc16'
            };
            
            const icons = {
                loading: '⟳',
                success: '✓',
                error: '✗',
                info: 'i'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: ${colors[type]};
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            
            notification.innerHTML = `
                <span style="font-size: 16px;">${icons[type]}</span>
                <span style="font-size: 14px;">${message}</span>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Auto-dismiss después de 3 segundos (excepto loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 3000);
            }
            
            return notification;
        }

        // Verificar si hay cambios pendientes al cargar la página
        window.addEventListener('load', () => {
            if (sessionStorage.getItem('routineNeedsReload') === 'true') {
                reloadRoutineSection();
                sessionStorage.removeItem('routineNeedsReload');
            }
            if (sessionStorage.getItem('dietNeedsReload') === 'true') {
                reloadDietSection();
                sessionStorage.removeItem('dietNeedsReload');
            }
        });

        // Inicializar sistema al cargar
        document.addEventListener('DOMContentLoaded', initNotificationSystem);
      </script>
  </body>
  </html>

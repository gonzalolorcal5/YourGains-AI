    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <title>YourGains AI</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                background-color: black;
                height: 100vh;
                height: 100dvh;
                color: white;
                font-family: Arial, sans-serif;
                position: relative;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            
            .main-layout {
                display: flex;
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
                width: 100%;
                position: relative;
            }
            
            .header-section {
                flex-shrink: 0;
                position: relative;
                width: 100%;
                z-index: 100;
                display: flex;
                flex-direction: column;
                padding-top: 75px;
                padding-bottom: 20px;
                background: #000000;
                background-color: black;
                min-height: auto;
            }
            
            .hamburger-btn {
                position: absolute;
                top: 75px;
                left: 40px;
                background: transparent;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 8px;
                z-index: 100;
                transition: all 0.3s ease;
            }
            
            .hamburger-btn:hover {
                color: #84cc16;
            }
            
            .logo {
                position: absolute;
                top: 80px;
                left: 100px;
                display: flex;
                align-items: center;
                gap: 3px;
                z-index: 11;
            }
            
            /* Menú lateral */
            .sidebar {
                position: fixed;
                top: 0;
                left: -300px;
                width: 280px;
                height: 100vh;
                background: #1a1a1a;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
                overflow-y: auto;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 999;
                display: none;
                transition: opacity 0.3s ease;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .sidebar-header {
                padding: 20px;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .sidebar-header h3 {
                color: white;
                font-size: 18px;
            }
            
            .sidebar-close {
                background: transparent;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .sidebar-close:hover {
                color: #84cc16;
            }
            
            .sidebar-menu {
                padding: 20px 0;
            }
            
            .sidebar-item {
                padding: 15px 20px;
                color: white;
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
            }
            
            .sidebar-item:hover {
                background: rgba(132, 204, 22, 0.1);
                border-left-color: #84cc16;
                color: #84cc16;
            }
            
            .sidebar-item:active {
                background: rgba(132, 204, 22, 0.2);
            }
            
            /* Estilos para menú desplegable Usuario */
            .sidebar-item.has-submenu {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .submenu-arrow {
                transition: transform 0.3s ease;
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
            }
            
            .sidebar-item.has-submenu.active .submenu-arrow {
                transform: rotate(90deg);
                color: #84cc16;
            }
            
            .sidebar-submenu {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                background: rgba(0, 0, 0, 0.3);
            }
            
            .sidebar-submenu.open {
                max-height: 300px;
            }
            
            .sidebar-submenu-item {
                padding: 12px 20px 12px 40px;
                color: rgba(255, 255, 255, 0.8);
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
                font-size: 14px;
            }
            
            .sidebar-submenu-item:hover {
                background: rgba(132, 204, 22, 0.15);
                border-left-color: #84cc16;
                color: #84cc16;
            }
            
            .dna-icon {
                width: 28px;
                height: 28px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .dna-icon img, .dna-icon svg {
                width: 100%;
                height: 100%;
                object-fit: contain;
                filter: drop-shadow(0 0 4px rgba(132, 204, 22, 0.45));
            }
            
            .logo-text {
                font-size: 20px;
                font-weight: bold;
            }
            
            .your-gains {
                color: white;
            }
            
            .ai {
                color: #84cc16;
            }
            
            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: #000000;
                min-height: 0;
                width: 100%;
                z-index: 1;
                position: relative;
                margin-top: 20px;
                padding-top: 0;
            }
            
            .chat-header {
                display: none;
            }
            
            
            .chat-messages {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                color: white;
                background: #000000;
                min-height: 0;
                scrollbar-width: thin;
                scrollbar-color: #333 #000;
                -ms-overflow-style: none;
            }
            
            .chat-messages::-webkit-scrollbar {
                width: 8px;
            }
            
            .chat-messages::-webkit-scrollbar-track {
                background: #000000;
            }
            
            .chat-messages::-webkit-scrollbar-thumb {
                background: #333;
                border-radius: 4px;
            }
            
            .chat-messages::-webkit-scrollbar-thumb:hover {
                background: #444;
            }
            
            .chat-input-area {
                flex-shrink: 0;
                padding: 16px;
                background: #000000;
                border-top: 1px solid #1a1a1a;
                width: 100%;
                box-sizing: border-box;
                min-height: 70px;
                display: flex;
                align-items: center;
            }
            
            .input-row {
                display: flex;
                gap: 12px;
                align-items: center;
                width: 100%;
                max-width: 100%;
            }
            
            .chat-input {
                flex: 1;
                padding: 12px 14px;
                border: 1px solid #1a1a1a;
                border-radius: 14px;
                outline: none;
                color: #e5e5e5;
                font-size: 14px;
                transition: all 0.15s ease-in-out;
                background: #0a0a0a;
                min-width: 0;
                width: 100%;
                resize: none;
                overflow-y: hidden;
                overflow-x: hidden;
                white-space: pre-wrap;
                word-break: break-word;
                min-height: 44px;
                max-height: 180px;
                line-height: 1.5;
                font-family: inherit;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .chat-input::-webkit-scrollbar {
                display: none;
            }
            
            .chat-input-max {
                overflow-y: auto;
            }
            
            .chat-input-max::-webkit-scrollbar {
                display: none;
            }
            
            .chat-input::placeholder {
                color: #777;
            }
            
            .chat-input:focus {
                border-color: #1a1a1a;
                box-shadow: none;
            }
            
            .chat-input:disabled {
                background: #0a0a0a;
                color: #666;
                cursor: not-allowed;
                border-color: #1a1a1a;
                opacity: 0.6;
            }
            
            .chat-input:disabled::placeholder {
                color: #555;
            }
            
            .send-btn {
                width: 44px;
                height: 44px;
                background: #000000;
                color: white;
                border: 1px solid #1a1a1a;
                border-radius: 50%;
                cursor: not-allowed;
                transition: all 0.15s ease-in-out;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                padding: 0;
            }
            
            .send-btn svg {
                width: 20px;
                height: 20px;
                stroke: white;
                transition: stroke 0.15s ease-in-out, filter 0.15s ease-in-out;
            }
            
            .send-btn:hover {
                background: #0d0d0d;
            }
            
            .send-btn:hover svg {
                stroke: #b3ff00;
                filter: drop-shadow(0 0 4px #b3ff00);
            }
            
            .send-btn:active {
                background: #1a1a1a;
                box-shadow: 0 0 6px #b3ff00;
            }
            
            .send-btn:active svg {
                stroke: #b3ff00;
            }
            
            .send-btn.active {
                background: #000000;
                color: white;
                cursor: pointer;
            }
            
            .send-btn.active:hover {
                background: #0d0d0d;
            }
            
            .send-btn.active:hover svg {
                stroke: #b3ff00;
                filter: drop-shadow(0 0 4px #b3ff00);
            }
            
            .send-btn.active:active {
                background: #1a1a1a;
                box-shadow: 0 0 6px #b3ff00;
            }
            
            .send-btn.active:active svg {
                stroke: #b3ff00;
            }
            
            .send-btn:disabled {
                background: #000000;
                color: #666;
                cursor: not-allowed;
                opacity: 0.5;
            }
            
            .send-btn:disabled:hover {
                background: #000000;
            }
            
            .send-btn:disabled:hover svg {
                filter: none;
            }
            
            .message {
                margin: 10px 0;
                padding: 12px 16px;
                border-radius: 12px;
                max-width: 85%;
                word-wrap: break-word;
                line-height: 1.5;
            }
            
            .user-message {
                background: #84cc16;
                color: #000000;
                margin-left: auto;
                text-align: left;
            }
            
            .ai-message {
                background: #1a1a1a;
                color: white;
                border: 1px solid #333;
            }
            
            .placeholder {
                text-align: center;
                color: #999;
                padding: 40px 20px;
                font-style: italic;
            }
            
            /* Animación para indicador "IA escribiendo" */
            @keyframes typing {
                0%, 60%, 100% { 
                    transform: translateY(0); 
                    opacity: 0.4;
                }
                30% { 
                    transform: translateY(-10px); 
                    opacity: 1;
                }
            }
            
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.05);
                    opacity: 0.8;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            
            .typing-indicator {
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 12px 16px;
                margin: 10px 0;
                background: #f0f0f0;
                border-radius: 15px;
                max-width: 90%;
                color: #84cc16;
                font-size: 18px;
                font-weight: bold;
            }
            
            .typing-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #84cc16;
                animation: typing 1.4s infinite;
            }
            
            .typing-dot:nth-child(2) { 
                animation-delay: 0.2s; 
            }
            
            .typing-dot:nth-child(3) { 
                animation-delay: 0.4s; 
            }
            
            .navigation {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0px;
                color: white;
                white-space: nowrap;
                z-index: 11;
                margin-top: 10px;
                background: #000000;
                background-color: black;
            }
            
            .nav-item {
                padding: 6px 2px;
                border-radius: 8px;
                transition: all 0.3s ease;
                cursor: pointer;
                font-size: 12px;
            }
            
            .nav-item:hover {
                color: #84cc16;
            }

            .nav-text {
                font-size: 12px;
                font-weight: 500;
            }
            
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            
            /* Overlay de consejos y estudios como página completa */
            #consejosEstudiosOverlay {
                background: #0a0a0a;
                display: none;
            }
            
            #consejosEstudiosOverlay[style*="display: block"] {
                display: block !important;
            }
            
            /* Estilos específicos para la página de Consejos y Estudios */
            .consejos-estudios-page {
                background: #0a0a0a;
            }
            
            .consejos-estudios-page::-webkit-scrollbar {
                width: 10px;
            }
            
            .consejos-estudios-page::-webkit-scrollbar-track {
                background: #0a0a0a;
            }
            
            .consejos-estudios-page::-webkit-scrollbar-thumb {
                background: #262626;
                border-radius: 5px;
            }
            
            .consejos-estudios-page::-webkit-scrollbar-thumb:hover {
                background: #404040;
            }
            
            .article-card {
                background: #171717;
                border: 1px solid #262626;
            }
            
            .article-card:hover {
                border-color: #84cc16;
                box-shadow: 0 10px 30px rgba(132, 204, 22, 0.1);
                transform: scale(1.02);
            }
            
            .overlay-content {
                background: #111111;
                color: white;
                padding: 40px;
                border-radius: 15px;
                max-width: 90%;
                width: 800px;
                max-height: 85vh;
                overflow-y: auto;
                position: relative;
                border: 1px solid #333;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            }
            
            .overlay-content.large {
                width: 95%;
                max-width: 1400px;
            }
            
            .overlay-content::-webkit-scrollbar {
                width: 8px;
            }
            
            .overlay-content::-webkit-scrollbar-track {
                background: #1a1a1a;
            }
            
            .overlay-content::-webkit-scrollbar-thumb {
                background: #333;
                border-radius: 4px;
            }
            
            .overlay-content::-webkit-scrollbar-thumb:hover {
                background: #444;
            }
            
            .close-btn {
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 32px;
                cursor: pointer;
                color: #888;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }
            
            .close-btn:hover {
                color: #84cc16;
                background: rgba(132, 204, 22, 0.1);
            }
            
            .overlay-content h2 {
                color: #ffffff;
                margin-bottom: 30px;
                font-size: 28px;
                font-weight: 600;
                padding-right: 50px;
            }
            
            .overlay-content h3 {
                color: #84cc16;
                margin-top: 30px;
                margin-bottom: 15px;
                font-size: 20px;
                font-weight: 600;
            }
            
            .overlay-content h4 {
                color: #ccc;
                margin-top: 20px;
                margin-bottom: 10px;
                font-size: 16px;
                font-weight: 600;
            }
            
            .overlay-content p {
                color: #e0e0e0;
                line-height: 1.8;
                margin-bottom: 15px;
                font-size: 15px;
            }
            
            .overlay-content ul {
                color: #e0e0e0;
                line-height: 1.8;
                margin-bottom: 15px;
                padding-left: 25px;
            }
            
            .overlay-content li {
                margin-bottom: 8px;
                font-size: 15px;
            }
            
            .overlay-content strong {
                color: #84cc16;
            }

            /* Forzar texto completamente blanco en el overlay de "Quiénes somos" */
            #aboutOverlay .overlay-content h3,
            #aboutOverlay .overlay-content h4,
            #aboutOverlay .overlay-content p,
            #aboutOverlay .overlay-content ul,
            #aboutOverlay .overlay-content li,
            #aboutOverlay .overlay-content strong {
                color: #ffffff !important;
            }
            
            /* Forzar texto completamente blanco en el overlay de "Términos y Privacidad" */
            #terminosPrivacidadOverlay .overlay-content h3,
            #terminosPrivacidadOverlay .overlay-content h4,
            #terminosPrivacidadOverlay .overlay-content p,
            #terminosPrivacidadOverlay .overlay-content ul,
            #terminosPrivacidadOverlay .overlay-content li,
            #terminosPrivacidadOverlay .overlay-content strong {
                color: #ffffff !important;
            }
            
            .isPremium-lock {
                position: relative;
                opacity: 0.5;
                pointer-events: none;
            }
            
            .upgrade-notice {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                padding: 15px;
                border-radius: 10px;
                margin: 20px 0;
            }
            
            .upgrade-btn {
                background: transparent;
                color: #84cc16;
                border: 1px solid #84cc16;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
                transition: all 0.3s ease;
            }
            
            .upgrade-btn:hover {
                background: #84cc16;
                color: white;
                transform: translateY(-1px);
            }
            
            .download-btn {
                background: #3b82f6;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }
            
            .download-btn:hover {
                background: #1d4ed8;
            }
            
            .download-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            
            .nav-separator {
                color: #666;
                font-size: 12px;
                opacity: 0.5;
            }
            
            .logout-btn {
                background: #333333;
                color: white;
                border: 1px solid #666;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s ease;
            }
            
            .logout-btn:hover {
                background: #444444;
                border-color: #777;
            }

            /* Controles móviles - eliminados, ahora en sidebar */
            .mobile-controls {
                display: none !important;
            }

            /* Gym Image Container */
            .gym-image-container {
                position: absolute;
                top: 50%;
                right: 20px;
                transform: translateY(-50%);
                width: 500px;
                height: 450px;
                border-radius: 20px;
                overflow: hidden;
                background: transparent;
                border: none;
            }

            .gym-image {
                width: 100%;
                height: 100%;
                object-fit: contain;
                border-radius: 20px;
                filter: brightness(0.9) contrast(1.6) saturate(1.3);
                transition: all 0.4s ease;
                background: transparent;
            }

            .gym-image:hover {
                transform: scale(1.05);
                filter: brightness(1.1) contrast(1.7) saturate(1.4);
            }

            /* Responsive adjustments */
            @media (max-width: 1600px) {
                .gym-image-container {
                    width: 400px;
                    height: 360px;
                    right: 15px;
                }
            }

            @media (max-width: 1400px) {
                .gym-image-container {
                    width: 350px;
                    height: 320px;
                    right: 10px;
                }
            }

            @media (max-width: 1200px) {
                .gym-image-container {
                    display: none;
                }
            }
            
                .overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.85);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }

                .overlay-content {
                    background: #111111;
                    color: white;
                    border-radius: 12px;
                    padding: 25px;
                    max-width: 95%;
                    width: 100%;
                    max-height: 85vh;
                    overflow-y: auto;
                    border: 1px solid #333;
                    position: relative;
                }
                
                .overlay-content h2 {
                    font-size: 22px;
                    padding-right: 40px;
                }
                
                .overlay-content h3 {
                    font-size: 18px;
                }
                
                .overlay-content p, .overlay-content li {
                    font-size: 14px;
                }

            .overlay-content.large {
                max-width: 1200px;
                max-height: 85vh;
            }

            .tab-content-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
                margin-top: 1.5rem;
            }

            .content-column {
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                padding: 1.5rem;
            }

            .content-column h3 {
                color: #ffffff;
                margin-bottom: 1rem;
                font-size: 1.2rem;
                font-weight: 600;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 0.5rem;
            }

            .close-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: none;
                border: none;
                color: #fff;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.5rem;
                border-radius: 50%;
                transition: background 0.3s ease;
            }

            .close-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .overlay-content h2 {
                color: #ffffff;
                margin-bottom: 1rem;
                font-size: 1.5rem;
            }

            .overlay-content p {
                color: #ccc;
                line-height: 1.6;
            }

            /* Estilos para contenido de rutina */
            .routine-item {
                background: rgba(132, 204, 22, 0.05);
                border: 1px solid rgba(132, 204, 22, 0.2);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .routine-day {
                color: #84cc16;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .exercise {
                margin: 0.5rem 0;
                padding: 0.5rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 6px;
            }

            .exercise-name {
                font-weight: 500;
                margin-bottom: 0.25rem;
            }

            .exercise-details {
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.7);
            }

            /* Estilos para contenido de dieta */
            .macros-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .macro-card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 1rem;
                text-align: center;
            }

            .macro-value {
                font-size: 1.5rem;
                font-weight: 700;
                color: #84cc16;
                display: block;
            }

            .macro-label {
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.7);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .meal-card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .meal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            .meal-time {
                font-size: 0.8rem;
                color: #84cc16;
                background: rgba(132, 204, 22, 0.1);
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
            }

            .meal-name {
                font-weight: 500;
            }

            .food-item {
                display: flex;
                justify-content: space-between;
                padding: 0.25rem 0;
                font-size: 0.9rem;
            }

            /* ═══════════════════════════════════════════════════════════════
               CONSEJOS Y ESTUDIOS - SCIENTIFIC DARK REDESIGN
               ═══════════════════════════════════════════════════════════════ */

            /* Contenedor Principal de Consejos */
            .consejos-estudios-section {
                background: #0a0a0a;
                min-height: 100vh;
                padding: 24px;
            }

            /* Header de la Sección */
            .consejos-header {
                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                border-bottom: 1px solid #2a2a2a;
                padding: 48px 24px 32px;
                text-align: center;
                margin-bottom: 32px;
                border-radius: 16px;
            }

            .consejos-title {
                color: #ffffff;
                font-size: 40px;
                font-weight: 800;
                margin-bottom: 12px;
                letter-spacing: -1px;
            }

            .consejos-title-highlight {
                color: #39ff14;
                position: relative;
            }

            .consejos-subtitle {
                color: #a3a3a3;
                font-size: 18px;
                font-weight: 400;
                letter-spacing: 0.5px;
            }

            /* Grid de Artículos */
            .consejos-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 24px;
                max-width: 1400px;
                margin: 0 auto;
            }

            /* Card Individual de Artículo */
            .article-card {
                background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
                border: 1px solid #2a2a2a;
                border-radius: 16px;
                padding: 32px;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .article-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(180deg, #39ff14 0%, transparent 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .article-card:hover {
                border-color: rgba(57, 255, 20, 0.3);
                transform: translateY(-4px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 
                            0 0 0 1px rgba(57, 255, 20, 0.1);
            }

            .article-card:hover::before {
                opacity: 1;
            }

            /* Badge de Categoría */
            .article-badge {
                display: inline-block;
                background: rgba(57, 255, 20, 0.15);
                border: 1px solid rgba(57, 255, 20, 0.3);
                color: #39ff14;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                padding: 6px 12px;
                border-radius: 6px;
                margin-bottom: 16px;
                width: fit-content;
            }

            /* Título del Artículo */
            .article-title {
                color: #ffffff;
                font-size: 24px;
                font-weight: 700;
                line-height: 1.3;
                margin-bottom: 16px;
                letter-spacing: -0.3px;
            }

            /* Contenido del Artículo */
            .article-content {
                color: #e5e5e5;
                font-size: 15px;
                line-height: 1.8;
                margin-bottom: 20px;
                flex: 1;
            }

            .article-content p {
                margin-bottom: 14px;
            }

            .article-content p:last-child {
                margin-bottom: 0;
            }

            /* Sección de Referencias */
            .article-references {
                border-top: 1px solid #2a2a2a;
                padding-top: 20px;
                margin-top: auto;
            }

            .references-title {
                color: #a3a3a3;
                font-size: 13px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 12px;
            }

            .reference-item {
                display: flex;
                align-items: flex-start;
                gap: 10px;
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 8px;
                transition: background 0.2s ease;
            }

            .reference-item:hover {
                background: rgba(255, 255, 255, 0.03);
            }

            .reference-item:last-child {
                margin-bottom: 0;
            }

            .reference-icon {
                font-size: 18px;
                flex-shrink: 0;
                opacity: 0.8;
                margin-top: 2px;
                color: #a3a3a3;
                font-weight: bold;
            }

            .reference-content {
                flex: 1;
            }

            .reference-text {
                color: #cccccc;
                font-size: 13px;
                line-height: 1.5;
                margin-bottom: 4px;
            }

            .reference-link {
                color: #39ff14;
                font-size: 12px;
                font-weight: 600;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 4px;
                transition: all 0.2s ease;
            }

            .reference-link:hover {
                color: #2ee00f;
                gap: 8px;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .consejos-header {
                    padding: 32px 20px 24px;
                }
                
                .consejos-title {
                    font-size: 32px;
                }
                
                .consejos-subtitle {
                    font-size: 16px;
                }
                
                .consejos-grid {
                    grid-template-columns: 1fr;
                    gap: 20px;
                }
                
                .article-card {
                    padding: 24px 20px;
                }
                
                .article-title {
                    font-size: 22px;
                }
                
                .article-content {
                    font-size: 14px;
                }
            }

            @media (max-width: 480px) {
                .consejos-estudios-section {
                    padding: 16px;
                }
                
                .consejos-title {
                    font-size: 28px;
                }
                
                .article-card {
                    padding: 20px 16px;
                }
            }

            /* ═══════════════════════════════════════════════════════════════
               RUTINA Y DIETA - RESPONSIVE
               ═══════════════════════════════════════════════════════════════ */
            @media (max-width: 1200px) {
                #rutinaDietaOverlay main {
                    max-width: 100%;
                    padding: 0 16px 40px 16px;
                }
            }

            @media (max-width: 768px) {
                #rutinaDietaOverlay header > div {
                    padding: 16px;
                }
                
                #rutinaDietaOverlay header h1 {
                    font-size: 28px;
                }
                
                #rutinaContent, #dietaContent {
                    padding: 24px 20px !important;
                }
                
                .section-title {
                    font-size: 26px !important;
                }
                
                .macros-summary {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 12px !important;
                    padding: 20px !important;
                }
                
                .macro-value {
                    font-size: 24px !important;
                }
            }

            /* ❌ ESTILOS ANTIGUOS - DEPRECADOS (mantenidos por compatibilidad) */
            .advice-card {
                background: rgba(132, 204, 22, 0.05);
                border: 1px solid rgba(132, 204, 22, 0.2);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .advice-title {
                color: #84cc16;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .advice-content {
                color: rgba(255, 255, 255, 0.9);
                line-height: 1.6;
            }

            .study-card {
                background: rgba(59, 130, 246, 0.05);
                border: 1px solid rgba(59, 130, 246, 0.2);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .study-title {
                color: #3b82f6;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .study-content {
                color: rgba(255, 255, 255, 0.9);
                line-height: 1.6;
                margin-bottom: 0.75rem;
            }

            .study-meta {
                border-top: 1px solid rgba(59, 130, 246, 0.2);
                padding-top: 0.75rem;
                font-size: 0.8rem;
            }

            .study-author {
                color: #84cc16;
                font-weight: 600;
                display: block;
                margin-bottom: 0.25rem;
            }

            .study-journal {
                color: rgba(255, 255, 255, 0.6);
                font-style: italic;
            }

            .study-card a {
                transition: all 0.2s ease;
            }

            .study-card a:hover {
                background: rgba(59, 130, 246, 0.2) !important;
                border-color: rgba(59, 130, 246, 0.5) !important;
                transform: translateY(-1px);
            }

            /* Premium overlay */
            .isPremium-overlay {
                position: relative;
                overflow: hidden;
            }

            .isPremium-overlay::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
                border-radius: 8px;
            }

            .isPremium-badge {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                color: white;
                padding: 1rem 2rem;
                border-radius: 8px;
                font-weight: 600;
                z-index: 2;
                text-align: center;
                box-shadow: 0 8px 32px rgba(132, 204, 22, 0.3);
            }

            .isPremium-badge h4 {
                margin-bottom: 0.5rem;
            }

            .isPremium-badge p {
                font-size: 0.9rem;
                opacity: 0.9;
                margin-bottom: 1rem;
            }

            .isPremium-btn {
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .isPremium-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: translateY(-1px);
            }

            /* Responsive */
            @media (max-width: 768px) {
                .tab-content-grid {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }

                .overlay-content.large {
                    max-width: 95%;
                    margin: 1rem;
                }

                .macros-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* ========== RESPONSIVE DESIGN - SOLO MÓVIL ========== */
            @media (max-width: 768px) {
                /* Layout general - cambiar a una columna */
                body {
                    overflow-x: hidden;
                }

                /* PASO 1: Estructura superior móvil */
                /* Logo - centrado en la parte superior */
                .hamburger-btn {
                    top: 75px;
                    left: 20px;
                    font-size: 28px;
                }
                
                .logo {
                    position: absolute;
                    top: 80px;
                    left: 70px !important;
                    transform: none !important;
                    gap: 3px;
                    z-index: 3;
                    display: flex;
                    align-items: center;
                    justify-content: flex-start;
                }
                
                .sidebar {
                    width: 260px;
                }
                

                .dna-icon {
                    width: 38px;
                    height: 38px;
                    flex-shrink: 0;
                }

                .logo-text {
                    font-size: 28px;
                    line-height: 1;
                    display: flex;
                    align-items: center;
                    white-space: nowrap;
                }

                .logo-text .your-gains {
                    margin-right: 8px;
                }

                .logo-text .ai {
                    margin-left: 0;
                }

                /* Navegación - debajo del logo, centrada y compacta */
                .header-section {
                    flex-shrink: 0;
                    position: relative;
                    padding-top: 75px;
                    padding-bottom: 20px;
                    background: #000000;
                    background-color: black;
                    z-index: 100;
                    min-height: auto;
                }
                
                .navigation {
                    margin-top: 20px;
                }

                .nav-item {
                    padding: 12px 4px;
                    font-size: 16px;
                    min-height: 50px;
                    display: flex;
                    align-items: center;
                    white-space: nowrap;
                    flex-shrink: 0;
                    font-weight: 600;
                    transition: all 0.3s ease;
                }

                .nav-separator {
                    display: inline;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 16px;
                    margin: 0 8px;
                    font-weight: 600;
                }

                /* Controles móviles - mostrar y posicionar */
                .mobile-controls {
                    display: flex;
                    position: fixed;
                    bottom: 15px;
                    right: 15px;
                    gap: 8px;
                    z-index: 1000;
                }

                .mobile-controls .upgrade-btn,
                .mobile-controls .logout-btn {
                    padding: 8px 12px;
                    font-size: 12px;
                    border-radius: 8px;
                    min-height: 36px;
                    white-space: nowrap;
                }

                /* Estilos específicos para botones móviles */
                .mobile-controls .upgrade-btn {
                    background: transparent;
                    color: #84cc16;
                    border: 1px solid #84cc16;
                    transition: all 0.3s ease;
                }

                .mobile-controls .upgrade-btn:hover {
                    background: #84cc16;
                    color: white;
                    transform: translateY(-1px);
                }

                .mobile-controls .logout-btn {
                    padding: 8px 12px;
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.8);
                    cursor: pointer;
                    border-radius: 8px;
                    min-height: 36px;
                    white-space: nowrap;
                    display: flex;
                    align-items: center;
                    transition: all 0.3s ease;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }

                .mobile-controls .logout-btn:hover {
                    color: #84cc16;
                    background: rgba(255, 255, 255, 0.2);
                    transform: translateY(-1px);
                }

                .mobile-controls .nav-item {
                    padding: 8px 12px;
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.8);
                    cursor: pointer;
                    border-radius: 8px;
                    min-height: 36px;
                    white-space: nowrap;
                    display: flex;
                    align-items: center;
                    transition: all 0.3s ease;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }

                .mobile-controls .nav-item:hover {
                    color: #84cc16;
                    background: rgba(255, 255, 255, 0.2);
                    transform: translateY(-1px);
                }

                /* Fondo negro absoluto */
                body {
                    background-color: #000000 !important;
                    background-image: none !important;
                }

                /* Ocultar el contenedor de imagen original */
                .gym-image-container {
                    display: none;
                }

                /* Chat Container - diseño profesional oscuro */
                .chat-container {
                    position: fixed;
                    top: 220px;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    width: 100%;
                    height: calc(100vh - 220px);
                    z-index: 2;
                    background: #000000;
                    border-radius: 0;
                    box-shadow: none;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    border: none;
                }

                .chat-header {
                    display: none;
                }

                .chat-messages {
                    padding: 20px 20px 50px 20px;
                    font-size: 14px;
                    background: #000000;
                    flex: 1;
                    overflow-y: auto;
                    min-height: 0;
                    line-height: 1.4;
                    scrollbar-width: thin;
                    scrollbar-color: #333 #000;
                }
                
                .chat-messages::-webkit-scrollbar {
                    width: 6px;
                }
                
                .chat-messages::-webkit-scrollbar-track {
                    background: #000000;
                }
                
                .chat-messages::-webkit-scrollbar-thumb {
                    background: #333;
                    border-radius: 3px;
                }
                
                .chat-input-area {
                    position: sticky;
                    bottom: 20px;
                    padding: 16px;
                    background: #000000;
                    flex-shrink: 0;
                    border-top: none;
                    width: 100%;
                    box-sizing: border-box;
                    box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.6);
                    min-height: 70px;
                    display: flex;
                    align-items: center;
                }

                .input-placeholder {
                    color: #666;
                    font-style: italic;
                    text-align: center;
                    padding: 40px 20px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: color 0.3s ease;
                }

                .input-placeholder:hover {
                    color: #888;
                }

                .input-row {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    width: 100%;
                }

                .chat-input {
                    flex: 1;
                    padding: 12px 14px;
                    font-size: 14px;
                    background: #0a0a0a;
                    border: 1px solid #1a1a1a;
                    border-radius: 14px;
                    outline: none;
                    color: #e5e5e5;
                    font-family: inherit;
                    line-height: 1.5;
                    text-align: left;
                    transition: all 0.15s ease-in-out;
                    width: 100%;
                    resize: none;
                    overflow-y: hidden;
                    overflow-x: hidden;
                    white-space: pre-wrap;
                    word-break: break-word;
                    min-height: 44px;
                    max-height: 180px;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                }
                
                .chat-input::-webkit-scrollbar {
                    display: none;
                }
                
                .chat-input-max {
                    overflow-y: auto;
                }
                
                .chat-input-max::-webkit-scrollbar {
                    display: none;
                }

                .chat-input::placeholder {
                    color: #777;
                    font-weight: 400;
                }
                
                .chat-input:focus {
                    border-color: #1a1a1a;
                    box-shadow: none;
                }
                
                .chat-input:disabled {
                    background: #0a0a0a;
                    color: #666;
                    cursor: not-allowed;
                    border-color: #1a1a1a;
                    opacity: 0.6;
                }
                
                .chat-input:disabled::placeholder {
                    color: #555;
                }

                .send-btn {
                    width: 44px;
                    height: 44px;
                    background: #000000;
                    border: 1px solid #1a1a1a;
                    border-radius: 50%;
                    color: white;
                    cursor: not-allowed;
                    transition: all 0.15s ease-in-out;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                    padding: 0;
                }
                
                .send-btn svg {
                    width: 20px;
                    height: 20px;
                    stroke: white;
                    transition: stroke 0.15s ease-in-out, filter 0.15s ease-in-out;
                }

                .send-btn:hover {
                    background: #0d0d0d;
                }
                
                .send-btn:hover svg {
                    stroke: #b3ff00;
                    filter: drop-shadow(0 0 4px #b3ff00);
                }
                
                .send-btn:active {
                    background: #1a1a1a;
                    box-shadow: 0 0 6px #b3ff00;
                }
                
                .send-btn:active svg {
                    stroke: #b3ff00;
                }

                .send-btn.active {
                    background: #000000;
                    color: white;
                    cursor: pointer;
                }

                .send-btn.active:hover {
                    background: #0d0d0d;
                }
                
                .send-btn.active:hover svg {
                    stroke: #b3ff00;
                    filter: drop-shadow(0 0 4px #b3ff00);
                }
                
                .send-btn.active:active {
                    background: #1a1a1a;
                    box-shadow: 0 0 6px #b3ff00;
                }
                
                .send-btn.active:active svg {
                    stroke: #b3ff00;
                }

                .send-btn:disabled {
                    background: #000000;
                    color: #666;
                    cursor: not-allowed;
                    opacity: 0.5;
                }
                
                .send-btn:disabled:hover {
                    background: #000000;
                }
                
                .send-btn:disabled:hover svg {
                    filter: none;
                }


                /* Estilos para mensajes */
                .message {
                    margin-bottom: 8px;
                    padding: 10px 12px;
                    border-radius: 12px;
                    font-size: 14px;
                    line-height: 1.4;
                    max-width: 85%;
                    word-wrap: break-word;
                }

                .user-message {
                    background: #84cc16;
                    color: #000000;
                    margin-left: auto;
                    font-weight: 500;
                }

                .ai-message {
                    background: #111111;
                    color: #ffffff;
                    margin-right: auto;
                    border: 1px solid #333;
                }

                /* Indicador de escritura para móvil */
                .typing-indicator {
                    background: #111111;
                    color: #84cc16;
                    border: 1px solid #333;
                }


                /* Overlays - ajustar para móvil */
                .overlay {
                    padding: 20px;
                }

                .overlay-content {
                    padding: 20px;
                    border-radius: 16px;
                    max-width: 95%;
                    max-height: 90%;
                }

                .close-btn {
                    top: 15px;
                    right: 20px;
                    width: 36px;
                    height: 36px;
                    min-height: 44px; /* Táctil */
                    min-width: 44px;
                }

                /* Contenido de overlays - más compacto */
                .tab-content-grid {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }

                .content-column {
                    padding: 15px;
                }

                .routine-item, .meal-card, .advice-card, .study-card {
                    padding: 12px;
                    margin-bottom: 10px;
                    border-radius: 8px;
                }

                .routine-day, .meal-header, .advice-title, .study-title {
                    font-size: 14px;
                    margin-bottom: 8px;
                }

                .exercise-name, .meal-name {
                    font-size: 13px;
                }

                .exercise-details, .food-item {
                    font-size: 12px;
                }

                .macros-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                    margin-bottom: 15px;
                }

                .macro-card {
                    padding: 8px;
                    border-radius: 6px;
                }

                .macro-value {
                    font-size: 16px;
                }

                .macro-label {
                    font-size: 11px;
                }

                .isPremium-btn {
                    padding: 10px 16px;
                    border-radius: 8px;
                    font-size: 12px;
                    min-height: 44px; /* Táctil */
                    margin-top: 10px;
                }
            }

            /* Responsive para cards de consejos y estudios */
            @media (max-width: 768px) {
                #consejosEstudiosContent {
                    grid-template-columns: 1fr !important;
                }
            }

        </style>
    </head>
    <body>
        <div class="main-layout">
        <!-- Botón hamburger -->
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">☰</button>
        
        <!-- Overlay para el menú lateral -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        
        <!-- Menú lateral -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Menú</h3>
                <button class="sidebar-close" onclick="closeSidebar()">&times;</button>
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-item" onclick="handleUpgrade()">Mejora tu plan</div>
                <div class="sidebar-item has-submenu" onclick="toggleUserSubmenu()">
                    <span>Usuario</span>
                    <span class="submenu-arrow">▶</span>
                </div>
                <div class="sidebar-submenu" id="userSubmenu">
                    <div class="sidebar-submenu-item" onclick="handleViewProfile()">Ver datos</div>
                    <div class="sidebar-submenu-item" onclick="handleNewRoutine()">Generar nuevo plan</div>
                </div>
                <div class="sidebar-item" onclick="handleAbout()">Quiénes somos</div>
                <div class="sidebar-item" onclick="handleTerms()">Términos y privacidad</div>
                <div class="sidebar-item" onclick="handleLogout()">Cerrar sesión</div>
            </div>
        </aside>
        
        <div class="header-section">
            <div class="logo" style="left: 100px !important; transform: none !important;">
                <div class="dna-icon">
                    <svg viewBox="0 0 800 800" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
                        <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="your-gains">YourGains</span><span class="ai"> AI</span>
                </div>
            </div>

            <div class="navigation">
                <div class="nav-item" id="rutinaDieta">Rutina y Dieta</div>
                <div class="nav-separator">|</div>
                <div class="nav-item" id="consejosEstudios">Consejos y Estudios</div>
            </div>
        </div>

        <div class="chat-container">
            <!-- Área de mensajes scrolleable -->
            <div class="chat-messages" id="chatMessages">
            </div>
            
            <!-- Área de input fija abajo -->
            <div class="chat-input-area">
                <div class="input-row">
                <textarea id="chatInput" class="chat-input" maxlength="500" placeholder="Escribe tu mensaje..." rows="1"></textarea>
                <button id="sendBtn" class="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19V5" />
                    <path d="M5 12l7-7 7 7" />
                    </svg>
                </button>
                </div>
            </div>
        </div>

        <!-- Overlay para Rutina y Dieta -->
        <div class="overlay" id="rutinaDietaOverlay" style="background: #0a0a0a; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; height: 100dvh; z-index: 1000; display: none; flex-direction: column; overflow: hidden;">
            
            <header style="flex-shrink: 0; background: rgba(10, 10, 10, 0.98); border-bottom: 1px solid #262626; z-index: 10;">
                <div style="max-width: 1800px; margin: 0 auto; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="dna-icon" style="display: flex; align-items: center;">
                            <svg viewBox="0 0 800 800" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
                                <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
                            </svg>
                        </div>
                        <span style="color: white; font-size: 18px; font-weight: bold;">
                            YourGains <span style="color: #84cc16;">AI</span>
                        </span>
                    </div>
                    
                    <button onclick="closeOverlay('rutinaDietaOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                
                <div style="text-align: center; padding: 20px 20px 24px 20px;">
                    <h1 style="font-size: 40px; font-weight: 800; color: white; margin-bottom: 10px; letter-spacing: -1px; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">Rutina y Dieta</h1>
                    <p style="font-size: 16px; color: #a8b3c1; margin: 0; letter-spacing: 0.2px;">Tu plan personalizado de entrenamiento y nutrición</p>
                </div>
            </header>
            
            <main style="flex: 1; overflow-y: auto; padding: 48px 40px 80px 40px; position: relative;">
                <div style="max-width: 1800px; margin: 0 auto; display: flex; flex-direction: column; gap: 64px;">
                    <div id="rutinaContent" style="width: 100%;">
                        <p style="color: #999; text-align: center; padding: 40px;">Cargando rutina...</p>
                    </div>
                    
                    <div id="dietaContent" style="width: 100%;">
                        <p style="color: #999; text-align: center; padding: 40px;">Cargando dieta...</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Overlay para Consejos y Estudios -->
        <div class="overlay" id="consejosEstudiosOverlay" style="background: #0a0a0a; overflow-y: auto; position: relative;">
            <!-- HEADER FIXED -->
            <header style="position: fixed; top: 0; left: 0; right: 0; z-index: 10000; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); border-bottom: 1px solid #262626;">
                <!-- Barra superior con logo y botón cerrar -->
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <!-- Logo izquierda -->
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="dna-icon" style="display: flex; align-items: center;">
                            <svg viewBox="0 0 800 800" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                                <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
                            </svg>
                        </div>
                        <span style="color: white; font-size: 18px; font-weight: bold;">
                            YourGains <span style="color: #84cc16;">AI</span>
                        </span>
                    </div>
                    
                    <!-- Botón cerrar derecha -->
                    <button onclick="closeOverlay('consejosEstudiosOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                
                <!-- Título sección -->
                <div style="text-align: center; padding: 20px 20px 30px 20px;">
                    <h1 style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 8px;">Consejos y Estudios</h1>
                    <p style="font-size: 16px; color: #999;">Conocimiento científico aplicado al fitness</p>
                </div>
            </header>
            
            <!-- SPACER para que el contenido no quede debajo del header -->
            <div style="height: 180px;"></div>
            
            <!-- CONTENEDOR DE CARDS -->
            <main style="max-width: 1400px; margin: 0 auto; padding: 0 20px 40px 20px; position: relative; z-index: 1;">
                <div id="consejosEstudiosContent" class="consejos-grid">
                    <!-- El contenido se carga dinámicamente aquí -->
                </div>
            </main>
        </div>

        <!-- Overlay para Términos y Privacidad -->
        <div class="overlay" id="terminosPrivacidadOverlay" onclick="if(event.target === this) closeOverlay('terminosPrivacidadOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()">
                <button class="close-btn" onclick="closeOverlay('terminosPrivacidadOverlay')">&times;</button>
                <h2>Términos de Servicio y Política de Privacidad</h2>
                <div id="terminosContent">
                    <!-- El contenido se carga dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Overlay para Quiénes somos -->
        <div class="overlay" id="aboutOverlay" onclick="if(event.target === this) closeOverlay('aboutOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()">
                <button class="close-btn" onclick="closeOverlay('aboutOverlay')">&times;</button>
                <h2>Quiénes somos</h2>
                <div id="aboutContent">
                    <!-- El contenido se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Overlay para Ver Datos del Perfil -->
        <div class="overlay" id="verDatosOverlay" onclick="if(event.target === this) closeOverlay('verDatosOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()" style="max-width: 1200px; margin: 0 auto; padding: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: white; font-size: 28px; font-weight: bold; margin: 0;">Mis Datos</h2>
                    <button class="close-btn" onclick="closeOverlay('verDatosOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                <div id="verDatosContent">
                    <!-- El contenido se cargará aquí -->
                </div>
            </div>
        </div>

        <!-- Overlay para Generar Rutina Nueva -->
        <div class="overlay" id="nuevaRutinaOverlay" onclick="if(event.target === this) closeOverlay('nuevaRutinaOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()" style="max-width: 1200px; margin: 0 auto; padding: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: white; font-size: 28px; font-weight: bold; margin: 0;">Generación de rutina nueva</h2>
                    <button class="close-btn" onclick="closeOverlay('nuevaRutinaOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                <div id="nuevaRutinaContent">
                    <!-- El contenido se cargará aquí -->
                </div>
            </div>
        </div>

        <!-- Modal de Upgrade -->
        <div class="overlay" id="upgradeModal">
            <div class="overlay-content">
                <button class="close-btn" onclick="closeUpgradeModal()">&times;</button>
                <h2>🚀 Mejora a Pro</h2>
                <div style="text-align: center; padding: 20px 0;">
                    <p style="font-size: 18px; margin-bottom: 20px; color: #84cc16; font-weight: 600;">
                        Has alcanzado el límite de mensajes gratuitos
                    </p>
                    <p style="margin-bottom: 30px; color: #ccc; line-height: 1.6;">
                        Para continuar chateando de forma ilimitada y desbloquear todas las funciones isPremium, mejora tu plan ahora.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="window.location.href='./tarifas.html'" 
                                style="background: #84cc16; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#65a30d'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='#84cc16'; this.style.transform='translateY(0)'">
                            Ver Planes
                        </button>
                        <button onclick="closeUpgradeModal()" 
                                style="background: transparent; color: #ccc; border: 1px solid #555; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.borderColor='#84cc16'; this.style.color='#84cc16'"
                                onmouseout="this.style.borderColor='#555'; this.style.color='#ccc'">
                            Más Tarde
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gym Image Container - Ocultado -->
        <div class="gym-image-container" style="display: none;">
        </div>
        </div>

        <script>
            // Funciones para el menú lateral
            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
            
            function closeSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
            
            // Handlers del menú lateral
            function handleUpgrade() {
                closeSidebar();
                window.location.href = './tarifas.html';
            }
            
            function toggleUserSubmenu() {
                const submenu = document.getElementById('userSubmenu');
                const menuItem = event.currentTarget;
                menuItem.classList.toggle('active');
                submenu.classList.toggle('open');
            }
            
            async function handleNewRoutine() {
                closeSidebar();
                
                try {
                    console.log('🔄 handleNewRoutine llamado');
                    
                    // Esperar a que las funciones del módulo estén disponibles
                    let checkPremium = window.checkPremiumStatus;
                    let attempts = 0;
                    while (!checkPremium && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        checkPremium = window.checkPremiumStatus;
                        attempts++;
                    }
                    
                    if (!checkPremium) {
                        console.error('❌ checkPremiumStatus no está disponible');
                        alert('Error: Las funciones del sistema no están cargadas. Por favor, recarga la página.');
                        return;
                    }
                    
                    // Verificar si es premium
                    const isPremium = await checkPremium();
                    console.log('💎 Usuario premium:', isPremium);
                    
                    if (!isPremium) {
                        // Mostrar modal de upgrade
                        // Esperar a que showPremiumModal esté disponible
                        let showModal = window.showPremiumModal;
                        let attempts = 0;
                        while (!showModal && attempts < 10) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            showModal = window.showPremiumModal;
                            attempts++;
                        }
                        
                        if (showModal) {
                            showModal({
                                title: "Función Premium",
                                message: "Generar rutinas personalizadas ilimitadas es una función exclusiva para usuarios Premium.",
                                features: [
                                    "Rutinas personalizadas con IA",
                                    "Adaptación automática a tu progreso",
                                    "Modificaciones ilimitadas via chat",
                                    "Planes nutricionales detallados"
                                ],
                                ctaText: "Actualizar a Premium",
                                ctaLink: "./tarifas.html"
                            });
                        } else {
                            // Fallback: redirigir a tarifas
                            alert('Esta función es exclusiva para usuarios Premium. Redirigiendo a la página de tarifas...');
                            window.location.href = './tarifas.html';
                        }
                        return;
                    }
                    
                    // Si es premium, abrir overlay
                    const open = window.openOverlay;
                    if (!open) {
                        console.error('❌ openOverlay no está disponible');
                        alert('Error: No se puede abrir el formulario. Por favor, recarga la página.');
                        return;
                    }
                    
                    console.log('📂 Abriendo overlay nuevaRutinaOverlay');
                    open('nuevaRutinaOverlay');
                    
                    // Esperar a que el overlay se renderice y las funciones estén disponibles
                    let loadForm = window.loadNewRoutineForm;
                    attempts = 0;
                    while (!loadForm && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        loadForm = window.loadNewRoutineForm;
                        attempts++;
                    }
                    
                    if (loadForm) {
                        console.log('📝 Cargando formulario...');
                        await loadForm();
                        console.log('✅ Formulario cargado');
                    } else {
                        console.error('❌ loadNewRoutineForm no está disponible después de esperar');
                        // Mostrar mensaje de error en el overlay
                        const contentDiv = document.getElementById('nuevaRutinaContent');
                        if (contentDiv) {
                            contentDiv.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Error al cargar el formulario. Por favor, recarga la página.</p>';
                        }
                    }
                } catch (error) {
                    console.error('❌ Error en handleNewRoutine:', error);
                    alert('Error al abrir el formulario: ' + error.message);
                }
            }
            
            // Exponer función globalmente
            window.handleNewRoutine = handleNewRoutine;
            
            // Función para ver datos del perfil (solo lectura)
            async function handleViewProfile() {
                closeSidebar();
                
                try {
                    console.log('👤 handleViewProfile llamado');
                    
                    // Abrir overlay
                    const open = window.openOverlay;
                    if (!open) {
                        console.error('❌ openOverlay no está disponible');
                        alert('Error: No se puede abrir la vista. Por favor, recarga la página.');
                        return;
                    }
                    
                    console.log('📂 Abriendo overlay verDatosOverlay');
                    open('verDatosOverlay');
                    
                    // Esperar a que el overlay se renderice y las funciones estén disponibles
                    let loadProfile = window.loadProfileView;
                    let attempts = 0;
                    while (!loadProfile && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        loadProfile = window.loadProfileView;
                        attempts++;
                    }
                    
                    if (loadProfile) {
                        console.log('📝 Cargando datos del perfil...');
                        await loadProfile();
                        console.log('✅ Datos del perfil cargados');
                    } else {
                        console.error('❌ loadProfileView no está disponible después de esperar');
                        const contentDiv = document.getElementById('verDatosContent');
                        if (contentDiv) {
                            contentDiv.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Error al cargar los datos. Por favor, recarga la página.</p>';
                        }
                    }
                } catch (error) {
                    console.error('❌ Error en handleViewProfile:', error);
                    alert('Error al abrir la vista: ' + error.message);
                }
            }
            
            // Exponer función globalmente
            window.handleViewProfile = handleViewProfile;
            
            function handleAbout() {
                closeSidebar();
                openOverlay('aboutOverlay');
                loadAboutContent();
            }
            
            function handleTerms() {
                closeSidebar();
                openOverlay('terminosPrivacidadOverlay');
                loadTermsContent();
            }
            
            function handleLogout() {
                closeSidebar();
                logout();
            }
            
            // Forzar posición del logo y navegación al cargar
            document.addEventListener('DOMContentLoaded', function() {
                // Forzar posición del logo (sobrescribe media queries)
                const logo = document.querySelector('.logo');
                if (logo) {
                    logo.style.cssText = 'position: absolute !important; top: 80px !important; left: 100px !important; transform: none !important; display: flex !important; align-items: center !important; gap: 3px !important;';
                }
                
                // Forzar centrado de navegación al cargar
                const nav = document.querySelector('.navigation');
                if (nav) {
                    // Mantener el top con más espacio del logo y centrado compacto
                    const currentTop = window.innerWidth <= 768 ? '170px' : '90px';
                    nav.style.cssText = `position: absolute !important; top: ${currentTop} !important; left: 50% !important; transform: translateX(-50%) !important; width: auto !important; display: flex !important; justify-content: center !important; align-items: center !important; gap: 0px !important; z-index: 10 !important;`;
                }
            });
        </script>
        
        <script type="module">
            import { API_BASE } from "./config.js";
            import { checkAuthOrRedirect, getAuthHeaders, logout, isTokenExpired, decodeJwt } from "./auth.js";

            // ==========================================
            // VERIFICACIÓN DE PAGO AL CARGAR
            // ==========================================
            /**
             * Verifica si el usuario viene de un pago exitoso de Stripe
             * y actualiza su estado premium antes de cargar el dashboard
             */
            async function checkPaymentSuccess() {
                const urlParams = new URLSearchParams(window.location.search);
                const success = urlParams.get('success');
                const sessionId = urlParams.get('session_id');

                if (success === '1' && sessionId) {
                    console.log('🔄 Pago detectado, verificando con backend...');
                    console.log(`   Session ID: ${sessionId}`);

                    // Mostrar loading
                    const container = document.getElementById('main-content') || document.body;
                    const originalContent = container.innerHTML;
                    container.innerHTML = `
                        <div class="flex items-center justify-center min-h-screen bg-black">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-lime-400 mb-4"></div>
                                <p class="text-xl text-white mb-2">Verificando tu pago...</p>
                                <p class="text-sm text-neutral-400">Esto solo tomará unos segundos</p>
                            </div>
                        </div>
                    `;

                    try {
                        // Obtener user_id del token
                        const token = localStorage.getItem('accessToken');
                        if (!token) {
                            console.error('❌ No hay token de autenticación');
                            container.innerHTML = originalContent;
                            return false;
                        }

                        // Decodificar JWT para obtener user_id
                        const payload = decodeJwt(token);
                        const userId = payload?.user_id || payload?.sub;

                        if (!userId) {
                            console.error('❌ No se pudo obtener user_id del token');
                            container.innerHTML = originalContent;
                            return false;
                        }

                        console.log(`✅ User ID obtenido: ${userId}`);

                        // Llamar al endpoint de activación con session_id
                        const response = await fetch(`${API_BASE}/stripe/activate-premium`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: parseInt(userId),
                                session_id: sessionId
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || errorData.detail || 'Error verificando pago');
                        }

                        const result = await response.json();
                        console.log('✅ Verificación completada:', result);

                        if (result.success && result.is_premium) {
                            console.log('🎉 ¡Pago confirmado! Eres premium.');

                            // Limpiar URL (quitar parámetros) y redirigir directamente al dashboard
                            window.history.replaceState({}, document.title, '/dashboard.html');
                            
                            // Recargar página inmediatamente para mostrar el dashboard premium
                            location.reload();

                            return true; // Indica que se procesó el pago
                        } else {
                            console.warn('⚠️ Verificación no exitosa:', result);
                            // Continuar normalmente
                            container.innerHTML = originalContent;
                        }

                    } catch (error) {
                        console.error('❌ Error verificando pago:', error);
                        // Mostrar error pero continuar
                        container.innerHTML = `
                            <div class="flex items-center justify-center min-h-screen bg-black">
                                <div class="text-center bg-neutral-900 rounded-2xl p-8 max-w-md border border-red-500/20">
                                    <div class="text-4xl mb-4">⚠️</div>
                                    <h2 class="text-xl font-bold text-white mb-2">Error verificando pago</h2>
                                    <p class="text-neutral-400 mb-6">${error.message}</p>
                                    <button onclick="location.href='/dashboard.html'" class="bg-neutral-800 text-white font-semibold py-2 px-6 rounded-xl hover:bg-neutral-700 transition">
                                        Continuar al Dashboard
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Recargar después de 3 segundos
                        setTimeout(() => {
                            window.history.replaceState({}, document.title, '/dashboard.html');
                            location.reload();
                        }, 3000);
                    }
                }

                return false; // No había pago que verificar
            }

            // Freemium helpers (frontend-only)
            // Variable global para cachear el estado isPremium
            let userPremiumStatus = null;
            
            async function checkPremiumStatus() {
                try {
                    // Usar el mismo método que tarifas.html: /subscription-status con autenticación
                    const headers = getAuthHeaders();
                    const response = await fetch(`${API_BASE}/subscription-status`, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('📊 Estado del usuario (checkPremiumStatus):', data);
                        
                        // Verificar si es premium: is_premium o plan_type PREMIUM_MONTHLY/YEARLY
                        const isPremium = data.is_premium === true || 
                                        data.plan_type === 'PREMIUM_MONTHLY' || 
                                        data.plan_type === 'PREMIUM_YEARLY' ||
                                        data.plan_type === 'PREMIUM';
                        
                        userPremiumStatus = isPremium;
                        console.log('💎 Usuario premium detectado:', isPremium, '(plan_type:', data.plan_type, ', is_premium:', data.is_premium, ')');
                        return isPremium;
                    } else {
                        console.warn('⚠️ No se pudo obtener status de suscripción, status:', response.status);
                        // Si falla la autenticación, intentar fallback
                    }
                } catch (error) {
                    console.error('❌ Error verificando isPremium:', error);
                }
                
                // Fallback: intentar con token JWT
                try {
                    const token = localStorage.getItem('accessToken');
                    if (token) {
                        const payload = decodeJwt(token) || {};
                        if (payload.plan === 'isPremium' || payload.tier === 'isPremium' || payload.isPremium === true) {
                            userPremiumStatus = true;
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn('Fallback JWT falló:', e);
                }
                
                // Último fallback: localStorage
                const storedPlan = localStorage.getItem('plan');
                userPremiumStatus = storedPlan === 'isPremium';
                return userPremiumStatus || false;
            }
            
            function isPremiumUser() {
                // Si ya tenemos el estado, devolverlo
                if (userPremiumStatus !== null) {
                    return userPremiumStatus;
                }
                
                // Si no, usar fallback
                const token = localStorage.getItem('accessToken');
                if (token) {
                    const payload = decodeJwt(token) || {};
                    if (payload.plan === 'premium' || payload.tier === 'premium' || payload.premium === true) {
                        return true;
                    }
                }
                const storedPlan = localStorage.getItem('plan');
                return storedPlan === 'premium';
            }

            // Función auxiliar para renderizar un alimento (maneja strings y objetos)
            function renderAlimento(alimento) {
                // CASO 1: String directo
                if (typeof alimento === 'string') {
                    return alimento;
                }
                
                // CASO 2: Objeto - intentar varias estructuras posibles
                if (typeof alimento === 'object' && alimento !== null) {
                    // Opción A: {nombre, cantidad, calorias}
                    if (alimento.nombre && alimento.cantidad && alimento.calorias) {
                        return `${alimento.cantidad} ${alimento.nombre} - ${alimento.calorias}kcal`;
                    }
                    // Opción B: {alimento, cantidad}
                    else if (alimento.alimento) {
                        return `${alimento.alimento}${alimento.cantidad ? ' - ' + alimento.cantidad : ''}`;
                    }
                    // Opción C: {descripcion}
                    else if (alimento.descripcion) {
                        return alimento.descripcion;
                    }
                    // Opción D: Solo {nombre}
                    else if (alimento.nombre) {
                        return alimento.nombre;
                    }
                    // Fallback: mostrar como JSON
                    else {
                        console.warn('⚠️ Estructura de alimento desconocida:', alimento);
                        return JSON.stringify(alimento);
                    }
                }
                
                // Fallback final
                return String(alimento);
            }

            function getChatUsageKey() {
                const email = localStorage.getItem('email') || 'anonymous';
                return `chat_usage_count_${email}`;
            }

            function getChatUsageCount() {
                const raw = localStorage.getItem(getChatUsageKey());
                const n = parseInt(raw || '0', 10);
                return Number.isFinite(n) ? n : 0;
            }

            function incrementChatUsage() {
                const next = getChatUsageCount() + 1;
                localStorage.setItem(getChatUsageKey(), String(next));
                return next;
            }

            function canUseChat() {
                if (isPremiumUser()) return true;
                return getChatUsageCount() < 2; // 2 prompts for free tier
            }
            
            // Función para mostrar modal de premium (MOVIDA FUERA DE initDashboard para scope global)
            function showPremiumModal(options) {
                const modal = document.getElementById('upgradeModal');
                if (!modal) return;
                
                // Actualizar contenido del modal
                const title = modal.querySelector('h2');
                const message = modal.querySelector('p');
                const ctaButton = modal.querySelector('button[onclick*="tarifas.html"]');
                
                if (title) title.textContent = options.title || '🚀 Función Premium';
                if (message) {
                    message.textContent = options.message || 'Esta función es exclusiva para usuarios Premium.';
                }
                if (ctaButton && options.ctaText) {
                    ctaButton.textContent = options.ctaText;
                }
                
                // Mostrar modal
                modal.style.display = 'flex';
            }
            
            // Función para cargar datos actuales del usuario (MOVIDA FUERA DE initDashboard)
            async function loadCurrentUserData() {
                try {
                    const headers = getAuthHeaders();
                    const response = await fetch(`${API_BASE}/plan/datos-actuales`, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    } else {
                        console.log('No hay datos previos, formulario vacío');
                        return null;
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                    return null;
                }
            }
            
            // Función para generar el HTML del formulario (MOVIDA FUERA DE initDashboard)
            function generateNewRoutineForm(userData) {
                return `
                    <form id="newRoutineForm" style="color: white;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <!-- Datos Básicos -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Altura (cm)</label>
                                <input type="number" id="altura" name="altura" min="100" max="250" required 
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Peso (kg)</label>
                                <input type="number" id="peso" name="peso" min="30" max="200" step="0.1" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Edad</label>
                                <input type="number" id="edad" name="edad" min="13" max="100" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Sexo</label>
                                <select id="sexo" name="sexo" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="hombre">Hombre</option>
                                    <option value="mujer">Mujer</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Experiencia</label>
                                <select id="experiencia" name="experiencia" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="principiante">Principiante</option>
                                    <option value="intermedio">Intermedio</option>
                                    <option value="avanzado">Avanzado</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Objetivo Gym</label>
                                <select id="objetivo_gym" name="objetivo_gym" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="ganar_musculo">Ganar Músculo</option>
                                    <option value="ganar_fuerza">Ganar Fuerza</option>
                                    <option value="perder_grasa">Perder Grasa</option>
                                    <option value="mantener_forma">Mantener Forma</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Objetivo Nutricional</label>
                                <select id="objetivo_nutricional" name="objetivo_nutricional" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="volumen">Volumen</option>
                                    <option value="definicion">Definición</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                    <option value="recomposicion">Recomposición</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Nivel de Actividad</label>
                                <select id="nivel_actividad" name="nivel_actividad" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="sedentario">Sedentario</option>
                                    <option value="ligero">Ligero</option>
                                    <option value="moderado">Moderado</option>
                                    <option value="activo">Activo</option>
                                    <option value="muy_activo">Muy Activo</option>
                                </select>
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Días de Entrenamiento por Semana</label>
                                <select id="dias_entrenamiento" name="dias_entrenamiento" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white; margin-bottom: 16px;">
                                    <option value="">Selecciona frecuencia</option>
                                    <option value="3">3 días/semana</option>
                                    <option value="4">4 días/semana</option>
                                    <option value="5">5 días/semana</option>
                                    <option value="6">6 días/semana</option>
                                </select>
                                
                                <!-- Días específicos de entrenamiento -->
                                <div id="specific_days_container" style="margin-top: 16px;">
                                    <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Selecciona los días específicos</label>
                                    <p style="font-size: 12px; color: #999; margin-bottom: 12px;">Debe coincidir con la frecuencia elegida</p>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_lunes" name="training_days" value="lunes" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Lunes</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_martes" name="training_days" value="martes" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Martes</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_miercoles" name="training_days" value="miércoles" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Miércoles</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_jueves" name="training_days" value="jueves" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Jueves</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_viernes" name="training_days" value="viernes" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Viernes</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_sabado" name="training_days" value="sábado" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Sábado</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_domingo" name="training_days" value="domingo" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Domingo</span>
                                        </label>
                                    </div>
                                    <p id="days-error" style="display: none; color: #ef4444; font-size: 13px; margin-top: 12px; font-weight: 500;">
                                        ⚠️ Debes seleccionar exactamente <span id="required-days"></span> días
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campos adicionales -->
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Materiales Disponibles</label>
                            <textarea id="materiales" name="materiales" rows="3" placeholder="Ej: Barra libre, mancuernas, banco plano..."
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Lesiones (opcional)</label>
                            <input type="text" id="lesiones" name="lesiones" placeholder="Ej: Lesión en rodilla izquierda"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Alergias Alimentarias (opcional)</label>
                            <input type="text" id="alergias" name="alergias" placeholder="Ej: Lactosa, gluten"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Restricciones Dietéticas (opcional)</label>
                            <input type="text" id="restricciones_dieta" name="restricciones_dieta" placeholder="Ej: Vegetariano, vegano"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                        </div>
                        
                        <!-- Botón de envío -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" 
                                style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; border: none; padding: 15px 40px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(132, 204, 22, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                Generar Nueva Rutina
                            </button>
                        </div>
                    </form>
                `;
            }
            
            // Función para validar días de entrenamiento
            function validateTrainingDays() {
                const frequency = parseInt(document.getElementById('dias_entrenamiento').value) || 0;
                const selectedDays = document.querySelectorAll('input[name="training_days"]:checked').length;
                const errorMsg = document.getElementById('days-error');
                const requiredDaysSpan = document.getElementById('required-days');
                
                if (frequency === 0) {
                    if (errorMsg) errorMsg.style.display = 'none';
                    return true;
                }
                
                if (selectedDays > frequency) {
                    // Desmarcar el último checkbox
                    const checkboxes = document.querySelectorAll('input[name="training_days"]:checked');
                    if (checkboxes.length > 0) {
                        checkboxes[checkboxes.length - 1].checked = false;
                        const lastLabel = checkboxes[checkboxes.length - 1].parentElement;
                        lastLabel.style.borderColor = '#404040';
                        lastLabel.style.background = '#1a1a1a';
                    }
                    if (errorMsg) {
                        if (requiredDaysSpan) requiredDaysSpan.textContent = frequency;
                        errorMsg.style.display = 'block';
                    }
                    return false;
                } else if (selectedDays === frequency) {
                    if (errorMsg) errorMsg.style.display = 'none';
                    return true;
                } else {
                    if (errorMsg) {
                        if (requiredDaysSpan) requiredDaysSpan.textContent = frequency;
                        errorMsg.style.display = 'none'; // Ocultar hasta que se intente enviar
                    }
                    return selectedDays > 0;
                }
            }
            
            // Función para pre-llenar el formulario con datos del usuario (MOVIDA FUERA DE initDashboard)
            function prefillForm(userData) {
                if (!userData) return;
                
                // Pre-llenar campos básicos
                if (userData.altura) document.getElementById('altura').value = userData.altura;
                if (userData.peso) document.getElementById('peso').value = userData.peso;
                if (userData.edad) document.getElementById('edad').value = userData.edad;
                if (userData.sexo) document.getElementById('sexo').value = userData.sexo;
                if (userData.experiencia) document.getElementById('experiencia').value = userData.experiencia;
                if (userData.objetivo_gym) document.getElementById('objetivo_gym').value = userData.objetivo_gym;
                if (userData.objetivo_nutricional) document.getElementById('objetivo_nutricional').value = userData.objetivo_nutricional;
                if (userData.nivel_actividad) document.getElementById('nivel_actividad').value = userData.nivel_actividad;
                
                // Pre-llenar días de entrenamiento
                const diasEntrenamiento = document.getElementById('dias_entrenamiento');
                if (diasEntrenamiento) {
                    diasEntrenamiento.value = userData.dias_entrenamiento || '';
                    // Limpiar días seleccionados cuando cambia la frecuencia
                    diasEntrenamiento.addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('input[name="training_days"]');
                        checkboxes.forEach(cb => {
                            cb.checked = false;
                            const label = cb.parentElement;
                            label.style.borderColor = '#404040';
                            label.style.background = '#1a1a1a';
                        });
                        validateTrainingDays();
                    });
                }
                
                // Pre-llenar días específicos si existen
                if (userData.training_days && Array.isArray(userData.training_days)) {
                    userData.training_days.forEach(day => {
                        const checkbox = document.getElementById(`day_${day}`);
                        if (checkbox) {
                            checkbox.checked = true;
                            const label = checkbox.parentElement;
                            label.style.borderColor = '#84cc16';
                            label.style.background = 'rgba(132, 204, 22, 0.15)';
                        }
                    });
                }
                
                if (userData.materiales) document.getElementById('materiales').value = userData.materiales;
                if (userData.lesiones) document.getElementById('lesiones').value = userData.lesiones;
                if (userData.alergias) document.getElementById('alergias').value = userData.alergias;
                if (userData.restricciones_dieta) document.getElementById('restricciones_dieta').value = userData.restricciones_dieta;
            }
            
            // Función para cargar el formulario de nueva rutina (MOVIDA FUERA DE initDashboard)
            async function loadNewRoutineForm() {
                const contentDiv = document.getElementById('nuevaRutinaContent');
                if (!contentDiv) return;
                
                // Mostrar loading
                contentDiv.innerHTML = '<p style="color: white; text-align: center; padding: 40px;">Cargando formulario...</p>';
                
                // Cargar datos del usuario
                const userData = await loadCurrentUserData();
                
                // Generar formulario HTML
                const formHTML = generateNewRoutineForm(userData);
                contentDiv.innerHTML = formHTML;
                
                // Si hay datos, pre-llenar formulario
                if (userData) {
                    prefillForm(userData);
                }
                
                // Agregar event listener al formulario
                const form = document.getElementById('newRoutineForm');
                if (form) {
                    form.addEventListener('submit', handleNewRoutineSubmit);
                }
                
                // Agregar event listener al select de frecuencia para limpiar días cuando cambie
                const diasEntrenamientoSelect = document.getElementById('dias_entrenamiento');
                if (diasEntrenamientoSelect) {
                    diasEntrenamientoSelect.addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('input[name="training_days"]');
                        checkboxes.forEach(cb => {
                            cb.checked = false;
                            const label = cb.parentElement;
                            label.style.borderColor = '#404040';
                            label.style.background = '#1a1a1a';
                        });
                        const errorMsg = document.getElementById('days-error');
                        if (errorMsg) errorMsg.style.display = 'none';
                    });
                }
            }
            
            // Función para manejar el envío del formulario (MOVIDA FUERA DE initDashboard)
            async function handleNewRoutineSubmit(event) {
                event.preventDefault();
                
                const form = event.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                
                // Deshabilitar botón y mostrar loading
                submitButton.disabled = true;
                submitButton.textContent = 'Generando rutina...';
                
                try {
                    // Recopilar datos del formulario
                    const objetivoGym = document.getElementById('objetivo_gym').value;
                    
                    // Mapear objetivo_gym a objetivo (el schema espera 'objetivo', no 'objetivo_gym')
                    const objetivoMapping = {
                        'ganar_musculo': 'ganar_musculo',
                        'ganar_fuerza': 'ganar_fuerza',
                        'perder_grasa': 'perder_grasa',
                        'mantener_forma': 'mantener_forma'
                    };
                    const objetivo = objetivoMapping[objetivoGym] || objetivoGym;
                    
                    // Validar días de entrenamiento antes de enviar
                    const frequency = parseInt(document.getElementById('dias_entrenamiento').value);
                    const selectedDaysRaw = Array.from(document.querySelectorAll('input[name="training_days"]:checked')).map(cb => cb.value);
                    
                    if (frequency > 0 && selectedDaysRaw.length !== frequency) {
                        const errorMsg = document.getElementById('days-error');
                        const requiredDaysSpan = document.getElementById('required-days');
                        if (errorMsg) {
                            if (requiredDaysSpan) requiredDaysSpan.textContent = frequency;
                            errorMsg.style.display = 'block';
                        }
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        document.getElementById('dias_entrenamiento').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }
                    
                    // Capitalizar días correctamente (primera letra mayúscula)
                    const selectedDays = selectedDaysRaw.length > 0 ? selectedDaysRaw.map(day => {
                        // Capitalizar: "lunes" -> "Lunes", "miércoles" -> "Miércoles"
                        return day.charAt(0).toUpperCase() + day.slice(1);
                    }) : null;
                    
                    const formData = {
                        altura: parseInt(document.getElementById('altura').value),
                        peso: parseInt(Math.round(parseFloat(document.getElementById('peso').value))), // Convertir a int
                        edad: parseInt(document.getElementById('edad').value),
                        sexo: document.getElementById('sexo').value,
                        experiencia: document.getElementById('experiencia').value,
                        objetivo: objetivo, // El schema espera 'objetivo', no 'objetivo_gym'
                        materiales: document.getElementById('materiales').value || '',
                        dias_entrenamiento: parseInt(document.getElementById('dias_entrenamiento').value), // Requerido por schema
                        training_days: selectedDays, // Días específicos de la semana (capitalizados)
                        lesiones: document.getElementById('lesiones').value || null,
                        alergias: document.getElementById('alergias').value || null,
                        restricciones_dieta: document.getElementById('restricciones_dieta').value || null,
                        idioma: 'es'
                    };
                    
                    console.log('📤 Datos a enviar:', formData);
                    
                    // Enviar al backend
                    const headers = getAuthHeaders();
                    const response = await fetch(`${API_BASE}/generar-rutina`, {
                        method: 'POST',
                        headers: {
                            ...headers,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('❌ Error del servidor:', errorData);
                        
                        // Mejorar el mensaje de error
                        let errorMessage = 'Error al generar rutina';
                        if (errorData.detail) {
                            if (Array.isArray(errorData.detail)) {
                                // Si es un array de errores de validación
                                errorMessage = errorData.detail.map(err => {
                                    const field = err.loc ? err.loc.join('.') : 'campo';
                                    return `${field}: ${err.msg}`;
                                }).join(', ');
                            } else {
                                errorMessage = errorData.detail;
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const planData = await response.json();
                    
                    // Cerrar overlay
                    closeOverlay('nuevaRutinaOverlay');
                    
                    // Recargar plan desde servidor para mostrar la nueva rutina
                    await reloadPlanFromServer();
                    
                    // Mostrar notificación de éxito
                    showReloadNotification('¡Nueva rutina generada exitosamente!');
                    
                } catch (error) {
                    console.error('Error generando rutina:', error);
                    alert('Error al generar la rutina: ' + error.message);
                } finally {
                    // Restaurar botón
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            }
            
            // Función principal
            async function initDashboard() {
                // Verificar autenticación al cargar la página
                checkAuthOrRedirect();
                
                // Verificar estado isPremium al cargar
                await checkPremiumStatus();
            
                const chatMessages = document.getElementById('chatMessages');
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');

                function addMessage(content, isUser = false, showUpgradeButton = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                    
                    if (showUpgradeButton) {
                        messageDiv.innerHTML = `
                            <div style="margin-bottom: 12px;">${content}</div>
                            <button onclick="window.location.href='./tarifas.html'" 
                                    style="background: #84cc16; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#65a30d'; this.style.transform='translateY(-1px)'"
                                    onmouseout="this.style.background='#84cc16'; this.style.transform='translateY(0)'">
                                Mejorar a Pro
                            </button>
                        `;
                    } else {
                    messageDiv.textContent = content;
                    }
                    
                    chatMessages.appendChild(messageDiv);
                    
                    // Auto-scroll al final del chat
                    setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }

                // Función para mostrar indicador "IA escribiendo"
                function showTypingIndicator() {
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'typing-indicator';
                    typingDiv.id = 'typingIndicator';
                    typingDiv.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    
                    chatMessages.appendChild(typingDiv);
                    
                    // Auto-scroll al final
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }

                // Función para ocultar indicador "IA escribiendo"
                function hideTypingIndicator() {
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                }

                // Función para mostrar modal de upgrade
                function showUpgradeModal() {
                    const modal = document.getElementById('upgradeModal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                }

                // Función para cerrar modal de upgrade
                function closeUpgradeModal() {
                    const modal = document.getElementById('upgradeModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }

                async function sendMessage() {
                    const message = chatInput.value.trim();
                    if (!message) return;

                    // RATE LIMITING: Prevenir envío excesivo de mensajes
                    const now = Date.now();
                    const lastMessageTime = window.lastMessageTime || 0;
                    const timeSinceLastMessage = now - lastMessageTime;
                    
                    if (timeSinceLastMessage < 2000) { // 2 segundos de debounce
                        console.log('⚠️ Rate limit: Espera 2 segundos entre mensajes');
                        return;
                    }
                    
                    // Verificar si ya hay un mensaje procesándose
                    if (window.isProcessingMessage) {
                        console.log('⚠️ Ya hay un mensaje procesándose, espera...');
                        return;
                    }
                    
                    window.lastMessageTime = now;
                    window.isProcessingMessage = true;

                    // Verificar autenticación antes de enviar
                    if (!checkAuthOrRedirect()) {
                        window.location.href = './login.html';
                        window.isProcessingMessage = false;
                        return;
                    }

                    // Freemium limit: bloquear solo al intentar enviar el tercer mensaje
                    if (!isPremiumUser() && !canUseChat()) {
                        // Mostrar modal de upgrade en lugar de mensaje en el chat
                        showUpgradeModal();
                        return;
                    }

                    addMessage(message, true);
                    chatInput.value = '';
                    autoResizeTextarea();
                    
                    // Mostrar indicador de escritura
                    showTypingIndicator();
                    
                    // Deshabilitar botón durante el envío
                    sendBtn.disabled = true;
                    sendBtn.classList.remove('active');

                    try {
                        // Preparar payload para logging
                        const userId = getCurrentUserId();
                        const conversationHistory = getConversationHistory();
                        const token = localStorage.getItem('accessToken');
                        
                        const payload = {
                            message: message,
                            user_id: userId,
                            conversation_history: conversationHistory
                        };

                        console.log('=== PAYLOAD ENVIADO ===');
                        console.log('Payload:', JSON.stringify(payload, null, 2));
                        console.log('User ID:', userId);
                        console.log('Message:', message);
                        console.log('Conversation History:', conversationHistory);
                        console.log('Token exists:', !!token);
                        console.log('======================');

                        // Usar nuevo endpoint de function calling
                        const response = await fetch(`${API_BASE}/api/chat/modify`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(payload)
                        });

                        // Logging del error 422
                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('=== ERROR HTTP ===');
                            console.error('Status:', response.status);
                            console.error('Status Text:', response.statusText);
                            console.error('Error detail:', errorData);
                            console.error('================');
                            
                            if (response.status === 422) {
                                addMessage(`Error de validación: ${JSON.stringify(errorData)}`);
                            } else if (response.status === 401) {
                                addMessage('Sesión expirada. Redirigiendo al login...');
                                setTimeout(() => {
                                    localStorage.clear();
                                    window.location.href = './login.html';
                                }, 2000);
                            } else {
                                addMessage(`Error del servidor: ${errorData.detail || 'Error desconocido'}`);
                            }
                            return;
                        }

                        const data = await response.json();
                        
                        // DEBUG: Log de la respuesta completa
                        console.log('🔍 Respuesta completa del chat:', data);
                        console.log('🔍 Campo modified:', data.modified);
                        console.log('🔍 Campo changes:', data.changes);
                        console.log('🔍 Campo function_used:', data.function_used);

                        // Ocultar indicador de escritura
                        hideTypingIndicator();

                        // Añadir respuesta del chat
                        addMessage(data.response);
                        
                        // Si se actualizó el plan, forzar recarga completa
                        if (data.success && data.plan_updated) {
                            console.log('✅ Plan actualizado, recargando página...');
                            
                            // Mostrar el mensaje de respuesta
                            if (data.response) {
                                addMessage(data.response, 'assistant');
                            }
                            
                            // FORZAR RECARGA INMEDIATA
                            setTimeout(() => {
                                console.log('🔄 Ejecutando location.reload()...');
                                location.reload(true);
                            }, 1500);
                            
                            return; // No continuar con el flujo normal
                        }
                        
                        // Si se realizaron modificaciones, mostrar notificación
                        console.log('🔍 Verificando si hay modificaciones...');
                        console.log('🔍 data.modified es:', data.modified, 'tipo:', typeof data.modified);
                        
                        if (data.modified) {
                            console.log('✅ Modificaciones detectadas, mostrando notificación...');
                            showModificationNotification({
                                modified: true,
                                changes: data.changes || [],
                                function_used: data.function_used || 'unknown'
                            });
                            
                            // Añadir badge visual al mensaje
                            addModificationBadge();
                            
                            // ✨ NUEVO: Recargar plan después de modificación
                            console.log('🔄 Plan modificado, recargando dashboard...');
                            setTimeout(async () => {
                                console.log('⏰ Ejecutando reloadPlanFromServer después de 1 segundo...');
                                await reloadPlanFromServer();
                            }, 1000); // Esperar 1 segundo para que la IA termine de guardar
                        } else {
                            console.log('❌ No se detectaron modificaciones');
                        }
                        
                        if (!isPremiumUser()) {
                            incrementChatUsage();
                        }
                    } catch (error) {
                        console.error('Error en chat:', error);
                        hideTypingIndicator();
                        addMessage('Error de conexión. Verifica que el servidor esté funcionando.');
                    } finally {
                        // Resetear rate limiting
                        window.isProcessingMessage = false;
                        updateSendButton();
                    }
                }

                // Función para deshabilitar el input cuando se alcanza el límite
                function disableChatInput() {
                    chatInput.disabled = true;
                    chatInput.placeholder = 'Mejora a Pro para continuar';
                    sendBtn.disabled = true;
                    sendBtn.style.opacity = '0.5';
                    sendBtn.style.cursor = 'not-allowed';
                    autoResizeTextarea();
                }

                // Función para habilitar el input (para usuarios isPremium)
                function enableChatInput() {
                    chatInput.disabled = false;
                    chatInput.placeholder = 'Escribe tu mensaje...';
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '';
                    sendBtn.style.cursor = 'pointer';
                    autoResizeTextarea();
                }

                // Manejar el estado del botón de envío
                function updateSendButton() {
                    // Si el input está deshabilitado, no actualizar el botón
                    if (chatInput.disabled) return;
                    
                    const hasText = chatInput.value.trim().length > 0;
                    if (hasText) {
                        sendBtn.classList.add('active');
                        sendBtn.disabled = false;
                    } else {
                        sendBtn.classList.remove('active');
                        sendBtn.disabled = true;
                    }
                }

                // Función para auto-resize del textarea
                function autoResizeTextarea() {
                    const textarea = chatInput;
                    textarea.style.height = 'auto';
                    const scrollHeight = textarea.scrollHeight;
                    const maxHeight = 180; // max-height en px
                    
                    if (scrollHeight <= maxHeight) {
                        textarea.style.height = scrollHeight + 'px';
                        textarea.classList.remove('chat-input-max');
                    } else {
                        textarea.style.height = maxHeight + 'px';
                        textarea.classList.add('chat-input-max');
                    }
                }
                
                // Event listeners básicos y funcionales
                sendBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('input', () => {
                    updateSendButton();
                    autoResizeTextarea();
                });
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Inicializar estado del botón y altura del textarea
                updateSendButton();
                autoResizeTextarea();

                // No verificar límites al cargar - permitir escribir hasta intentar enviar

                // Cargar planes del usuario al iniciar
                loadUserPlans();

                // Event listeners para los overlays
                const rutinaBtn = document.getElementById('rutinaDieta');
                const consejosBtn = document.getElementById('consejosEstudios');
                
                if (rutinaBtn) {
                    rutinaBtn.addEventListener('click', () => {
                        openOverlay('rutinaDietaOverlay');
                        loadRoutineAndDietContent();
                    });
                }
                if (consejosBtn) {
                    consejosBtn.addEventListener('click', () => {
                        openOverlay('consejosEstudiosOverlay');
                        loadAdviceAndStudiesContent();
                    });
                }

                // Hacer funciones disponibles globalmente
                window.logout = logout;
                window.closeUpgradeModal = closeUpgradeModal;
            }

            // ✨ NUEVA FUNCIÓN: Recargar plan desde servidor después de modificación
            async function reloadPlanFromServer() {
                try {
                    console.log('🔄 Recargando plan desde servidor...');
                    
                    const userId = getCurrentUserId();
                    if (!userId) {
                        console.error('❌ No se pudo obtener user_id para recargar plan');
                        return;
                    }

                    console.log('🔍 User ID obtenido:', userId);
                    console.log('🔍 URL de la petición:', `${API_BASE}/user/current-routine?user_id=${userId}`);

                    // Obtener datos actualizados del servidor
                    const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                        method: 'GET'
                    });

                    console.log('📡 Respuesta del servidor:', response.status, response.statusText);

                    if (!response.ok) {
                        console.error('❌ Error obteniendo plan actualizado:', response.status);
                        return;
                    }

                    const data = await response.json();
                    console.log('📊 Datos recibidos del servidor:', data);
                    console.log('📊 current_routine existe:', !!data.current_routine);
                    console.log('📊 current_diet existe:', !!data.current_diet);

                    if (data.success && data.current_routine) {
                        console.log('✅ Datos válidos recibidos, creando objeto plan...');
                        
                        // Crear objeto plan compatible con displayPlan
                        const plan = {
                            rutina: data.current_routine,
                            dieta: data.current_diet,
                            motivacion: "Rutina actualizada dinámicamente"
                        };

                        console.log('📋 Plan creado:', plan);
                        console.log('📋 Dieta en el plan:', plan.dieta);

                        // Actualizar visualización con datos frescos
                        const isPremium = data.is_premium || false;
                        console.log('🎨 Actualizando visualización con isPremium:', isPremium);
                        
                        displayPlan(plan, isPremium);
                        
                        console.log('✅ Plan recargado exitosamente');
                        
                        // Mostrar notificación de éxito
                        showReloadNotification('Plan actualizado correctamente');
                    } else {
                        console.error('❌ No se pudo obtener plan actualizado');
                        console.error('❌ data.success:', data.success);
                        console.error('❌ data.current_routine:', !!data.current_routine);
                    }
                } catch (error) {
                    console.error('❌ Error recargando plan:', error);
                }
            }

            // ✨ NUEVA FUNCIÓN: Mostrar notificación de recarga
            function showReloadNotification(message) {
                // Crear notificación temporal
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #39ff14;
                    color: #000000;
                    padding: 15px 25px;
                    border-radius: 8px;
                    font-weight: 700;
                    z-index: 10000;
                    animation: slideInNotification 0.3s ease;
                    box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
                    border: 2px solid #000000;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Remover después de 3 segundos
                setTimeout(() => {
                    notification.style.animation = 'slideOutNotification 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Función para cargar planes del usuario - CORREGIDA PARA USAR current_routine
            async function loadUserPlans() {
                try {
                    // Obtener user_id del token
                    const userId = getCurrentUserId();
                    if (!userId) {
                        console.error('No se pudo obtener user_id');
                        return;
                    }

                    console.log(`🔍 Frontend: Solicitando rutina para user_id: ${userId}`);

                    // Usar el endpoint corregido que devuelve current_routine
                    const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                        method: 'GET'
                    });

                    console.log(`📡 Frontend: Respuesta del servidor: ${response.status}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log(`📊 Frontend: Datos recibidos:`, data);
                        
                        console.log('🔍 DEBUG COMPLETO DE MACROS:');
                        console.log('   data.current_diet:', data.current_diet);
                        console.log('   data.current_diet.macros:', data.current_diet?.macros);
                        console.log('   data.current_diet.total_kcal:', data.current_diet?.total_kcal);

                        if (data.current_diet?.macros) {
                            console.log('   🎯 MACROS ENCONTRADOS:');
                            console.log('      proteina:', data.current_diet.macros.proteina);
                            console.log('      carbohidratos:', data.current_diet.macros.carbohidratos);
                            console.log('      grasas:', data.current_diet.macros.grasas);
                        } else {
                            console.error('   ❌ NO HAY MACROS EN current_diet');
                        }
                        
                        console.log(`🔍 Frontend: data.success = ${data.success}`);
                        console.log(`🔍 Frontend: data.current_routine existe = ${!!data.current_routine}`);
                        if (data.current_routine) {
                            console.log(`🔍 Frontend: exercises count = ${data.current_routine.exercises?.length || 0}`);
                        }
                        
                        if (data.success && data.current_routine) {
                            console.log(`✅ Frontend: Rutina encontrada con ${data.current_routine.exercises?.length || 0} ejercicios`);
                            console.log(`💎 Frontend: Usuario premium según servidor: ${data.is_premium}`);
                            
                            // Crear un plan compatible con el formato esperado
                            const plan = {
                                rutina: data.current_routine,
                                dieta: data.current_diet || {},
                                motivacion: "Rutina actualizada dinámicamente"
                            };
                            
                            // Guardar en localStorage para futuras consultas
                            localStorage.setItem("userPlan", JSON.stringify(plan));
                            
                            // Usar el estado premium del servidor en lugar del local
                            const isPremium = data.is_premium;
                            
                            console.log(`🎯 Frontend: Mostrando plan para usuario premium: ${isPremium}`);
                            
                            // Mostrar el plan actualizado
                            console.log('🚀 Llamando displayPlan() con:', { plan, isPremium });
                            displayPlan(plan, isPremium);
                            return;
                        } else {
                            console.log('❌ Frontend: No se encontró rutina en la respuesta');
                            showNoContentMessages();
                        }
                    } else {
                        console.error('Error al cargar rutina actual:', response.status);
                        showNoContentMessages();
                    }
                } catch (error) {
                    console.error('Error al cargar rutina actual:', error);
                    // Si no se pudo cargar, mostrar mensaje
                showNoContentMessages();
                }
            }

            // Función auxiliar para reintentar displayPlan cuando el elemento no existe
            function displayPlanRetry(plan, userPremiumStatus, rutinaContent) {
                console.log('🔄 displayPlanRetry() llamado');
                if (plan.rutina && plan.rutina.exercises) {
                    const exercises = plan.rutina.exercises;

                    let rutinaHTML = '';

                    // Mostrar todos los ejercicios sin restricciones
                    exercises.forEach((exercise) => {
                        const exerciseName = typeof exercise === 'object' ? exercise.name : exercise;
                        const sets = typeof exercise === 'object' ? (exercise.sets || 'N/A') : 'N/A';
                        const reps = typeof exercise === 'object' ? (exercise.reps || 'N/A') : 'N/A';
                        const weight = typeof exercise === 'object' ? (exercise.weight || 'N/A') : 'N/A';
                        const notes = typeof exercise === 'object' ? (exercise.notes || '') : '';
                        
                        // Ejercicio visible
                        rutinaHTML += `<div style="margin-bottom: 15px; padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #84cc16;">`;
                        rutinaHTML += `<strong style="color: #2d5016;">${exerciseName}</strong><br>`;
                        rutinaHTML += `<span style="color: #365314;">Series: ${sets} | Reps: ${reps} | Peso: ${weight}</span>`;
                        if (notes) {
                            rutinaHTML += `<br><em style="color: #84cc16; font-size: 12px;">${notes}</em>`;
                        }
                        rutinaHTML += `</div>`;
                    });

                    console.log('🎨 Insertando HTML en DOM (retry)');
                    console.log('   Container found:', !!rutinaContent);
                    console.log('   HTML length:', rutinaHTML.length);
                    
                    if (rutinaContent) {
                        // 🔥 FORZAR VISIBILIDAD DEL CONTAINER (retry)
                        rutinaContent.style.display = 'block';
                        rutinaContent.style.visibility = 'visible';
                        rutinaContent.style.opacity = '1';
                        rutinaContent.style.zIndex = '10';
                        rutinaContent.style.position = 'relative';
                        
                        // 🔥 OCULTAR MENSAJES DE ERROR (retry)
                        const noContentMessages = rutinaContent.querySelectorAll('p');
                        noContentMessages.forEach(p => {
                            if (p.textContent.includes('No tienes una rutina generada')) {
                                p.style.display = 'none';
                                console.log('🚫 Ocultando mensaje de error encontrado (retry)');
                            }
                        });
                        
                        // 🔥 INSERTAR HTML (retry)
                        rutinaContent.innerHTML = rutinaHTML;
                        console.log('✅ HTML insertado correctamente (retry)');
                        console.log('✅ Container forzado a ser visible (retry)');
                    } else {
                        console.error('❌ rutinaContent es NULL en retry');
                    }
                }
            }

            // Función para mostrar el plan en los overlays - DISEÑO MINIMALISTA
            function displayPlan(plan, userPremiumStatus = null) {
                console.log('🎨 displayPlan() llamado con:', plan);
                console.log('🎨 userPremiumStatus:', userPremiumStatus);
                
                const rutinaContent = document.getElementById('rutinaContent');
                const dietaContent = document.getElementById('dietaContent');
                const isPremium = userPremiumStatus !== null ? userPremiumStatus : isPremiumUser();
                
                // Si el elemento no existe, esperar un poco y reintentar
                if (!rutinaContent) {
                    console.log('⚠️ rutinaContent no encontrado, reintentando en 100ms...');
                    setTimeout(() => {
                        const retryRutinaContent = document.getElementById('rutinaContent');
                        if (retryRutinaContent) {
                            console.log('✅ rutinaContent encontrado en reintento');
                            displayPlanRetry(plan, userPremiumStatus, retryRutinaContent);
                        } else {
                            console.error('❌ rutinaContent sigue sin existir después del reintento');
                        }
                    }, 100);
                    return;
                }
                
                // RUTINA - Manejar ambos formatos (exercises y dias)
                console.log('🔍 Verificando rutina:', plan.rutina);
                console.log('🔍 Tiene exercises?', plan.rutina?.exercises);
                console.log('🔍 Tiene dias?', plan.rutina?.dias);
                console.log('🔍 Exercises count:', plan.rutina?.exercises?.length);
                console.log('🔍 Dias count:', plan.rutina?.dias?.length);
                
                if (plan.rutina) {
                    let rutinaHtml = `
                        <style>
                            #rutinaContent {
                                background: #0f0f0f;
                                border: none;
                                border-radius: 0;
                                padding: 0;
                                color: #ffffff;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                                line-height: 1.6;
                                width: 100%;
                                min-height: auto;
                                height: auto;
                                overflow: visible;
                            }
                            .routine-header {
                                margin-bottom: 48px;
                                padding-bottom: 32px;
                                border-bottom: 2px solid rgba(132, 204, 22, 0.15);
                            }
                            .section-title {
                                font-size: 44px;
                                font-weight: 800;
                                margin-bottom: 10px;
                                color: #ffffff;
                                letter-spacing: -1.8px;
                                background: linear-gradient(135deg, #ffffff 0%, #84cc16 100%);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            .section-subtitle {
                                font-size: 18px;
                                color: #a8b3c1;
                                margin-top: 10px;
                                font-weight: 400;
                                line-height: 1.7;
                                letter-spacing: 0.2px;
                            }
                            .day-card {
                                background: #1e1e1e;
                                border: 1px solid rgba(132, 204, 22, 0.12);
                                border-radius: 16px;
                                padding: 36px 44px;
                                margin-bottom: 36px;
                                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
                                transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                            }
                            .day-card:hover {
                                border-color: rgba(132, 204, 22, 0.25);
                                transform: translateY(-3px);
                                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(132, 204, 22, 0.1);
                            }
                            .day-title {
                                font-size: 15px;
                                font-weight: 700;
                                margin-bottom: 26px;
                                color: #84cc16;
                                padding: 0;
                                background: none;
                                border: none;
                                letter-spacing: 1.2px;
                                text-transform: uppercase;
                                display: flex;
                                align-items: center;
                                gap: 14px;
                                position: relative;
                                padding-bottom: 16px;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            .day-title::before {
                                content: "";
                                width: 5px;
                                height: 28px;
                                background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%);
                                border-radius: 3px;
                                box-shadow: 0 0 8px rgba(132, 204, 22, 0.4);
                            }
                            .day-title::after {
                                content: "";
                                position: absolute;
                                bottom: 0;
                                left: 19px;
                                right: 0;
                                height: 1px;
                                background: linear-gradient(90deg, rgba(132, 204, 22, 0.3) 0%, transparent 100%);
                            }
                            .exercise-item {
                                font-size: 17px;
                                color: #e8edf3;
                                margin-bottom: 12px;
                                line-height: 1.75;
                                padding: 20px 32px;
                                padding-left: 68px;
                                position: relative;
                                background: #252525;
                                border-radius: 14px;
                                border: 1px solid rgba(255, 255, 255, 0.06);
                                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            .exercise-item:hover {
                                background: #2a2a2a;
                                border-color: rgba(132, 204, 22, 0.2);
                                transform: translateX(6px);
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(132, 204, 22, 0.1);
                            }
                            .exercise-item::before {
                                content: "→";
                                position: absolute;
                                left: 32px;
                                color: #84cc16;
                                font-weight: 600;
                                font-size: 18px;
                                opacity: 0.7;
                                transition: all 0.3s ease;
                            }
                            .exercise-item:hover::before {
                                opacity: 1;
                                transform: translateX(2px);
                            }
                            .exercise-name {
                                font-weight: 600;
                                color: #f5f7fa;
                                font-size: 17px;
                                letter-spacing: 0.1px;
                                flex: 1;
                            }
                            .exercise-sets {
                                color: #84cc16;
                                font-weight: 700;
                                font-size: 16px;
                                background: rgba(132, 204, 22, 0.12);
                                padding: 6px 16px;
                                border-radius: 8px;
                                letter-spacing: 0.3px;
                                border: 1px solid rgba(132, 204, 22, 0.2);
                                white-space: nowrap;
                                margin-left: 20px;
                            }
                        </style>
                        <div class="routine-header">
                            <h1 class="section-title">Rutina de Entrenamiento</h1>
                            <p class="section-subtitle">${plan.rutina.titulo || 'Plan personalizado diseñado para maximizar tus resultados'}</p>
                        </div>
                    `;
                    
                    // Formato 1: exercises (formato nuevo del backend)
                    if (plan.rutina.exercises && Array.isArray(plan.rutina.exercises) && plan.rutina.exercises.length > 0) {
                        console.log('✅ Usando formato exercises, total:', plan.rutina.exercises.length);
                        const exercisesByDay = {};
                        plan.rutina.exercises.forEach(exercise => {
                            const day = exercise.day || 'Sin día';
                            if (!exercisesByDay[day]) {
                                exercisesByDay[day] = [];
                            }
                            exercisesByDay[day].push(exercise);
                        });
                        
                        const days = Object.keys(exercisesByDay);
                        console.log('📅 Días encontrados:', days);
                        days.forEach((day) => {
                            rutinaHtml += `<div class="day-card">`;
                            rutinaHtml += `<div class="day-title">${day}</div>`;
                            exercisesByDay[day].forEach(ej => {
                                const name = ej.name || 'Ejercicio';
                                const sets = ej.sets || 3;
                                const reps = ej.reps || '10-12';
                                rutinaHtml += `<div class="exercise-item">`;
                                rutinaHtml += `<span class="exercise-name">${name}</span>`;
                                rutinaHtml += `<span class="exercise-sets">${sets}x${reps}</span>`;
                                rutinaHtml += `</div>`;
                            });
                            rutinaHtml += `</div>`;
                        });
                    }
                    // Formato 2: dias (formato antiguo)
                    else if (plan.rutina.dias && Array.isArray(plan.rutina.dias) && plan.rutina.dias.length > 0) {
                        console.log('✅ Usando formato dias, total:', plan.rutina.dias.length);
                        plan.rutina.dias.forEach(dia => {
                            rutinaHtml += `<div class="day-card">`;
                            rutinaHtml += `<div class="day-title">${dia.dia || dia.nombre || 'Día'}</div>`;
                            (dia.ejercicios || []).forEach(ejercicio => {
                                const nombre = ejercicio.nombre || ejercicio.name || '';
                                const series = ejercicio.series || ejercicio.sets || 3;
                                const reps = ejercicio.repeticiones || ejercicio.reps || '10-12';
                                rutinaHtml += `<div class="exercise-item">`;
                                rutinaHtml += `<span class="exercise-name">${nombre}</span>`;
                                rutinaHtml += `<span class="exercise-sets">${series}x${reps}</span>`;
                                rutinaHtml += `</div>`;
                            });
                            rutinaHtml += `</div>`;
                        });
                    } else {
                        console.warn('⚠️ No se encontraron ejercicios en ningún formato');
                        rutinaHtml += `<p style="color: #999; text-align: center; padding: 40px;">No hay ejercicios disponibles en la rutina</p>`;
                    }
                    
                    // Insertar rutina
                    if (rutinaContent) {
                        rutinaContent.style.display = 'block';
                        rutinaContent.style.visibility = 'visible';
                        rutinaContent.style.opacity = '1';
                        rutinaContent.style.height = 'auto';
                        rutinaContent.style.minHeight = 'auto';
                        rutinaContent.style.overflow = 'visible';
                        rutinaContent.innerHTML = rutinaHtml;
                        console.log('✅ Rutina insertada con diseño profesional, HTML length:', rutinaHtml.length);
                    } else {
                        console.error('❌ rutinaContent no encontrado');
                    }
                } else {
                    console.warn('⚠️ plan.rutina no existe');
                    if (rutinaContent) {
                        rutinaContent.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No hay rutina disponible</p>';
                    }
                }
                
                // DIETA - DISEÑO MINIMALISTA - Manejar ambos formatos (meals y comidas)
                console.log('🍽️ Verificando dieta:', plan.dieta);
                console.log('🍽️ Tiene meals?', plan.dieta?.meals);
                console.log('🍽️ Tiene comidas?', plan.dieta?.comidas);
                
                // Normalizar formato: usar meals si existe, sino comidas
                const meals = plan.dieta?.meals || plan.dieta?.comidas || [];
                
                if (dietaContent && plan.dieta && meals.length > 0) {
                    const totalKcal = (typeof plan.dieta.total_kcal === 'number')
                        ? plan.dieta.total_kcal
                        : (Array.isArray(meals)
                            ? meals.reduce((acc, m) => acc + (Number(m.kcal) || 0), 0)
                            : 0);
                    const proteinas = (plan.dieta?.macros?.proteinas ?? plan.dieta?.macros?.proteina) || 0;
                    const carbos = plan.dieta?.macros?.carbohidratos || 0;
                    const grasas = plan.dieta?.macros?.grasas || 0;
                    
                    let dietaHtml = `
                        <style>
                            #dietaContent {
                                background: #0f0f0f;
                                border: none;
                                border-radius: 0;
                                padding: 0;
                                color: #ffffff;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                                line-height: 1.6;
                                width: 100%;
                                min-height: auto;
                                height: auto;
                                overflow: visible;
                            }
                            .diet-header {
                                margin-bottom: 48px;
                                padding-bottom: 32px;
                                border-bottom: 2px solid rgba(59, 130, 246, 0.15);
                            }
                            .section-title {
                                font-size: 44px;
                                font-weight: 800;
                                margin-bottom: 10px;
                                color: #ffffff;
                                letter-spacing: -1.8px;
                                background: linear-gradient(135deg, #ffffff 0%, #3b82f6 100%);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            .section-subtitle {
                                font-size: 18px;
                                color: #a8b3c1;
                                margin-top: 10px;
                                font-weight: 400;
                                line-height: 1.7;
                                letter-spacing: 0.2px;
                            }
                            .macros-grid {
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 24px;
                                margin-bottom: 48px;
                            }
                            .macro-card {
                                background: #1e1e1e;
                                border: 1px solid rgba(59, 130, 246, 0.12);
                                border-radius: 16px;
                                padding: 32px 28px;
                                text-align: center;
                                transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
                            }
                            .macro-card:hover {
                                border-color: rgba(59, 130, 246, 0.25);
                                transform: translateY(-4px);
                                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(59, 130, 246, 0.15);
                            }
                            .macro-value {
                                font-size: 40px;
                                font-weight: 800;
                                color: #3b82f6;
                                display: block;
                                margin-bottom: 10px;
                                line-height: 1;
                                letter-spacing: -1px;
                            }
                            .macro-label {
                                font-size: 12px;
                                color: #a8b3c1;
                                text-transform: uppercase;
                                letter-spacing: 1.8px;
                                font-weight: 600;
                            }
                            .meal-card {
                                background: #1e1e1e;
                                border: 1px solid rgba(59, 130, 246, 0.12);
                                border-radius: 16px;
                                padding: 36px 44px;
                                margin-bottom: 36px;
                                transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
                            }
                            .meal-card:hover {
                                border-color: rgba(59, 130, 246, 0.25);
                                transform: translateY(-3px);
                                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(59, 130, 246, 0.1);
                            }
                            .meal-header {
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                margin-bottom: 26px;
                                padding-bottom: 18px;
                                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                            }
                            .meal-name {
                                font-size: 22px;
                                font-weight: 700;
                                color: #3b82f6;
                                letter-spacing: 0.2px;
                                display: flex;
                                align-items: center;
                                gap: 14px;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            .meal-name::before {
                                content: "";
                                width: 5px;
                                height: 28px;
                                background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
                                border-radius: 3px;
                                box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
                            }
                            .meal-kcal {
                                font-size: 17px;
                                font-weight: 700;
                                color: #a8b3c1;
                                background: rgba(59, 130, 246, 0.12);
                                padding: 8px 18px;
                                border-radius: 10px;
                                border: 1px solid rgba(59, 130, 246, 0.2);
                                letter-spacing: 0.3px;
                            }
                            .food-item {
                                font-size: 17px;
                                color: #e8edf3;
                                margin-bottom: 12px;
                                line-height: 1.75;
                                padding: 20px 32px;
                                padding-left: 68px;
                                position: relative;
                                background: #252525;
                                border-radius: 14px;
                                border: 1px solid rgba(255, 255, 255, 0.06);
                                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            }
                            .food-item:hover {
                                background: #2a2a2a;
                                border-color: rgba(59, 130, 246, 0.2);
                                transform: translateX(6px);
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(59, 130, 246, 0.1);
                            }
                            .food-item::before {
                                content: "→";
                                position: absolute;
                                left: 32px;
                                color: #3b82f6;
                                font-weight: 600;
                                font-size: 18px;
                                opacity: 0.7;
                                transition: all 0.3s ease;
                            }
                            .food-item:hover::before {
                                opacity: 1;
                                transform: translateX(2px);
                            }
                            .censored-content {
                                filter: blur(8px);
                                background: #1a1a1a;
                                padding: 20px;
                                margin: 20px 0;
                                border-radius: 12px;
                                pointer-events: none;
                                user-select: none;
                                border: 1px solid #2a2a2a;
                            }
                            .upgrade-overlay {
                                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                                padding: 40px;
                                border-radius: 16px;
                                text-align: center;
                                margin: 40px 0;
                                border: 2px solid #3b82f6;
                                box-shadow: 0 0 30px rgba(59, 130, 246, 0.15);
                            }
                            .upgrade-overlay h3 {
                                color: #3b82f6;
                                font-size: 26px;
                                font-weight: 700;
                                margin-bottom: 16px;
                            }
                            .upgrade-overlay p {
                                color: #cccccc;
                                font-size: 16px;
                                margin-bottom: 30px;
                                line-height: 1.6;
                            }
                            .upgrade-button {
                                background: #3b82f6;
                                color: #ffffff;
                                padding: 16px 48px;
                                border: none;
                                border-radius: 10px;
                                font-weight: 700;
                                cursor: pointer;
                                font-size: 16px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                transition: all 0.3s ease;
                            }
                            .upgrade-button:hover {
                                background: #2563eb;
                                transform: translateY(-2px);
                                box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
                            }
                        </style>
                        <div class="diet-header">
                            <h1 class="section-title">Plan Nutricional</h1>
                            <p class="section-subtitle">Alimentación optimizada para tus objetivos</p>
                        </div>
                        <div class="macros-grid">
                            <div class="macro-card">
                                <span class="macro-value">${totalKcal}</span>
                                <span class="macro-label">Calorías</span>
                            </div>
                            <div class="macro-card">
                                <span class="macro-value">${proteinas}</span>
                                <span class="macro-label">Proteínas</span>
                            </div>
                            <div class="macro-card">
                                <span class="macro-value">${carbos}</span>
                                <span class="macro-label">Carbohidratos</span>
                            </div>
                            <div class="macro-card">
                                <span class="macro-value">${grasas}</span>
                                <span class="macro-label">Grasas</span>
                            </div>
                        </div>
                    `;
                    
                    // Mostrar todas las comidas sin restricciones
                    meals.forEach((comida) => {
                        console.log(`🍽️ Comida:`, comida);
                        const nombreComida = comida.nombre || comida.nombre_comida || 'Comida';
                        const kcalComida = comida.kcal || '';
                        dietaHtml += `<div class="meal-card">`;
                        dietaHtml += `<div class="meal-header">`;
                        dietaHtml += `<div class="meal-name">${nombreComida}</div>`;
                        if (kcalComida) {
                            dietaHtml += `<span class="meal-kcal">${kcalComida} kcal</span>`;
                        }
                        dietaHtml += `</div>`;
                        if (comida.alimentos) {
                            // Debug: log del primer alimento para ver estructura
                            if (comida.alimentos.length > 0) {
                                console.log('🍎 Estructura del primer alimento:', comida.alimentos[0]);
                                console.log('🔍 Tipo:', typeof comida.alimentos[0]);
                            }
                            
                            comida.alimentos.forEach(alimento => {
                                const alimentoText = renderAlimento(alimento);
                                dietaHtml += `<div class="food-item">${alimentoText}</div>`;
                            });
                        }
                        dietaHtml += `</div>`;
                    });
                    
                    // Insertar dieta
                    if (dietaContent) {
                        // 🔥 LIMPIAR MENSAJES DE ERROR QUE TAPAN LA DIETA
                        const noContentMessages = dietaContent.querySelectorAll('p');
                        noContentMessages.forEach(p => {
                            if (p.textContent.includes('No tienes') || p.textContent.includes('nutricional')) {
                                p.style.display = 'none';
                                p.remove(); // Eliminarlo completamente
                                console.log('🚫 Eliminando mensaje de error que tapa la dieta');
                            }
                        });
                        
                        // 🔥 FORZAR VISIBILIDAD
                        dietaContent.style.display = 'block';
                        dietaContent.style.visibility = 'visible';
                        dietaContent.style.opacity = '1';
                        dietaContent.style.zIndex = '10';
                        dietaContent.style.position = 'relative';
                        
                        // 🔥 INSERTAR DIETA
                        dietaContent.innerHTML = dietaHtml;
                        console.log('✅ Dieta insertada con diseño minimalista');
                    }
                } else {
                    console.error('❌ No se pudo renderizar dieta:');
                    console.error('  - dietaContent existe:', !!dietaContent);
                    console.error('  - plan.dieta existe:', !!plan.dieta);
                    console.error('  - plan.dieta.meals existe:', !!plan.dieta?.meals);
                    console.error('  - plan.dieta.meals.length:', plan.dieta?.meals?.length);
                    
                    // Forzar mostrar mensaje de error
                    if (dietaContent) {
                        dietaContent.innerHTML = `
                            <h1 class="section-title" style="margin-top: 50px;">Dieta</h1>
                            <p style="color: #ff4444;">Error: No se pudo cargar el plan nutricional</p>
                            <pre style="color: #888; font-size: 12px;">${JSON.stringify(plan.dieta, null, 2)}</pre>
                        `;
                    }
                }

                // Mostrar consejos (aplicar recorte si es free)
                const consejosContent = document.getElementById('consejosContent');
                if (plan.rutina && plan.rutina.consejos) {
                    const consejos = plan.rutina.consejos;
                    const total = consejos.length;
                    const isPremium = isPremiumUser();
                    const visibles = isPremium ? total : Math.max(2, Math.ceil(total * 0.33)); // Mostrar 33% (mínimo 2)

                    let consejosHTML = '<h3>Consejos de Entrenamiento</h3>';
                    
                    // Consejos visibles expandidos
                    const consejosExpandidos = [
                        "SOBRECARGA PROGRESIVA: El principio fundamental del crecimiento muscular. Debes aumentar gradualmente el peso, repeticiones o series cada 1-2 semanas. Si puedes hacer 3 series de 10 repeticiones con 50kg, la próxima semana intenta 3x10 con 52.5kg o 3x12 con 50kg. Esta progresión constante es lo que estimula la adaptación muscular.",
                        "CALENTAMIENTO COMPLETO: Nunca saltes el calentamiento. Dedica 10-15 minutos a activar tu sistema cardiovascular y preparar tus músculos. Comienza con 5 minutos de cardio ligero, luego realiza movimientos dinámicos como círculos de brazos, sentadillas sin peso y estiramientos activos. Esto reduce el riesgo de lesiones y mejora tu rendimiento."
                    ];

                    consejosExpandidos.forEach(consejo => {
                        consejosHTML += `<div style=\"margin-bottom: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #84cc16;\">`;
                        consejosHTML += `<div style=\"font-weight: 600; color: #2d5016; margin-bottom: 8px;\">${consejo.split(':')[0]}:</div>`;
                        consejosHTML += `<div style=\"color: #365314; line-height: 1.5;\">${consejo.split(':').slice(1).join(':').trim()}</div>`;
                        consejosHTML += `</div>`;
                    });

                    // Consejos censurados para usuarios no isPremium
                    if (!isPremium && visibles < total) {
                        const ocultos = total - visibles;
                        const consejosCensurados = [
                            "NUTRICIÓN PRE-ENTRENAMIENTO: Consume carbohidratos complejos 2-3 horas antes del entrenamiento para tener energía sostenida. Avena, arroz integral o patata son excelentes opciones. Evita comidas pesadas que puedan causar molestias digestivas durante el ejercicio.",
                            "PROTEÍNA POST-ENTRENAMIENTO: La ventana anabólica es real. Consume 20-30g de proteína de alta calidad (suero de leche, pollo, pescado) en los primeros 30-60 minutos post-entreno. Esto maximiza la síntesis de proteína muscular y acelera la recuperación.",
                            "La hidratación adecuada es fundamental para el rendimiento muscular. Bebe al menos 2-3 litros de agua diarios, especialmente antes y después del entrenamiento.",
                            "El descanso entre series debe ser progresivo: 60-90 segundos para hipertrofia, 2-3 minutos para fuerza máxima.",
                            "La técnica correcta siempre prevalece sobre el peso. Es mejor hacer 8 repeticiones perfectas que 12 mal ejecutadas.",
                            "La nutrición post-entrenamiento es crucial. Consume proteínas y carbohidratos en los primeros 30-60 minutos después del ejercicio."
                        ];

                        consejosCensurados.slice(0, Math.min(ocultos, 6)).forEach(consejo => {
                            consejosHTML += `<div style=\"margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; position: relative; overflow: hidden; border-left: 4px solid #cbd5e1;\">`;
                            consejosHTML += `<div style=\"filter: blur(2px); color: #64748b; user-select: none; pointer-events: none; line-height: 1.5;\">`;
                            if (consejo.includes(':')) {
                                consejosHTML += `<div style=\"font-weight: 600; color: #475569; margin-bottom: 8px;\">${consejo.split(':')[0]}:</div>`;
                                consejosHTML += `<div style=\"color: #64748b;\">${consejo.split(':').slice(1).join(':').trim()}</div>`;
                            } else {
                                consejosHTML += `• ${consejo}`;
                            }
                            consejosHTML += `</div>`;
                            consejosHTML += `<div style=\"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(132, 204, 22, 0.95); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(132, 204, 22, 0.3);\">PRO</div>`;
                            consejosHTML += `</div>`;
                        });

                        consejosHTML += `<div style=\"margin-top: 10px; padding: 14px; border: 1px dashed #94a3b8; border-radius: 8px; background: rgba(148,163,184,0.08); color: #cbd5e1;\">`;
                        consejosHTML += `${ocultos} consejo(s) adicionales disponibles en Pro. `;
                        consejosHTML += `<a href=\"./tarifas.html\" style=\"color:#84cc16; font-weight:600; text-decoration: underline;\">Mejora a Pro</a> para desbloquear todos los consejos.`;
                        consejosHTML += `</div>`;
                    }

                    consejosContent.innerHTML = consejosHTML;
                }
            }

            // Función para abrir overlays
            function openOverlay(overlayId) {
                const overlay = document.getElementById(overlayId);
                if (!overlay) {
                    console.error('Overlay no encontrado:', overlayId);
                    return;
                }
                
                // Si es el overlay de consejos y estudios, mostrar como página completa
                if (overlayId === 'consejosEstudiosOverlay') {
                    overlay.style.display = 'block';
                    // Cargar contenido cuando se abre
                    loadAdviceAndStudiesContent();
                } else {
                    overlay.style.display = 'flex';
                }
            }

            // Función para cerrar overlays
            function closeOverlay(overlayId) {
                const overlay = document.getElementById(overlayId);
                if (!overlay) {
                    console.error('Overlay no encontrado:', overlayId);
                    return;
                }
                overlay.style.display = 'none';
            }

            // Función para cargar contenido de rutina y dieta
            function loadRoutineAndDietContent() {
                const storedPlan = localStorage.getItem('userPlan');
                const isPremium = isPremiumUser();
                
                if (storedPlan) {
                    try {
                        const plan = JSON.parse(storedPlan);
                        // Usar displayPlan que maneja correctamente ambos formatos
                        displayPlan(plan, isPremium);
                    } catch (e) {
                        console.error('Error parsing stored plan:', e);
                        // Intentar cargar desde la base de datos
                        loadUserPlans();
                    }
                } else {
                    // Intentar cargar desde la base de datos
                    loadUserPlans();
                }
            }

            // Función para mostrar contenido de rutina
            function displayRoutineContent(plan, isPremium) {
                const contentArea = document.getElementById('rutinaContent');
                
                if (plan.rutina && plan.rutina.dias) {
                    const dias = plan.rutina.dias;

                    let routineHTML = '';
                    
                    // Mostrar todos los días sin restricciones
                    dias.forEach(dia => {
                        routineHTML += `<div class="routine-item">`;
                        routineHTML += `<div class="routine-day">${dia.dia || dia.nombre}</div>`;
                        (dia.ejercicios || []).forEach(ejercicio => {
                            routineHTML += `<div class="exercise">`;
                            routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                            routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                            routineHTML += `</div>`;
                        });
                        routineHTML += `</div>`;
                    });

                    contentArea.innerHTML = routineHTML;
                } else {
                    // COMENTADO: No insertar mensaje de error para evitar conflictos con displayPlan()
                    // contentArea.innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
                    console.log('⚠️ No hay rutina para mostrar en función alternativa');
                }
            }

            // Función para mostrar contenido de dieta
            function displayDietContent(plan, isPremium) {
                const contentArea = document.getElementById('dietaContent');
                
                if (plan.dieta && plan.dieta.comidas) {
                    const comidas = plan.dieta.comidas;
                    const total = comidas.length;
                    const visibles = isPremium ? total : Math.max(2, Math.ceil(total * 0.5)); // 50% para usuarios básicos

                    let dietHTML = '';
                    
                    // Mostrar macros si están disponibles
                    if (plan.dieta.macros) {
                        dietHTML += `<div class="macros-grid">`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.proteinas}g</span><span class="macro-label">Proteínas</span></div>`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.hidratos}g</span><span class="macro-label">Carbohidratos</span></div>`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.grasas}g</span><span class="macro-label">Grasas</span></div>`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.calorias || plan.dieta.kcal_objetivo || ''}</span><span class="macro-label">Calorías</span></div>`;
                        dietHTML += `</div>`;
                    }

                    // Mostrar comidas visibles
                    comidas.slice(0, visibles).forEach(comida => {
                        dietHTML += `<div class="meal-card">`;
                        dietHTML += `<div class="meal-header">`;
                        dietHTML += `<span class="meal-time">${comida.kcal || ''} kcal</span>`;
                        dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                        dietHTML += `</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                dietHTML += `<div class="food-item">`;
                                const alimentoText = renderAlimento(alimento);
                                dietHTML += `<span>${alimentoText}</span>`;
                                dietHTML += `</div>`;
                            });
                        }
                        dietHTML += `</div>`;
                    });

                    // Mostrar comidas censuradas para usuarios no isPremium
                    if (!isPremium && visibles < total) {
                        const ocultos = total - visibles;
                        
                        // Agregar comidas censuradas
                        comidas.slice(visibles, visibles + Math.min(ocultos, 2)).forEach(comida => {
                            dietHTML += `<div class="meal-card isPremium-overlay">`;
                            dietHTML += `<div class="meal-header">`;
                            dietHTML += `<span class="meal-time">${comida.kcal || ''} kcal</span>`;
                            dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                            dietHTML += `</div>`;
                            if (comida.alimentos) {
                                comida.alimentos.forEach(alimento => {
                                    dietHTML += `<div class="food-item">`;
                                    if (typeof alimento === 'string') {
                                        dietHTML += `<span>${alimento}</span>`;
                                    } else {
                                        dietHTML += `<span>${alimento.nombre || alimento}</span>`;
                                        if (alimento.cantidad) {
                                            dietHTML += `<span>${alimento.cantidad}</span>`;
                                        }
                                    }
                                    dietHTML += `</div>`;
                                });
                            }
                            dietHTML += `<div class="isPremium-badge">`;
                            dietHTML += `<h4>Desbloquea contenido completo con Pro</h4>`;
                            dietHTML += `<p>${ocultos} comidas adicionales disponibles</p>`;
                            dietHTML += `<button class="isPremium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                            dietHTML += `</div>`;
                            dietHTML += `</div>`;
                        });
                    }

                    contentArea.innerHTML = dietHTML;
                } else {
                    // COMENTADO: Conflicto con displayPlan() que inserta la dieta genérica
                    // contentArea.innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
                    console.log('⚠️ No hay dieta en localStorage, pero displayPlan() debería insertarla');
                }
            }

            // Función para cargar contenido de consejos y estudios
            function loadAdviceAndStudiesContent() {
                const contentArea = document.getElementById('consejosEstudiosContent');
                if (!contentArea) {
                    console.error('No se encontró el contenedor consejosEstudiosContent');
                    return;
                }
                
                // Estilos por categoría (fondo oscuro, texto brillante, borde)
                const categoryStyles = {
                    'Entrenamiento': {
                        bg: '#1a3a0d',      // Verde muy oscuro (casi negro verdoso)
                        text: '#84cc16',    // Verde lima neón (brand color)
                        border: '#84cc16'   // Borde verde para destacar
                    },
                    'Nutrición': {
                        bg: '#0f1f3d',      // Azul muy oscuro
                        text: '#3b82f6',    // Azul brillante
                        border: '#3b82f6'
                    },
                    'Recuperación': {
                        bg: '#2d1b4e',      // Púrpura oscuro
                        text: '#a78bfa',    // Púrpura claro
                        border: '#a78bfa'
                    },
                    'Suplementación': {
                        bg: '#3d1f0f',      // Naranja oscuro
                        text: '#fb923c',    // Naranja brillante
                        border: '#fb923c'
                    }
                };
                
                // Array de artículos
                const articulos = [
                    {
                        categoria: 'Entrenamiento',
                        titulo: '¿Por qué no crecen tus músculos?',
                        contenido: [
                            'La hipertrofia responde a tres mecanismos: tensión mecánica, daño muscular y estrés metabólico. Las series pesadas de 6-8 repeticiones maximizan la tensión, mientras que las de 12-15 reps generan mayor estrés metabólico. La clave está en integrarlos estratégicamente.',
                            'El volumen es crucial: 10-20 series semanales por grupo muscular. La proximidad al fallo también importa: las últimas 5 repeticiones (RIR 1-3) generan el estímulo real. Acumula 10-20 series/músculo/semana, entrena cada grupo 2-3 veces por semana y termina series a RIR 1-3.'
                        ],
                        referencias: [
                            { titulo: 'The mechanisms of muscle hypertrophy and their application to resistance training', pmid: '20847704' },
                            { titulo: 'Dose-response relationship between weekly resistance training volume and increases in muscle mass', pmid: '28834797' },
                            { titulo: 'A Systematic Review of The Effects of Different Resistance Training Volumes on Muscle Hypertrophy', pmid: '35291645' }
                        ]
                    },
                    {
                        categoria: 'Nutrición',
                        titulo: 'No ingieras proteína justo al acabar de entrenar',
                        contenido: [
                            'Si solo ingieres proteína post-entreno, tu cuerpo activa la gluconeogénesis: convierte los aminoácidos en glucosa para reponer el glucógeno vacío. El problema: esa proteína que debería reparar fibras musculares se desvía para fabricar energía, desaprovechando el recurso más valioso para la hipertrofia.',
                            'La estrategia óptima es combinar carbohidratos + proteína. Los carbohidratos reponen rápidamente el glucógeno, mientras que la proteína se destina completamente a la síntesis proteica. Combina 20-40g de proteína + 40-80g de carbohidratos en tu comida post-entreno (batido con plátano, arroz con pollo, patatas con atún).'
                        ],
                        referencias: [
                            { titulo: 'Carbohydrate and protein co-ingestion augments skeletal muscle glycogen synthesis', pmid: '33507402' },
                            { titulo: 'Impact of Muscle Glycogen Availability on the Capacity for Repeated Exercise in Man', pmid: '29519691' },
                            { titulo: 'Biochemistry, Gluconeogenesis', pmid: '31082163' }
                        ]
                    },
                    {
                        categoria: 'Nutrición',
                        titulo: 'Proteína: Cantidad, Distribución y el Mito de los 30g',
                        contenido: [
                            'Para hipertrofia necesitas 1.6-2.2g/kg/día según Morton (2018). De 0.8 a 1.5g/kg ves mejoras significativas, de 1.5 a 2.0g/kg las mejoras son pequeñas pero presentes, y más allá de 2.2g/kg no hay beneficios adicionales. En déficit calórico aumenta a 2.0-2.4g/kg para preservar músculo. La distribución es menos importante: estudios con ayuno intermitente 16/8 muestran ganancias equivalentes a 4-5 comidas. Lo determinante es la proteína total diaria, no el número de comidas.',
                            'El mito de "solo absorbes 30g por comida" es falso. Estudios de 2024 demuestran que el cuerpo absorbe y utiliza 100g+ en una comida. La leucina es clave: necesitas 2-3g por comida (equivalente a 20-30g de proteína de calidad) para activar mTOR y maximizar la síntesis muscular. Estrategia: alcanza 1.6-2.2g/kg diariamente, distribuye en 3-5 comidas o practica ayuno si prefieres, y asegura 20-30g por comida para activar leucina.'
                        ],
                        referencias: [
                            { titulo: 'A systematic review, meta-analysis and meta-regression of the effect of protein supplementation on resistance training-induced gains in muscle mass and strength', pmid: '28698222' },
                            { titulo: 'Evidence-based recommendations for natural bodybuilding contest preparation: nutrition and supplementation', pmid: '24864135' },
                            { titulo: 'How much protein can the body use in a single meal for muscle-building?', pmid: '29497353' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: '¿Cuánto debo entrenar?',
                        contenido: [
                            'El volumen óptimo es 12-20 series efectivas semanales por grupo muscular según Baz-Valle (2022). Menos de 12 deja ganancias sobre la mesa, más de 20 no produce beneficio adicional. Una serie solo es efectiva si alcanzas RIR 5 o menos (dejar máximo 5 reps en el tanque). El punto dulce es RIR 1-3: suficiente intensidad para maximizar síntesis proteica sin la fatiga desproporcionada del fallo absoluto.',
                            'Tu capacidad de tolerar volumen depende de tu estado calórico. En superávit puedes operar en el rango alto (16-20 series), en déficit reduce al rango bajo (10-14 series). Principiantes: 6-12 series/semana. Intermedios/Avanzados: 12-20 series/semana. Entrena cada músculo 2 veces/semana distribuyendo 6-10 series por sesión. Una vez alcances tu rango óptimo, progresa aumentando carga y esfuerzo, no añadiendo más series indefinidamente.'
                        ],
                        referencias: [
                            { titulo: 'Dose-response relationship between weekly resistance training volume and increases in muscle mass', pmid: '27433992' },
                            { titulo: 'A Systematic Review of The Effects of Different Resistance Training Volumes on Muscle Hypertrophy', pmid: '35291645' },
                            { titulo: 'Training volume increases or maintenance: effects on muscular adaptations', pmid: '38970765' },
                            { titulo: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength in Trained Men', pmid: '30153194' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Frecuencia de Entrenamiento: ¿Cuántas Veces por Semana Entrenar Cada Músculo?',
                        contenido: [
                            'La frecuencia no es el driver, es la herramienta. El volumen semanal total (12-20 series efectivas) es lo que impulsa la hipertrofia. Entrenar cada músculo 2 veces por semana produce significativamente más hipertrofia que 1 vez según Schoenfeld (2016, 2019). Existe un límite práctico de 10-12 series efectivas por grupo muscular por sesión. A partir de ese punto, la fatiga degrada la calidad de las series subsecuentes.',
                            'La estrategia ganadora: divide tu volumen semanal objetivo (12-20 series) en 2 sesiones de 6-10 series cada una. Fullbody 3 días/semana es ideal para principiantes. Upper/Lower 4 días o PPL 6 días (frecuencia 2x) es ideal para intermedios/avanzados. El bro-split (1 músculo/día) es subóptimo. Nunca pases de 10-12 series efectivas por grupo muscular en una sola sesión.'
                        ],
                        referencias: [
                            { titulo: 'Effects of Resistance Training Frequency on Measures of Muscle Hypertrophy: A Systematic Review and Meta-Analysis', pmid: '27102172' },
                            { titulo: 'How many times per week should a muscle be trained to maximize muscle hypertrophy?', pmid: '30558493' },
                            { titulo: 'Dose-response relationship between weekly resistance training volume and increases in muscle mass', pmid: '27433992' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Rango de Repeticiones: El Mito Más Grande del Fitness Desacreditado',
                        contenido: [
                            'El continuum tradicional (1-5 reps fuerza, 6-12 hipertrofia, 15+ resistencia) es un mito. El meta-análisis de Schoenfeld (2021) demuestra que todos los rangos de 3-30 reps producen hipertrofia IDÉNTICA cuando el volumen total y la proximidad al fallo se equiparan. Lo que realmente importa es el RIR (Repeticiones en Reserva): series a RIR 0-1 producen 100% de síntesis proteica máxima, RIR 2-3 producen 95-98%.',
                            'El rango 6-12 reps no produce más músculo pero tiene ventajas prácticas: mejor balance de los 3 mecanismos de hipertrofia, más eficiente en tiempo, técnica se mantiene bien. Si prefieres cargas pesadas: 3-8 reps funciona perfectamente con más series. Si prefieres pump: 15-25 reps es igualmente efectivo con menos series. La clave: lleva las series a RIR 1-3 en cualquier rango.'
                        ],
                        referencias: [
                            { titulo: 'A Re-Examination of the Repetition Continuum', pmid: 'No disponible - Journal ACSM-MSSE 2021' },
                            { titulo: 'Muscular adaptations in response to three different resistance-training regimens', pmid: '12436270' },
                            { titulo: 'Neither load nor systemic hormones determine resistance training-mediated hypertrophy', pmid: '27928218' },
                            { titulo: 'Effects of Low- vs. High-Load Resistance Training on Muscle Strength and Hypertrophy', pmid: '25530577' }
                        ]
                    },
                    {
                        categoria: 'Nutrición',
                        titulo: 'Déficit Calórico Óptimo: Perder Grasa Sin Perder Músculo',
                        contenido: [
                            'Cuando creas déficit solo reduciendo calorías, pierdes aproximadamente 24-28% del peso total en forma de músculo. Si pierdes 10kg solo con dieta, 2.5-3kg serán músculo. En contraste, cuando combinas déficit moderado por dieta más ejercicio, solo pierdes ~13% en músculo. La fórmula ganadora: déficit pequeño por dieta (10-15% bajo TDEE) más gasto calórico por ejercicio.',
                            'La velocidad óptima es 0.5-0.7% del peso corporal por semana. El estudio de Garthe (2011) comparó déficit lento vs rápido: el grupo lento ganó +2.1% de masa muscular mientras perdía grasa. Calcula tu TDEE, aplica déficit del 10-15% por dieta, añade 2-3 sesiones semanales de cardio moderado. CRÍTICO: mantén o aumenta el volumen de entrenamiento de fuerza y aumenta proteína a 2.0-2.4g/kg.'
                        ],
                        referencias: [
                            { titulo: 'Exercise-training enhances fat-free mass preservation during diet-induced weight loss', pmid: '8130813' },
                            { titulo: 'Effects of Weight Loss on Lean Mass, Strength, Bone, and Aerobic Capacity', pmid: '27580151' },
                            { titulo: 'Effect of two different weight-loss rates on body composition and strength in elite athletes', pmid: '21558571' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'RIR y Fallo Muscular: La Verdad Que Necesitas Saber',
                        contenido: [
                            'Los meta-análisis de Grgic (2022), Vieira (2021) y Refalo (2023) son contundentes: cuando el volumen total se iguala, NO hay diferencias en hipertrofia entre entrenar al fallo (RIR 0) o cerca del fallo (RIR 1-3). El fallo no es superior pero genera fatiga sistémica desproporcionada: tu rendimiento en series siguientes cae, tu volumen total disminuye, y tu recuperación se alarga.',
                            'En ejercicios compuestos pesados (sentadilla, press banca, peso muerto), EVITA el fallo. Trabaja a RIR 2-3. En ejercicios de aislamiento (curls, extensiones, elevaciones laterales), es seguro ir al fallo o muy cerca (RIR 0-1). Estrategia óptima: última serie al fallo. Haz las series 1-3 a RIR 1-2, y solo la serie final llévala al fallo técnico. Principiantes: NUNCA entrenen al fallo, trabajen a RIR 3 a 5.'
                        ],
                        referencias: [
                            { titulo: 'Effects of resistance training performed to repetition failure or non-failure on muscular strength and hypertrophy', pmid: 'No disponible - Sci-Space 2022' },
                            { titulo: 'Effects of Resistance Training Performed to Failure or Not to Failure on Muscle Strength, Hypertrophy, and Power Output', pmid: '33555822' },
                            { titulo: 'Influence of Resistance Training Proximity-to-Failure on Skeletal Muscle Hypertrophy', pmid: 'No disponible - Sports Medicine 2023' },
                            { titulo: 'Exploring the Dose-Response Relationship Between Estimated Resistance Training Proximity to Failure', pmid: '38970765' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Selección de Ejercicios: La Combinación Ganadora para Hipertrofia',
                        contenido: [
                            'Ambos son necesarios: compuestos (multiarticulares) y aislamientos (monoarticulares). Los compuestos son la base: eficientes en tiempo, permiten cargas máximas. Los aislamientos son el complemento: atacan músculos rezagados, añaden volumen con mínima fatiga sistémica. Gentil (2018) demostró que añadir aislamientos a un programa de solo compuestos produjo ganancias adicionales significativas. SIEMPRE haz los compuestos al principio cuando tu energía está fresca.',
                            'Para hipertrofia pura, pesos libres y máquinas son igual de efectivos. Pero en máquinas toda tu energía se dirige 100% al músculo objetivo porque la estabilización está resuelta. Por eso máquinas son superiores para: aislar sin que auxiliares fallen, entrenar al fallo seguro, acumular volumen cuando fatigado. Usa rango de movimiento completo siempre que sea posible. Schoenfeld (2020) confirmó que ROM completo es superior para hipertrofia.'
                        ],
                        referencias: [
                            { titulo: 'Does the addition of single joint exercises to a resistance training program improve changes in performance and anthropometric measures in untrained men?', pmid: '30584485' },
                            { titulo: 'Effect of free-weight vs. machine-based strength training on maximal strength, hypertrophy and jump performance – a systematic review and meta-analysis', pmid: '37592269' },
                            { titulo: 'Effects of range of motion on muscle development during resistance training interventions: A systematic review', pmid: '32030125' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Sobrecarga Progresiva: El Factor Más Importante Para Crecer',
                        contenido: [
                            'Sin progresión no hay crecimiento. Si haces exactamente lo mismo semana tras semana, tu cuerpo NO tiene razón para cambiar. McLeod (2024) confirma: la falta de progresión es el motivo más común de estancamiento. El método de doble progresión: define un rango (ej: 8-12 reps), progresa PRIMERO en repeticiones manteniendo el peso fijo. Cuando llegues al límite ALTO en TODAS las series, sube el peso y vuelve al límite BAJO.',
                            'Chaves (2024) comparó progresar en peso vs repeticiones—ambos grupos ganaron músculo idéntico. Ventajas: progresión más gradual, mejor técnica, menos lesiones, tracking claro. Principiantes pueden progresar casi cada sesión. Intermedios: progresión semanal o quincenal. Avanzados: progresión muy lenta, a veces solo por mesociclo completo. Si te estancas 3-4 semanas: deload (reduce series 30-50%), cambia variable, aumenta descanso, mejora técnica.'
                        ],
                        referencias: [
                            { titulo: 'Effects of Resistance Training Overload Progression Protocols on Strength and Muscle Mass', pmid: '38286426' },
                            { titulo: 'Progressive overload without progressing load? The effects of progressing load vs. repetitions', pmid: 'PMC9528903' },
                            { titulo: 'The influence of resistance exercise training prescription on muscle mass and strength', pmid: 'No disponible - Science Direct 2024' },
                            { titulo: 'Low-Load vs. High-Load Resistance Training: A Systematic Review and Meta-analysis', pmid: '28834797' }
                        ]
                    },
                    {
                        categoria: 'Recuperación',
                        titulo: 'Sueño y Recuperación: El Pilar Olvidado de la Hipertrofia',
                        contenido: [
                            'El músculo NO crece en el gimnasio. El crecimiento real ocurre durante el sueño. El estudio Brasil (2011): Grupo A durmió 5.5h/noche durante 3 días y perdió 60% de masa muscular. Grupo B durmió 8.5h/noche y ganó 40% en el mismo período. Rango no negociable: 7-9 horas por noche. El 60-90% de testosterona se secreta DURANTE LA NOCHE. Una semana de 5h/noche reduce testosterona 15%. Sin sueño, el cortisol permanece ALTO (+40-50%), activando proteólisis muscular.',
                            'La MAYORÍA de síntesis proteica ocurre mientras duermes, especialmente 12-36h post-entreno. Consumir 20-30g proteína (caseína, yogur griego) 30-60min antes de dormir amplifica MPS nocturna. Descanso entre series: 1-2 minutos maximiza hipertrofia. Frecuencia: 2 veces por semana es el sweet spot. Regla 48 horas: espera mínimo 48h entre entrenamientos intensos del mismo músculo. Señales de sobreentrenamiento: pérdida de fuerza persistente, fatiga que no se resuelve con 8h sueño, frecuencia cardíaca reposo +10 latidos.'
                        ],
                        referencias: [
                            { titulo: 'Sleep quality and muscular strength in college students', pmid: '28490639' },
                            { titulo: 'One night of total sleep deprivation impairs implicit learning', pmid: 'No disponible - BioRxiv 2021' },
                            { titulo: 'Sleep and testosterone: effects of sleep deprivation on hormonal balance', pmid: 'No disponible - PubMed 2022' },
                            { titulo: 'The effects of protein supplementation before sleep on muscle mass and strength', pmid: 'No disponible - PubMed 2024' },
                            { titulo: 'Effects of resistance training frequency on measures of muscle hypertrophy', pmid: '27102172' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Adaptaciones Neurales: Por Qué Progresas Tan Rápido Al Principio',
                        contenido: [
                            'El músculo NO crece las primeras 4-6 semanas de entrenamiento, pero tu fuerza puede duplicarse o triplicarse. Este fenómeno se llama newbie gains y tiene una explicación: adaptaciones neurales. Durante las primeras semanas, tu cerebro aprende a reclutar unidades motoras que antes estaban dormidas, aumenta la frecuencia de disparo neural, mejora la coordinación. Grgic & Schoenfeld (2018) confirman: principiantes mejoran dramáticamente el reclutamiento antes de cualquier hipertrofia medible.',
                            'Semanas 1-4: Adaptaciones neurales DOMINAN completamente. Fuerza sube rápido, músculo no crece. Semanas 6-8+: La hipertrofia estructural se vuelve medible. Principiantes pueden añadir 2.5-5kg semanal. Avanzados: progresión extremadamente lenta, tal vez 5-15% en 12 semanas. Memoria muscular: si entrenaste años, paraste 6 meses y perdiste músculo, recuperarás todo mucho más rápido. Los mionúcleos adicionales permanecen años después de atrofia completa.'
                        ],
                        referencias: [
                            { titulo: 'The Mechanisms of Muscle Hypertrophy and Their Application to Resistance Training', pmid: '20847704' },
                            { titulo: 'Neural adaptations to resistance training: Mechanisms and recommendations', pmid: 'No disponible - Frontiers Physiology 2018' },
                            { titulo: 'Skeletal muscle memory: myonuclear accretion and their potential role in hypertrophy', pmid: 'No disponible - Frontiers 2013' },
                            { titulo: 'Muscle hypertrophy response to resistance training in trained versus untrained', pmid: 'No disponible - Frontiers 2011' }
                        ]
                    },
                    {
                        categoria: 'Nutrición',
                        titulo: 'Síntesis Proteica Muscular: Cómo Se Construye Músculo A Nivel Biológico',
                        contenido: [
                            'El músculo crece cuando la Síntesis de Proteínas Musculares (MPS) supera la Degradación (MPB). Balance Proteico Neto = MPS - MPB. Si MPS > MPB → ganas músculo. La MPS puede aumentar 400-500% tras entrenamiento más proteína. Solo la síntesis MIOFIBRILAR (MyoPS, actina/miosina) correlaciona con hipertrofia funcional y fuerza. El complejo mTORC1 es el nodo central que decide si construyes músculo. Para encenderlo necesitas 2 señales: tensión mecánica (entrenamiento) y leucina suficiente (2-3g por comida, equivalente a 20-30g proteína de calidad).',
                            'NOVATOS experimentan picos MPS masivos y prolongados (>24-48h), pero esa MPS va principalmente a reparar daño muscular. AVANZADOS tienen MPS más corta (12-24h) pero correlaciona CASI PERFECTAMENTE con hipertrofia real. Trommelen et al. (2023) demostraron que 100g proteína de leche (absorción lenta) mantiene MPS elevada por >12 HORAS sin saturación. Con proteína lenta NO HAY LÍMITE SUPERIOR práctico. Timing peri-entreno es crítico para avanzados. Post-entreno: 30-40g whey dentro 1-2h. Pre-sueño: 30-50g caseína para MPS nocturna.'
                        ],
                        referencias: [
                            { titulo: 'The anabolic response to protein ingestion has no upper limit in vivo in humans', pmid: '38118410' },
                            { titulo: 'Resistance training-induced changes in myofibrillar protein synthesis related to hypertrophy after attenuation of muscle damage', pmid: 'No disponible - J Physiology 2016 DOI: 10.1113/JP272472' },
                            { titulo: 'A review of resistance training-induced changes in skeletal muscle protein synthesis', pmid: '25739559' },
                            { titulo: 'Muscle protein synthesis response greater following 40g than 20g whey protein', pmid: 'No disponible - Physiological Reports 2016' },
                            { titulo: 'Ingested protein dose response of muscle and albumin protein synthesis after resistance exercise', pmid: '19056590' },
                            { titulo: 'Evaluating the Leucine Trigger Hypothesis for Post-prandial Regulation of Muscle Protein Synthesis', pmid: 'No disponible - Frontiers Nutrition 2020' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Tipos de Fibras Musculares: Cómo Entrenar Cada Una Para Máxima Hipertrofia',
                        contenido: [
                            'Tu músculo es un mosaico de 3 tipos de fibras. TIPO I (lentas): alta densidad mitocondrial, queman grasa, inagotables. TIPO IIa (rápidas versátiles): LAS MÁS PLÁSTICAS—pueden aumentar mitocondrias o hipertrofiarse masivamente según estímulo. Dominan (60-80% área) en culturistas. TIPO IIx (explosivas puras): velocidad máxima suprema, se agotan en 5-10s. El gen ACTN3 determina tu techo de velocidad: RR tienen mayor % fibras IIx (15-25%), mayor potencia explosiva. XX tienen fibras más eficientes pero menos explosivas.',
                            'TIPO I—Estrés Metabólico Extremo: cargas 40-50% 1RM, tempo ultra-lento 6-10s/rep, sin relajación (tensión continua 60-90s). Alternativa: BFR (Blood Flow Restriction) con 20-30% 1RM. TIPO IIa—Tensión Mecánica Máxima: cargas 70-85% 1RM, 6-12 reps, 3-5 series. TIPO IIx—Minimizar Fatiga más VBT: detener serie cuando velocidad cae >10-20% vs primera rep (RIR 3-5). Cargas 85-95%, 1-5 reps, descansos 3-5min. Para hipertrofia máxima: combina cargas 70-85% para maximizar IIa (80% volumen) más 1-2 ejercicios BFR para crecer Tipo I.'
                        ],
                        referencias: [
                            { titulo: 'ACTN3 Genotype is Associated with Human Elite Athletic Performance', pmid: '12879365' },
                            { titulo: 'Skeletal muscle fiber type switching, myosin isoforms and collagen content in bodybuilders', pmid: '16423842' },
                            { titulo: 'Are the Hypertrophic Adaptations to High and Low-Load Resistance Training Muscle Fiber Type Specific?', pmid: '29773994' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Prevención de Lesiones: Calentamiento, Detección y Entrenamiento Adaptado',
                        contenido: [
                            'Las 3 lesiones más comunes: (1) HOMBRO (tendinitis manguito rotador), (2) ESPALDA BAJA (distensiones lumbares, hernias), (3) RODILLA (condromalacia, esguinces). Saltar calentamiento eleva riesgo lesión un 30%. Calentamiento efectivo: (1) General 5-10min—elevar temperatura. (2) Específico—movilidad más estiramientos DINÁMICOS. HOMBROS: Rotaciones externas/internas banda elástica 15-20 reps/lado, pull-aparts banda 2x15. PIERNAS: Monster walks banda, puentes glúteos 2x15, sentadillas sin peso 2x10-15.',
                            'Señales de alarma: dolor agudo DURANTE entrenamiento = DETENTE INMEDIATAMENTE. Tendinitis hombro: dolor hombro/brazo, pérdida movilidad, dolor nocturno. Condromalacia rodilla: dolor FRONTAL rodilla, dolor subir escaleras. Hernia discal (MUY GRAVE): dolor lumbar IRRADIA PIERNA (ciática), entumecimiento, hormigueo. Si tienes lesión: consulta médico/fisio. Entrena zonas no afectadas, usa ejercicios alternativos, sigue protocolo RICE (Reposo, Hielo, Compresión, Elevación) las primeras 48-72h.'
                        ],
                        referencias: [
                            { titulo: 'The Epidemiology of Injuries Across the Weight-Training Sports: A Systematic Review', pmid: '27329683' },
                            { titulo: 'Does warming up prevent injury in sport? The evidence from randomised controlled trials', pmid: '16790386' },
                            { titulo: 'Cryotherapy for acute ankle sprains: a randomised controlled study of two different icing protocols', pmid: '16864561' }
                        ]
                    }
                ];
                
                // Función para generar HTML de una card (NUEVO DISEÑO OSCURO)
                function generarCard(articulo) {
                    // Mapear categoría a color de badge
                    const badgeColors = {
                        'Entrenamiento': { bg: 'rgba(57, 255, 20, 0.15)', border: 'rgba(57, 255, 20, 0.3)', text: '#39ff14' },
                        'Nutrición': { bg: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.3)', text: '#3b82f6' },
                        'Recuperación': { bg: 'rgba(167, 139, 250, 0.15)', border: 'rgba(167, 139, 250, 0.3)', text: '#a78bfa' },
                        'Suplementación': { bg: 'rgba(251, 146, 60, 0.15)', border: 'rgba(251, 146, 60, 0.3)', text: '#fb923c' }
                    };
                    
                    const badgeStyle = badgeColors[articulo.categoria] || badgeColors['Entrenamiento'];
                    
                    // Filtrar referencias que no están disponibles (eliminar las que tienen "No disponible" en pmid)
                    const referenciasValidas = articulo.referencias.filter(ref => 
                        !ref.pmid.includes('No disponible') && 
                        !ref.pmid.startsWith('PMC') && 
                        /^\d+$/.test(ref.pmid.trim())
                    );
                    
                    return `
                        <div class="article-card">
                            <!-- Badge de Categoría -->
                            <span class="article-badge" style="background: ${badgeStyle.bg}; border-color: ${badgeStyle.border}; color: ${badgeStyle.text};">
                                ${articulo.categoria}
                            </span>
                            
                            <!-- Título del Artículo -->
                            <h3 class="article-title">${articulo.titulo}</h3>
                            
                            <!-- Contenido del Artículo -->
                            <div class="article-content">
                                ${articulo.contenido.map(parrafo => `<p>${parrafo}</p>`).join('')}
                            </div>
                            
                            <!-- Referencias -->
                            ${referenciasValidas.length > 0 ? `
                            <div class="article-references">
                                <h3 class="references-title">Referencias</h3>
                                ${referenciasValidas.map(ref => `
                                    <div class="reference-item">
                                        <span class="reference-icon">•</span>
                                        <div class="reference-content">
                                            <p class="reference-text">${ref.titulo}</p>
                                            <a href="https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}" 
                                               target="_blank" 
                                               rel="noopener noreferrer" 
                                               class="reference-link">
                                                PMID: ${ref.pmid}
                                            </a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Generar HTML de todas las cards
                const cardsHTML = articulos.map(articulo => generarCard(articulo)).join('');
                
                contentArea.innerHTML = cardsHTML;
            }

            // Función para mostrar consejos - Cards Verdes con texto blanco
            function loadAdviceContent(storedPlan, isPremium) {
                const contentArea = document.getElementById('consejosContent');
                
                // Tema: Fundamentos de la Hipertrofia Muscular
                const tema = {
                    title: "¿Por qué no crecen tus músculos?",
                    category: "Entrenamiento",
                    content: [
                        "¿Por qué tus músculos crecen? No es solo 'levantar peso'. La hipertrofia responde a tres mecanismos científicos: tensión mecánica (la carga que levantas), daño muscular (microlesiones que se reparan más grandes) y estrés metabólico (acumulación de lactato que activa señales anabólicas). Entender esto te permite entrenar de forma inteligente, no solo intensa.",
                        "Volumen e Intensidad: Los Factores Decisivos. La ciencia es clara: necesitas 10-20 series semanales por grupo muscular para maximizar hipertrofia. Menos de 10 deja ganancias sobre la mesa, más de 20 puede sobreentrenarte. Y no todas las repeticiones cuentan igual: solo las últimas 5 reps de cada serie (cerca del fallo muscular) generan el estímulo real. Por eso trabajar a RIR 1-3 (dejar 1-3 reps en el tanque) es la estrategia óptima: suficiente intensidad sin fatiga excesiva.",
                        "Aplicación Práctica. Acumula 10-20 series por músculo/semana, entrena cada grupo 2-3 veces/semana, termina series a RIR 1-3, y combina rangos: 6-8 reps para tensión mecánica, 10-15 para volumen, 15-20 para estrés metabólico. Estos son los fundamentos no negociables del crecimiento muscular."
                    ],
                    references: [
                        {
                            title: "The mechanisms of muscle hypertrophy and their application to resistance training",
                            pmid: "20847704"
                        },
                        {
                            title: "Dose-response relationship between weekly resistance training volume and increases in muscle mass",
                            pmid: "28834797"
                        }
                    ]
                };

                let adviceHTML = '';
                
                // Determinar color del tag según categoría
                let tagBgClass = 'bg-lime-700';
                if (tema.category === 'Nutrición') tagBgClass = 'bg-blue-600';
                else if (tema.category === 'Recuperación') tagBgClass = 'bg-purple-600';
                else if (tema.category === 'Suplementación') tagBgClass = 'bg-orange-600';
                
                adviceHTML += `<div class="bg-gradient-to-br from-lime-500 to-lime-600 rounded-2xl p-6 border-2 border-lime-400 hover:scale-[1.02] transition duration-300">`;
                
                // Tag categoría
                adviceHTML += `<span class="${tagBgClass} text-white text-xs font-bold uppercase px-3 py-1 rounded-full inline-block mb-4">`;
                adviceHTML += tema.category;
                adviceHTML += `</span>`;
                
                // Título pregunta
                adviceHTML += `<h3 class="text-2xl font-bold text-white mb-4">`;
                adviceHTML += tema.title;
                adviceHTML += `</h3>`;
                
                // Contenido (todos los párrafos)
                tema.content.forEach((parrafo, index) => {
                    adviceHTML += `<p class="text-white text-sm mb-3 leading-relaxed">`;
                    adviceHTML += parrafo;
                    adviceHTML += `</p>`;
                });
                
                // Referencias
                if (tema.references && tema.references.length > 0) {
                    adviceHTML += `<div class="mt-6 pt-4 border-t-2 border-white/20">`;
                    adviceHTML += `<div class="text-white font-semibold text-sm mb-3">📚 Referencias:</div>`;
                    adviceHTML += `<ul class="space-y-2">`;
                    
                    tema.references.forEach(ref => {
                        const pubmedUrl = `https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}/`;
                        adviceHTML += `<li>`;
                        adviceHTML += `<a href="${pubmedUrl}" target="_blank" rel="noopener noreferrer" class="text-white/90 text-sm hover:text-white hover:underline inline-flex items-center gap-1">`;
                        adviceHTML += `<span>• ${ref.title}</span>`;
                        adviceHTML += `<span class="font-mono text-xs">(PMID: ${ref.pmid})</span>`;
                        adviceHTML += `<span>→</span>`;
                        adviceHTML += `</a>`;
                        adviceHTML += `</li>`;
                    });
                    
                    adviceHTML += `</ul>`;
                    adviceHTML += `</div>`;
                }
                
                adviceHTML += `</div>`;

                contentArea.innerHTML = adviceHTML;
            }
            
            // Función para abrir detalle del artículo (se implementará después)
            function openArticleDetail(articleId) {
                // Por ahora, mostrar el contenido completo en el mismo overlay
                console.log('Abriendo artículo:', articleId);
                // TODO: Implementar vista detallada del artículo
            }

            // Función para mostrar estudios (ya no se usa en el nuevo diseño, pero se mantiene por compatibilidad)
            function loadStudiesContent() {
                // Los estudios ahora se muestran dentro de cada artículo
                // Esta función se puede usar para cargar estudios relacionados si es necesario
            }

            // Función para cargar contenido de términos
            function loadTermsContent() {
                const contentArea = document.getElementById('terminosContent');
                
                const termsHTML = `
                    <h3>1. Aceptación de los términos</h3>
                    <p>YourGains AI es una plataforma de inteligencia artificial que genera planes de entrenamiento y nutrición personalizados. Al usar este servicio aceptas estos términos y confirmas que tienes al menos 18 años o utilizas la plataforma bajo la supervisión de un adulto responsable.</p>
                    
                    <h3>2. Naturaleza del servicio (no es asesoramiento médico)</h3>
                    <p>Los planes de entrenamiento y las recomendaciones nutricionales que ofrece YourGains AI son sugerencias generales basadas en los datos que introduces (peso, altura, experiencia, objetivos, lesiones, etc.).</p>
                    <p>No constituyen asesoramiento médico, ni sustituyen la opinión de un profesional sanitario, nutricionista o entrenador titulado.</p>
                    <p><strong>Antes de comenzar cualquier rutina de ejercicio o dieta, consulta siempre con tu médico, especialmente si tienes patologías previas, lesiones o tomas medicación.</strong></p>
                    
                    <h3>3. Uso permitido de la plataforma</h3>
                    <p>Te comprometes a:</p>
                    <ul>
                        <li>Introducir datos reales y actualizados.</li>
                        <li>No usar la plataforma para actividades ilegales o que puedan dañar a terceros.</li>
                        <li>No intentar acceder al código, base de datos o sistemas internos de forma no autorizada.</li>
                    </ul>
                    <p>Podremos suspender o cerrar tu cuenta si detectamos un uso fraudulento o abusivo.</p>
                    
                    <h3>4. Limitación de responsabilidad</h3>
                    <p>YourGains AI no se hace responsable de:</p>
                    <ul>
                        <li>Lesiones, daños físicos o problemas de salud derivados del uso de los planes generados.</li>
                        <li>Resultados no obtenidos (por ejemplo, no ganar músculo, no perder grasa, etc.).</li>
                        <li>Errores puntuales en el contenido generado por la IA.</li>
                    </ul>
                    <p>El uso de la plataforma es exclusivamente bajo tu responsabilidad.</p>
                    
                    <h3>5. Cuentas, suscripciones y pagos</h3>
                    <p>Al crear una cuenta, eres responsable de mantener la confidencialidad de tu usuario y contraseña.</p>
                    <p>En los planes de pago:</p>
                    <ul>
                        <li>El precio, la moneda y la periodicidad (mensual/anual) se indicarán antes de la contratación.</li>
                        <li>Las renovaciones son automáticas hasta que canceles tu suscripción.</li>
                        <li>Puedes cancelar en cualquier momento; el acceso al plan se mantendrá hasta el final del periodo ya pagado.</li>
                    </ul>
                    
                    <h3>6. Política de Privacidad (resumen)</h3>
                    
                    <h4>Datos que recogemos:</h4>
                    <ul>
                        <li><strong>Datos de registro:</strong> nombre, email, contraseña (encriptada).</li>
                        <li><strong>Datos de entrenamiento:</strong> peso, altura, experiencia, objetivos, tipo de cuerpo, materiales disponibles, lesiones, preferencias alimentarias.</li>
                        <li><strong>Datos técnicos básicos:</strong> dirección IP, dispositivo, uso de la app (para análisis y mejoras).</li>
                    </ul>
                    
                    <h4>Para qué usamos tus datos:</h4>
                    <ul>
                        <li>Para generar tus rutinas y dietas personalizadas.</li>
                        <li>Para mostrar tu historial y progresos.</li>
                        <li>Para mejorar la plataforma (estadísticas de uso, detección de errores).</li>
                        <li>Para enviarte comunicaciones relacionadas con el servicio (confirmaciones, avisos importantes, etc.).</li>
                    </ul>
                    
                    <h4>Base legal (RGPD y normativa aplicable):</h4>
                    <ul>
                        <li>Ejecución del contrato (cuando te damos el servicio que has solicitado).</li>
                        <li>Consentimiento (por ejemplo, envío de comunicaciones comerciales si lo aceptas).</li>
                        <li>Interés legítimo (mejorar la seguridad y el rendimiento del sistema).</li>
                    </ul>
                    
                    <h4>Conservación y protección:</h4>
                    <ul>
                        <li>Conservamos tus datos mientras mantengas tu cuenta activa.</li>
                        <li>Puedes solicitar la eliminación de tu cuenta y de tus datos, salvo los que debamos conservar por obligación legal (por ejemplo, facturación).</li>
                        <li>Aplicamos medidas razonables de seguridad para proteger tu información.</li>
                    </ul>
                    
                    <h4>Tus derechos:</h4>
                    <ul>
                        <li>Acceder, rectificar y suprimir tus datos.</li>
                        <li>Limitar u oponerte al tratamiento en ciertos casos.</li>
                        <li>Portabilidad de los datos.</li>
                    </ul>
                    <p>Para ejercer tus derechos o resolver dudas sobre privacidad, podrás contactar con nosotros en el email de soporte que se muestre en la web.</p>
                    
                    <h3>7. Cambios en los términos</h3>
                    <p>Podremos actualizar estos términos y la política de privacidad para adaptarnos a cambios legales o mejoras del servicio.</p>
                    <p>Cuando haya cambios importantes, te lo notificaremos dentro de la plataforma o por email.</p>
                    
                    <p style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #ffffff; font-weight: 600;">
                        Al seguir usando YourGains AI aceptas estos términos y condiciones de uso.
                    </p>
                `;
                
                contentArea.innerHTML = termsHTML;
            }
            
            // Función para cargar contenido de "Quiénes somos"
            function loadAboutContent() {
                const contentArea = document.getElementById('aboutContent');
                
                const aboutHTML = `
                    <p>YourGains AI surgió de la necesidad de llevar el entrenamiento personalizado al alcance de todo tipo de personas. En un mundo de sobreinformación, vimos el problema de muchísima gente que no sabe por dónde empezar y de otras que quieren acceder a conocimiento de calidad a un precio asequible.</p>
                    
                    <p>Nosotros hemos hecho eso posible haciendo el trabajo por ti: recopilamos y actualizamos la información que necesitas para que sepas qué hacer en todo momento con tu entrenamiento y tu nutrición, sin tener que vivir pegado a foros, vídeos o estudios.</p>
                    
                    <p>Nuestra misión es ayudarte a entrenar de forma inteligente, ahorrándote tiempo y dudas. Combinamos:</p>
                    <ul>
                        <li>Conocimiento de entrenamiento de fuerza, hipertrofia y nutrición.</li>
                        <li>Modelos de inteligencia artificial que analizan tus datos y generan planes personalizados.</li>
                        <li>Una interfaz sencilla para que entiendas qué tienes que hacer cada día en el gimnasio y en la cocina.</li>
                    </ul>
                    
                    <h3>¿Qué hace diferente a YourGains AI?</h3>
                    <ul>
                        <li><strong>Planes adaptados</strong> a tu experiencia, material disponible y puntos débiles (por ejemplo, pecho, espalda, piernas, brazos).</li>
                        <li><strong>Dietas personalizadas</strong> con calorías ajustadas, reparto de macros y sugerencias de alimentos realistas.</li>
                        <li><strong>Capacidad de actualizar</strong> tu plan cuando cambias de peso, gimnasio, objetivos o sufres una lesión.</li>
                        <li><strong>Contenido de "Consejos y estudios"</strong> basado en evidencia, explicado en lenguaje simple.</li>
                    </ul>
                    
                    <p>YourGains AI no pretende sustituir a un entrenador personal humano, sino darte una herramienta potente para organizar tu entrenamiento y tu nutrición de forma coherente, constante y sostenible.</p>
                    
                    <p>Si tienes dudas, sugerencias o quieres colaborar con el proyecto, encontrarás nuestro contacto en la sección de soporte de la web.</p>
                `;
                
                contentArea.innerHTML = aboutHTML;
            }

            // Función para mostrar mensajes de no contenido - COMENTADA PARA EVITAR CONFLICTOS
            function showNoContentMessages() {
                console.log('⚠️ showNoContentMessages() llamada - pero no insertando mensaje de error');
                // COMENTADO: No insertar mensajes de error para evitar conflictos con displayPlan()
                // document.getElementById('rutinaContent').innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
                // document.getElementById('dietaContent').innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
            }

            // Hacer funciones globales
            window.openOverlay = openOverlay;
            window.closeOverlay = closeOverlay;
            window.loadTermsContent = loadTermsContent;
            window.loadAboutContent = loadAboutContent;
            window.checkPremiumStatus = checkPremiumStatus;
            window.showPremiumModal = showPremiumModal;
            window.loadNewRoutineForm = loadNewRoutineForm;
            window.validateTrainingDays = validateTrainingDays;
            
            // Función para generar el HTML de visualización de datos (solo lectura) - DISEÑO PREMIUM
            function generateProfileViewHTML(userData) {
                if (!userData) {
                    return `
                        <div style="text-align: center; padding: 80px 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: rgba(132, 204, 22, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <h3 style="color: #e5e5e5; font-size: 20px; font-weight: 600; margin-bottom: 12px;">No hay datos disponibles</h3>
                            <p style="color: #999; font-size: 15px; line-height: 1.6;">Genera tu primer plan para ver tus datos aquí</p>
                        </div>
                    `;
                }
                
                // Función auxiliar para formatear valores
                const formatValue = (value) => {
                    if (value === null || value === undefined || value === '') return 'No especificado';
                    return value;
                };
                
                // Función auxiliar para formatear opciones
                const formatOption = (value, options) => {
                    if (!value) return 'No especificado';
                    const option = options.find(opt => opt.value === value);
                    return option ? option.label : value;
                };
                
                const objetivoGymOptions = [
                    { value: 'ganar_musculo', label: 'Ganar Músculo' },
                    { value: 'ganar_fuerza', label: 'Ganar Fuerza' },
                    { value: 'perder_grasa', label: 'Perder Grasa' },
                    { value: 'mantener_forma', label: 'Mantener Forma' }
                ];
                
                const objetivoNutricionalOptions = [
                    { value: 'volumen', label: 'Volumen' },
                    { value: 'definicion', label: 'Definición' },
                    { value: 'mantenimiento', label: 'Mantenimiento' },
                    { value: 'recomposicion', label: 'Recomposición' }
                ];
                
                const experienciaOptions = [
                    { value: 'principiante', label: 'Principiante' },
                    { value: 'intermedio', label: 'Intermedio' },
                    { value: 'avanzado', label: 'Avanzado' }
                ];
                
                const nivelActividadOptions = [
                    { value: 'sedentario', label: 'Sedentario' },
                    { value: 'ligero', label: 'Ligero' },
                    { value: 'moderado', label: 'Moderado' },
                    { value: 'activo', label: 'Activo' },
                    { value: 'muy_activo', label: 'Muy Activo' }
                ];
                
                const sexoOptions = [
                    { value: 'hombre', label: 'Hombre' },
                    { value: 'mujer', label: 'Mujer' }
                ];
                
                // Iconos SVG
                // Altura: monigote humano estilizado (más limpio y proporcionado)
                const iconHeight = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <!-- Cabeza -->
                    <circle cx="12" cy="5" r="2.5"></circle>
                    <!-- Columna -->
                    <path d="M12 7.8v6.2"></path>
                    <!-- Brazos (ligeramente en V) -->
                    <path d="M8.2 10.2L12 9.2l3.8 1"></path>
                    <!-- Piernas -->
                    <path d="M10 14.2L8.7 18.5"></path>
                    <path d="M14 14.2L15.3 18.5"></path>
                </svg>`;
                const iconWeight = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4z"></path><path d="M12 8v8M8 12h8"></path></svg>`;
                const iconAge = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
                const iconGender = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="14" r="8"></circle><path d="M22 2l-8 8M16 2h6v6"></path></svg>`;
                const iconTarget = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`;
                const iconActivity = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>`;
                const iconDays = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;
                const iconEquipment = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><path d="M6 14h12v8H6z"></path></svg>`;
                const iconInjury = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
                const iconAllergy = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`;
                const iconDiet = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4z"></path></svg>`;
                
                return `
                    <style>
                        @keyframes fadeInUp {
                            from {
                                opacity: 0;
                                transform: translateY(20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                        .profile-card {
                            animation: fadeInUp 0.4s ease-out;
                            animation-fill-mode: both;
                        }
                        .profile-card:nth-child(1) { animation-delay: 0.05s; }
                        .profile-card:nth-child(2) { animation-delay: 0.1s; }
                        .profile-card:nth-child(3) { animation-delay: 0.15s; }
                        .profile-card:nth-child(4) { animation-delay: 0.2s; }
                        .profile-card:nth-child(5) { animation-delay: 0.25s; }
                    </style>
                    <div style="color: white; max-width: 1400px; margin: 0 auto;">
                        <!-- Datos Físicos -->
                        <div style="margin-bottom: 48px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 28px;">
                                <div style="width: 4px; height: 32px; background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%); border-radius: 2px;"></div>
                                <h3 style="color: #e5e5e5; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin: 0;">Datos Físicos</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconHeight}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Altura</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatValue(userData.altura)} <span style="font-size: 18px; font-weight: 500; color: #84cc16;">cm</span></div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconWeight}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Peso</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatValue(userData.peso)} <span style="font-size: 18px; font-weight: 500; color: #84cc16;">kg</span></div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconAge}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Edad</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatValue(userData.edad)} <span style="font-size: 18px; font-weight: 500; color: #84cc16;">años</span></div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconGender}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Sexo</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatOption(userData.sexo, sexoOptions)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Objetivos y Experiencia -->
                        <div style="margin-bottom: 48px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 28px;">
                                <div style="width: 4px; height: 32px; background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%); border-radius: 2px;"></div>
                                <h3 style="color: #e5e5e5; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin: 0;">Objetivos y Experiencia</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconTarget}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Experiencia</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.experiencia, experienciaOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconTarget}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Objetivo Gym</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.objetivo_gym, objetivoGymOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconTarget}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Objetivo Nutricional</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.objetivo_nutricional, objetivoNutricionalOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconActivity}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Nivel de Actividad</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.nivel_actividad, nivelActividadOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconDays}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Días de Entrenamiento</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatValue(userData.dias_entrenamiento)} <span style="font-size: 16px; font-weight: 500; color: #84cc16;">días/semana</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preferencias y Restricciones -->
                        <div style="margin-bottom: 48px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 28px;">
                                <div style="width: 4px; height: 32px; background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%); border-radius: 2px;"></div>
                                <h3 style="color: #e5e5e5; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin: 0;">Preferencias y Restricciones</h3>
                            </div>
                            <div style="display: grid; gap: 20px;">
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconEquipment}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Materiales Disponibles</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.materiales)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconInjury}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Lesiones</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.lesiones)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconAllergy}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Alergias Alimentarias</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.alergias)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconDiet}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Restricciones Dietéticas</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.restricciones_dieta)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botón para generar nuevo plan -->
                        <div style="text-align: center; margin-top: 56px; padding-top: 40px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                            <button onclick="closeOverlay('verDatosOverlay'); handleNewRoutine();" 
                                style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; border: none; padding: 18px 48px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 16px rgba(132, 204, 22, 0.3); letter-spacing: 0.3px;"
                                onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 24px rgba(132, 204, 22, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(132, 204, 22, 0.3)'">
                                Generar Nuevo Plan
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Función para cargar la vista de datos del perfil
            async function loadProfileView() {
                const contentDiv = document.getElementById('verDatosContent');
                if (!contentDiv) return;
                
                // Mostrar loading
                contentDiv.innerHTML = '<p style="color: white; text-align: center; padding: 40px;">Cargando datos...</p>';
                
                // Cargar datos del usuario
                const userData = await loadCurrentUserData();
                
                // Generar HTML de visualización
                const viewHTML = generateProfileViewHTML(userData);
                contentDiv.innerHTML = viewHTML;
            }
            
            // Exponer funciones globalmente
            window.loadProfileView = loadProfileView;

            // ═══════════════════════════════════════════════════════════
            // DETECCIÓN AUTOMÁTICA DE PAGO PREMIUM
            // ═══════════════════════════════════════════════════════════
            (async function checkPremiumActivation() {
                console.log('🔍 Iniciando detección de pago premium...');
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectStatus = urlParams.get('redirect_status');
                    const paymentIntent = urlParams.get('payment_intent');
                    const sessionId = urlParams.get('session_id');

                    console.log('📋 Parámetros URL:', {
                        redirectStatus,
                        paymentIntent: paymentIntent ? 'presente' : 'ausente',
                        sessionId: sessionId ? 'presente' : 'ausente'
                    });

                    if (redirectStatus !== 'succeeded' || (!paymentIntent && !sessionId)) {
                        console.log('ℹ️ No es un redirect de pago, continuando normal');
                        return;
                    }

                    console.log('💳 Detectado pago exitoso - Activando premium automáticamente...');

                    // 1) Intentar localStorage
                    let userId = localStorage.getItem('user_id');
                    console.log('📦 user_id en localStorage:', userId);

                    // 2) Desde token JWT
                    if (!userId) {
                        console.log('⚠️ user_id no en localStorage, buscando en token...');
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        if (token) {
                            try {
                                const payload = JSON.parse(atob(token.split('.')[1]));
                                userId = payload.user_id || payload.sub;
                                console.log('🔑 user_id obtenido de token JWT:', userId);
                            } catch (e) {
                                console.error('❌ Error parseando token:', e);
                            }
                        }
                    }

                    // 3) /user-status como último recurso
                    if (!userId) {
                        try {
                            console.log('🔄 Intentando obtener user_id desde /user-status...');
                            const statusResp = await fetch('/user-status?user_id=0', { credentials: 'include' });
                            if (statusResp.ok) {
                                const statusData = await statusResp.json();
                                userId = statusData.user_id;
                                console.log('✅ user_id obtenido de /user-status:', userId);
                                if (userId) localStorage.setItem('user_id', userId);
                            }
                        } catch (e) {
                            console.error('❌ Error obteniendo /user-status:', e);
                        }
                    }

                    if (!userId) {
                        console.error('❌ No se pudo obtener user_id de ninguna fuente');
                        alert('Error: No se pudo verificar tu identidad. Por favor, inicia sesión.');
                        window.location.href = '/login.html';
                        return;
                    }

                    console.log('✅ user_id confirmado:', userId);

                    // 4) Activar premium
                    console.log('🔄 Llamando a /stripe/activate-premium...');
                    const resp = await fetch('/stripe/activate-premium', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: parseInt(userId), session_id: sessionId || paymentIntent })
                    });
                    const result = await resp.json();
                    console.log('📊 Resultado activación premium:', result);

                    if (result.success) {
                        if (result.is_premium) {
                            console.log(`✅ Premium activado (${result.activated_by})`);
                            localStorage.setItem('is_premium', 'true');
                            localStorage.setItem('user_id', userId);
                            window.history.replaceState({}, document.title, window.location.pathname);
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            console.log('⚠️ Usuario aún no premium, reintentando...');
                            setTimeout(async () => {
                                const retry = await fetch('/stripe/activate-premium', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ user_id: parseInt(userId), session_id: sessionId || paymentIntent })
                                });
                                const retryResult = await retry.json();
                                if (retryResult.success && retryResult.is_premium) {
                                    localStorage.setItem('is_premium', 'true');
                                    localStorage.setItem('user_id', userId);
                                    window.location.href = '/dashboard.html';
                                }
                            }, 2000);
                        }
                    } else {
                        console.error('❌ Error activando premium:', result.error);
                    }

                } catch (e) {
                    console.error('❌ Error en detección automática de pago:', e);
                }
            })();

            // Inicializar el dashboard cuando se carga la página
            // PRIMERO verificar si hay un pago pendiente de verificar
            (async function() {
                // Verificar pago ANTES de inicializar el dashboard
                const paymentProcessed = await checkPaymentSuccess();
                
                if (paymentProcessed) {
                    // Si se procesó un pago, no continuar con init normal
                    // La página se recargará automáticamente después de mostrar el mensaje de éxito
                    console.log('✅ Pago procesado, esperando recarga...');
                    return;
                }
                
                // Si no hay pago que verificar, continuar normalmente con la inicialización
                // initDashboard() ahora maneja todos los event listeners y checkPremiumStatus()
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initDashboard);
                } else {
                    initDashboard();
                }
            })();

            // FUNCIONES AUXILIARES PARA FUNCTION CALLING
            // =========================================

            /**
             * Obtiene el ID del usuario actual
             */
            function getCurrentUserId() {
                try {
                    // Buscar token con la clave correcta (accessToken, no token)
                    const token = localStorage.getItem('accessToken');
                    if (!token) {
                        console.error('❌ No se encontró accessToken en localStorage');
                        return null;
                    }
                    
                    // Decodificar JWT para obtener user_id
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const userId = payload.user_id || payload.sub;
                    console.log('✅ User ID obtenido:', userId);
                    return userId;
                } catch (error) {
                    console.error('❌ Error obteniendo user ID:', error);
                    return null;
                }
            }

            /**
             * Obtiene el historial de conversación actual
             */
            function getConversationHistory() {
                const messages = document.querySelectorAll('.message');
                const history = [];
                
                messages.forEach(msg => {
                    const isUser = msg.classList.contains('user-message');
                    const content = msg.textContent.trim();
                    
                    if (content) {
                        history.push({
                            role: isUser ? 'user' : 'assistant',
                            content: content
                        });
                    }
                });
                
                return history;
            }

            /**
             * Añade badge visual a mensaje que generó modificaciones
             */
            function addModificationBadge() {
                const lastMessage = document.querySelector('.ai-message:last-child');
                if (lastMessage) {
                    const badge = document.createElement('div');
                    badge.style.cssText = `
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                        margin-top: 8px;
                        animation: pulse 2s infinite;
                    `;
                    badge.innerHTML = '✓ Plan modificado';
                    lastMessage.appendChild(badge);
                }
            }

            // getAuthHeaders ya está importado desde auth.js


            // SISTEMA DE NOTIFICACIONES INLINE
            // =================================
            // Evita el error 404 del archivo externo

            // Configuración de la API
            const NOTIFICATION_API_BASE = 'http://127.0.0.1:8000';

            // Elementos del DOM
            let notificationContainer = null;

            /**
             * Inicializa el sistema de notificaciones
             */
            function initNotificationSystem() {
                // Crear contenedor de notificaciones si no existe
                if (!notificationContainer) {
                    notificationContainer = document.createElement('div');
                    notificationContainer.id = 'notification-container';
                    notificationContainer.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        max-width: 400px;
                    `;
                    document.body.appendChild(notificationContainer);
                }
            }

            /**
             * Muestra notificación de modificación de plan
             * @param {Object} result - Resultado de la modificación
             * @param {boolean} result.modified - Si se realizaron modificaciones
             * @param {Array} result.changes - Lista de cambios realizados
             * @param {string} result.function_used - Función utilizada
             */
            function showModificationNotification(result) {
                if (!result.modified) return;
                
                initNotificationSystem();
                
                // Crear notificación
                const notification = document.createElement('div');
                notification.className = 'modification-notification';
                notification.style.cssText = `
                    background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
                    color: #ffffff;
                    padding: 20px;
                    border-radius: 16px;
                    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), 0 4px 16px rgba(0, 0, 0, 0.3);
                    backdrop-filter: blur(0px);
                    border: 2px solid rgba(255, 255, 255, 0.15);
                    animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                    position: relative;
                    overflow: hidden;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-weight: 500;
                    letter-spacing: 0.025em;
                    text-rendering: optimizeLegibility;
                    -webkit-font-smoothing: antialiased;
                    -moz-osx-font-smoothing: grayscale;
                `;
                
                // Contenido de la notificación
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <div style="
                            width: 24px;
                            height: 24px;
                            background: rgba(255, 255, 255, 0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 12px;
                            font-size: 14px;
                        ">✓</div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">Plan Actualizado</h3>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 18px;
                            cursor: pointer;
                            margin-left: auto;
                            opacity: 0.7;
                            transition: opacity 0.2s;
                        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <p style="margin: 0 0 12px 0; font-size: 15px; color: #e5e5e5; font-weight: 500; line-height: 1.4;">
                            Tu plan ha sido modificado automáticamente:
                        </p>
                        <div id="changes-list-${Date.now()}" style="max-height: 120px; overflow-y: auto;">
                            ${result.changes.map(change => {
                                // Si change es un objeto, convertirlo a string legible
                                const changeText = typeof change === 'object' ? JSON.stringify(change) : String(change);
                                return `
                                <div style="
                                    background: rgba(255, 255, 255, 0.08);
                                    padding: 10px 14px;
                                    margin: 6px 0;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    color: #f0f0f0;
                                    border-left: 3px solid #84cc16;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                                    transition: all 0.2s ease;
                                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'">• ${changeText}</div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="goToRoutineAndDiet()" style="
                            background: rgba(255, 255, 255, 0.12);
                            border: 2px solid rgba(255, 255, 255, 0.25);
                            color: #ffffff;
                            padding: 12px 20px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            flex: 1;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        " onmouseover="this.style.background='#84cc16'; this.style.borderColor='#84cc16'; this.style.color='#000000'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(132, 204, 22, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                            Ver Rutina
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            background: rgba(255, 255, 255, 0.12);
                            border: 2px solid rgba(255, 255, 255, 0.25);
                            color: #ffffff;
                            padding: 12px 20px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            flex: 1;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        " onmouseover="this.style.background='#ef4444'; this.style.borderColor='#ef4444'; this.style.color='#ffffff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                            Descartar
                        </button>
                    </div>
                    
                    <div style="
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        height: 3px;
                        background: rgba(255, 255, 255, 0.3);
                        animation: progressBar 8s linear forwards;
                        border-radius: 0 0 12px 12px;
                    "></div>
                `;
                
                // Añadir al contenedor
                notificationContainer.appendChild(notification);
                
                // Auto-dismiss después de 8 segundos
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 8000);
                
                // Añadir animaciones CSS si no existen
                addNotificationStyles();
            }

            /**
             * Añade estilos CSS para las animaciones
             */
            function addNotificationStyles() {
                if (document.getElementById('notification-styles')) return;
                
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                    
                    @keyframes progressBar {
                        from {
                            width: 100%;
                        }
                        to {
                            width: 0%;
                        }
                    }
                    
                    @keyframes slideInNotification {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutNotification {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                    
                    .modification-notification {
                        transition: all 0.3s ease;
                    }
                    
                    .modification-notification:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 12px 40px rgba(132, 204, 22, 0.4);
                    }
                `;
                document.head.appendChild(style);
            }

            /**
             * Muestra modal con detalles de los cambios
             * @param {string} functionUsed - Función utilizada
             * @param {Array} changes - Lista de cambios
             */
            // Event listener para botones de ver cambios
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-changes-btn')) {
                    const functionUsed = e.target.getAttribute('data-function');
                    const changes = JSON.parse(e.target.getAttribute('data-changes'));
                    showChangesModal(functionUsed, changes);
                }
            });

            // Funciones para recargar secciones de rutina y dieta
            async function reloadRoutineSection() {
                console.log('🔄 Recargando sección de rutina...');
                
                try {
                    // Obtener token JWT
                    const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                    if (!token) {
                        console.error('No hay token para recargar rutina');
                        return;
                    }
                    
                    // Fetch nueva rutina desde backend
                    const response = await fetch('http://127.0.0.1:8000/user/current-routine?user_id=' + userId, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        console.error('Error al obtener rutina:', response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('Nueva rutina obtenida:', data);
                    
                    // Buscar contenedor de rutina en el DOM
                    const routineContainer = document.querySelector('#routine-content') || 
                                            document.querySelector('.routine-section') ||
                                            document.querySelector('[data-section="routine"]') ||
                                            document.querySelector('.routine-container');
                    
                    if (routineContainer) {
                        // Renderizar nueva rutina
                        routineContainer.innerHTML = renderRoutine(data.current_routine);
                        console.log('✅ Rutina actualizada en DOM');
                    } else {
                        console.warn('No se encontró contenedor de rutina');
                        // Si estamos en otra página, marcar para recargar cuando vuelvan
                        sessionStorage.setItem('routineNeedsReload', 'true');
                    }
                    
                } catch (error) {
                    console.error('Error recargando rutina:', error);
                }
            }

            async function reloadDietSection() {
                console.log('🔄 Recargando sección de dieta...');
                
                try {
                    const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                    if (!token) {
                        console.error('No hay token para recargar dieta');
                        return;
                    }
                    
                    const response = await fetch('http://127.0.0.1:8000/api/user/current-diet', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        console.error('Error al obtener dieta:', response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('Nueva dieta obtenida:', data);
                    
                    const dietContainer = document.querySelector('#diet-content') || 
                                        document.querySelector('.diet-section') ||
                                        document.querySelector('[data-section="diet"]') ||
                                        document.querySelector('.diet-container');
                    
                    if (dietContainer) {
                        dietContainer.innerHTML = renderDiet(data.current_diet);
                        console.log('✅ Dieta actualizada en DOM');
                    } else {
                        console.warn('No se encontró contenedor de dieta');
                        sessionStorage.setItem('dietNeedsReload', 'true');
                    }
                    
                } catch (error) {
                    console.error('Error recargando dieta:', error);
                }
            }

            // Helper para obtener cookies
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            // Funciones para renderizar rutina y dieta
            function renderRoutine(routine) {
                if (!routine || !routine.exercises) {
                    return '<div class="no-routine">No hay rutina disponible</div>';
                }
                
                let html = '<div class="routine-display">';
                html += '<h3>Tu Rutina Actualizada</h3>';
                
                // Agrupar ejercicios por día si hay schedule
                if (routine.schedule) {
                    Object.keys(routine.schedule).forEach(day => {
                        html += `<div class="day-section"><h4>${day}</h4>`;
                        routine.schedule[day].forEach(exercise => {
                            html += `<div class="exercise-item">${exercise}</div>`;
                        });
                        html += '</div>';
                    });
                } else {
                    // Mostrar ejercicios sin agrupar
                    routine.exercises.forEach(exercise => {
                        if (typeof exercise === 'object') {
                            html += `<div class="exercise-item">${exercise.name || exercise}</div>`;
                        } else {
                            html += `<div class="exercise-item">${exercise}</div>`;
                        }
                    });
                }
                
                html += '</div>';
                return html;
            }

            function renderDiet(diet) {
                if (!diet || !diet.meals) {
                    return '<div class="no-diet">No hay dieta disponible</div>';
                }
                
                let html = '<div class="diet-display">';
                html += '<h3>Tu Dieta Actualizada</h3>';
                
                diet.meals.forEach(meal => {
                    html += `<div class="meal-section">`;
                    html += `<h4>${meal.name || meal.nombre || 'Comida'}</h4>`;
                    if (meal.alimentos) {
                        meal.alimentos.forEach(food => {
                            const foodText = renderAlimento(food);
                            html += `<div class="food-item">• ${foodText}</div>`;
                        });
                    }
                    html += '</div>';
                });
                
                html += '</div>';
                return html;
            }

            // Función para ir a rutina y dieta
            function goToRoutineAndDiet() {
                console.log('🔄 Ejecutando goToRoutineAndDiet...');
                
                try {
                    // Remover la notificación
                    const notification = document.querySelector('.modification-notification');
                    if (notification) {
                        notification.remove();
                        console.log('✅ Notificación removida');
                    }
                    
                    // Recargar las secciones con datos actualizados
                    if (typeof reloadRoutineSection === 'function') {
                        reloadRoutineSection();
                        console.log('✅ Rutina recargada');
                    }
                    
                    if (typeof reloadDietSection === 'function') {
                        reloadDietSection();
                        console.log('✅ Dieta recargada');
                    }
                    
                    // Intentar navegar a las secciones
                    const routineSection = document.getElementById('routine-section');
                    const dietSection = document.getElementById('diet-section');
                    
                    if (routineSection) {
                        console.log('✅ Navegando a sección de rutina');
                        routineSection.scrollIntoView({ behavior: 'smooth' });
                    } else if (dietSection) {
                        console.log('✅ Navegando a sección de dieta');
                        dietSection.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        console.log('⚠️ No se encontraron secciones, recargando página');
                        window.location.reload();
                    }
                    
                } catch (error) {
                    console.error('❌ Error en goToRoutineAndDiet:', error);
                    // Fallback: recargar la página
                    window.location.reload();
                }
            }

            function showChangesModal(functionUsed, changes) {
                // Crear modal si no existe
                let modal = document.getElementById('changes-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'changes-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 20000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    `;
                    document.body.appendChild(modal);
                }
                
                // Función de mapeo de funciones a nombres legibles
                const functionNames = {
                    'modify_routine_injury': 'Adaptación por Lesión',
                    'modify_routine_focus': 'Enfoque en Área Específica',
                    'adjust_routine_difficulty': 'Ajuste de Dificultad',
                    'adjust_for_menstrual_cycle': 'Adaptación Menstrual',
                    'recalculate_diet_macros': 'Recálculo de Macros',
                    'substitute_disliked_food': 'Sustitución de Alimentos',
                    'generate_meal_alternatives': 'Alternativas de Comidas',
                    'simplify_diet_plan': 'Simplificación de Dieta',
                    'revert_last_modification': 'Reversión de Cambios'
                };
                
                const functionName = functionNames[functionUsed] || functionUsed;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        color: #333;
                        padding: 24px;
                        border-radius: 16px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        transform: scale(0.9);
                        transition: transform 0.3s ease;
                    ">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-right: 16px;
                                color: white;
                                font-size: 18px;
                            ">✓</div>
                            <div>
                                <h2 style="margin: 0; font-size: 20px; color: #333;">${functionName}</h2>
                                <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">
                                    Cambios realizados automáticamente
                                </p>
                            </div>
                            <button onclick="closeChangesModal()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                color: #999;
                                cursor: pointer;
                                margin-left: auto;
                                padding: 4px;
                                transition: color 0.2s;
                            " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">Cambios Realizados:</h3>
                            <div style="
                                background: #f8f9fa;
                                border-radius: 8px;
                                padding: 16px;
                                border-left: 4px solid #84cc16;
                            ">
                                ${changes.map(change => `
                                    <div style="
                                        padding: 8px 0;
                                        border-bottom: 1px solid #e9ecef;
                                        font-size: 14px;
                                        color: #333;
                                    ">• ${change}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeChangesModal()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                                Cerrar
                            </button>
                            <button onclick="revertLastModification(); closeChangesModal();" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                Deshacer Cambios
                            </button>
                        </div>
                    </div>
                `;
                
                // Mostrar modal
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.querySelector('div').style.transform = 'scale(1)';
                }, 10);
            }

            /**
             * Cierra el modal de cambios
             */
            function closeChangesModal() {
                const modal = document.getElementById('changes-modal');
                if (modal) {
                    modal.style.opacity = '0';
                    modal.querySelector('div').style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            }

            /**
             * Revierte la última modificación
             */
            async function revertLastModification() {
                try {
                    console.log('🔄 Revirtiendo última modificación...');
                    
                    // Obtener token JWT
                    const token = localStorage.getItem('accessToken');
                    if (!token) {
                        console.error('No hay token para revertir cambios');
                        return;
                    }
                    
                    const response = await fetch('http://127.0.0.1:8000/api/chat/modify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            message: "deshaz el último cambio",
                            user_id: getCurrentUserId(),
                            conversation_history: []
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success !== false) {
                        console.log('✅ Cambios deshechos correctamente');
                        
                        // Recargar secciones afectadas
                        reloadRoutineSection();
                        reloadDietSection();
                        
                        // Mostrar notificación de éxito
                        alert('Cambios deshechos correctamente');
                    } else {
                        throw new Error(result.message || 'Error deshaciendo cambios');
                    }
                } catch (error) {
                    console.error('Error reverting modification:', error);
                    alert('Error deshaciendo cambios: ' + error.message);
                }
            }

            /**
             * Recarga las secciones afectadas por modificaciones
             */
            async function reloadAffectedSections() {
                try {
                    // Recargar rutina si es necesario
                    await reloadRoutineSection();
                    
                    // Recargar dieta si es necesario
                    await reloadDietSection();
                } catch (error) {
                    console.error('Error reloading sections:', error);
                }
            }


            /**
             * Muestra notificación de loading
             */
            function showLoadingNotification(message) {
                showSimpleNotification(message, 'loading');
            }

            /**
             * Muestra notificación de éxito
             */
            function showSuccessNotification(message) {
                showSimpleNotification(message, 'success');
            }

            /**
             * Muestra notificación de error
             */
            function showErrorNotification(message) {
                showSimpleNotification(message, 'error');
            }

            /**
             * Muestra notificación simple
             */
            function showSimpleNotification(message, type = 'info') {
                initNotificationSystem();
                
                const colors = {
                    loading: '#3b82f6',
                    success: '#10b981',
                    error: '#ef4444',
                    info: '#84cc16'
                };
                
                const icons = {
                    loading: '⟳',
                    success: '✓',
                    error: '✗',
                    info: 'i'
                };
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: ${colors[type]};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    animation: slideInRight 0.3s ease-out;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                
                notification.innerHTML = `
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span style="font-size: 14px;">${message}</span>
                `;
                
                notificationContainer.appendChild(notification);
                
                // Auto-dismiss después de 3 segundos (excepto loading)
                if (type !== 'loading') {
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, 3000);
                }
                
                return notification;
            }

            // Verificar si hay cambios pendientes al cargar la página
            window.addEventListener('load', () => {
                if (sessionStorage.getItem('routineNeedsReload') === 'true') {
                    reloadRoutineSection();
                    sessionStorage.removeItem('routineNeedsReload');
                }
                if (sessionStorage.getItem('dietNeedsReload') === 'true') {
                    reloadDietSection();
                    sessionStorage.removeItem('dietNeedsReload');
                }
            });

            // Inicializar sistema al cargar
            document.addEventListener('DOMContentLoaded', initNotificationSystem);
        </script>
    </body>
    </html>

  <!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>YourGains AI</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              background-color: black;
              height: 100vh;
              color: white;
              font-family: Arial, sans-serif;
              position: relative;
          }
          
          .logo {
              position: absolute;
              top: 45px;
              left: 40px;
              display: flex;
              align-items: center;
              gap: 3px;
          }
          
          .dna-icon {
              width: 40px;
              height: 40px;
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
          }
          
          .dna-icon img, .dna-icon svg {
              width: 100%;
              height: 100%;
              object-fit: contain;
              filter: drop-shadow(0 0 4px rgba(132, 204, 22, 0.45));
          }
          
          .logo-text {
              font-size: 24px;
              font-weight: bold;
          }
          
          .your-gains {
              color: white;
          }
          
          .ai {
              color: #84cc16;
          }
          
          .chat-container {
              position: absolute;
            top: 60%;
            left: 35%;
              transform: translate(-50%, -50%);
            width: 45%;
            max-width: 450px;
            height: 45%;
            border: 2px solid #84cc16;
            border-radius: 16px;
              display: flex;
              flex-direction: column;
              overflow: hidden;
              box-shadow: 0 8px 32px rgba(132, 204, 22, 0.15);
              backdrop-filter: blur(10px);
              background: rgba(255, 255, 255, 0.95);
          }
          
          .chat-header {
              padding: 14px 20px;
              text-align: center;
              background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
              color: white;
              border-radius: 14px 14px 0 0;
          }
          
          .chat-header h2 {
              font-size: 18px;
              margin-bottom: 4px;
              font-weight: 600;
          }
          
          .chat-header p {
              font-size: 12px;
              opacity: 0.9;
              margin: 0;
          }
          
          
          .chat-messages {
              flex: 1;
            padding: 16px;
              overflow-y: auto;
              color: black;
              background: white;
              height: calc(100% - 140px);
              max-height: calc(100% - 140px);
              scrollbar-width: none;
              -ms-overflow-style: none;
          }
          
          .chat-messages::-webkit-scrollbar {
              display: none;
          }
          
          .chat-input-area {
            padding: 14px 18px;
              background: #f8f9fa;
              border-radius: 0 0 14px 14px;
              border-top: 1px solid #e9ecef;
              flex-shrink: 0;
          }
          
          .input-row {
              display: flex;
              gap: 10px;
              align-items: center;
          }
          
          .chat-input {
              flex: 1;
              padding: 12px 16px;
              border: 2px solid #e9ecef;
            border-radius: 18px;
              outline: none;
              color: #333;
              font-size: 13px;
              transition: all 0.3s ease;
              background: white;
          }
          
          .chat-input:focus {
              border-color: #84cc16;
              box-shadow: 0 0 0 3px rgba(132, 204, 22, 0.1);
          }
          
          .chat-input:disabled {
              background: #f5f5f5;
              color: #999;
              cursor: not-allowed;
              border-color: #ddd;
          }
          
          .chat-input:disabled::placeholder {
              color: #bbb;
          }
          
          .send-btn {
              width: 40px;
              height: 40px;
              background: #4a4a4a;
              color: #9ca3af;
              border: none;
              border-radius: 10px;
              cursor: not-allowed;
              font-weight: bold;
              font-size: 20px;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
          }
          
          .send-btn.active {
              background: #84cc16;
              color: #000000;
              cursor: pointer;
          }
          
          .send-btn.active:hover {
              background: #65a30d;
              transform: translateY(-1px);
          }
          
          .send-btn:disabled {
              background: #e9ecef;
              color: #6c757d;
              cursor: not-allowed;
              transform: none;
          }
          
          .message {
            margin: 10px 0;
              padding: 10px 15px;
            border-radius: 15px;
              max-width: 90%;
              word-wrap: break-word;
          }
          
          .user-message {
              background: #84cc16;
              color: white;
              margin-left: auto;
              text-align: right;
          }
          
          .ai-message {
              background: #f0f0f0;
              color: black;
          }
          
          .placeholder {
              text-align: center;
            color: #999;
              padding: 40px 20px;
              font-style: italic;
          }
          
          /* Animaci贸n para indicador "IA escribiendo" */
          @keyframes typing {
              0%, 60%, 100% { 
                  transform: translateY(0); 
                  opacity: 0.4;
              }
              30% { 
                  transform: translateY(-10px); 
                  opacity: 1;
              }
          }
          
          @keyframes pulse {
              0% {
                  transform: scale(1);
                  opacity: 1;
              }
              50% {
                  transform: scale(1.05);
                  opacity: 0.8;
              }
              100% {
                  transform: scale(1);
                  opacity: 1;
              }
          }
          
          .typing-indicator {
              display: flex;
              align-items: center;
              gap: 4px;
              padding: 12px 16px;
              margin: 10px 0;
              background: #f0f0f0;
              border-radius: 15px;
              max-width: 90%;
              color: #84cc16;
              font-size: 18px;
              font-weight: bold;
          }
          
          .typing-dot {
              width: 8px;
              height: 8px;
              border-radius: 50%;
              background: #84cc16;
              animation: typing 1.4s infinite;
          }
          
          .typing-dot:nth-child(2) { 
              animation-delay: 0.2s; 
          }
          
          .typing-dot:nth-child(3) { 
              animation-delay: 0.4s; 
          }
          
          .navigation {
              position: absolute;
            top: 60px;
            right: 100px;
              display: flex;
            gap: 20px;
              align-items: center;
              color: white;
              white-space: nowrap;
          }
          
          .nav-item {
            padding: 8px 16px;
              border-radius: 8px;
              transition: all 0.3s ease;
              cursor: pointer;
          }
          
          .nav-item:hover {
              color: #84cc16;
          }

          .nav-text {
              font-size: 14px;
              font-weight: 500;
          }
          
          .overlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: none;
              align-items: center;
              justify-content: center;
              z-index: 1000;
          }
          
          .overlay-content {
              background: white;
            color: black;
            padding: 30px;
            border-radius: 15px;
            max-width: 80%;
              max-height: 80%;
              overflow-y: auto;
              position: relative;
          }
          
          .close-btn {
              position: absolute;
              top: 15px;
              right: 20px;
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #666;
          }
          
          .close-btn:hover {
              color: #84cc16;
          }
          
          .overlay h2 {
              color: #ffffff;
              margin-bottom: 20px;
              font-size: 24px;
          }
          
          .overlay h3 {
            color: #333;
              margin-top: 20px;
              margin-bottom: 10px;
          }
          
          .isPremium-lock {
            position: relative;
              opacity: 0.5;
              pointer-events: none;
          }
          
          .upgrade-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
              border-radius: 10px;
              margin: 20px 0;
          }
          
          .upgrade-btn {
              background: transparent;
              color: #84cc16;
              border: 1px solid #84cc16;
            padding: 10px 20px;
            border-radius: 5px;
              cursor: pointer;
              font-weight: bold;
              margin-top: 10px;
              transition: all 0.3s ease;
          }
          
          .upgrade-btn:hover {
              background: #84cc16;
              color: white;
              transform: translateY(-1px);
          }
          
          .download-btn {
            background: #3b82f6;
              color: white;
              border: none;
            padding: 8px 16px;
            border-radius: 6px;
              cursor: pointer;
            display: flex;
              align-items: center;
              gap: 8px;
              font-size: 14px;
          }
          
          .download-btn:hover {
              background: #1d4ed8;
          }
          
          .download-btn:disabled {
              background: #9ca3af;
              cursor: not-allowed;
          }
          
          .nav-separator {
              color: #666;
              font-size: 18px;
          }
          
          .logout-btn {
            background: #333333;
              color: white;
              border: 1px solid #666;
            padding: 6px 12px;
            border-radius: 6px;
              cursor: pointer;
              font-size: 12px;
              font-weight: bold;
              transition: all 0.3s ease;
          }
          
          .logout-btn:hover {
              background: #444444;
              border-color: #777;
          }

          /* Controles m贸viles - ocultos en desktop */
          .mobile-controls {
              display: none;
          }

          /* Gym Image Container */
          .gym-image-container {
              position: absolute;
              top: 50%;
              right: 20px;
              transform: translateY(-50%);
              width: 500px;
              height: 450px;
              border-radius: 20px;
              overflow: hidden;
              background: transparent;
              border: none;
          }

          .gym-image {
              width: 100%;
              height: 100%;
              object-fit: contain;
              border-radius: 20px;
              filter: brightness(0.9) contrast(1.6) saturate(1.3);
              transition: all 0.4s ease;
              background: transparent;
          }

          .gym-image:hover {
              transform: scale(1.05);
              filter: brightness(1.1) contrast(1.7) saturate(1.4);
          }

          /* Responsive adjustments */
          @media (max-width: 1600px) {
              .gym-image-container {
                  width: 400px;
                  height: 360px;
                  right: 15px;
              }
          }

          @media (max-width: 1400px) {
              .gym-image-container {
                  width: 350px;
                  height: 320px;
                  right: 10px;
              }
          }

          @media (max-width: 1200px) {
              .gym-image-container {
                  display: none;
              }
          }
          
          .overlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: none;
              justify-content: center;
              align-items: center;
              z-index: 1000;
          }

          .overlay-content {
              background: #1a1a1a;
              border-radius: 12px;
              padding: 2rem;
              max-width: 800px;
              max-height: 80vh;
              overflow-y: auto;
              border: 1px solid #333;
              position: relative;
          }

          .overlay-content.large {
              max-width: 1200px;
              max-height: 85vh;
          }

          .tab-content-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 2rem;
              margin-top: 1.5rem;
          }

          .content-column {
              background: rgba(255, 255, 255, 0.03);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 12px;
              padding: 1.5rem;
          }

          .content-column h3 {
              color: #ffffff;
              margin-bottom: 1rem;
              font-size: 1.2rem;
              font-weight: 600;
              border-bottom: 1px solid rgba(255, 255, 255, 0.2);
              padding-bottom: 0.5rem;
          }

          .close-btn {
              position: absolute;
              top: 1rem;
              right: 1rem;
              background: none;
              border: none;
              color: #fff;
              font-size: 1.5rem;
              cursor: pointer;
              padding: 0.5rem;
              border-radius: 50%;
              transition: background 0.3s ease;
          }

          .close-btn:hover {
              background: rgba(255, 255, 255, 0.1);
          }

          .overlay-content h2 {
              color: #ffffff;
              margin-bottom: 1rem;
              font-size: 1.5rem;
          }

          .overlay-content p {
              color: #ccc;
              line-height: 1.6;
          }

          /* Estilos para contenido de rutina */
          .routine-item {
              background: rgba(132, 204, 22, 0.05);
              border: 1px solid rgba(132, 204, 22, 0.2);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .routine-day {
              color: #84cc16;
              font-weight: 600;
              margin-bottom: 0.5rem;
          }

          .exercise {
              margin: 0.5rem 0;
              padding: 0.5rem;
              background: rgba(255, 255, 255, 0.05);
              border-radius: 6px;
          }

          .exercise-name {
              font-weight: 500;
              margin-bottom: 0.25rem;
          }

          .exercise-details {
              font-size: 0.9rem;
              color: rgba(255, 255, 255, 0.7);
          }

          /* Estilos para contenido de dieta */
          .macros-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 1rem;
              margin-bottom: 1.5rem;
          }

          .macro-card {
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 8px;
              padding: 1rem;
              text-align: center;
          }

          .macro-value {
              font-size: 1.5rem;
              font-weight: 700;
              color: #84cc16;
              display: block;
          }

          .macro-label {
              font-size: 0.8rem;
              color: rgba(255, 255, 255, 0.7);
              text-transform: uppercase;
              letter-spacing: 0.5px;
          }

          .meal-card {
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .meal-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.5rem;
          }

          .meal-time {
              font-size: 0.8rem;
              color: #84cc16;
              background: rgba(132, 204, 22, 0.1);
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
          }

          .meal-name {
              font-weight: 500;
          }

          .food-item {
              display: flex;
              justify-content: space-between;
              padding: 0.25rem 0;
              font-size: 0.9rem;
          }

          /* Estilos para consejos */
          .advice-card {
              background: rgba(132, 204, 22, 0.05);
              border: 1px solid rgba(132, 204, 22, 0.2);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .advice-title {
              color: #84cc16;
              font-weight: 600;
              margin-bottom: 0.5rem;
          }

          .advice-content {
              color: rgba(255, 255, 255, 0.9);
              line-height: 1.6;
          }

          /* Estilos para estudios */
          .study-card {
              background: rgba(59, 130, 246, 0.05);
              border: 1px solid rgba(59, 130, 246, 0.2);
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
          }

          .study-title {
              color: #3b82f6;
              font-weight: 600;
              margin-bottom: 0.5rem;
          }

          .study-content {
              color: rgba(255, 255, 255, 0.9);
              line-height: 1.6;
              margin-bottom: 0.75rem;
          }

          .study-meta {
              border-top: 1px solid rgba(59, 130, 246, 0.2);
              padding-top: 0.75rem;
              font-size: 0.8rem;
          }

          .study-author {
              color: #84cc16;
              font-weight: 600;
              display: block;
              margin-bottom: 0.25rem;
          }

          .study-journal {
              color: rgba(255, 255, 255, 0.6);
              font-style: italic;
          }

          /* Premium overlay */
          .isPremium-overlay {
              position: relative;
              overflow: hidden;
          }

          .isPremium-overlay::after {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.8);
              backdrop-filter: blur(4px);
              border-radius: 8px;
          }

          .isPremium-badge {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
              color: white;
              padding: 1rem 2rem;
              border-radius: 8px;
              font-weight: 600;
              z-index: 2;
              text-align: center;
              box-shadow: 0 8px 32px rgba(132, 204, 22, 0.3);
          }

          .isPremium-badge h4 {
              margin-bottom: 0.5rem;
          }

          .isPremium-badge p {
              font-size: 0.9rem;
              opacity: 0.9;
              margin-bottom: 1rem;
          }

          .isPremium-btn {
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              padding: 0.5rem 1rem;
              border-radius: 6px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
          }

          .isPremium-btn:hover {
              background: rgba(255, 255, 255, 0.3);
              transform: translateY(-1px);
          }

          /* Responsive */
          @media (max-width: 768px) {
              .tab-content-grid {
                  grid-template-columns: 1fr;
                  gap: 1rem;
              }

              .overlay-content.large {
                  max-width: 95%;
                  margin: 1rem;
              }

              .macros-grid {
                  grid-template-columns: 1fr;
              }
          }

          /* ========== RESPONSIVE DESIGN - SOLO MVIL ========== */
          @media (max-width: 768px) {
              /* Layout general - cambiar a una columna */
              body {
                  overflow-x: hidden;
              }

              /* PASO 1: Estructura superior m贸vil */
              /* Logo - centrado en la parte superior */
              .logo {
                  position: absolute;
                  top: 40px;
                  left: 50%;
                  transform: translateX(-50%);
                  gap: 3px;
                  z-index: 3;
                  display: flex;
                  align-items: center;
                  justify-content: center;
              }

              .dna-icon {
                  width: 56px;
                  height: 56px;
                  flex-shrink: 0;
              }

              .logo-text {
                  font-size: 36px;
                  line-height: 1;
                  display: flex;
                  align-items: center;
                  white-space: nowrap;
              }

              .logo-text .your-gains {
                  margin-right: 8px;
              }

              .logo-text .ai {
                  margin-left: 0;
              }

              /* Navegaci贸n - debajo del logo, centrada y compacta */
              .navigation {
                  position: absolute;
                  top: 140px;
                  left: 50%;
                  transform: translateX(-50%);
                  gap: 2px;
                  flex-wrap: nowrap;
                  justify-content: center;
                  width: auto;
                  z-index: 3;
              }

              .nav-item {
                  padding: 16px 24px;
                  font-size: 18px;
                  min-height: 60px; /* Mucho m谩s grande y t谩ctil */
                  display: flex;
                  align-items: center;
                  white-space: nowrap;
                  flex-shrink: 0;
                  font-weight: 600;
                  transition: all 0.3s ease;
              }

              .nav-separator {
                  display: inline;
                  color: rgba(255, 255, 255, 0.6);
                  font-size: 16px;
                  margin: 0 8px;
                  font-weight: 600;
              }

              /* Controles m贸viles - mostrar y posicionar */
              .mobile-controls {
                  display: flex;
                  position: fixed;
                  bottom: 15px;
                  right: 15px;
                  gap: 8px;
                  z-index: 1000;
              }

              .mobile-controls .upgrade-btn,
              .mobile-controls .logout-btn {
                  padding: 8px 12px;
                  font-size: 12px;
                  border-radius: 8px;
                  min-height: 36px;
                  white-space: nowrap;
              }

              /* Estilos espec铆ficos para botones m贸viles */
              .mobile-controls .upgrade-btn {
                  background: transparent;
                  color: #84cc16;
                  border: 1px solid #84cc16;
                  transition: all 0.3s ease;
              }

              .mobile-controls .upgrade-btn:hover {
                  background: #84cc16;
                  color: white;
                  transform: translateY(-1px);
              }

              .mobile-controls .logout-btn {
                  padding: 8px 12px;
                  font-size: 12px;
                  color: rgba(255, 255, 255, 0.8);
                  cursor: pointer;
                  border-radius: 8px;
                  min-height: 36px;
                  white-space: nowrap;
                  display: flex;
                  align-items: center;
                  transition: all 0.3s ease;
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid rgba(255, 255, 255, 0.2);
              }

              .mobile-controls .logout-btn:hover {
                  color: #84cc16;
                  background: rgba(255, 255, 255, 0.2);
                  transform: translateY(-1px);
              }

              .mobile-controls .nav-item {
                  padding: 8px 12px;
                  font-size: 12px;
                  color: rgba(255, 255, 255, 0.8);
                  cursor: pointer;
                  border-radius: 8px;
                  min-height: 36px;
                  white-space: nowrap;
                  display: flex;
                  align-items: center;
                  transition: all 0.3s ease;
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid rgba(255, 255, 255, 0.2);
              }

              .mobile-controls .nav-item:hover {
                  color: #84cc16;
                  background: rgba(255, 255, 255, 0.2);
                  transform: translateY(-1px);
              }

              /* PASO 1: Fondo negro con imagen del entrenador */
              body {
                  background-color: #000000 !important;
                  background-image: url('./images/gym-training-dark.jpg');
                  background-size: 180% auto;
                  background-position: center -200px;
                  background-repeat: no-repeat;
                  z-index: 0;
              }

              /* Ocultar el contenedor de imagen original */
              .gym-image-container {
                  display: none;
              }

              /* Chat Container - dise帽o profesional oscuro */
              .chat-container {
                  position: fixed;
                  top: 62.5%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  width: 85%;
                  max-width: 280px;
                  height: 35vh;
                  max-height: 240px;
                  min-height: 200px;
                  z-index: 2;
                  background: #000000;
                  border-radius: 20px;
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
                  overflow: hidden;
                  display: flex;
                  flex-direction: column;
                  border: none;
              }

              .chat-header {
                  padding: 20px 20px 10px 20px;
                  background: #000000;
                  flex-shrink: 0;
              }

              .chat-header h2 {
                  font-size: 16px;
                  color: #ffffff;
                  margin: 0;
                  font-weight: 600;
                  line-height: 1.3;
                  text-align: center;
              }


              .chat-messages {
                  padding: 10px 20px;
                  font-size: 14px;
                  background: #000000;
                  flex: 1;
                  overflow-y: auto;
                  min-height: 0;
                  line-height: 1.4;
                  height: calc(100% - 120px);
                  max-height: calc(100% - 120px);
                  scrollbar-width: none;
                  -ms-overflow-style: none;
              }
              
              .chat-messages::-webkit-scrollbar {
                  display: none;
              }
              
              .chat-input-area {
                  padding: 10px 20px;
                  background: #000000;
                  flex-shrink: 0;
                  border-top: 1px solid #333;
              }

              .input-placeholder {
                  color: #666;
                  font-style: italic;
                  text-align: center;
                  padding: 40px 20px;
                  font-size: 14px;
                  cursor: pointer;
                  transition: color 0.3s ease;
              }

              .input-placeholder:hover {
                  color: #888;
              }

              .input-row {
                  display: flex;
                  align-items: center;
                  gap: 12px;
              }

              .chat-input {
                  flex: 1;
                  padding: 12px 16px;
                  font-size: 14px;
                  background: transparent;
                  border: none;
                  outline: none;
                  color: #ffffff;
                  font-family: inherit;
                  line-height: 1.4;
                  text-align: left;
              }

              .chat-input::placeholder {
                  color: #666;
                  font-weight: 400;
              }
              
              .chat-input:disabled {
                  background: #222;
                  color: #666;
                  cursor: not-allowed;
                  border-color: #444;
              }
              
              .chat-input:disabled::placeholder {
                  color: #555;
              }

              .send-btn {
                  font-size: 20px;
                  width: 40px;
                  height: 40px;
                  background: #4a4a4a;
                  border: none;
                  border-radius: 10px;
                  color: #9ca3af;
                  cursor: not-allowed;
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-weight: bold;
                  flex-shrink: 0;
              }

              .send-btn.active {
                  background: #84cc16;
                  color: #000000;
                  cursor: pointer;
              }

              .send-btn.active:hover {
                  background: #65a30d;
                  transform: translateY(-1px);
              }

              .send-btn:disabled {
                  background: #e9ecef;
                  color: #6c757d;
                  cursor: not-allowed;
                  transform: none;
              }


              /* Estilos para mensajes */
              .message {
                  margin-bottom: 8px;
                  padding: 10px 12px;
                  border-radius: 12px;
                  font-size: 14px;
                  line-height: 1.4;
                  max-width: 85%;
                  word-wrap: break-word;
              }

              .user-message {
                  background: #84cc16;
                  color: #000000;
                  margin-left: auto;
                  font-weight: 500;
              }

              .ai-message {
                  background: #111111;
                  color: #ffffff;
                  margin-right: auto;
                  border: 1px solid #333;
              }

              /* Indicador de escritura para m贸vil */
              .typing-indicator {
                  background: #111111;
                  color: #84cc16;
                  border: 1px solid #333;
              }


              /* Overlays - ajustar para m贸vil */
              .overlay {
                  padding: 20px;
              }

              .overlay-content {
                  padding: 20px;
                  border-radius: 16px;
                  max-width: 95%;
                  max-height: 90%;
              }

              .close-btn {
                  top: 15px;
                  right: 20px;
                  width: 36px;
                  height: 36px;
                  min-height: 44px; /* T谩ctil */
                  min-width: 44px;
              }

              /* Contenido de overlays - m谩s compacto */
              .tab-content-grid {
                  grid-template-columns: 1fr;
                  gap: 15px;
              }

              .content-column {
                  padding: 15px;
              }

              .routine-item, .meal-card, .advice-card, .study-card {
                  padding: 12px;
                  margin-bottom: 10px;
                  border-radius: 8px;
              }

              .routine-day, .meal-header, .advice-title, .study-title {
                  font-size: 14px;
                  margin-bottom: 8px;
              }

              .exercise-name, .meal-name {
                  font-size: 13px;
              }

              .exercise-details, .food-item {
                  font-size: 12px;
              }

              .macros-grid {
                  grid-template-columns: repeat(2, 1fr);
                  gap: 8px;
                  margin-bottom: 15px;
              }

              .macro-card {
                  padding: 8px;
                  border-radius: 6px;
              }

              .macro-value {
                  font-size: 16px;
              }

              .macro-label {
                  font-size: 11px;
              }

              .isPremium-btn {
                  padding: 10px 16px;
                  border-radius: 8px;
                  font-size: 12px;
                  min-height: 44px; /* T谩ctil */
                  margin-top: 10px;
              }
          }

      </style>
  </head>
  <body>
    <div class="logo">
        <div class="dna-icon">
            <svg viewBox="0 0 800 800" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
            </svg>
        </div>
        <div class="logo-text">
            <span class="your-gains">YourGains</span><span class="ai"> AI</span>
        </div>
    </div>

    <div class="navigation">
        <div class="nav-item" id="rutinaDieta">Rutina y Dieta</div>
        <div class="nav-separator">|</div>
        <div class="nav-item" id="consejosEstudios">Consejos y Estudios</div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h2>隆Hola! Soy tu entrenador personal de IA</h2>
                  </div>
        
        <!-- rea de mensajes scrolleable -->
            <div class="chat-messages" id="chatMessages">
                </div>
        
        <!-- rea de input fija abajo -->
        <div class="chat-input-area">
            <div class="input-row">
              <input type="text" id="chatInput" class="chat-input" maxlength="500" placeholder="Escribe tu mensaje...">
              <button id="sendBtn" class="send-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L4 14h4v8h8v-8h4L12 2z"/>
                </svg>
              </button>
            </div>
        </div>
      </div>

    <!-- Botones de Upgrade y Logout para m贸vil -->
    <div class="mobile-controls">
        <div class="nav-item" id="terminosPrivacidad">T茅rminos y Privacidad</div>
        <button class="upgrade-btn" onclick="window.location.href='./tarifas.html'">Upgrade</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Overlay para Rutina y Dieta -->
    <div class="overlay" id="rutinaDietaOverlay">
          <div class="overlay-content large">
            <button class="close-btn" onclick="closeOverlay('rutinaDietaOverlay')">&times;</button>
            <div class="tab-content-grid">
                <div class="content-column">
            <div id="rutinaContent">
                <p>Cargando rutina...</p>
                    </div>
                </div>
                <div class="content-column">
                    <div id="dietaContent">
                        <p>Cargando dieta...</p>
                    </div>
                </div>
              </div>
          </div>
      </div>

    <!-- Overlay para Consejos y Estudios -->
    <div class="overlay" id="consejosEstudiosOverlay">
        <div class="overlay-content large">
            <button class="close-btn" onclick="closeOverlay('consejosEstudiosOverlay')">&times;</button>
            <h2>Consejos y Estudios</h2>
            <div class="tab-content-grid">
                <div class="content-column">
                    <h3>Consejos T茅cnicos</h3>
            <div id="consejosContent">
                        <p>Cargando consejos...</p>
                    </div>
                </div>
                <div class="content-column">
                    <h3>Evidencia Cient铆fica</h3>
                    <div id="estudiosContent">
                        <p>Cargando estudios...</p>
                    </div>
                </div>
          </div>
          </div>
      </div>

    <!-- Overlay para T茅rminos y Privacidad -->
    <div class="overlay" id="terminosPrivacidadOverlay">
        <div class="overlay-content">
            <button class="close-btn" onclick="closeOverlay('terminosPrivacidadOverlay')">&times;</button>
            <h2>T茅rminos y Privacidad</h2>
            <div id="terminosContent">
                <p>Contenido de t茅rminos y condiciones...</p>
            </div>
          </div>
      </div>

    <!-- Modal de Upgrade -->
    <div class="overlay" id="upgradeModal">
        <div class="overlay-content">
            <button class="close-btn" onclick="closeUpgradeModal()">&times;</button>
            <h2> Mejora a Pro</h2>
            <div style="text-align: center; padding: 20px 0;">
                <p style="font-size: 18px; margin-bottom: 20px; color: #84cc16; font-weight: 600;">
                    Has alcanzado el l铆mite de mensajes gratuitos
                </p>
                <p style="margin-bottom: 30px; color: #ccc; line-height: 1.6;">
                    Para continuar chateando de forma ilimitada y desbloquear todas las funciones isPremium, mejora tu plan ahora.
                </p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="window.location.href='./tarifas.html'" 
                            style="background: #84cc16; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                            onmouseover="this.style.background='#65a30d'; this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.background='#84cc16'; this.style.transform='translateY(0)'">
                        Ver Planes
                    </button>
                    <button onclick="closeUpgradeModal()" 
                            style="background: transparent; color: #ccc; border: 1px solid #555; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                            onmouseover="this.style.borderColor='#84cc16'; this.style.color='#84cc16'"
                            onmouseout="this.style.borderColor='#555'; this.style.color='#ccc'">
                        M谩s Tarde
                    </button>
                </div>
            </div>
          </div>
      </div>

      <!-- Gym Image Container -->
      <div class="gym-image-container">
          <img src="./images/gym-training-dark.jpg" alt="Gimnasio moderno con persona entrenando - Your Gains AI" class="gym-image">
      </div>

      <script type="module">
          import { API_BASE } from "./config.js";
          import { checkAuthOrRedirect, getAuthHeaders, logout, isTokenExpired, decodeJwt } from "./auth.js";

        // Freemium helpers (frontend-only)
        // Variable global para cachear el estado isPremium
        let userPremiumStatus = null;
        
        async function checkPremiumStatus() {
            try {
                const userId = getCurrentUserId();
                if (!userId) return false;
                
                const response = await fetch(`${API_BASE}/user-status?user_id=${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    userPremiumStatus = data.is_premium === true || data.plan_type === 'PREMIUM';
                    return userPremiumStatus;
                }
            } catch (error) {
                console.error('Error verificando isPremium:', error);
            }
            
            // Fallback al m茅todo anterior
            const token = localStorage.getItem('accessToken');
            if (token) {
                const payload = decodeJwt(token) || {};
                if (payload.plan === 'isPremium' || payload.tier === 'isPremium' || payload.isPremium === true) {
                    userPremiumStatus = true;
                    return true;
                }
            }
            const storedPlan = localStorage.getItem('plan');
            userPremiumStatus = storedPlan === 'isPremium';
            return userPremiumStatus;
        }
        
        function isPremiumUser() {
            // Si ya tenemos el estado, devolverlo
            if (userPremiumStatus !== null) {
                return userPremiumStatus;
            }
            
            // Si no, usar fallback
            const token = localStorage.getItem('accessToken');
            if (token) {
                const payload = decodeJwt(token) || {};
                if (payload.plan === 'premium' || payload.tier === 'premium' || payload.premium === true) {
                    return true;
                }
            }
            const storedPlan = localStorage.getItem('plan');
            return storedPlan === 'premium';
        }

        function getChatUsageKey() {
            const email = localStorage.getItem('email') || 'anonymous';
            return `chat_usage_count_${email}`;
        }

        function getChatUsageCount() {
            const raw = localStorage.getItem(getChatUsageKey());
            const n = parseInt(raw || '0', 10);
            return Number.isFinite(n) ? n : 0;
        }

        function incrementChatUsage() {
            const next = getChatUsageCount() + 1;
            localStorage.setItem(getChatUsageKey(), String(next));
            return next;
        }

        function canUseChat() {
            if (isPremiumUser()) return true;
            return getChatUsageCount() < 2; // 2 prompts for free tier
        }
        
        // Funci贸n principal
        function initDashboard() {
            // Verificar autenticaci贸n al cargar la p谩gina
            checkAuthOrRedirect();
          
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            function addMessage(content, isUser = false, showUpgradeButton = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                
                if (showUpgradeButton) {
                    messageDiv.innerHTML = `
                        <div style="margin-bottom: 12px;">${content}</div>
                        <button onclick="window.location.href='./tarifas.html'" 
                                style="background: #84cc16; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#65a30d'; this.style.transform='translateY(-1px)'"
                                onmouseout="this.style.background='#84cc16'; this.style.transform='translateY(0)'">
                            Mejorar a Pro
                        </button>
                    `;
                } else {
                messageDiv.textContent = content;
                }
                
                chatMessages.appendChild(messageDiv);
                
                // Auto-scroll al final del chat
                setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            // Funci贸n para mostrar indicador "IA escribiendo"
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                
                chatMessages.appendChild(typingDiv);
                
                // Auto-scroll al final
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            // Funci贸n para ocultar indicador "IA escribiendo"
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            // Funci贸n para mostrar modal de upgrade
            function showUpgradeModal() {
                const modal = document.getElementById('upgradeModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            // Funci贸n para cerrar modal de upgrade
            function closeUpgradeModal() {
                const modal = document.getElementById('upgradeModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // RATE LIMITING: Prevenir env铆o excesivo de mensajes
                const now = Date.now();
                const lastMessageTime = window.lastMessageTime || 0;
                const timeSinceLastMessage = now - lastMessageTime;
                
                if (timeSinceLastMessage < 2000) { // 2 segundos de debounce
                    console.log('锔 Rate limit: Espera 2 segundos entre mensajes');
                    return;
                }
                
                // Verificar si ya hay un mensaje proces谩ndose
                if (window.isProcessingMessage) {
                    console.log('锔 Ya hay un mensaje proces谩ndose, espera...');
                    return;
                }
                
                window.lastMessageTime = now;
                window.isProcessingMessage = true;

                // Verificar autenticaci贸n antes de enviar
                if (!checkAuthOrRedirect()) {
                    window.location.href = './login.html';
                    window.isProcessingMessage = false;
                    return;
                }

                // Freemium limit: bloquear solo al intentar enviar el tercer mensaje
                if (!isPremiumUser() && !canUseChat()) {
                    // Mostrar modal de upgrade en lugar de mensaje en el chat
                    showUpgradeModal();
                    return;
                }

                addMessage(message, true);
                chatInput.value = '';
                
                // Mostrar indicador de escritura
                showTypingIndicator();
                
                // Deshabilitar bot贸n durante el env铆o
                sendBtn.disabled = true;
                sendBtn.classList.remove('active');

                try {
                    // Preparar payload para logging
                    const userId = getCurrentUserId();
                    const conversationHistory = getConversationHistory();
                    const token = localStorage.getItem('accessToken');
                    
                    const payload = {
                        message: message,
                        user_id: userId,
                        conversation_history: conversationHistory
                    };

                    console.log('=== PAYLOAD ENVIADO ===');
                    console.log('Payload:', JSON.stringify(payload, null, 2));
                    console.log('User ID:', userId);
                    console.log('Message:', message);
                    console.log('Conversation History:', conversationHistory);
                    console.log('Token exists:', !!token);
                    console.log('======================');

                    // Usar nuevo endpoint de function calling
                    const response = await fetch(`${API_BASE}/api/chat/modify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    // Logging del error 422
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('=== ERROR HTTP ===');
                        console.error('Status:', response.status);
                        console.error('Status Text:', response.statusText);
                        console.error('Error detail:', errorData);
                        console.error('================');
                        
                        if (response.status === 422) {
                            addMessage(`Error de validaci贸n: ${JSON.stringify(errorData)}`);
                        } else if (response.status === 401) {
                            addMessage('Sesi贸n expirada. Redirigiendo al login...');
                            setTimeout(() => {
                                localStorage.clear();
                                window.location.href = './login.html';
                            }, 2000);
                        } else {
                            addMessage(`Error del servidor: ${errorData.detail || 'Error desconocido'}`);
                        }
                        return;
                    }

                    const data = await response.json();

                    // Ocultar indicador de escritura
                    hideTypingIndicator();

                    // A帽adir respuesta del chat
                    addMessage(data.response);
                    
                    // Si se realizaron modificaciones, mostrar notificaci贸n
                    if (data.modified) {
                        showModificationNotification({
                            modified: true,
                            changes: data.changes || [],
                            function_used: data.function_used || 'unknown'
                        });
                        
                        // A帽adir badge visual al mensaje
                        addModificationBadge();
                        
                        //  NUEVO: Recargar plan despu茅s de modificaci贸n
                        console.log(' Plan modificado, recargando dashboard...');
                        setTimeout(async () => {
                            await reloadPlanFromServer();
                        }, 1000); // Esperar 1 segundo para que la IA termine de guardar
                    }
                    
                    if (!isPremiumUser()) {
                        incrementChatUsage();
                    }
                } catch (error) {
                    console.error('Error en chat:', error);
                    hideTypingIndicator();
                    addMessage('Error de conexi贸n. Verifica que el servidor est茅 funcionando.');
                } finally {
                    // Resetear rate limiting
                    window.isProcessingMessage = false;
                    updateSendButton();
                }
            }

            // Funci贸n para deshabilitar el input cuando se alcanza el l铆mite
            function disableChatInput() {
                chatInput.disabled = true;
                chatInput.placeholder = 'Mejora a Pro para continuar';
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
                sendBtn.style.cursor = 'not-allowed';
            }

            // Funci贸n para habilitar el input (para usuarios isPremium)
            function enableChatInput() {
                chatInput.disabled = false;
                chatInput.placeholder = 'Escribe tu mensaje...';
                sendBtn.disabled = false;
                sendBtn.style.opacity = '';
                sendBtn.style.cursor = 'pointer';
            }

            // Manejar el estado del bot贸n de env铆o
            function updateSendButton() {
                // Si el input est谩 deshabilitado, no actualizar el bot贸n
                if (chatInput.disabled) return;
                
                const hasText = chatInput.value.trim().length > 0;
                if (hasText) {
                    sendBtn.classList.add('active');
                    sendBtn.disabled = false;
                } else {
                    sendBtn.classList.remove('active');
                    sendBtn.disabled = true;
                }
            }

            // Event listeners b谩sicos y funcionales
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('input', updateSendButton);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Inicializar estado del bot贸n
            updateSendButton();

            // No verificar l铆mites al cargar - permitir escribir hasta intentar enviar

            // Cargar planes del usuario al iniciar
            loadUserPlans();

            // Event listeners para los overlays
            const rutinaBtn = document.getElementById('rutinaDieta');
            const consejosBtn = document.getElementById('consejosEstudios');
            const terminosBtn = document.getElementById('terminosPrivacidad');
            
            if (rutinaBtn) {
                rutinaBtn.addEventListener('click', () => openOverlay('rutinaDietaOverlay'));
            }
            if (consejosBtn) {
                consejosBtn.addEventListener('click', () => openOverlay('consejosEstudiosOverlay'));
            }
            if (terminosBtn) {
                terminosBtn.addEventListener('click', () => openOverlay('terminosPrivacidadOverlay'));
            }

            // Hacer funciones disponibles globalmente
            window.logout = logout;
            window.closeUpgradeModal = closeUpgradeModal;
        }

        //  NUEVA FUNCIN: Recargar plan desde servidor despu茅s de modificaci贸n
        async function reloadPlanFromServer() {
            try {
                console.log(' Recargando plan desde servidor...');
                
                const userId = getCurrentUserId();
                if (!userId) {
                    console.error(' No se pudo obtener user_id para recargar plan');
                    return;
                }

                // Obtener datos actualizados del servidor
                const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    console.error(' Error obteniendo plan actualizado:', response.status);
                    return;
                }

                const data = await response.json();
                console.log(' Datos recibidos del servidor:', data);

                if (data.success && data.current_routine) {
                    // Crear objeto plan compatible con displayPlan
                    const plan = {
                        rutina: data.current_routine,
                        dieta: data.current_diet,
                        motivacion: "Rutina actualizada din谩micamente"
                    };

                    // Actualizar visualizaci贸n con datos frescos
                    const isPremium = data.is_premium || false;
                    console.log(' Actualizando visualizaci贸n con isPremium:', isPremium);
                    
                    displayPlan(plan, isPremium);
                    
                    console.log(' Plan recargado exitosamente');
                    
                    // Mostrar notificaci贸n de 茅xito
                    showReloadNotification('Plan actualizado correctamente');
                } else {
                    console.error(' No se pudo obtener plan actualizado');
                }
            } catch (error) {
                console.error(' Error recargando plan:', error);
            }
        }

        //  NUEVA FUNCIN: Mostrar notificaci贸n de recarga
        function showReloadNotification(message) {
            // Crear notificaci贸n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #39ff14;
                color: #000000;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 700;
                z-index: 10000;
                animation: slideInNotification 0.3s ease;
                box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
                border: 2px solid #000000;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remover despu茅s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOutNotification 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Funci贸n para cargar planes del usuario - CORREGIDA PARA USAR current_routine
        async function loadUserPlans() {
            try {
                // Obtener user_id del token
                const userId = getCurrentUserId();
                if (!userId) {
                    console.error('No se pudo obtener user_id');
                    return;
                }

                console.log(` Frontend: Solicitando rutina para user_id: ${userId}`);

                // Usar el endpoint corregido que devuelve current_routine
                const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                    method: 'GET'
                });

                console.log(` Frontend: Respuesta del servidor: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    console.log(` Frontend: Datos recibidos:`, data);
                    console.log(` Frontend: data.success = ${data.success}`);
                    console.log(` Frontend: data.current_routine existe = ${!!data.current_routine}`);
                    if (data.current_routine) {
                        console.log(` Frontend: exercises count = ${data.current_routine.exercises?.length || 0}`);
                    }
                    
                    if (data.success && data.current_routine) {
                        console.log(` Frontend: Rutina encontrada con ${data.current_routine.exercises?.length || 0} ejercicios`);
                        console.log(` Frontend: Usuario premium seg煤n servidor: ${data.is_premium}`);
                        
                        // Crear un plan compatible con el formato esperado
                        const plan = {
                            rutina: data.current_routine,
                            dieta: data.current_diet || {},
                            motivacion: "Rutina actualizada din谩micamente"
                        };
                        
                        // Guardar en localStorage para futuras consultas
                        localStorage.setItem("userPlan", JSON.stringify(plan));
                        
                        // Usar el estado premium del servidor en lugar del local
                        const isPremium = data.is_premium;
                        
                        console.log(` Frontend: Mostrando plan para usuario premium: ${isPremium}`);
                        
                        // Mostrar el plan actualizado
                        console.log(' Llamando displayPlan() con:', { plan, isPremium });
                        displayPlan(plan, isPremium);
                        return;
                    } else {
                        console.log(' Frontend: No se encontr贸 rutina en la respuesta');
                        showNoContentMessages();
                    }
                } else {
                    console.error('Error al cargar rutina actual:', response.status);
                    showNoContentMessages();
                }
            } catch (error) {
                console.error('Error al cargar rutina actual:', error);
                // Si no se pudo cargar, mostrar mensaje
            showNoContentMessages();
            }
        }

        // Funci贸n auxiliar para reintentar displayPlan cuando el elemento no existe
        function displayPlanRetry(plan, userPremiumStatus, rutinaContent) {
            console.log(' displayPlanRetry() llamado');
            if (plan.rutina && plan.rutina.exercises) {
                const exercises = plan.rutina.exercises;
                const total = exercises.length;
                const isPremium = userPremiumStatus !== null ? userPremiumStatus : isPremiumUser();
                const visibles = isPremium ? total : Math.max(3, Math.ceil(total * 0.25));

                let rutinaHTML = '';

                // Mostrar ejercicios con censura para usuarios FREE (retry)
                exercises.forEach((exercise, index) => {
                    const exerciseName = typeof exercise === 'object' ? exercise.name : exercise;
                    const sets = typeof exercise === 'object' ? (exercise.sets || 'N/A') : 'N/A';
                    const reps = typeof exercise === 'object' ? (exercise.reps || 'N/A') : 'N/A';
                    const weight = typeof exercise === 'object' ? (exercise.weight || 'N/A') : 'N/A';
                    const notes = typeof exercise === 'object' ? (exercise.notes || '') : '';
                    
                    //  CENSURA: Solo mostrar primeros 2 ejercicios para usuarios FREE (retry)
                    if (!isPremium && index >= 2) {
                        // Ejercicio censurado
                        rutinaHTML += `<div style="margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; position: relative; overflow: hidden; border-left: 4px solid #cbd5e1;">`;
                        rutinaHTML += `<div style="filter: blur(5px); color: #64748b; user-select: none; pointer-events: none;">`;
                        rutinaHTML += `<strong>${exerciseName}</strong><br>`;
                        rutinaHTML += `<span>Series: ${sets} | Reps: ${reps} | Peso: ${weight}</span>`;
                        rutinaHTML += `</div>`;
                        rutinaHTML += `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(132, 204, 22, 0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">PRO</div>`;
                        rutinaHTML += `</div>`;
                        
                        // Mostrar mensaje de upgrade despu茅s del segundo ejercicio censurado
                        if (index === 2) {
                            rutinaHTML += `
                                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center;">
                                    <h3 style="color: white; margin-bottom: 10px;"> Desbloquea tu rutina completa</h3>
                                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">
                                        Accede a tu plan personalizado completo, modificaciones ilimitadas y seguimiento de progreso
                                    </p>
                                    <button onclick="window.location.href='./tarifas.html'" 
                                            style="background: white; color: #667eea; padding: 12px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                        Mejorar a Premium - 9.99/mes
                                    </button>
                                </div>
                            `;
                        }
                        return; // No mostrar m谩s ejercicios para usuarios FREE
                    }
                    
                    // Ejercicio visible (premium o primeros 2 para free)
                    rutinaHTML += `<div style="margin-bottom: 15px; padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #84cc16;">`;
                    rutinaHTML += `<strong style="color: #2d5016;">${exerciseName}</strong><br>`;
                    rutinaHTML += `<span style="color: #365314;">Series: ${sets} | Reps: ${reps} | Peso: ${weight}</span>`;
                    if (notes) {
                        rutinaHTML += `<br><em style="color: #84cc16; font-size: 12px;">${notes}</em>`;
                    }
                    rutinaHTML += `</div>`;
                });

                console.log(' Insertando HTML en DOM (retry)');
                console.log('   Container found:', !!rutinaContent);
                console.log('   HTML length:', rutinaHTML.length);
                
                if (rutinaContent) {
                    //  FORZAR VISIBILIDAD DEL CONTAINER (retry)
                    rutinaContent.style.display = 'block';
                    rutinaContent.style.visibility = 'visible';
                    rutinaContent.style.opacity = '1';
                    rutinaContent.style.zIndex = '10';
                    rutinaContent.style.position = 'relative';
                    
                    //  OCULTAR MENSAJES DE ERROR (retry)
                    const noContentMessages = rutinaContent.querySelectorAll('p');
                    noContentMessages.forEach(p => {
                        if (p.textContent.includes('No tienes una rutina generada')) {
                            p.style.display = 'none';
                            console.log(' Ocultando mensaje de error encontrado (retry)');
                        }
                    });
                    
                    //  INSERTAR HTML (retry)
                    rutinaContent.innerHTML = rutinaHTML;
                    console.log(' HTML insertado correctamente (retry)');
                    console.log(' Container forzado a ser visible (retry)');
                } else {
                    console.error(' rutinaContent es NULL en retry');
                }
            }
        }

        // Funci贸n para mostrar el plan en los overlays - DISEO MINIMALISTA
        function displayPlan(plan, userPremiumStatus = null) {
            console.log(' displayPlan() llamado con:', plan);
            console.log(' userPremiumStatus:', userPremiumStatus);
            
            const rutinaContent = document.getElementById('rutinaContent');
            const dietaContent = document.getElementById('dietaContent');
            const isPremium = userPremiumStatus !== null ? userPremiumStatus : isPremiumUser();
            
            // Si el elemento no existe, esperar un poco y reintentar
            if (!rutinaContent) {
                console.log('锔 rutinaContent no encontrado, reintentando en 100ms...');
                setTimeout(() => {
                    const retryRutinaContent = document.getElementById('rutinaContent');
                    if (retryRutinaContent) {
                        console.log(' rutinaContent encontrado en reintento');
                        displayPlanRetry(plan, userPremiumStatus, retryRutinaContent);
                    } else {
                        console.error(' rutinaContent sigue sin existir despu茅s del reintento');
                    }
                }, 100);
                return;
            }
            
            if (plan.rutina && plan.rutina.exercises) {
                // RUTINA - DISEO MINIMALISTA (SIN DUPLICADOS)
                let rutinaHtml = `
                    <style>
                        #rutinaContent, #dietaContent {
                            background: #000000;
                            color: #ffffff;
                            padding: 30px;
                            font-family: 'Inter', -apple-system, sans-serif;
                        }
                        .section-title {
                            font-size: 32px;
                            font-weight: 700;
                            margin-bottom: 10px;
                            color: #ffffff;
                        }
                        .section-subtitle {
                            font-size: 18px;
                            color: #888888;
                            margin-bottom: 30px;
                            font-weight: 500;
                        }
                        .day-title {
                            font-size: 20px;
                            font-weight: 600;
                            margin-top: 25px;
                            margin-bottom: 15px;
                            color: #ffffff;
                        }
                        .exercise-item {
                            font-size: 16px;
                            color: #cccccc;
                            margin-left: 20px;
                            margin-bottom: 8px;
                            line-height: 1.5;
                        }
                        .meal-title {
                            font-size: 20px;
                            font-weight: 600;
                            margin-top: 25px;
                            margin-bottom: 15px;
                            color: #ffffff;
                        }
                        .food-item {
                            font-size: 16px;
                            color: #cccccc;
                            margin-left: 20px;
                            margin-bottom: 6px;
                        }
                        .censored-content {
                            filter: blur(8px);
                            background: #1a1a1a;
                            padding: 20px;
                            margin: 20px 0;
                            border-radius: 8px;
                            pointer-events: none;
                            user-select: none;
                        }
                        .upgrade-overlay {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            padding: 30px;
                            border-radius: 12px;
                            text-align: center;
                            margin: 30px 0;
                        }
                        .upgrade-overlay h3 {
                            color: white;
                            font-size: 24px;
                            margin-bottom: 10px;
                        }
                        .upgrade-overlay p {
                            color: rgba(255,255,255,0.9);
                            font-size: 16px;
                            margin-bottom: 20px;
                        }
                        .upgrade-button {
                            background: white;
                            color: #667eea;
                            padding: 12px 30px;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 16px;
                        }
                    </style>
                    <h1 class="section-title">Rutina</h1>
                    <p class="section-subtitle">${plan.rutina.titulo || 'Plan personalizado'}</p>
                `;
                
                // Agrupar ejercicios por d铆a
                const exercisesByDay = {};
                plan.rutina.exercises.forEach(exercise => {
                    const day = exercise.day || 'Sin d铆a';
                    if (!exercisesByDay[day]) {
                        exercisesByDay[day] = [];
                    }
                    exercisesByDay[day].push(exercise);
                });
                
                const days = Object.keys(exercisesByDay);
                let upgradeShown = false;
                
                days.forEach((day, index) => {
                    // Primer d铆a siempre visible
                    if (index === 0) {
                        rutinaHtml += `<div class="day-title">${day}</div>`;
                        exercisesByDay[day].forEach(ej => {
                            rutinaHtml += `<div class="exercise-item"> ${ej.name} ${ej.sets}x${ej.reps}</div>`;
                        });
                    } 
                    // Resto censurado para FREE
                    else if (!isPremium) {
                        if (index === 1 && !upgradeShown) {
                            rutinaHtml += `
                                <div class="censored-content">
                                    <div class="day-title">${day}</div>
                                    ${exercisesByDay[day].map(ej => 
                                        `<div class="exercise-item"> ${ej.name} ${ej.sets}x${ej.reps}</div>`
                                    ).join('')}
                                </div>
                            `;
                            
                            // Overlay de upgrade despu茅s del primer d铆a censurado
                            rutinaHtml += `
                                <div style="
                                    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                                    border: 2px solid #39ff14;
                                    padding: 40px 30px;
                                    border-radius: 16px;
                                    text-align: center;
                                    margin: 30px 0;
                                    box-shadow: 0 0 30px rgba(57, 255, 20, 0.15);
                                ">
                                    <h3 style="color: #39ff14; font-size: 24px; font-weight: 700; margin-bottom: 12px;">
                                        Desbloquea la Rutina Completa
                                    </h3>
                                    <p style="color: #cccccc; font-size: 15px; margin-bottom: 25px;">
                                        Accede a todos los d铆as, modificaciones ilimitadas con IA y seguimiento de progreso
                                    </p>
                                    <button onclick="window.location.href='./tarifas.html'" style="
                                        background: #39ff14;
                                        color: #000000;
                                        padding: 14px 40px;
                                        border: none;
                                        border-radius: 10px;
                                        font-weight: 700;
                                        cursor: pointer;
                                        font-size: 16px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        transition: all 0.3s ease;
                                    ">
                                        Mejorar a Premium - 9.99/mes
                                    </button>
                                </div>
                            `;
                            upgradeShown = true;
                        } else if (index > 1) {
                            rutinaHtml += `
                                <div class="censored-content">
                                    <div class="day-title">${day}</div>
                                    <div class="exercise-item">  </div>
                                    <div class="exercise-item">  </div>
                                </div>
                            `;
                        }
                    }
                    // Todo visible para PREMIUM
                    else {
                        rutinaHtml += `<div class="day-title">${day}</div>`;
                        exercisesByDay[day].forEach(ej => {
                            rutinaHtml += `<div class="exercise-item"> ${ej.name} ${ej.sets}x${ej.reps}</div>`;
                        });
                    }
                });
                
                // Insertar rutina
                if (rutinaContent) {
                    rutinaContent.style.display = 'block';
                    rutinaContent.style.visibility = 'visible';
                    rutinaContent.style.opacity = '1';
                    rutinaContent.innerHTML = rutinaHtml;
                    console.log(' Rutina insertada con dise帽o minimalista');
                }
            }
            
            // DIETA - DISEO MINIMALISTA
            console.log('斤 Verificando dieta:', plan.dieta);
            console.log('斤 Tiene meals?', plan.dieta?.meals);
            console.log('斤 Meals count:', plan.dieta?.meals?.length);
            
            if (dietaContent && plan.dieta && plan.dieta.meals && plan.dieta.meals.length > 0) {
                const totalKcal = plan.dieta.total_kcal || 2215;
                let dietaHtml = `
                    <h1 class="section-title" style="margin-top: 50px;">Dieta</h1>
                    <p class="section-subtitle">${plan.dieta.titulo || 'Plan personalizado'} - ${totalKcal} kcal diarias</p>
                `;
                
                let upgradeShown = false;
                
                plan.dieta.meals.forEach((comida, index) => {
                    console.log(`斤 Comida ${index}:`, comida);
                    // Primera comida siempre visible
                    if (index === 0) {
                        dietaHtml += `<div class="meal-title">${comida.nombre}</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                if (typeof alimento === 'string') {
                                    dietaHtml += `<div class="food-item"> ${alimento}</div>`;
                                } else if (typeof alimento === 'object' && alimento.alimento) {
                                    dietaHtml += `<div class="food-item"> ${alimento.alimento} - ${alimento.cantidad}</div>`;
                                } else {
                                    dietaHtml += `<div class="food-item"> ${alimento}</div>`;
                                }
                            });
                        }
                    }
                    // Resto censurado para FREE
                    else if (!isPremium) {
                        dietaHtml += `
                            <div class="censored-content">
                                <div class="meal-title">${comida.nombre}</div>
                                <div class="food-item">  </div>
                                <div class="food-item">  </div>
                            </div>
                        `;
                        
                        // Mostrar overlay despu茅s de la primera comida censurada
                        if (index === 1 && !upgradeShown) {
                            dietaHtml += `
                                <div style="
                                    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                                    border: 2px solid #39ff14;
                                    padding: 40px 30px;
                                    border-radius: 16px;
                                    text-align: center;
                                    margin: 30px 0;
                                    box-shadow: 0 0 30px rgba(57, 255, 20, 0.15);
                                ">
                                    <h3 style="color: #39ff14; font-size: 24px; font-weight: 700; margin-bottom: 12px;">
                                        Desbloquea la Dieta Completa
                                    </h3>
                                    <p style="color: #cccccc; font-size: 15px; margin-bottom: 25px;">
                                        Accede a todas las comidas, ajustes personalizados seg煤n tu progreso y recetas exclusivas
                                    </p>
                                    <button onclick="window.location.href='./tarifas.html'" style="
                                        background: #39ff14;
                                        color: #000000;
                                        padding: 14px 40px;
                                        border: none;
                                        border-radius: 10px;
                                        font-weight: 700;
                                        cursor: pointer;
                                        font-size: 16px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        transition: all 0.3s ease;
                                    ">
                                        Mejorar a Premium - 9.99/mes
                                    </button>
                                </div>
                            `;
                            upgradeShown = true;
                        }
                    }
                    // Todo visible para PREMIUM
                    else {
                        dietaHtml += `<div class="meal-title">${comida.nombre}</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                if (typeof alimento === 'string') {
                                    dietaHtml += `<div class="food-item"> ${alimento}</div>`;
                                } else if (typeof alimento === 'object' && alimento.alimento) {
                                    dietaHtml += `<div class="food-item"> ${alimento.alimento} - ${alimento.cantidad}</div>`;
                                } else {
                                    dietaHtml += `<div class="food-item"> ${alimento}</div>`;
                                }
                            });
                        }
                    }
                });
                
                // Insertar dieta
                if (dietaContent) {
                    //  LIMPIAR MENSAJES DE ERROR QUE TAPAN LA DIETA
                    const noContentMessages = dietaContent.querySelectorAll('p');
                    noContentMessages.forEach(p => {
                        if (p.textContent.includes('No tienes') || p.textContent.includes('nutricional')) {
                            p.style.display = 'none';
                            p.remove(); // Eliminarlo completamente
                            console.log(' Eliminando mensaje de error que tapa la dieta');
                        }
                    });
                    
                    //  FORZAR VISIBILIDAD
                    dietaContent.style.display = 'block';
                    dietaContent.style.visibility = 'visible';
                    dietaContent.style.opacity = '1';
                    dietaContent.style.zIndex = '10';
                    dietaContent.style.position = 'relative';
                    
                    //  INSERTAR DIETA
                    dietaContent.innerHTML = dietaHtml;
                    console.log(' Dieta insertada con dise帽o minimalista');
                }
            } else {
                console.error(' No se pudo renderizar dieta:');
                console.error('  - dietaContent existe:', !!dietaContent);
                console.error('  - plan.dieta existe:', !!plan.dieta);
                console.error('  - plan.dieta.meals existe:', !!plan.dieta?.meals);
                console.error('  - plan.dieta.meals.length:', plan.dieta?.meals?.length);
                
                // Forzar mostrar mensaje de error
                if (dietaContent) {
                    dietaContent.innerHTML = `
                        <h1 class="section-title" style="margin-top: 50px;">Dieta</h1>
                        <p style="color: #ff4444;">Error: No se pudo cargar el plan nutricional</p>
                        <pre style="color: #888; font-size: 12px;">${JSON.stringify(plan.dieta, null, 2)}</pre>
                    `;
                }
            }

            // Mostrar consejos (aplicar recorte si es free)
            const consejosContent = document.getElementById('consejosContent');
            if (plan.rutina && plan.rutina.consejos) {
                const consejos = plan.rutina.consejos;
                const total = consejos.length;
                const isPremium = isPremiumUser();
                const visibles = isPremium ? total : Math.max(2, Math.ceil(total * 0.33)); // Mostrar 33% (m铆nimo 2)

                let consejosHTML = '<h3>Consejos de Entrenamiento</h3>';
                
                // Consejos visibles expandidos
                const consejosExpandidos = [
                    "SOBRECARGA PROGRESIVA: El principio fundamental del crecimiento muscular. Debes aumentar gradualmente el peso, repeticiones o series cada 1-2 semanas. Si puedes hacer 3 series de 10 repeticiones con 50kg, la pr贸xima semana intenta 3x10 con 52.5kg o 3x12 con 50kg. Esta progresi贸n constante es lo que estimula la adaptaci贸n muscular.",
                    "CALENTAMIENTO COMPLETO: Nunca saltes el calentamiento. Dedica 10-15 minutos a activar tu sistema cardiovascular y preparar tus m煤sculos. Comienza con 5 minutos de cardio ligero, luego realiza movimientos din谩micos como c铆rculos de brazos, sentadillas sin peso y estiramientos activos. Esto reduce el riesgo de lesiones y mejora tu rendimiento."
                ];

                consejosExpandidos.forEach(consejo => {
                    consejosHTML += `<div style=\"margin-bottom: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #84cc16;\">`;
                    consejosHTML += `<div style=\"font-weight: 600; color: #2d5016; margin-bottom: 8px;\">${consejo.split(':')[0]}:</div>`;
                    consejosHTML += `<div style=\"color: #365314; line-height: 1.5;\">${consejo.split(':').slice(1).join(':').trim()}</div>`;
                    consejosHTML += `</div>`;
                });

                // Consejos censurados para usuarios no isPremium
                if (!isPremium && visibles < total) {
                    const ocultos = total - visibles;
                    const consejosCensurados = [
                        "NUTRICIN PRE-ENTRENAMIENTO: Consume carbohidratos complejos 2-3 horas antes del entrenamiento para tener energ铆a sostenida. Avena, arroz integral o patata son excelentes opciones. Evita comidas pesadas que puedan causar molestias digestivas durante el ejercicio.",
                        "PROTENA POST-ENTRENAMIENTO: La ventana anab贸lica es real. Consume 20-30g de prote铆na de alta calidad (suero de leche, pollo, pescado) en los primeros 30-60 minutos post-entreno. Esto maximiza la s铆ntesis de prote铆na muscular y acelera la recuperaci贸n.",
                        "La hidrataci贸n adecuada es fundamental para el rendimiento muscular. Bebe al menos 2-3 litros de agua diarios, especialmente antes y despu茅s del entrenamiento.",
                        "El descanso entre series debe ser progresivo: 60-90 segundos para hipertrofia, 2-3 minutos para fuerza m谩xima.",
                        "La t茅cnica correcta siempre prevalece sobre el peso. Es mejor hacer 8 repeticiones perfectas que 12 mal ejecutadas.",
                        "La nutrici贸n post-entrenamiento es crucial. Consume prote铆nas y carbohidratos en los primeros 30-60 minutos despu茅s del ejercicio."
                    ];

                    consejosCensurados.slice(0, Math.min(ocultos, 6)).forEach(consejo => {
                        consejosHTML += `<div style=\"margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; position: relative; overflow: hidden; border-left: 4px solid #cbd5e1;\">`;
                        consejosHTML += `<div style=\"filter: blur(2px); color: #64748b; user-select: none; pointer-events: none; line-height: 1.5;\">`;
                        if (consejo.includes(':')) {
                            consejosHTML += `<div style=\"font-weight: 600; color: #475569; margin-bottom: 8px;\">${consejo.split(':')[0]}:</div>`;
                            consejosHTML += `<div style=\"color: #64748b;\">${consejo.split(':').slice(1).join(':').trim()}</div>`;
                        } else {
                            consejosHTML += ` ${consejo}`;
                        }
                        consejosHTML += `</div>`;
                        consejosHTML += `<div style=\"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(132, 204, 22, 0.95); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(132, 204, 22, 0.3);\">PRO</div>`;
                        consejosHTML += `</div>`;
                    });

                    consejosHTML += `<div style=\"margin-top: 10px; padding: 14px; border: 1px dashed #94a3b8; border-radius: 8px; background: rgba(148,163,184,0.08); color: #cbd5e1;\">`;
                    consejosHTML += `${ocultos} consejo(s) adicionales disponibles en Pro. `;
                    consejosHTML += `<a href=\"./tarifas.html\" style=\"color:#84cc16; font-weight:600; text-decoration: underline;\">Mejora a Pro</a> para desbloquear todos los consejos.`;
                    consejosHTML += `</div>`;
                }

                consejosContent.innerHTML = consejosHTML;
            }
        }

        // Funci贸n para abrir overlays
        function openOverlay(overlayId) {
            const overlay = document.getElementById(overlayId);
            if (!overlay) {
                console.error('Overlay no encontrado:', overlayId);
                return;
            }
            overlay.style.display = 'flex';
        }

        // Funci贸n para cerrar overlays
        function closeOverlay(overlayId) {
            const overlay = document.getElementById(overlayId);
            if (!overlay) {
                console.error('Overlay no encontrado:', overlayId);
                return;
            }
            overlay.style.display = 'none';
        }

        // Funci贸n para cargar contenido de rutina y dieta
        function loadRoutineAndDietContent() {
            const storedPlan = localStorage.getItem('userPlan');
            const isPremium = isPremiumUser();
            
            if (storedPlan) {
                try {
                    const plan = JSON.parse(storedPlan);
                    displayRoutineContent(plan, isPremium);
                    displayDietContent(plan, isPremium);
                } catch (e) {
                    console.error('Error parsing stored plan:', e);
                    // Intentar cargar desde la base de datos
                    loadUserPlans();
                }
            } else {
                // Intentar cargar desde la base de datos
                loadUserPlans();
            }
        }

        // Funci贸n para mostrar contenido de rutina
        function displayRoutineContent(plan, isPremium) {
            const contentArea = document.getElementById('rutinaContent');
            
            if (plan.rutina && plan.rutina.dias) {
                const dias = plan.rutina.dias;
                const total = dias.length;
                const visibles = isPremium ? total : Math.max(1, Math.ceil(total * 0.2)); // 20% para usuarios b谩sicos

                let routineHTML = '';
                
                // Mostrar d铆as visibles
                dias.slice(0, visibles).forEach(dia => {
                    routineHTML += `<div class="routine-item">`;
                    routineHTML += `<div class="routine-day">${dia.dia || dia.nombre}</div>`;
                    (dia.ejercicios || []).forEach(ejercicio => {
                        routineHTML += `<div class="exercise">`;
                        routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                        routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                        routineHTML += `</div>`;
                    });
                    routineHTML += `</div>`;
                });

                // Mostrar d铆as censurados para usuarios no isPremium
                if (!isPremium && visibles < total) {
                    const ocultos = total - visibles;
                    
                    // Agregar d铆as censurados
                    dias.slice(visibles, visibles + Math.min(ocultos, 2)).forEach(dia => {
                        routineHTML += `<div class="routine-item isPremium-overlay">`;
                        routineHTML += `<div class="routine-day">${dia.dia || dia.nombre}</div>`;
                        (dia.ejercicios || []).forEach(ejercicio => {
                            routineHTML += `<div class="exercise">`;
                            routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                            routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                            routineHTML += `</div>`;
                        });
                        routineHTML += `<div class="isPremium-badge">`;
                        routineHTML += `<h4>Desbloquea contenido completo con Pro</h4>`;
                        routineHTML += `<p>${ocultos} d铆as adicionales disponibles</p>`;
                        routineHTML += `<button class="isPremium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                        routineHTML += `</div>`;
                        routineHTML += `</div>`;
                    });
                }

                contentArea.innerHTML = routineHTML;
            } else {
                // COMENTADO: No insertar mensaje de error para evitar conflictos con displayPlan()
                // contentArea.innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
                console.log('锔 No hay rutina para mostrar en funci贸n alternativa');
            }
        }

        // Funci贸n para mostrar contenido de dieta
        function displayDietContent(plan, isPremium) {
            const contentArea = document.getElementById('dietaContent');
            
            if (plan.dieta && plan.dieta.comidas) {
                const comidas = plan.dieta.comidas;
                const total = comidas.length;
                const visibles = isPremium ? total : Math.max(2, Math.ceil(total * 0.5)); // 50% para usuarios b谩sicos

                let dietHTML = '';
                
                // Mostrar macros si est谩n disponibles
                if (plan.dieta.macros) {
                    dietHTML += `<div class="macros-grid">`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.proteinas}g</span><span class="macro-label">Prote铆nas</span></div>`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.hidratos}g</span><span class="macro-label">Carbohidratos</span></div>`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.grasas}g</span><span class="macro-label">Grasas</span></div>`;
                    dietHTML += `<div class="macro-card"><span class="macro-value">${plan.dieta.macros.calorias || plan.dieta.kcal_objetivo || ''}</span><span class="macro-label">Calor铆as</span></div>`;
                    dietHTML += `</div>`;
                }

                // Mostrar comidas visibles
                comidas.slice(0, visibles).forEach(comida => {
                    dietHTML += `<div class="meal-card">`;
                    dietHTML += `<div class="meal-header">`;
                    dietHTML += `<span class="meal-time">${comida.kcal || ''} kcal</span>`;
                    dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                    dietHTML += `</div>`;
                    if (comida.alimentos) {
                        comida.alimentos.forEach(alimento => {
                            dietHTML += `<div class="food-item">`;
                            if (typeof alimento === 'string') {
                                dietHTML += `<span>${alimento}</span>`;
                            } else {
                                dietHTML += `<span>${alimento.nombre || alimento}</span>`;
                                if (alimento.cantidad) {
                                    dietHTML += `<span>${alimento.cantidad}</span>`;
                                }
                            }
                            dietHTML += `</div>`;
                        });
                    }
                    dietHTML += `</div>`;
                });

                // Mostrar comidas censuradas para usuarios no isPremium
                if (!isPremium && visibles < total) {
                    const ocultos = total - visibles;
                    
                    // Agregar comidas censuradas
                    comidas.slice(visibles, visibles + Math.min(ocultos, 2)).forEach(comida => {
                        dietHTML += `<div class="meal-card isPremium-overlay">`;
                        dietHTML += `<div class="meal-header">`;
                        dietHTML += `<span class="meal-time">${comida.kcal || ''} kcal</span>`;
                        dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                        dietHTML += `</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                dietHTML += `<div class="food-item">`;
                                if (typeof alimento === 'string') {
                                    dietHTML += `<span>${alimento}</span>`;
                                } else {
                                    dietHTML += `<span>${alimento.nombre || alimento}</span>`;
                                    if (alimento.cantidad) {
                                        dietHTML += `<span>${alimento.cantidad}</span>`;
                                    }
                                }
                                dietHTML += `</div>`;
                            });
                        }
                        dietHTML += `<div class="isPremium-badge">`;
                        dietHTML += `<h4>Desbloquea contenido completo con Pro</h4>`;
                        dietHTML += `<p>${ocultos} comidas adicionales disponibles</p>`;
                        dietHTML += `<button class="isPremium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                        dietHTML += `</div>`;
                        dietHTML += `</div>`;
                    });
                }

                contentArea.innerHTML = dietHTML;
            } else {
                // COMENTADO: Conflicto con displayPlan() que inserta la dieta gen茅rica
                // contentArea.innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
                console.log('锔 No hay dieta en localStorage, pero displayPlan() deber铆a insertarla');
            }
        }

        // Funci贸n para cargar contenido de consejos y estudios
        function loadAdviceAndStudiesContent() {
            const storedPlan = localStorage.getItem('userPlan');
            const isPremium = isPremiumUser();
            
            loadAdviceContent(storedPlan, isPremium);
            loadStudiesContent();
        }

        // Funci贸n para mostrar consejos
        function loadAdviceContent(storedPlan, isPremium) {
            const contentArea = document.getElementById('consejosContent');
            
            const consejosTecnicos = [
                {
                    title: "SOBRECARGA PROGRESIVA SISTEMTICA",
                    content: "Implementa un sistema de progresi贸n basado en el rendimiento. Aumenta el peso cuando puedas completar todas las series con 2-3 repeticiones en reserva. Para ejercicios de fuerza, incrementa 2.5-5kg; para hipertrofia, 1.25-2.5kg. Documenta cada sesi贸n para asegurar progresi贸n consistente."
                },
                {
                    title: "OPTIMIZACIN DEL VOLUMEN DE ENTRENAMIENTO",
                    content: "Mant茅n 10-20 series por grupo muscular por semana para maximizar la hipertrofia. Distribuye el volumen a lo largo de la semana, evitando sesiones excesivamente largas. Monitorea la fatiga acumulada y ajusta el volumen seg煤n tu capacidad de recuperaci贸n."
                }
            ];

            let adviceHTML = '';
            consejosTecnicos.forEach(consejo => {
                adviceHTML += `<div class="advice-card">`;
                adviceHTML += `<div class="advice-title">${consejo.title}</div>`;
                adviceHTML += `<div class="advice-content">${consejo.content}</div>`;
                adviceHTML += `</div>`;
            });

            // Consejos censurados para usuarios no isPremium
            if (!isPremium) {
                const consejosCensurados = [
                    {
                        title: "TCNICA Y ACTIVACIN MUSCULAR",
                        content: "La ejecuci贸n t茅cnica correcta es fundamental para la activaci贸n 贸ptima del m煤sculo objetivo. Realiza movimientos controlados con rango completo de movimiento, manteniendo tensi贸n constante durante la fase exc茅ntrica y conc茅ntrica."
                    },
                    {
                        title: "TIMING DE NUTRIENTES ESTRATGICO",
                        content: "Consume 20-40g de prote铆na de alta calidad dentro de 2 horas post-entrenamiento. Combina con 30-60g de carbohidratos de r谩pida absorci贸n para maximizar la s铆ntesis de prote铆nas musculares y la reposici贸n de gluc贸geno."
                    }
                ];

                consejosCensurados.forEach(consejo => {
                    adviceHTML += `<div class="advice-card isPremium-overlay">`;
                    adviceHTML += `<div class="advice-title">${consejo.title}</div>`;
                    adviceHTML += `<div class="advice-content">${consejo.content}</div>`;
                    adviceHTML += `<div class="isPremium-badge">`;
                    adviceHTML += `<h4>Consejos Avanzados Disponibles</h4>`;
                    adviceHTML += `<p>Contenido t茅cnico adicional para usuarios Pro</p>`;
                    adviceHTML += `<button class="isPremium-btn" onclick="window.location.href='./tarifas.html'">Mejorar a Pro</button>`;
                    adviceHTML += `</div>`;
                    adviceHTML += `</div>`;
                });
            }

            contentArea.innerHTML = adviceHTML;
        }

        // Funci贸n para mostrar estudios
        function loadStudiesContent() {
            const contentArea = document.getElementById('estudiosContent');
            
            const estudios = [
                {
                    title: "Progresi贸n Lineal en Entrenamiento de Fuerza",
                    content: "Estudio longitudinal que demuestra la efectividad de la sobrecarga progresiva sistem谩tica en el desarrollo de la fuerza muscular. Los participantes que siguieron un protocolo de progresi贸n lineal mostraron aumentos del 23% en fuerza m谩xima comparado con el grupo control.",
                    author: "Schoenfeld, B.J., Grgic, J., Ogborn, D., & Krieger, J.W. (2017)",
                    journal: "Journal of Strength and Conditioning Research, 31(12), 3508-3523"
                },
                {
                    title: "Timing de Prote铆nas y S铆ntesis Muscular",
                    content: "Investigaci贸n que eval煤a el momento 贸ptimo de consumo de prote铆nas post-entrenamiento. Los resultados indican que la ventana anab贸lica se extiende hasta 4 horas post-ejercicio, con beneficios m谩ximos en los primeros 2 horas.",
                    author: "Areta, J.L., Burke, L.M., Ross, M.L., et al. (2013)",
                    journal: "Journal of the International Society of Sports Nutrition, 10(1), 5"
                },
                {
                    title: "Volumen de Entrenamiento y Hipertrofia",
                    content: "Meta-an谩lisis de 15 estudios que examina la relaci贸n entre volumen de entrenamiento y crecimiento muscular. Los hallazgos sugieren que 10-20 series por grupo muscular por semana optimizan la hipertrofia en entrenados.",
                    author: "Schoenfeld, B.J., Ogborn, D., & Krieger, J.W. (2017)",
                    journal: "Sports Medicine, 47(8), 1681-1696"
                }
            ];

            let studiesHTML = '';
            estudios.forEach(estudio => {
                studiesHTML += `<div class="study-card">`;
                studiesHTML += `<div class="study-title">${estudio.title}</div>`;
                studiesHTML += `<div class="study-content">${estudio.content}</div>`;
                studiesHTML += `<div class="study-meta">`;
                studiesHTML += `<span class="study-author">${estudio.author}</span>`;
                studiesHTML += `<span class="study-journal">${estudio.journal}</span>`;
                studiesHTML += `</div>`;
                studiesHTML += `</div>`;
            });

            contentArea.innerHTML = studiesHTML;
        }

        // Funci贸n para cargar contenido de t茅rminos
        function loadTermsContent() {
            const contentArea = document.getElementById('terminosContent');
            
            const termsHTML = `
                <h3>T茅rminos de Servicio</h3>
                <p>Al utilizar YourGains AI, aceptas estos t茅rminos de servicio. Si no est谩s de acuerdo con alguna parte de estos t茅rminos, no debes usar nuestros servicios.</p>
                
                <h4>Descripci贸n del Servicio</h4>
                <p>YourGains AI es una plataforma de inteligencia artificial que proporciona planes de entrenamiento personalizados, recomendaciones nutricionales y consejos de fitness basados en tus objetivos y preferencias.</p>
                
                <h4>Limitaciones de Responsabilidad</h4>
                <p><strong>Importante:</strong> Los planes de entrenamiento y recomendaciones nutricionales son sugerencias generales. Siempre consulta con un profesional m茅dico o de fitness antes de comenzar cualquier programa de ejercicios o dieta.</p>
                
                <h3>Pol铆tica de Privacidad</h3>
                <p>Recopilamos informaci贸n para proporcionarte un servicio personalizado, incluyendo datos de perfil, historial de entrenamiento y preferencias. Utilizamos esta informaci贸n para generar planes personalizados y mejorar nuestros algoritmos de IA.</p>
                
                <h4>Protecci贸n de Datos</h4>
                <p>Implementamos medidas de seguridad t茅cnicas y organizativas para proteger tu informaci贸n personal contra acceso no autorizado, alteraci贸n, divulgaci贸n o destrucci贸n.</p>
                
                <h4>Contacto</h4>
                <p>Si tienes preguntas sobre estos t茅rminos y pol铆ticas, puedes contactarnos en: legal@yourgainsai.com</p>
            `;
            
            contentArea.innerHTML = termsHTML;
        }

        // Funci贸n para mostrar mensajes de no contenido - COMENTADA PARA EVITAR CONFLICTOS
        function showNoContentMessages() {
            console.log('锔 showNoContentMessages() llamada - pero no insertando mensaje de error');
            // COMENTADO: No insertar mensajes de error para evitar conflictos con displayPlan()
            // document.getElementById('rutinaContent').innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
            // document.getElementById('dietaContent').innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
        }

        // Hacer funciones globales
        window.openOverlay = openOverlay;
        window.closeOverlay = closeOverlay;

        // Event listeners para los botones de navegaci贸n
        document.addEventListener('DOMContentLoaded', async function() {
            //  Verificar estado isPremium al cargar
            await checkPremiumStatus();
            
            document.getElementById('rutinaDieta').addEventListener('click', function() {
                openOverlay('rutinaDietaOverlay');
                loadRoutineAndDietContent();
            });
            
            document.getElementById('consejosEstudios').addEventListener('click', function() {
                openOverlay('consejosEstudiosOverlay');
                loadAdviceAndStudiesContent();
            });
            
            document.getElementById('terminosPrivacidad').addEventListener('click', function() {
                openOverlay('terminosPrivacidadOverlay');
                loadTermsContent();
            });
        });

        // Inicializar el dashboard cuando se carga la p谩gina
        initDashboard();

        // FUNCIONES AUXILIARES PARA FUNCTION CALLING
        // =========================================

        /**
         * Obtiene el ID del usuario actual
         */
        function getCurrentUserId() {
            try {
                // Buscar token con la clave correcta (accessToken, no token)
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error(' No se encontr贸 accessToken en localStorage');
                    return null;
                }
                
                // Decodificar JWT para obtener user_id
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userId = payload.user_id || payload.sub;
                console.log(' User ID obtenido:', userId);
                return userId;
            } catch (error) {
                console.error(' Error obteniendo user ID:', error);
                return null;
            }
        }

        /**
         * Obtiene el historial de conversaci贸n actual
         */
        function getConversationHistory() {
            const messages = document.querySelectorAll('.message');
            const history = [];
            
            messages.forEach(msg => {
                const isUser = msg.classList.contains('user-message');
                const content = msg.textContent.trim();
                
                if (content) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content
                    });
                }
            });
            
            return history;
        }

        /**
         * A帽ade badge visual a mensaje que gener贸 modificaciones
         */
        function addModificationBadge() {
            const lastMessage = document.querySelector('.ai-message:last-child');
            if (lastMessage) {
                const badge = document.createElement('div');
                badge.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 600;
                    margin-top: 8px;
                    animation: pulse 2s infinite;
                `;
                badge.innerHTML = ' Plan modificado';
                lastMessage.appendChild(badge);
            }
        }

        // getAuthHeaders ya est谩 importado desde auth.js


        // SISTEMA DE NOTIFICACIONES INLINE
        // =================================
        // Evita el error 404 del archivo externo

        // Configuraci贸n de la API
        const NOTIFICATION_API_BASE = 'http://127.0.0.1:8000';

        // Elementos del DOM
        let notificationContainer = null;

        /**
         * Inicializa el sistema de notificaciones
         */
        function initNotificationSystem() {
            // Crear contenedor de notificaciones si no existe
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                `;
                document.body.appendChild(notificationContainer);
            }
        }

        /**
         * Muestra notificaci贸n de modificaci贸n de plan
         * @param {Object} result - Resultado de la modificaci贸n
         * @param {boolean} result.modified - Si se realizaron modificaciones
         * @param {Array} result.changes - Lista de cambios realizados
         * @param {string} result.function_used - Funci贸n utilizada
         */
        function showModificationNotification(result) {
            if (!result.modified) return;
            
            initNotificationSystem();
            
            // Crear notificaci贸n
            const notification = document.createElement('div');
            notification.className = 'modification-notification';
            notification.style.cssText = `
                background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
                color: #ffffff;
                padding: 20px;
                border-radius: 16px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), 0 4px 16px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(0px);
                border: 2px solid rgba(255, 255, 255, 0.15);
                animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                position: relative;
                overflow: hidden;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-weight: 500;
                letter-spacing: 0.025em;
                text-rendering: optimizeLegibility;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            `;
            
            // Contenido de la notificaci贸n
            notification.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="
                        width: 24px;
                        height: 24px;
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-right: 12px;
                        font-size: 14px;
                    "></div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">Plan Actualizado</h3>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: none;
                        border: none;
                        color: white;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: auto;
                        opacity: 0.7;
                        transition: opacity 0.2s;
                    " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <p style="margin: 0 0 12px 0; font-size: 15px; color: #e5e5e5; font-weight: 500; line-height: 1.4;">
                        Tu plan ha sido modificado autom谩ticamente:
                    </p>
                    <div id="changes-list-${Date.now()}" style="max-height: 120px; overflow-y: auto;">
                        ${result.changes.map(change => `
                            <div style="
                                background: rgba(255, 255, 255, 0.08);
                                padding: 10px 14px;
                                margin: 6px 0;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 500;
                                color: #f0f0f0;
                                border-left: 3px solid #84cc16;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'"> ${change}</div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button onclick="goToRoutineAndDiet()" style="
                        background: rgba(255, 255, 255, 0.12);
                        border: 2px solid rgba(255, 255, 255, 0.25);
                        color: #ffffff;
                        padding: 12px 20px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        flex: 1;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    " onmouseover="this.style.background='#84cc16'; this.style.borderColor='#84cc16'; this.style.color='#000000'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(132, 204, 22, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                        Ver Rutina
                    </button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: rgba(255, 255, 255, 0.12);
                        border: 2px solid rgba(255, 255, 255, 0.25);
                        color: #ffffff;
                        padding: 12px 20px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        flex: 1;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    " onmouseover="this.style.background='#ef4444'; this.style.borderColor='#ef4444'; this.style.color='#ffffff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                        Descartar
                    </button>
                </div>
                
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    height: 3px;
                    background: rgba(255, 255, 255, 0.3);
                    animation: progressBar 8s linear forwards;
                    border-radius: 0 0 12px 12px;
                "></div>
            `;
            
            // A帽adir al contenedor
            notificationContainer.appendChild(notification);
            
            // Auto-dismiss despu茅s de 8 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 8000);
            
            // A帽adir animaciones CSS si no existen
            addNotificationStyles();
        }

        /**
         * A帽ade estilos CSS para las animaciones
         */
        function addNotificationStyles() {
            if (document.getElementById('notification-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOutRight {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
                
                @keyframes progressBar {
                    from {
                        width: 100%;
                    }
                    to {
                        width: 0%;
                    }
                }
                
                @keyframes slideInNotification {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOutNotification {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
                
                .modification-notification {
                    transition: all 0.3s ease;
                }
                
                .modification-notification:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 12px 40px rgba(132, 204, 22, 0.4);
                }
            `;
            document.head.appendChild(style);
        }

        /**
         * Muestra modal con detalles de los cambios
         * @param {string} functionUsed - Funci贸n utilizada
         * @param {Array} changes - Lista de cambios
         */
        // Event listener para botones de ver cambios
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-changes-btn')) {
                const functionUsed = e.target.getAttribute('data-function');
                const changes = JSON.parse(e.target.getAttribute('data-changes'));
                showChangesModal(functionUsed, changes);
            }
        });

        // Funciones para recargar secciones de rutina y dieta
        async function reloadRoutineSection() {
            console.log(' Recargando secci贸n de rutina...');
            
            try {
                // Obtener token JWT
                const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                if (!token) {
                    console.error('No hay token para recargar rutina');
                    return;
                }
                
                // Fetch nueva rutina desde backend
                const response = await fetch('http://127.0.0.1:8000/user/current-routine?user_id=' + userId, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    console.error('Error al obtener rutina:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('Nueva rutina obtenida:', data);
                
                // Buscar contenedor de rutina en el DOM
                const routineContainer = document.querySelector('#routine-content') || 
                                         document.querySelector('.routine-section') ||
                                         document.querySelector('[data-section="routine"]') ||
                                         document.querySelector('.routine-container');
                
                if (routineContainer) {
                    // Renderizar nueva rutina
                    routineContainer.innerHTML = renderRoutine(data.current_routine);
                    console.log(' Rutina actualizada en DOM');
                } else {
                    console.warn('No se encontr贸 contenedor de rutina');
                    // Si estamos en otra p谩gina, marcar para recargar cuando vuelvan
                    sessionStorage.setItem('routineNeedsReload', 'true');
                }
                
            } catch (error) {
                console.error('Error recargando rutina:', error);
            }
        }

        async function reloadDietSection() {
            console.log(' Recargando secci贸n de dieta...');
            
            try {
                const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                if (!token) {
                    console.error('No hay token para recargar dieta');
                    return;
                }
                
                const response = await fetch('http://127.0.0.1:8000/api/user/current-diet', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('Error al obtener dieta:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('Nueva dieta obtenida:', data);
                
                const dietContainer = document.querySelector('#diet-content') || 
                                      document.querySelector('.diet-section') ||
                                      document.querySelector('[data-section="diet"]') ||
                                      document.querySelector('.diet-container');
                
                if (dietContainer) {
                    dietContainer.innerHTML = renderDiet(data.current_diet);
                    console.log(' Dieta actualizada en DOM');
                } else {
                    console.warn('No se encontr贸 contenedor de dieta');
                    sessionStorage.setItem('dietNeedsReload', 'true');
                }
                
            } catch (error) {
                console.error('Error recargando dieta:', error);
            }
        }

        // Helper para obtener cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Funciones para renderizar rutina y dieta
        function renderRoutine(routine) {
            if (!routine || !routine.exercises) {
                return '<div class="no-routine">No hay rutina disponible</div>';
            }
            
            let html = '<div class="routine-display">';
            html += '<h3>Tu Rutina Actualizada</h3>';
            
            // Agrupar ejercicios por d铆a si hay schedule
            if (routine.schedule) {
                Object.keys(routine.schedule).forEach(day => {
                    html += `<div class="day-section"><h4>${day}</h4>`;
                    routine.schedule[day].forEach(exercise => {
                        html += `<div class="exercise-item">${exercise}</div>`;
                    });
                    html += '</div>';
                });
            } else {
                // Mostrar ejercicios sin agrupar
                routine.exercises.forEach(exercise => {
                    if (typeof exercise === 'object') {
                        html += `<div class="exercise-item">${exercise.name || exercise}</div>`;
                    } else {
                        html += `<div class="exercise-item">${exercise}</div>`;
                    }
                });
            }
            
            html += '</div>';
            return html;
        }

        function renderDiet(diet) {
            if (!diet || !diet.meals) {
                return '<div class="no-diet">No hay dieta disponible</div>';
            }
            
            let html = '<div class="diet-display">';
            html += '<h3>Tu Dieta Actualizada</h3>';
            
            diet.meals.forEach(meal => {
                html += `<div class="meal-section">`;
                html += `<h4>${meal.name || 'Comida'}</h4>`;
                if (meal.alimentos) {
                    meal.alimentos.forEach(food => {
                        html += `<div class="food-item">${food}</div>`;
                    });
                }
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }

        // Funci贸n para ir a rutina y dieta
        function goToRoutineAndDiet() {
            console.log(' Ejecutando goToRoutineAndDiet...');
            
            try {
                // Remover la notificaci贸n
                const notification = document.querySelector('.modification-notification');
                if (notification) {
                    notification.remove();
                    console.log(' Notificaci贸n removida');
                }
                
                // Recargar las secciones con datos actualizados
                if (typeof reloadRoutineSection === 'function') {
                    reloadRoutineSection();
                    console.log(' Rutina recargada');
                }
                
                if (typeof reloadDietSection === 'function') {
                    reloadDietSection();
                    console.log(' Dieta recargada');
                }
                
                // Intentar navegar a las secciones
                const routineSection = document.getElementById('routine-section');
                const dietSection = document.getElementById('diet-section');
                
                if (routineSection) {
                    console.log(' Navegando a secci贸n de rutina');
                    routineSection.scrollIntoView({ behavior: 'smooth' });
                } else if (dietSection) {
                    console.log(' Navegando a secci贸n de dieta');
                    dietSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.log('锔 No se encontraron secciones, recargando p谩gina');
                    window.location.reload();
                }
                
            } catch (error) {
                console.error(' Error en goToRoutineAndDiet:', error);
                // Fallback: recargar la p谩gina
                window.location.reload();
            }
        }

        function showChangesModal(functionUsed, changes) {
            // Crear modal si no existe
            let modal = document.getElementById('changes-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'changes-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 20000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(modal);
            }
            
            // Funci贸n de mapeo de funciones a nombres legibles
            const functionNames = {
                'modify_routine_injury': 'Adaptaci贸n por Lesi贸n',
                'modify_routine_focus': 'Enfoque en rea Espec铆fica',
                'adjust_routine_difficulty': 'Ajuste de Dificultad',
                'adjust_for_menstrual_cycle': 'Adaptaci贸n Menstrual',
                'recalculate_diet_macros': 'Rec谩lculo de Macros',
                'substitute_disliked_food': 'Sustituci贸n de Alimentos',
                'generate_meal_alternatives': 'Alternativas de Comidas',
                'simplify_diet_plan': 'Simplificaci贸n de Dieta',
                'revert_last_modification': 'Reversi贸n de Cambios'
            };
            
            const functionName = functionNames[functionUsed] || functionUsed;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    color: #333;
                    padding: 24px;
                    border-radius: 16px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    transform: scale(0.9);
                    transition: transform 0.3s ease;
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 16px;
                            color: white;
                            font-size: 18px;
                        "></div>
                        <div>
                            <h2 style="margin: 0; font-size: 20px; color: #333;">${functionName}</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">
                                Cambios realizados autom谩ticamente
                            </p>
                        </div>
                        <button onclick="closeChangesModal()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            color: #999;
                            cursor: pointer;
                            margin-left: auto;
                            padding: 4px;
                            transition: color 0.2s;
                        " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">Cambios Realizados:</h3>
                        <div style="
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border-left: 4px solid #84cc16;
                        ">
                            ${changes.map(change => `
                                <div style="
                                    padding: 8px 0;
                                    border-bottom: 1px solid #e9ecef;
                                    font-size: 14px;
                                    color: #333;
                                "> ${change}</div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeChangesModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            Cerrar
                        </button>
                        <button onclick="revertLastModification(); closeChangesModal();" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            Deshacer Cambios
                        </button>
                    </div>
                </div>
            `;
            
            // Mostrar modal
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('div').style.transform = 'scale(1)';
            }, 10);
        }

        /**
         * Cierra el modal de cambios
         */
        function closeChangesModal() {
            const modal = document.getElementById('changes-modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.querySelector('div').style.transform = 'scale(0.9)';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        /**
         * Revierte la 煤ltima modificaci贸n
         */
        async function revertLastModification() {
            try {
                console.log(' Revirtiendo 煤ltima modificaci贸n...');
                
                // Obtener token JWT
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No hay token para revertir cambios');
                    return;
                }
                
                const response = await fetch('http://127.0.0.1:8000/api/chat/modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        message: "deshaz el 煤ltimo cambio",
                        user_id: getCurrentUserId(),
                        conversation_history: []
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success !== false) {
                    console.log(' Cambios deshechos correctamente');
                    
                    // Recargar secciones afectadas
                    reloadRoutineSection();
                    reloadDietSection();
                    
                    // Mostrar notificaci贸n de 茅xito
                    alert('Cambios deshechos correctamente');
                } else {
                    throw new Error(result.message || 'Error deshaciendo cambios');
                }
            } catch (error) {
                console.error('Error reverting modification:', error);
                alert('Error deshaciendo cambios: ' + error.message);
            }
        }

        /**
         * Recarga las secciones afectadas por modificaciones
         */
        async function reloadAffectedSections() {
            try {
                // Recargar rutina si es necesario
                await reloadRoutineSection();
                
                // Recargar dieta si es necesario
                await reloadDietSection();
            } catch (error) {
                console.error('Error reloading sections:', error);
            }
        }


        /**
         * Muestra notificaci贸n de loading
         */
        function showLoadingNotification(message) {
            showSimpleNotification(message, 'loading');
        }

        /**
         * Muestra notificaci贸n de 茅xito
         */
        function showSuccessNotification(message) {
            showSimpleNotification(message, 'success');
        }

        /**
         * Muestra notificaci贸n de error
         */
        function showErrorNotification(message) {
            showSimpleNotification(message, 'error');
        }

        /**
         * Muestra notificaci贸n simple
         */
        function showSimpleNotification(message, type = 'info') {
            initNotificationSystem();
            
            const colors = {
                loading: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                info: '#84cc16'
            };
            
            const icons = {
                loading: '',
                success: '',
                error: '',
                info: 'i'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: ${colors[type]};
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            
            notification.innerHTML = `
                <span style="font-size: 16px;">${icons[type]}</span>
                <span style="font-size: 14px;">${message}</span>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Auto-dismiss despu茅s de 3 segundos (excepto loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 3000);
            }
            
            return notification;
        }

        // Verificar si hay cambios pendientes al cargar la p谩gina
        window.addEventListener('load', () => {
            if (sessionStorage.getItem('routineNeedsReload') === 'true') {
                reloadRoutineSection();
                sessionStorage.removeItem('routineNeedsReload');
            }
            if (sessionStorage.getItem('dietNeedsReload') === 'true') {
                reloadDietSection();
                sessionStorage.removeItem('dietNeedsReload');
            }
        });

        // Inicializar sistema al cargar
        document.addEventListener('DOMContentLoaded', initNotificationSystem);
      </script>
  </body>
  </html>

    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta httpx-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <title>YourGains AI</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                background-color: black;
                height: 100vh;
                height: 100dvh;
                color: white;
                font-family: Arial, sans-serif;
                position: relative;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            
            .main-layout {
                display: flex;
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
                width: 100%;
                position: relative;
            }
            
            @media (max-width: 768px) {
                .main-layout {
                    display: flex;
                    flex-direction: column;
                    height: 100vh; /* Altura exacta del viewport */
                    height: 100dvh;
                    overflow: hidden; /* Sin scroll interno */
                    position: relative;
                }
            }
            
            .header-section {
                flex-shrink: 0;
                position: relative;
                width: 100%;
                z-index: 100;
                display: flex;
                flex-direction: column;
                padding-top: 75px;
                padding-bottom: 20px;
                background: #000000;
                background-color: black;
                min-height: auto;
            }
            
            .hamburger-btn {
                position: absolute;
                top: 75px;
                left: 40px;
                background: transparent;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 8px;
                z-index: 100;
                transition: all 0.3s ease;
            }
            
            .hamburger-btn:hover {
                color: #84cc16;
            }
            
            .logo {
                position: absolute;
                top: 80px;
                left: 100px;
                display: flex;
                align-items: center;
                gap: 3px;
                z-index: 11;
            }
            
            /* Men√∫ lateral */
            .sidebar {
                position: fixed;
                top: 0;
                left: -300px;
                width: 280px;
                height: 100vh;
                background: #1a1a1a;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
                overflow-y: auto;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 999;
                display: none;
                transition: opacity 0.3s ease;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .sidebar-header {
                padding: 20px;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .sidebar-header h3 {
                color: white;
                font-size: 18px;
            }
            
            .sidebar-close {
                background: transparent;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .sidebar-close:hover {
                color: #84cc16;
            }
            
            .sidebar-menu {
                padding: 20px 0;
            }
            
            .sidebar-item {
                padding: 15px 20px;
                color: white;
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
            }
            
            .sidebar-item:hover {
                background: rgba(132, 204, 22, 0.1);
                border-left-color: #84cc16;
                color: #84cc16;
            }
            
            .sidebar-item:active {
                background: rgba(132, 204, 22, 0.2);
            }
            
            /* Estilos para men√∫ desplegable Usuario */
            .sidebar-item.has-submenu {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .submenu-arrow {
                transition: transform 0.3s ease;
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
            }
            
            .sidebar-item.has-submenu.active .submenu-arrow {
                transform: rotate(90deg);
                color: #84cc16;
            }
            
            .sidebar-submenu {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                background: rgba(0, 0, 0, 0.3);
            }
            
            .sidebar-submenu.open {
                max-height: 300px;
            }
            
            .sidebar-submenu-item {
                padding: 12px 20px 12px 40px;
                color: rgba(255, 255, 255, 0.8);
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
                font-size: 14px;
            }
            
            .sidebar-submenu-item:hover {
                background: rgba(132, 204, 22, 0.15);
                border-left-color: #84cc16;
                color: #84cc16;
            }
            
            .dna-icon {
                width: 28px;
                height: 28px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .dna-icon img, .dna-icon svg {
                width: 100%;
                height: 100%;
                object-fit: contain;
                filter: drop-shadow(0 0 4px rgba(132, 204, 22, 0.45));
            }
            
            .logo-text {
                font-size: 20px;
                font-weight: bold;
            }
            
            .your-gains {
                color: white;
            }
            
            .ai {
                color: #84cc16;
            }
            
            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: #000000;
                min-height: 0;
                width: 100%;
                z-index: 1;
                position: relative;
                margin-top: 20px;
                padding-top: 0;
            }
            
            .chat-header {
                display: none;
            }
            
            
            .chat-messages {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                color: white;
                background: #000000;
                min-height: 0;
                scrollbar-width: thin;
                scrollbar-color: #333 #000;
                -ms-overflow-style: none;
            }
            
            .chat-messages::-webkit-scrollbar {
                width: 8px;
            }
            
            .chat-messages::-webkit-scrollbar-track {
                background: #000000;
            }
            
            .chat-messages::-webkit-scrollbar-thumb {
                background: #333;
                border-radius: 4px;
            }
            
            .chat-messages::-webkit-scrollbar-thumb:hover {
                background: #444;
            }
            
            .chat-input-area {
                flex-shrink: 0;
                padding: 16px;
                background: #000000;
                border-top: 1px solid #1a1a1a;
                width: 100%;
                box-sizing: border-box;
                min-height: 70px;
                display: flex;
                align-items: center;
            }
            
            .input-row {
                display: flex;
                gap: 12px;
                align-items: center;
                width: 100%;
                max-width: 100%;
            }
            
            .chat-input {
                flex: 1;
                padding: 12px 14px;
                border: 1px solid #1a1a1a;
                border-radius: 14px;
                outline: none;
                color: #e5e5e5;
                font-size: 14px;
                transition: all 0.15s ease-in-out;
                background: #0a0a0a;
                min-width: 0;
                width: 100%;
                resize: none;
                overflow-y: hidden;
                overflow-x: hidden;
                white-space: pre-wrap;
                word-break: break-word;
                min-height: 44px;
                max-height: 180px;
                line-height: 1.5;
                font-family: inherit;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .chat-input::-webkit-scrollbar {
                display: none;
            }
            
            .chat-input-max {
                overflow-y: auto;
            }
            
            .chat-input-max::-webkit-scrollbar {
                display: none;
            }
            
            .chat-input::placeholder {
                color: #777;
            }
            
            .chat-input:focus {
                border-color: #1a1a1a;
                box-shadow: none;
            }
            
            .chat-input:disabled {
                background: #0a0a0a;
                color: #666;
                cursor: not-allowed;
                border-color: #1a1a1a;
                opacity: 0.6;
            }
            
            .chat-input:disabled::placeholder {
                color: #555;
            }
            
            .send-btn {
                width: 44px;
                height: 44px;
                background: #000000;
                color: white;
                border: 1px solid #1a1a1a;
                border-radius: 50%;
                cursor: not-allowed;
                transition: all 0.15s ease-in-out;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                padding: 0;
            }
            
            .send-btn svg {
                width: 20px;
                height: 20px;
                stroke: white;
                transition: stroke 0.15s ease-in-out, filter 0.15s ease-in-out;
            }
            
            .send-btn:hover {
                background: #0d0d0d;
            }
            
            .send-btn:hover svg {
                stroke: #b3ff00;
                filter: drop-shadow(0 0 4px #b3ff00);
            }
            
            .send-btn:active {
                background: #1a1a1a;
                box-shadow: 0 0 6px #b3ff00;
            }
            
            .send-btn:active svg {
                stroke: #b3ff00;
            }
            
            .send-btn.active {
                background: #000000;
                color: white;
                cursor: pointer;
            }
            
            .send-btn.active:hover {
                background: #0d0d0d;
            }
            
            .send-btn.active:hover svg {
                stroke: #b3ff00;
                filter: drop-shadow(0 0 4px #b3ff00);
            }
            
            .send-btn.active:active {
                background: #1a1a1a;
                box-shadow: 0 0 6px #b3ff00;
            }
            
            .send-btn.active:active svg {
                stroke: #b3ff00;
            }
            
            .send-btn:disabled {
                background: #000000;
                color: #666;
                cursor: not-allowed;
                opacity: 0.5;
            }
            
            .send-btn:disabled:hover {
                background: #000000;
            }
            
            .send-btn:disabled:hover svg {
                filter: none;
            }
            
            .message {
                margin: 10px 0;
                padding: 12px 16px;
                border-radius: 12px;
                max-width: 85%;
                word-wrap: break-word;
                line-height: 1.5;
            }
            
            .user-message {
                background: #84cc16;
                color: #000000;
                margin-left: auto;
                text-align: left;
            }
            
            .ai-message {
                background: #1a1a1a;
                color: white;
                border: 1px solid #333;
            }
            
            .placeholder {
                text-align: center;
                color: #999;
                padding: 40px 20px;
                font-style: italic;
            }
            
            /* Animaci√≥n para indicador "IA escribiendo" */
            @keyframes typing {
                0%, 60%, 100% { 
                    transform: translateY(0); 
                    opacity: 0.4;
                }
                30% { 
                    transform: translateY(-10px); 
                    opacity: 1;
                }
            }
            
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.05);
                    opacity: 0.8;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            
            .typing-indicator {
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 12px 16px;
                margin: 10px 0;
                background: #f0f0f0;
                border-radius: 15px;
                max-width: 90%;
                color: #84cc16;
                font-size: 18px;
                font-weight: bold;
            }
            
            .typing-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #84cc16;
                animation: typing 1.4s infinite;
            }
            
            .typing-dot:nth-child(2) { 
                animation-delay: 0.2s; 
            }
            
            .typing-dot:nth-child(3) { 
                animation-delay: 0.4s; 
            }
            
            .navigation {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0px;
                color: white;
                white-space: nowrap;
                z-index: 11;
                margin-top: 10px;
                background: #000000;
                background-color: black;
            }
            
            .nav-item {
                padding: 6px 2px;
                border-radius: 8px;
                transition: all 0.3s ease;
                cursor: pointer;
                font-size: 12px;
            }
            
            .nav-item:hover {
                color: #84cc16;
            }

            .nav-text {
                font-size: 12px;
                font-weight: 500;
            }
            
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            
            /* Overlay de consejos y estudios como p√°gina completa */
            #consejosEstudiosOverlay {
                background: #0a0a0a;
                display: none;
            }
            
            #consejosEstudiosOverlay[style*="display: block"] {
                display: block !important;
            }
            
            /* Estilos espec√≠ficos para la p√°gina de Consejos y Estudios */
            .consejos-estudios-page {
                background: #0a0a0a;
            }
            
            .consejos-estudios-page::-webkit-scrollbar {
                width: 10px;
            }
            
            .consejos-estudios-page::-webkit-scrollbar-track {
                background: #0a0a0a;
            }
            
            .consejos-estudios-page::-webkit-scrollbar-thumb {
                background: #262626;
                border-radius: 5px;
            }
            
            .consejos-estudios-page::-webkit-scrollbar-thumb:hover {
                background: #404040;
            }
            
            .article-card {
                background: #171717;
                border: 1px solid #262626;
            }
            
            .article-card:hover {
                border-color: #84cc16;
                box-shadow: 0 10px 30px rgba(132, 204, 22, 0.1);
                transform: scale(1.02);
            }
            
            .overlay-content {
                background: #000000; /* Negro puro - m√°s oscuro */
                color: white;
                padding: 40px;
                border-radius: 15px;
                max-width: 90%;
                width: 800px;
                max-height: 85vh;
                overflow-y: auto;
                position: relative;
                border: 1px solid #1a1a1a; /* Borde m√°s sutil contra fondo negro */
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            }
            
            .overlay-content.large {
                width: 95%;
                max-width: 1400px;
            }
            
            .overlay-content::-webkit-scrollbar {
                width: 8px;
            }
            
            .overlay-content::-webkit-scrollbar-track {
                background: #000000; /* Negro puro para el track */
            }
            
            .overlay-content::-webkit-scrollbar-thumb {
                background: #1a1a1a; /* Gris muy oscuro para el thumb */
                border-radius: 4px;
            }
            
            .overlay-content::-webkit-scrollbar-thumb:hover {
                background: #262626; /* Gris un poco m√°s claro al hover */
            }
            
            .close-btn {
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 32px;
                cursor: pointer;
                color: #888;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }
            
            .close-btn:hover {
                color: #84cc16;
                background: rgba(132, 204, 22, 0.1);
            }
            
            .overlay-content h2 {
                color: #ffffff;
                margin-bottom: 30px;
                font-size: 28px;
                font-weight: 600;
                padding-right: 50px;
            }
            
            .overlay-content h3 {
                color: #84cc16;
                margin-top: 30px;
                margin-bottom: 15px;
                font-size: 20px;
                font-weight: 600;
            }
            
            .overlay-content h4 {
                color: #ccc;
                margin-top: 20px;
                margin-bottom: 10px;
                font-size: 16px;
                font-weight: 600;
            }
            
            .overlay-content p {
                color: #e0e0e0;
                line-height: 1.8;
                margin-bottom: 15px;
                font-size: 15px;
            }
            
            .overlay-content ul {
                color: #e0e0e0;
                line-height: 1.8;
                margin-bottom: 15px;
                padding-left: 25px;
            }
            
            .overlay-content li {
                margin-bottom: 8px;
                font-size: 15px;
            }
            
            .overlay-content strong {
                color: #84cc16;
            }

            /* Forzar texto completamente blanco en el overlay de "Qui√©nes somos" */
            #aboutOverlay .overlay-content h3,
            #aboutOverlay .overlay-content h4,
            #aboutOverlay .overlay-content p,
            #aboutOverlay .overlay-content ul,
            #aboutOverlay .overlay-content li,
            #aboutOverlay .overlay-content strong {
                color: #ffffff !important;
            }
            
            /* Forzar texto completamente blanco en el overlay de "T√©rminos y Privacidad" */
            #terminosPrivacidadOverlay .overlay-content h3,
            #terminosPrivacidadOverlay .overlay-content h4,
            #terminosPrivacidadOverlay .overlay-content p,
            #terminosPrivacidadOverlay .overlay-content ul,
            #terminosPrivacidadOverlay .overlay-content li,
            #terminosPrivacidadOverlay .overlay-content strong {
                color: #ffffff !important;
            }
            
            .isPremium-lock {
                position: relative;
                opacity: 0.5;
                pointer-events: none;
            }
            
            .upgrade-notice {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                padding: 15px;
                border-radius: 10px;
                margin: 20px 0;
            }
            
            .upgrade-btn {
                background: transparent;
                color: #84cc16;
                border: 1px solid #84cc16;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
                transition: all 0.3s ease;
            }
            
            .upgrade-btn:hover {
                background: #84cc16;
                color: white;
                transform: translateY(-1px);
            }
            
            .download-btn {
                background: #3b82f6;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }
            
            .download-btn:hover {
                background: #1d4ed8;
            }
            
            .download-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }
            
            .nav-separator {
                color: #666;
                font-size: 12px;
                opacity: 0.5;
            }
            
            .logout-btn {
                background: #333333;
                color: white;
                border: 1px solid #666;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s ease;
            }
            
            .logout-btn:hover {
                background: #444444;
                border-color: #777;
            }

            /* Controles m√≥viles - eliminados, ahora en sidebar */
            .mobile-controls {
                display: none !important;
            }

            /* Gym Image Container */
            .gym-image-container {
                position: absolute;
                top: 50%;
                right: 20px;
                transform: translateY(-50%);
                width: 500px;
                height: 450px;
                border-radius: 20px;
                overflow: hidden;
                background: transparent;
                border: none;
            }

            .gym-image {
                width: 100%;
                height: 100%;
                object-fit: contain;
                border-radius: 20px;
                filter: brightness(0.9) contrast(1.6) saturate(1.3);
                transition: all 0.4s ease;
                background: transparent;
            }

            .gym-image:hover {
                transform: scale(1.05);
                filter: brightness(1.1) contrast(1.7) saturate(1.4);
            }

            /* Responsive adjustments */
            @media (max-width: 1600px) {
                .gym-image-container {
                    width: 400px;
                    height: 360px;
                    right: 15px;
                }
            }

            @media (max-width: 1400px) {
                .gym-image-container {
                    width: 350px;
                    height: 320px;
                    right: 10px;
                }
            }

            @media (max-width: 1200px) {
                .gym-image-container {
                    display: none;
                }
            }
            
                .overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.85);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }

                .overlay-content {
                    background: #111111;
                    color: white;
                    border-radius: 12px;
                    padding: 25px;
                    max-width: 95%;
                    width: 100%;
                    max-height: 85vh;
                    overflow-y: auto;
                    border: 1px solid #333;
                    position: relative;
                }
                
                .overlay-content h2 {
                    font-size: 22px;
                    padding-right: 40px;
                }
                
                .overlay-content h3 {
                    font-size: 18px;
                }
                
                .overlay-content p, .overlay-content li {
                    font-size: 14px;
                }

            .overlay-content.large {
                max-width: 1200px;
                max-height: 85vh;
            }

            .tab-content-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
                margin-top: 1.5rem;
            }

            .content-column {
                background: #0a0a0a; /* Negro muy oscuro - m√°s oscuro que el gris claro anterior */
                border: 1px solid #1a1a1a; /* Borde m√°s sutil */
                border-radius: 12px;
                padding: 1.5rem;
            }

            .content-column h3 {
                color: #ffffff;
                margin-bottom: 1rem;
                font-size: 1.2rem;
                font-weight: 600;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 0.5rem;
            }

            .close-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: none;
                border: none;
                color: #fff;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.5rem;
                border-radius: 50%;
                transition: background 0.3s ease;
            }

            .close-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .overlay-content h2 {
                color: #ffffff;
                margin-bottom: 1rem;
                font-size: 1.5rem;
            }

            .overlay-content p {
                color: #ccc;
                line-height: 1.6;
            }

            /* Estilos para contenido de rutina */
            .routine-item {
                background: rgba(132, 204, 22, 0.05);
                border: 1px solid rgba(132, 204, 22, 0.2);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .routine-day {
                color: #84cc16;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .exercise {
                margin: 0.5rem 0;
                padding: 0.5rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 6px;
            }

            .exercise-name {
                font-weight: 500;
                margin-bottom: 0.25rem;
            }

            .exercise-details {
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.7);
            }

            /* Estilos para contenido de dieta */
            .macros-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .macro-card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 1rem;
                text-align: center;
            }

            .macro-value {
                font-size: 1.5rem;
                font-weight: 700;
                color: #84cc16;
                display: block;
            }

            .macro-label {
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.7);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .meal-card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .meal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            .meal-time {
                font-size: 0.8rem;
                color: #84cc16;
                background: rgba(132, 204, 22, 0.1);
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
            }

            .meal-name {
                font-weight: 500;
            }

            .food-item {
                display: flex;
                justify-content: space-between;
                padding: 0.25rem 0;
                font-size: 0.9rem;
            }

            .blur-content {
                filter: blur(5px);
                user-select: none;
                pointer-events: none;
                opacity: 0.6;
            }

            /* Estilos para consejos - Dise√±o Scientific Card Moderno */
            .advice-card {
                background: #ffffff;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 16px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                border-left: 4px solid #009688;
                transition: all 0.3s ease;
            }

            .advice-card:hover {
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
                transform: translateY(-2px);
            }

            .advice-card.locked {
                background: #f8f9fa;
                border-left-color: #cbd5e1;
                position: relative;
                overflow: hidden;
            }

            .advice-title {
                color: #1a1a1a;
                font-weight: 700;
                margin-bottom: 8px;
                font-size: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .advice-title::before {
                content: 'üí°';
                font-size: 18px;
                color: #009688;
            }

            .advice-content {
                color: #333333;
                line-height: 1.6;
                font-size: 14px;
            }

            .advice-card.locked .advice-content {
                filter: blur(2px);
                user-select: none;
                pointer-events: none;
            }

            .advice-card.locked::after {
                content: 'PRO';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 150, 136, 0.95);
                color: white;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 700;
                box-shadow: 0 2px 8px rgba(0, 150, 136, 0.3);
            }

            /* Estilos para estudios */
            .study-card {
                background: rgba(59, 130, 246, 0.05);
                border: 1px solid rgba(59, 130, 246, 0.2);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .study-title {
                color: #3b82f6;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .study-content {
                color: rgba(255, 255, 255, 0.9);
                line-height: 1.6;
                margin-bottom: 0.75rem;
            }

            .study-meta {
                border-top: 1px solid rgba(59, 130, 246, 0.2);
                padding-top: 0.75rem;
                font-size: 0.8rem;
            }

            .study-author {
                color: #84cc16;
                font-weight: 600;
                display: block;
                margin-bottom: 0.25rem;
            }

            .study-journal {
                color: rgba(255, 255, 255, 0.6);
                font-style: italic;
            }

            /* Estilos para enlaces de estudios */
            .study-card a {
                transition: all 0.2s ease;
            }

            .study-card a:hover {
                background: rgba(59, 130, 246, 0.2) !important;
                border-color: rgba(59, 130, 246, 0.5) !important;
                transform: translateY(-1px);
            }

            /* Premium overlay */
            .isPremium-overlay {
                position: relative;
                overflow: hidden;
            }

            .isPremium-overlay::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
                border-radius: 8px;
            }

            .isPremium-badge {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                color: white;
                padding: 1.5rem 2.5rem;
                border-radius: 12px;
                font-weight: 600;
                z-index: 10;
                text-align: center;
                box-shadow: 0 8px 32px rgba(132, 204, 22, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
                min-width: 300px;
                max-width: 90%;
            }

            .isPremium-badge h4 {
                margin-bottom: 0.75rem;
                font-size: 1.25rem;
                font-weight: 700;
                letter-spacing: 0.5px;
            }

            .isPremium-badge p {
                font-size: 0.95rem;
                opacity: 0.95;
                margin-bottom: 1.25rem;
                line-height: 1.5;
            }

            .isPremium-btn {
                background: rgba(255, 255, 255, 0.25);
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.4);
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 0.95rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .isPremium-btn:hover {
                background: rgba(255, 255, 255, 0.35);
                border-color: rgba(255, 255, 255, 0.6);
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            }

            .isPremium-btn:active {
                transform: translateY(0);
            }

            /* ESTILOS UNIFICADOS PREMIUM LOCK */
            .premium-lock-container {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
                z-index: 10;
                text-align: center;
            }
            
            .premium-lock-card {
                background: rgba(20, 20, 20, 0.95);
                border: 1px solid rgba(132, 204, 22, 0.3);
                border-radius: 16px;
                padding: 30px 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(132, 204, 22, 0.1);
                backdrop-filter: blur(10px);
            }

            .premium-icon-wrapper {
                width: 50px;
                height: 50px;
                background: rgba(132, 204, 22, 0.1);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 15px auto;
                border: 1px solid rgba(132, 204, 22, 0.2);
            }

            .premium-title {
                color: white;
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 8px;
            }

            .premium-subtitle {
                color: #a0a0a0;
                font-size: 14px;
                margin-bottom: 24px;
                line-height: 1.5;
            }

            .premium-btn-unified {
                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 700;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.3s ease;
                width: 100%;
                box-shadow: 0 4px 15px rgba(132, 204, 22, 0.3);
            }

            .premium-btn-unified:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(132, 204, 22, 0.5);
                background: linear-gradient(135deg, #95d624 0%, #76bd1d 100%);
            }

            /* Responsive */
            @media (max-width: 768px) {
                .tab-content-grid {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }
                
                /* Aumentar espacio de la columna de dieta en m√≥vil */
                .content-column:last-child {
                    min-width: 100%;
                    flex: 1.2; /* Dar m√°s espacio a la dieta */
                    padding: 1.8rem; /* Aumentado de 1.5rem a 1.8rem para m√°s espacio */
                }
                
                #dietaContent {
                    font-size: 16px; /* Tama√±o base m√°s grande para la dieta */
                    line-height: 1.7; /* Mejor espaciado entre l√≠neas */
                }

                .overlay-content.large {
                    max-width: 95%;
                    margin: 1rem;
                }

                .macros-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* ========== RESPONSIVE DESIGN - SOLO M√ìVIL ========== */
            @media (max-width: 768px) {
                /* Forzar que todo quepa en viewport m√≥vil sin scroll */
                html, body {
                    height: 100vh;
                    height: 100dvh; /* Soporte para navegadores modernos */
                    overflow: hidden; /* Prevenir scroll vertical */
                    position: fixed; /* Fijar posici√≥n */
                    width: 100%;
                    overscroll-behavior: none; /* Prevenir bounce scroll en iOS Safari */
                    -webkit-overflow-scrolling: touch;
                    background: #000000 !important; /* Negro puro */
                    background-color: #000000 !important;
                }
                
                /* Prevenir zoom al hacer focus en inputs en iOS */
                input, textarea {
                    font-size: 16px !important; /* M√≠nimo 16px previene zoom */
                }
                
                /* Layout general - cambiar a una columna */
                body {
                    overflow-x: hidden;
                    background: #000000 !important; /* Negro puro */
                    background-color: #000000 !important;
                }

                /* PASO 1: Estructura superior m√≥vil */
                /* Hamburger - alineado con logo */
                .hamburger-btn {
                    position: absolute;
                    top: 85px; /* Subido un poco */
                    left: 20px;
                    width: 44px; /* √Årea t√°ctil grande */
                    height: 44px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    background: transparent;
                    border: none;
                    cursor: pointer;
                    font-size: 24px;
                }
                
                .hamburger-btn svg {
                    width: 28px; /* Icono proporcionado */
                    height: 28px;
                }
                
                /* Logo - centrado horizontalmente, m√°s grande */
                .logo {
                    position: absolute;
                    top: 24px; /* Misma altura que hamburger */
                    left: 50%;
                    transform: translateX(-50%); /* Centrado horizontal */
                    display: flex;
                    align-items: center;
                    gap: 12px; /* M√°s espacio entre icono y texto */
                    z-index: 3;
                    justify-content: center;
                    margin-bottom: 0;
                }
                
                .sidebar {
                    width: 260px;
                }
                

                .dna-icon {
                    width: 44px; /* M√°s grande: 32px ‚Üí 44px */
                    height: 44px;
                    flex-shrink: 0;
                }

                .logo-text {
                    font-size: 26px; /* M√°s grande: 20px ‚Üí 26px */
                    font-weight: 800;
                    letter-spacing: -0.5px;
                    line-height: 1;
                    display: flex;
                    align-items: center;
                    white-space: nowrap;
                }

                .logo-text .your-gains {
                    margin-right: 8px;
                }

                .logo-text .ai {
                    margin-left: 0;
                }

                /* Navegaci√≥n - debajo del logo, centrada y m√°s grande */
                .header-section {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 180px; /* M√°s alto para acomodar logo y nav m√°s grandes */
                    min-height: 180px;
                    padding: 24px 20px 20px 20px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: flex-start;
                    z-index: 100;
                    background: #000000;
                    border-bottom: 1px solid #1a1a1a;
                }
                
                .navigation {
                    position: absolute;
                    top: 90px; /* Debajo del logo (24px top + 44px height + 22px gap) */
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 20px; /* M√°s espacio entre items */
                    width: auto;
                    z-index: 10;
                    margin-top: 0;
                }

                .nav-item {
                    font-size: 17px; /* M√°s grande: 14px ‚Üí 17px */
                    font-weight: 600;
                    padding: 8px 0; /* M√°s padding para mejor t√°ctil */
                    letter-spacing: 0.2px;
                    min-height: 40px;
                    display: flex;
                    align-items: center;
                    white-space: nowrap;
                    flex-shrink: 0;
                    transition: all 0.3s ease;
                }

                .nav-separator {
                    display: inline;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 17px; /* Mismo tama√±o que items */
                    margin: 0 8px;
                    font-weight: 600;
                    opacity: 0.4;
                }

                /* Controles m√≥viles - mostrar y posicionar */
                .mobile-controls {
                    display: flex;
                    position: fixed;
                    bottom: 15px;
                    right: 15px;
                    gap: 8px;
                    z-index: 1000;
                }

                .mobile-controls .upgrade-btn,
                .mobile-controls .logout-btn {
                    padding: 8px 12px;
                    font-size: 12px;
                    border-radius: 8px;
                    min-height: 36px;
                    white-space: nowrap;
                }

                /* Estilos espec√≠ficos para botones m√≥viles */
                .mobile-controls .upgrade-btn {
                    background: transparent;
                    color: #84cc16;
                    border: 1px solid #84cc16;
                    transition: all 0.3s ease;
                }

                .mobile-controls .upgrade-btn:hover {
                    background: #84cc16;
                    color: white;
                    transform: translateY(-1px);
                }

                .mobile-controls .logout-btn {
                    padding: 8px 12px;
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.8);
                    cursor: pointer;
                    border-radius: 8px;
                    min-height: 36px;
                    white-space: nowrap;
                    display: flex;
                    align-items: center;
                    transition: all 0.3s ease;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }

                .mobile-controls .logout-btn:hover {
                    color: #84cc16;
                    background: rgba(255, 255, 255, 0.2);
                    transform: translateY(-1px);
                }

                .mobile-controls .nav-item {
                    padding: 8px 12px;
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.8);
                    cursor: pointer;
                    border-radius: 8px;
                    min-height: 36px;
                    white-space: nowrap;
                    display: flex;
                    align-items: center;
                    transition: all 0.3s ease;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }

                .mobile-controls .nav-item:hover {
                    color: #84cc16;
                    background: rgba(255, 255, 255, 0.2);
                    transform: translateY(-1px);
                }

                /* Fondo negro absoluto */
                body {
                    background-color: #000000 !important;
                    background-image: none !important;
                }

                /* Ocultar el contenedor de imagen original */
                .gym-image-container {
                    display: none;
                }

                /* Chat Container - dise√±o profesional oscuro */
                .chat-container {
                    position: fixed;
                    top: 210px; /* Bajado un poco m√°s para reducir altura del chat */
                    left: 0;
                    right: 0;
                    bottom: 0; /* Pegado al fondo */
                    width: 100%;
                    height: calc(100vh - 210px); /* Altura reducida a√∫n m√°s */
                    z-index: 2;
                    background: #000000 !important; /* Negro puro forzado */
                    border-radius: 0;
                    box-shadow: none;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    border: none;
                    margin: 0;
                    padding: 0;
                }

                .chat-header {
                    display: none;
                }

                .chat-messages {
                    padding: 20px;
                    font-size: 14px;
                    background: #000000 !important; /* Negro puro forzado */
                    flex: 1; /* Ocupar todo el espacio disponible menos el input */
                    overflow-y: auto;
                    overflow-x: hidden;
                    min-height: 0;
                    line-height: 1.4;
                    scrollbar-width: thin;
                    scrollbar-color: #333 #000;
                    height: auto; /* Dejar que flex controle la altura */
                }
                
                .chat-messages::-webkit-scrollbar {
                    width: 6px;
                }
                
                .chat-messages::-webkit-scrollbar-track {
                    background: #000000;
                }
                
                .chat-messages::-webkit-scrollbar-thumb {
                    background: #333;
                    border-radius: 3px;
                }
                
                .chat-input-area {
                    flex-shrink: 0;
                    padding: 12px 16px 20px 16px; /* M√°s padding inferior: 16px ‚Üí 20px */
                    background: #000000 !important; /* Negro puro forzado */
                    border-top: 1px solid #1a1a1a;
                    position: relative;
                    bottom: 0;
                    width: 100%;
                    box-sizing: border-box;
                    min-height: 70px;
                    display: flex;
                    align-items: center;
                }

                .input-placeholder {
                    color: #666;
                    font-style: italic;
                    text-align: center;
                    padding: 40px 20px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: color 0.3s ease;
                }

                .input-placeholder:hover {
                    color: #888;
                }

                .input-row {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    width: 100%;
                }

                .chat-input {
                    width: 100%;
                    min-height: 48px; /* √Årea t√°ctil grande */
                    padding: 12px 16px;
                    font-size: 16px !important; /* Prevenir zoom en iOS */
                    background: #000000 !important; /* Negro puro */
                    border: 1px solid #1a1a1a; /* Border m√°s sutil contra negro puro */
                    border-radius: 12px;
                    color: #ffffff;
                    outline: none;
                    flex: 1;
                    font-family: inherit;
                    line-height: 1.5;
                    text-align: left;
                    transition: all 0.15s ease-in-out;
                    width: 100%;
                    resize: none;
                    overflow-y: hidden;
                    overflow-x: hidden;
                    white-space: pre-wrap;
                    word-break: break-word;
                    min-height: 44px;
                    max-height: 180px;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                }
                
                .chat-input::-webkit-scrollbar {
                    display: none;
                }
                
                .chat-input-max {
                    overflow-y: auto;
                }
                
                .chat-input-max::-webkit-scrollbar {
                    display: none;
                }

                .chat-input::placeholder {
                    color: #777;
                    font-weight: 400;
                }
                
                .chat-input:focus {
                    outline: none;
                    border-color: #84cc16;
                }
                
                .chat-input:disabled {
                    background: #0a0a0a;
                    color: #666;
                    cursor: not-allowed;
                    border-color: #1a1a1a;
                    opacity: 0.6;
                }
                
                .chat-input:disabled::placeholder {
                    color: #555;
                }

                .send-btn {
                    width: 44px;
                    height: 44px;
                    background: #000000;
                    border: 1px solid #1a1a1a;
                    border-radius: 50%;
                    color: white;
                    cursor: not-allowed;
                    transition: all 0.15s ease-in-out;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                    padding: 0;
                }
                
                .send-btn svg {
                    width: 20px;
                    height: 20px;
                    stroke: white;
                    transition: stroke 0.15s ease-in-out, filter 0.15s ease-in-out;
                }

                .send-btn:hover {
                    background: #0d0d0d;
                }
                
                .send-btn:hover svg {
                    stroke: #b3ff00;
                    filter: drop-shadow(0 0 4px #b3ff00);
                }
                
                .send-btn:active {
                    background: #1a1a1a;
                    box-shadow: 0 0 6px #b3ff00;
                }
                
                .send-btn:active svg {
                    stroke: #b3ff00;
                }

                .send-btn.active {
                    background: #000000;
                    color: white;
                    cursor: pointer;
                }

                .send-btn.active:hover {
                    background: #0d0d0d;
                }
                
                .send-btn.active:hover svg {
                    stroke: #b3ff00;
                    filter: drop-shadow(0 0 4px #b3ff00);
                }
                
                .send-btn.active:active {
                    background: #1a1a1a;
                    box-shadow: 0 0 6px #b3ff00;
                }
                
                .send-btn.active:active svg {
                    stroke: #b3ff00;
                }

                .send-btn:disabled {
                    background: #000000;
                    color: #666;
                    cursor: not-allowed;
                    opacity: 0.5;
                }
                
                .send-btn:disabled:hover {
                    background: #000000;
                }
                
                .send-btn:disabled:hover svg {
                    filter: none;
                }


                /* Estilos para mensajes */
                .message {
                    margin-bottom: 8px;
                    padding: 10px 12px;
                    border-radius: 12px;
                    font-size: 14px;
                    line-height: 1.4;
                    max-width: 85%;
                    word-wrap: break-word;
                }

                .user-message {
                    background: #84cc16;
                    color: #000000;
                    margin-left: auto;
                    font-weight: 500;
                }

                .ai-message {
                    background: #111111;
                    color: #ffffff;
                    margin-right: auto;
                    border: 1px solid #333;
                }

                /* Indicador de escritura para m√≥vil */
                .typing-indicator {
                    background: #111111;
                    color: #84cc16;
                    border: 1px solid #333;
                }


                /* Overlays - ajustar para m√≥vil */
                .overlay {
                    padding: 20px;
                }

                .overlay-content {
                    padding: 20px;
                    border-radius: 16px;
                    max-width: 95%;
                    max-height: 90%;
                }

                .close-btn {
                    top: 15px;
                    right: 20px;
                    width: 36px;
                    height: 36px;
                    min-height: 44px; /* T√°ctil */
                    min-width: 44px;
                }

                /* Contenido de overlays - m√°s compacto */
                .tab-content-grid {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }

                .content-column {
                    padding: 15px;
                }

                .routine-item, .meal-card, .advice-card, .study-card {
                    padding: 12px;
                    margin-bottom: 10px;
                    border-radius: 8px;
                }

                .routine-day, .meal-header, .advice-title, .study-title {
                    font-size: 14px;
                    margin-bottom: 8px;
                }

                .exercise-name, .meal-name {
                    font-size: 13px;
                }

                .exercise-details {
                    font-size: 12px;
                }
                
                .food-item {
                    font-size: 14px; /* Reducido para que quepa en una l√≠nea con calor√≠as */
                    font-weight: 500; /* Hacer el texto un poco m√°s grueso */
                }

                .macros-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                    margin-bottom: 15px;
                }

                .macro-card {
                    padding: 8px;
                    border-radius: 6px;
                }

                .macro-value {
                    font-size: 16px;
                }

                .macro-label {
                    font-size: 11px;
                }

                .isPremium-btn {
                    padding: 10px 16px;
                    border-radius: 8px;
                    font-size: 12px;
                    min-height: 44px; /* T√°ctil */
                    margin-top: 10px;
                }
            }

            /* Responsive para cards de consejos y estudios */
            @media (max-width: 1200px) {
                #consejosEstudiosContent {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
            }
            @media (max-width: 768px) {
                #consejosEstudiosContent {
                    grid-template-columns: 1fr !important;
                }
            }
            
            /* Centrado mejorado para el contenedor de consejos y estudios */
            #consejosEstudiosOverlay main {
                max-width: 1150px !important;
                margin: 0 auto 0 60px !important;
                padding-left: 40px !important;
                padding-right: 40px !important;
                width: calc(100% - 60px) !important;
            }
            
            @media (max-width: 1400px) {
                #consejosEstudiosOverlay main {
                    padding-left: 35px !important;
                    padding-right: 35px !important;
                }
            }
            
            @media (max-width: 1200px) {
                #consejosEstudiosOverlay main {
                    padding-left: 30px !important;
                    padding-right: 30px !important;
                }
            }
            
            @media (max-width: 768px) {
                #consejosEstudiosOverlay main {
                    padding-left: 20px !important;
                    padding-right: 20px !important;
                }
            }

            /* ============================================
               DESKTOP LAYOUT - Chat Container Reducido
               ============================================ */
            @media (min-width: 1200px) {
                .chat-container {
                    position: fixed;
                    left: 280px;
                    right: 20px;
                    bottom: 20px;
                    width: auto;
                    height: 560px;
                    max-height: 560px;
                    min-height: 450px;
                    margin: 0;
                    padding: 0;
                    background: rgba(10, 10, 10, 0.4); /* Fondo semi-transparente MUY sutil */
                    border: none; /* SIN borde */
                    border-radius: 0; /* Sin esquinas redondeadas */
                    box-shadow: none; /* SIN sombra */
                    overflow: hidden;
                    z-index: 100;
                    backdrop-filter: blur(8px); /* Blur muy sutil para legibilidad */
                }
                
                .chat-messages {
                    padding: 20px 18px 120px 18px; /* M√°s padding inferior: 16px ‚Üí 120px */
                    height: calc(100% - 80px);
                    overflow-y: auto;
                    overflow-x: hidden;
                    background: transparent; /* Mantener transparente para mensajes */
                    scroll-behavior: smooth;
                }
                
                .chat-input-area {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    padding: 20px 24px 24px 24px;
                    background: #000000; /* Fondo negro S√ìLIDO - NO transparent */
                    border-top: 1px solid #1a1a1a; /* Borde sutil superior */
                    z-index: 10; /* Asegurar que est√© por encima de mensajes */
                }
                
                /* Gradient fade above input area */
                .chat-input-area::before {
                    content: '';
                    position: absolute;
                    top: -40px; /* 40px fade above input */
                    left: 0;
                    right: 0;
                    height: 40px;
                    background: linear-gradient(to bottom,
                        transparent 0%,
                        rgba(0, 0, 0, 0.5) 50%,
                        #000000 100%
                    );
                    pointer-events: none; /* No bloquear clicks */
                    z-index: 5;
                }
                
                .chat-input {
                    background: #0a0a0a; /* Fondo oscuro S√ìLIDO */
                    border: 1px solid #262626;
                    border-radius: 12px;
                    padding: 12px 16px;
                    color: #ffffff;
                    font-size: 15px;
                    width: 100%;
                    min-height: 48px;
                }
                
                .chat-input:focus {
                    outline: none;
                    border-color: #84cc16;
                    background: #0d0d0d; /* Ligeramente m√°s claro al focus */
                }
                
                /* Navegaci√≥n con letras m√°s grandes y posicionada a la derecha del logo */
                .navigation {
                    position: fixed;
                    left: calc(50% + 100px);
                    top: 65px;
                    transform: translateX(0);
                    width: auto;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 25px;
                    margin: 0;
                    padding: 0;
                    z-index: 99;
                }
                
                .nav-item {
                    font-size: 26px !important;
                    font-weight: 600;
                    padding: 10px 0;
                }
                
                .nav-separator {
                    font-size: 20px;
                }
                
                /* ========== LOGO - M√°s grande y desplazado a la izquierda ========== */
                .logo {
                    position: fixed !important;
                    left: calc(50% - 200px) !important;
                    top: 60px !important;
                    transform: translateX(-50%) !important;
                    margin-bottom: 0 !important;
                    margin-left: 0 !important;
                    gap: 12px;
                    z-index: 1001 !important;
                }
                
                .dna-icon {
                    width: 52px; /* M√°s grande: 40px ‚Üí 52px */
                    height: 52px;
                }
                
                .logo-text {
                    font-size: 34px; /* M√°s grande: 28px ‚Üí 34px */
                    font-weight: 800;
                    letter-spacing: -0.5px;
                }
                
                /* ========== SIDEBAR - Siempre visible en desktop ========== */
                .sidebar {
                    position: fixed !important;
                    left: 0 !important;
                    top: 0 !important;
                    width: 260px !important;
                    height: 100vh !important;
                    background: linear-gradient(180deg, #0a0a0a 0%, #000000 100%) !important;
                    border-right: 1px solid #1a1a1a !important;
                    transform: translateX(0) !important; /* Siempre visible, no hidden */
                    opacity: 1 !important;
                    visibility: visible !important;
                    z-index: 1000 !important;
                    overflow-y: auto !important;
                    box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3) !important;
                    padding: 40px 0 40px 0 !important;
                }
                
                .sidebar.open {
                    left: 0 !important; /* Mantener visible en desktop */
                }
                
                /* Ocultar overlay del sidebar en desktop (no es necesario) */
                .sidebar-overlay {
                    display: none !important;
                }
                
                /* Hamburger oculto en desktop */
                .hamburger-btn {
                    display: none !important;
                }
                
                /* Ocultar bot√≥n de cerrar del sidebar en desktop */
                .sidebar-close {
                    display: none !important;
                }
                
                /* Ajustar header del sidebar en desktop */
                .sidebar-header {
                    padding: 30px 20px 20px 20px !important;
                    border-bottom: 1px solid #1a1a1a !important;
                }
                
                /* Ajustar margen del contenido principal para dejar espacio al sidebar */
                .header-section {
                    margin-left: 260px !important;
                    padding-left: 60px !important;
                }
                
                .main-layout {
                    margin-left: 260px !important;
                }
                
                /* Ajustar tambi√©n el texto motivacional */
                .motivational-text {
                    margin-left: 0 !important;
                }
                
                /* Ajustar navegaci√≥n horizontal */
                .navigation {
                    margin-left: 0 !important;
                }
                
                /* Items del sidebar - estilos mejorados */
                .sidebar-item {
                    padding: 16px 28px !important;
                    margin: 4px 16px !important;
                    border-radius: 12px !important;
                    transition: all 0.3s ease !important;
                    border-left: 3px solid transparent !important;
                }
                
                .sidebar-item:hover {
                    background: rgba(132, 204, 22, 0.1) !important;
                    border-left-color: #84cc16 !important;
                    transform: translateX(4px) !important;
                }
                
                .sidebar-item.active {
                    background: rgba(132, 204, 22, 0.15) !important;
                    border-left-color: #84cc16 !important;
                }
                
                /* Iconos del sidebar */
                .sidebar-item svg {
                    width: 22px !important;
                    height: 22px !important;
                }
                
                /* Logout button en sidebar */
                .sidebar-item.logout-btn {
                    margin-top: auto !important;
                    color: #ef4444 !important;
                    border-left-color: transparent !important;
                }
                
                .sidebar-item.logout-btn:hover {
                    background: rgba(239, 68, 68, 0.1) !important;
                    border-left-color: #ef4444 !important;
                }
            }

            /* ============================================
               ESTILOS PARA OVERLAY DE PAGO PREMIUM
               ============================================ */
            .payment-overlay-content {
                background: rgba(23, 23, 23, 0.95);
                border: 1px solid #84cc16;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(132, 204, 22, 0.15);
                border-radius: 28px;
                padding: 28px 22px;
                width: 90%;
                margin: auto;
                text-align: center;
                backdrop-filter: blur(10px);
                animation: fadeInScale 0.5s ease-out;
                box-sizing: border-box;
            }

            /* Desktop: tarjeta m√°s compacta y elegante */
            @media (min-width: 768px) {
                .payment-overlay-content {
                    max-width: 450px;
                    padding: 40px 30px;
                }
            }

            @keyframes fadeInScale {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .dna-spinner {
                margin: 0 auto 20px;
                width: 60px;
                height: 60px;
                animation: pulse 2s ease-in-out infinite;
                max-width: 80px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .payment-overlay-content .dna-spinner svg {
                max-width: 80px;
                width: 100%;
                height: auto;
                display: block;
                margin: 0 auto;
            }

            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.7;
                    transform: scale(1.05);
                }
            }

            .payment-step {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                margin: 8px 0;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.05);
                transition: all 0.3s ease;
            }

            .payment-step.active {
                background: rgba(132, 204, 22, 0.1);
                border-color: rgba(132, 204, 22, 0.3);
            }

            .payment-step.completed {
                background: rgba(132, 204, 22, 0.15);
                border-color: rgba(132, 204, 22, 0.5);
            }

            .payment-step-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                font-weight: bold;
                font-size: 14px;
                flex-shrink: 0;
                transition: all 0.3s ease;
            }

            .payment-step-icon.pending {
                background: rgba(255, 255, 255, 0.05);
                color: rgba(255, 255, 255, 0.4);
            }

            .payment-step-icon.active {
                background: rgba(132, 204, 22, 0.2);
                color: #84cc16;
                animation: pulseIcon 1.5s ease-in-out infinite;
            }

            .payment-step-icon.completed {
                background: rgba(132, 204, 22, 0.3);
                color: #84cc16;
            }

            @keyframes pulseIcon {
                0%, 100% {
                    box-shadow: 0 0 0 0 rgba(132, 204, 22, 0.4);
                }
                50% {
                    box-shadow: 0 0 0 8px rgba(132, 204, 22, 0);
                }
            }

            .payment-step-text {
                flex: 1;
                text-align: left;
                font-size: 14px;
                transition: color 0.3s ease;
            }

            .payment-step-text.pending {
                color: rgba(255, 255, 255, 0.4);
            }

            .payment-step-text.active {
                color: rgba(255, 255, 255, 0.8);
            }

            .payment-step-text.completed {
                color: #84cc16;
                font-weight: 500;
            }

            .progress-indicator {
                margin-top: 24px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            .progress-container {
                width: 100%;
                background: #262626;
                border-radius: 10px;
                height: 8px;
                margin: 20px 0;
                overflow: hidden;
            }

            .progress-bar-container {
                width: 100%;
                height: 8px;
                background: #262626;
                border-radius: 10px;
                overflow: hidden;
                margin-top: 12px;
            }

            .progress-bar {
                width: 0%;
                height: 100%;
                background: linear-gradient(90deg, #84cc16, #a3e635);
                border-radius: 10px;
                transition: width 0.5s ease-in-out;
                box-shadow: 0 0 10px rgba(132, 204, 22, 0.5);
            }

            .progress-text {
                font-size: 14px;
                color: rgba(255, 255, 255, 0.7);
                margin-top: 12px;
                text-align: center;
                font-weight: 500;
                transition: opacity 0.3s ease, color 0.3s ease;
                min-height: 20px;
            }

            .progress-text.active {
                color: #84cc16;
            }

        </style>
    </head>
    <body>
        <div class="main-layout">
        <!-- Bot√≥n hamburger -->
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">‚ò∞</button>
        
        <!-- Overlay para el men√∫ lateral -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        
        <!-- Men√∫ lateral -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Men√∫</h3>
                <button class="sidebar-close" onclick="closeSidebar()">&times;</button>
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-item" onclick="handleUpgrade()">Mejora tu plan</div>
                <div class="sidebar-item has-submenu" onclick="toggleUserSubmenu()">
                    <span>Usuario</span>
                    <span class="submenu-arrow">‚ñ∂</span>
                </div>
                <div class="sidebar-submenu" id="userSubmenu">
                    <div class="sidebar-submenu-item" onclick="handleViewProfile()">Ver datos</div>
                    <div class="sidebar-submenu-item" onclick="handleNewRoutine()">Generar nuevo plan</div>
                </div>
                <div class="sidebar-item" onclick="handleAbout()">Qui√©nes somos</div>
                <div class="sidebar-item" onclick="handleTerms()">T√©rminos y privacidad</div>
                <div class="sidebar-item" onclick="handleLogout()">Cerrar sesi√≥n</div>
            </div>
        </aside>
        
        <div class="header-section">
            <div class="logo" style="left: 100px !important; transform: none !important;">
                <div class="dna-icon">
                    <svg viewBox="0 0 800 800" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
                        <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="your-gains">YourGains</span><span class="ai"> AI</span>
                </div>
            </div>

            <div class="navigation">
                <div class="nav-item" id="rutinaDieta">Rutina y Dieta</div>
                <div class="nav-separator">|</div>
                <div class="nav-item" id="consejosEstudios">Consejos y Estudios</div>
            </div>
        </div>

        <div class="chat-container">
            <!-- √Årea de mensajes scrolleable -->
            <div class="chat-messages" id="chatMessages">
            </div>
            
            <!-- √Årea de input fija abajo -->
            <div class="chat-input-area">
                <div class="input-row">
                <textarea id="chatInput" class="chat-input" maxlength="500" placeholder="Escribe tu mensaje..." rows="1"></textarea>
                <button id="sendBtn" class="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19V5" />
                    <path d="M5 12l7-7 7 7" />
                    </svg>
                </button>
                </div>
            </div>
        </div>

        <!-- Overlay para Rutina y Dieta -->
        <div class="overlay" id="rutinaDietaOverlay">
            <div class="overlay-content large">
                <button class="close-btn" onclick="closeOverlay('rutinaDietaOverlay')">&times;</button>
                <div class="tab-content-grid">
                    <div class="content-column">
                <div id="rutinaContent">
                    <p>Cargando rutina...</p>
                        </div>
                    </div>
                    <div class="content-column">
                        <div id="dietaContent">
                            <p>Cargando dieta...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay para Consejos y Estudios -->
        <div class="overlay" id="consejosEstudiosOverlay" style="background: #0a0a0a; overflow-y: auto; position: relative;">
            <!-- HEADER FIXED -->
            <header style="position: fixed; top: 0; left: 0; right: 0; z-index: 10000; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); border-bottom: 1px solid #262626;">
                <!-- Barra superior con logo y bot√≥n cerrar -->
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <!-- Logo izquierda -->
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="dna-icon" style="display: flex; align-items: center;">
                            <svg viewBox="0 0 800 800" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                                <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
                            </svg>
                        </div>
                        <span style="color: white; font-size: 18px; font-weight: bold;">
                            YourGains <span style="color: #84cc16;">AI</span>
                        </span>
                    </div>
                    
                    <!-- Bot√≥n cerrar derecha -->
                    <button onclick="closeOverlay('consejosEstudiosOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                
                <!-- T√≠tulo secci√≥n -->
                <div style="text-align: center; padding: 20px 20px 30px 20px;">
                    <h1 style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 8px;">Consejos y Estudios</h1>
                    <p style="font-size: 16px; color: #999;">Conocimiento cient√≠fico aplicado al fitness</p>
                </div>
            </header>
            
            <!-- SPACER para que el contenido no quede debajo del header -->
            <div style="height: 180px;"></div>
            
            <!-- CONTENEDOR DE CARDS -->
            <main style="max-width: 1150px; margin: 0 auto 0 60px; padding: 0 40px 40px 40px; position: relative; z-index: 1; width: calc(100% - 60px);">
                <div id="consejosEstudiosContent" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                    <!-- El contenido se carga din√°micamente aqu√≠ -->
                </div>
            </main>
        </div>

        <!-- Overlay para T√©rminos y Privacidad -->
        <div class="overlay" id="terminosPrivacidadOverlay" onclick="if(event.target === this) closeOverlay('terminosPrivacidadOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()">
                <button class="close-btn" onclick="closeOverlay('terminosPrivacidadOverlay')">&times;</button>
                <h2>T√©rminos de Servicio y Pol√≠tica de Privacidad</h2>
                <div id="terminosContent">
                    <!-- El contenido se carga din√°micamente -->
                </div>
            </div>
        </div>
        
        <!-- Overlay para Qui√©nes somos -->
        <div class="overlay" id="aboutOverlay" onclick="if(event.target === this) closeOverlay('aboutOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()">
                <button class="close-btn" onclick="closeOverlay('aboutOverlay')">&times;</button>
                <h2>Qui√©nes somos</h2>
                <div id="aboutContent">
                    <!-- El contenido se carga din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Overlay para Ver Datos del Perfil -->
        <div class="overlay" id="verDatosOverlay" onclick="if(event.target === this) closeOverlay('verDatosOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()" style="max-width: 1200px; margin: 0 auto; padding: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: white; font-size: 28px; font-weight: bold; margin: 0;">Mis Datos</h2>
                    <button class="close-btn" onclick="closeOverlay('verDatosOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                <div id="verDatosContent">
                    <!-- El contenido se cargar√° aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Overlay para Generar Rutina Nueva -->
        <div class="overlay" id="nuevaRutinaOverlay" onclick="if(event.target === this) closeOverlay('nuevaRutinaOverlay')">
            <div class="overlay-content" onclick="event.stopPropagation()" style="max-width: 1200px; margin: 0 auto; padding: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: white; font-size: 28px; font-weight: bold; margin: 0;">Generaci√≥n de rutina nueva</h2>
                    <button class="close-btn" onclick="closeOverlay('nuevaRutinaOverlay')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #404040; color: #a3a3a3; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#525252'; this.style.color='white'" onmouseout="this.style.borderColor='#404040'; this.style.color='#a3a3a3'">&times;</button>
                </div>
                <div id="nuevaRutinaContent">
                    <!-- El contenido se cargar√° aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Modal de Upgrade -->
        <div class="overlay" id="upgradeModal">
            <div class="overlay-content">
                <button class="close-btn" onclick="closeUpgradeModal()">&times;</button>
                <h2>üöÄ Mejora a Pro</h2>
                <div style="text-align: center; padding: 20px 0;">
                    <p style="font-size: 18px; margin-bottom: 20px; color: #84cc16; font-weight: 600;">
                        Has alcanzado el l√≠mite de mensajes gratuitos
                    </p>
                    <p style="margin-bottom: 30px; color: #ccc; line-height: 1.6;">
                        Para continuar chateando de forma ilimitada y desbloquear todas las funciones isPremium, mejora tu plan ahora.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="window.location.href='./tarifas.html'" 
                                style="background: #84cc16; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#65a30d'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='#84cc16'; this.style.transform='translateY(0)'">
                            Ver Planes
                        </button>
                        <button onclick="closeUpgradeModal()" 
                                style="background: transparent; color: #ccc; border: 1px solid #555; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.borderColor='#84cc16'; this.style.color='#84cc16'"
                                onmouseout="this.style.borderColor='#555'; this.style.color='#ccc'">
                            M√°s Tarde
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gym Image Container - Ocultado -->
        <div class="gym-image-container" style="display: none;">
        </div>
        </div>

        <script>
            // Funciones para el men√∫ lateral
            // Hamburger menu toggle (SOLO M√ìVIL)
            function toggleSidebar() {
                const isDesktop = window.innerWidth >= 1200;
                if (isDesktop) {
                    return; // No hacer nada en desktop, sidebar siempre visible
                }
                
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
            
            function closeSidebar() {
                const isDesktop = window.innerWidth >= 1200;
                if (isDesktop) {
                    return; // No hacer nada en desktop, sidebar siempre visible
                }
                
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
            
            // Manejar resize para desktop/mobile transitions
            window.addEventListener('resize', function() {
                const currentIsDesktop = window.innerWidth >= 1200;
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (currentIsDesktop) {
                    // Desktop: asegurar que sidebar est√© siempre visible
                    if (sidebar) {
                        sidebar.classList.add('open');
                    }
                    if (overlay) {
                        overlay.classList.remove('active');
                    }
                } else {
                    // M√≥vil: cerrar sidebar por defecto
                    if (sidebar) {
                        sidebar.classList.remove('open');
                    }
                    if (overlay) {
                        overlay.classList.remove('active');
                    }
                }
            });
            
            // Inicializar estado correcto al cargar
            if (window.innerWidth >= 1200) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.add('open');
                }
            }
            
            // Handlers del men√∫ lateral
            function handleUpgrade() {
                closeSidebar();
                window.location.href = './tarifas.html';
            }
            
            function toggleUserSubmenu() {
                const submenu = document.getElementById('userSubmenu');
                const menuItem = event.currentTarget;
                menuItem.classList.toggle('active');
                submenu.classList.toggle('open');
            }
            
            async function handleNewRoutine() {
                closeSidebar();
                
                try {
                    console.log('üîÑ handleNewRoutine llamado');
                    
                    // Esperar a que las funciones del m√≥dulo est√©n disponibles
                    let checkPremium = window.checkPremiumStatus;
                    let attempts = 0;
                    while (!checkPremium && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        checkPremium = window.checkPremiumStatus;
                        attempts++;
                    }
                    
                    if (!checkPremium) {
                        console.error('‚ùå checkPremiumStatus no est√° disponible');
                        alert('Error: Las funciones del sistema no est√°n cargadas. Por favor, recarga la p√°gina.');
                        return;
                    }
                    
                    // Verificar si es premium
                    const isPremium = await checkPremium();
                    console.log('üíé Usuario premium:', isPremium);
                    
                    if (!isPremium) {
                        // Mostrar modal de upgrade
                        // Esperar a que showPremiumModal est√© disponible
                        let showModal = window.showPremiumModal;
                        let attempts = 0;
                        while (!showModal && attempts < 10) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            showModal = window.showPremiumModal;
                            attempts++;
                        }
                        
                        if (showModal) {
                            showModal({
                                title: "Funci√≥n Premium",
                                message: "Generar rutinas personalizadas ilimitadas es una funci√≥n exclusiva para usuarios Premium.",
                                features: [
                                    "Rutinas personalizadas con IA",
                                    "Adaptaci√≥n autom√°tica a tu progreso",
                                    "Modificaciones ilimitadas via chat",
                                    "Planes nutricionales detallados"
                                ],
                                ctaText: "Actualizar a Premium",
                                ctaLink: "./tarifas.html"
                            });
                        } else {
                            // Fallback: redirigir a tarifas
                            alert('Esta funci√≥n es exclusiva para usuarios Premium. Redirigiendo a la p√°gina de tarifas...');
                            window.location.href = './tarifas.html';
                        }
                        return;
                    }
                    
                    // Si es premium, abrir overlay
                    const open = window.openOverlay;
                    if (!open) {
                        console.error('‚ùå openOverlay no est√° disponible');
                        alert('Error: No se puede abrir el formulario. Por favor, recarga la p√°gina.');
                        return;
                    }
                    
                    console.log('üìÇ Abriendo overlay nuevaRutinaOverlay');
                    open('nuevaRutinaOverlay');
                    
                    // Esperar a que el overlay se renderice y las funciones est√©n disponibles
                    let loadForm = window.loadNewRoutineForm;
                    attempts = 0;
                    while (!loadForm && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        loadForm = window.loadNewRoutineForm;
                        attempts++;
                    }
                    
                    if (loadForm) {
                        console.log('üìù Cargando formulario...');
                        await loadForm();
                        console.log('‚úÖ Formulario cargado');
                    } else {
                        console.error('‚ùå loadNewRoutineForm no est√° disponible despu√©s de esperar');
                        // Mostrar mensaje de error en el overlay
                        const contentDiv = document.getElementById('nuevaRutinaContent');
                        if (contentDiv) {
                            contentDiv.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Error al cargar el formulario. Por favor, recarga la p√°gina.</p>';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error en handleNewRoutine:', error);
                    alert('Error al abrir el formulario: ' + error.message);
                }
            }
            
            // Exponer funci√≥n globalmente
            window.handleNewRoutine = handleNewRoutine;
            
            // Funci√≥n para ver datos del perfil (solo lectura)
            async function handleViewProfile() {
                closeSidebar();
                
                try {
                    console.log('üë§ handleViewProfile llamado');
                    
                    // Abrir overlay
                    const open = window.openOverlay;
                    if (!open) {
                        console.error('‚ùå openOverlay no est√° disponible');
                        alert('Error: No se puede abrir la vista. Por favor, recarga la p√°gina.');
                        return;
                    }
                    
                    console.log('üìÇ Abriendo overlay verDatosOverlay');
                    open('verDatosOverlay');
                    
                    // Esperar a que el overlay se renderice y las funciones est√©n disponibles
                    let loadProfile = window.loadProfileView;
                    let attempts = 0;
                    while (!loadProfile && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        loadProfile = window.loadProfileView;
                        attempts++;
                    }
                    
                    if (loadProfile) {
                        console.log('üìù Cargando datos del perfil...');
                        await loadProfile();
                        console.log('‚úÖ Datos del perfil cargados');
                    } else {
                        console.error('‚ùå loadProfileView no est√° disponible despu√©s de esperar');
                        const contentDiv = document.getElementById('verDatosContent');
                        if (contentDiv) {
                            contentDiv.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Error al cargar los datos. Por favor, recarga la p√°gina.</p>';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error en handleViewProfile:', error);
                    alert('Error al abrir la vista: ' + error.message);
                }
            }
            
            // Exponer funci√≥n globalmente
            window.handleViewProfile = handleViewProfile;
            
            function handleAbout() {
                closeSidebar();
                openOverlay('aboutOverlay');
                loadAboutContent();
            }
            
            function handleTerms() {
                closeSidebar();
                openOverlay('terminosPrivacidadOverlay');
                loadTermsContent();
            }
            
            function handleLogout() {
                closeSidebar();
                logout();
            }
            
            // Forzar posici√≥n del logo y navegaci√≥n al cargar (SOLO M√ìVIL)
            document.addEventListener('DOMContentLoaded', function() {
                const isDesktop = window.innerWidth >= 1200;
                
                // SOLO aplicar estilos forzados en M√ìVIL y TABLET
                if (!isDesktop) {
                    // Forzar posici√≥n del logo en m√≥vil
                    const logo = document.querySelector('.logo');
                    if (logo) {
                        logo.style.cssText = 'position: absolute !important; top: 80px !important; left: 100px !important; transform: none !important; display: flex !important; align-items: center !important; gap: 3px !important;';
                    }
                    
                    // Forzar centrado de navegaci√≥n en m√≥vil
                    const nav = document.querySelector('.navigation');
                    if (nav) {
                        const currentTop = window.innerWidth <= 768 ? '170px' : '90px';
                        nav.style.cssText = `position: absolute !important; top: ${currentTop} !important; left: 50% !important; transform: translateX(-50%) !important; width: auto !important; display: flex !important; justify-content: center !important; align-items: center !important; gap: 0px !important; z-index: 10 !important;`;
                    }
                } else {
                    // DESKTOP (‚â•1200px): Limpiar estilos inline para que CSS media queries tomen control
                    const logo = document.querySelector('.logo');
                    if (logo) {
                        logo.removeAttribute('style');
                    }
                    
                    const nav = document.querySelector('.navigation');
                    if (nav) {
                        nav.removeAttribute('style');
                    }
                }
                
                // Manejar resize de ventana din√°micamente
                window.addEventListener('resize', function() {
                    const isDesktopResize = window.innerWidth >= 1200;
                    const logo = document.querySelector('.logo');
                    const nav = document.querySelector('.navigation');
                    
                    if (isDesktopResize) {
                        // Desktop: limpiar estilos inline para que CSS tome control
                        if (logo) logo.removeAttribute('style');
                        if (nav) nav.removeAttribute('style');
                    } else {
                        // M√≥vil/Tablet: aplicar estilos forzados
                        if (logo) {
                            logo.style.cssText = 'position: absolute !important; top: 80px !important; left: 100px !important; transform: none !important; display: flex !important; align-items: center !important; gap: 3px !important;';
                        }
                        if (nav) {
                            const currentTop = window.innerWidth <= 768 ? '170px' : '90px';
                            nav.style.cssText = `position: absolute !important; top: ${currentTop} !important; left: 50% !important; transform: translateX(-50%) !important; width: auto !important; display: flex !important; justify-content: center !important; align-items: center !important; gap: 0px !important; z-index: 10 !important;`;
                        }
                    }
                });
            });
        </script>
        
        <script type="module">
            import { API_BASE } from "./config.js";
            import { checkAuthOrRedirect, getAuthHeaders, logout, isTokenExpired, decodeJwt } from "./auth.js";

            // ==========================================
            // VERIFICACI√ìN DE PAGO AL CARGAR
            // ==========================================
            /**
             * Pantalla de loading con pasos mientras se verifica el pago y se genera el plan
             */
            // Overlay de pantalla completa bloqueante para verificaci√≥n de pago
            let paymentOverlayVisible = false;
            
            function showPaymentLoadingScreen() {
                // Si ya existe el overlay, no crear otro
                if (document.getElementById('payment-verification-overlay')) {
                    return;
                }
                
                paymentOverlayVisible = true;
                const overlay = document.createElement('div');
                overlay.id = 'payment-verification-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    z-index: 99999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    backdrop-filter: blur(10px);
                `;
                overlay.innerHTML = `
                    <div class="payment-overlay-content">
                        <!-- Logo DNA Spinner -->
                        <div class="dna-spinner">
                            <svg viewBox="0 0 800 800" width="60" height="60" xmlns="http://www.w3.org/2000/svg">
                                <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
                            </svg>
                        </div>

                        <!-- T√≠tulo -->
                        <h2 class="text-2xl font-bold text-white mb-3">¬°Pago Exitoso!</h2>
                        
                        <!-- Mensaje de Calidad -->
                        <p class="text-neutral-300 text-sm mb-6 leading-relaxed">
                            Estamos dise√±ando tu plan con <span class="text-lime-400 font-semibold">precisi√≥n cient√≠fica</span>. 
                            Nuestra IA est√° analizando tu perfil para <span class="text-lime-400 font-semibold">maximizar tus resultados</span>. 
                            Este proceso puede tardar hasta 2 minutos.
                        </p>

                        <!-- Indicadores de Progreso -->
                        <div class="space-y-2 mb-6">
                            <div id="step-payment" class="payment-step completed">
                                <div class="payment-step-icon completed">‚úì</div>
                                <div class="payment-step-text completed">Pago verificado</div>
                            </div>
                            <div id="step-premium" class="payment-step">
                                <div class="payment-step-icon pending">2</div>
                                <div class="payment-step-text pending">Activando premium...</div>
                            </div>
                            <div id="step-ai" class="payment-step">
                                <div class="payment-step-icon pending">3</div>
                                <div class="payment-step-text pending">Generando rutina con GPT-4o...</div>
                            </div>
                            <div id="step-diet" class="payment-step">
                                <div class="payment-step-icon pending">4</div>
                                <div class="payment-step-text pending">Creando plan nutricional...</div>
                            </div>
                        </div>

                        <!-- Indicador de Progreso -->
                        <div class="progress-indicator">
                            <div class="progress-text" id="progress-text">Iniciando proceso...</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progress-bar" style="width: 5%"></div>
                            </div>
                        </div>

                        <!-- Mensaje Final -->
                        <p class="mt-6 text-xs text-lime-400/80 font-medium">
                            ‚ú® Tu rutina se cargar√° autom√°ticamente al finalizar
                        </p>
                        <p class="mt-2 text-xs text-neutral-500">
                            ‚ö†Ô∏è Por favor, no cierres esta ventana
                        </p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            
            function hidePaymentLoadingScreen() {
                const overlay = document.getElementById('payment-verification-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.5s ease-out';
                    setTimeout(() => {
                        overlay.remove();
                        paymentOverlayVisible = false;
                    }, 500);
                }
            }

            /**
             * Actualiza los pasos visuales seg√∫n la respuesta del backend
             */
            function updatePaymentProgressUI(result) {
                // Paso 2: premium activado
                if (result && result.is_premium) {
                    const stepPremium = document.getElementById('step-premium');
                    if (stepPremium) {
                        stepPremium.classList.remove('pending');
                        stepPremium.classList.add('completed');
                        
                        const icon = stepPremium.querySelector('.payment-step-icon');
                        const text = stepPremium.querySelector('.payment-step-text');
                        
                        if (icon) {
                            icon.classList.remove('pending', 'active');
                            icon.classList.add('completed');
                            icon.textContent = '‚úì';
                        }
                        
                        if (text) {
                            text.classList.remove('pending', 'active');
                            text.classList.add('completed');
                            text.textContent = 'Premium activado ‚úì';
                        }
                    }
                }

                // Paso 3/4: plan generado
                if (result && result.plan_generated) {
                    const stepAi = document.getElementById('step-ai');
                    const stepDiet = document.getElementById('step-diet');

                    if (stepAi) {
                        stepAi.classList.remove('pending', 'active');
                        stepAi.classList.add('completed');
                        
                        const icon = stepAi.querySelector('.payment-step-icon');
                        const text = stepAi.querySelector('.payment-step-text');
                        
                        if (icon) {
                            icon.classList.remove('pending', 'active');
                            icon.classList.add('completed');
                            icon.textContent = '‚úì';
                        }
                        
                        if (text) {
                            text.classList.remove('pending', 'active');
                            text.classList.add('completed');
                            text.textContent = 'Rutina GPT-4o generada ‚úì';
                        }
                    }

                    if (stepDiet) {
                        stepDiet.classList.remove('pending', 'active');
                        stepDiet.classList.add('completed');
                        
                        const icon = stepDiet.querySelector('.payment-step-icon');
                        const text = stepDiet.querySelector('.payment-step-text');
                        
                        if (icon) {
                            icon.classList.remove('pending', 'active');
                            icon.classList.add('completed');
                            icon.textContent = '‚úì';
                        }
                        
                        if (text) {
                            text.classList.remove('pending', 'active');
                            text.classList.add('completed');
                            text.textContent = 'Plan nutricional creado ‚úì';
                        }
                    }
                }
            }

            /**
             * Actualiza el progreso visual con porcentaje y mensaje espec√≠fico
             */
            function setPaymentProgress(percentage, message) {
                const progressText = document.getElementById('progress-text');
                const progressBar = document.getElementById('progress-bar');
                
                if (!progressText || !progressBar) return;
                
                // Actualizar barra de progreso con transici√≥n suave
                progressBar.style.width = `${Math.min(percentage, 100)}%`;
                
                // Actualizar texto con transici√≥n suave
                progressText.style.opacity = '0';
                setTimeout(() => {
                    progressText.textContent = message;
                    progressText.classList.add('active');
                    progressText.style.opacity = '1';
                }, 150);
            }

            /**
             * Actualiza el indicador de progreso basado en los intentos de polling
             */
            function updatePaymentProgress(attempts, maxAttempts) {
                const progressText = document.getElementById('progress-text');
                const progressBar = document.getElementById('progress-bar');
                
                if (!progressText || !progressBar) return;
                
                // Calcular porcentaje basado en intentos (entre 60% y 85% durante polling)
                const basePercentage = 60;
                const pollingRange = 25; // 60% a 85%
                const pollingProgress = Math.min((attempts / maxAttempts) * pollingRange, pollingRange);
                const percentage = basePercentage + pollingProgress;
                
                // Actualizar barra de progreso
                progressBar.style.width = `${percentage}%`;
                
                // Actualizar texto seg√∫n la fase de polling
                if (attempts <= 8) {
                    // Fase RAG (60-70%)
                    progressText.textContent = `IA analizando tus datos cient√≠ficos (RAG)...`;
                    progressText.style.opacity = '1';
                } else {
                    // Fase GPT-4o (70-85%)
                    progressText.textContent = `GPT-4o redactando tu rutina y dieta personalizada...`;
                    progressText.style.opacity = '1';
                }
                
                // Activar visualmente el paso correspondiente
                if (attempts <= 5) {
                    const stepAi = document.getElementById('step-ai');
                    if (stepAi && !stepAi.classList.contains('completed')) {
                        stepAi.classList.add('active');
                        const icon = stepAi.querySelector('.payment-step-icon');
                        const text = stepAi.querySelector('.payment-step-text');
                        if (icon && !icon.classList.contains('completed')) {
                            icon.classList.remove('pending');
                            icon.classList.add('active');
                        }
                        if (text && !text.classList.contains('completed')) {
                            text.classList.remove('pending');
                            text.classList.add('active');
                        }
                    }
                } else {
                    const stepDiet = document.getElementById('step-diet');
                    if (stepDiet && !stepDiet.classList.contains('completed')) {
                        stepDiet.classList.add('active');
                        const icon = stepDiet.querySelector('.payment-step-icon');
                        const text = stepDiet.querySelector('.payment-step-text');
                        if (icon && !icon.classList.contains('completed')) {
                            icon.classList.remove('pending');
                            icon.classList.add('active');
                        }
                        if (text && !text.classList.contains('completed')) {
                            text.classList.remove('pending');
                            text.classList.add('active');
                        }
                    }
                }
            }
            
            /**
             * Verifica si la rutina premium est√° lista (generada por GPT, no template free)
             * Usa el campo is_premium_routine_ready del backend
             */
            async function checkRoutineReady(userId) {
                try {
                    const headers = getAuthHeaders();
                    if (!headers) {
                        return { ready: false, reason: 'no_auth' };
                    }
                    
                    const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        // Si es 401, es error de autenticaci√≥n
                        if (response.status === 401) {
                            return { ready: false, reason: 'no_auth' };
                        }
                        return { ready: false, reason: 'http_error', status: response.status };
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        return { ready: false, reason: 'no_routine' };
                    }
                    
                    // üéØ Usar el campo is_premium_routine_ready del backend
                    // Este campo ya verifica: is_premium, rutina no nula, no template free, tiene marcadores GPT
                    const isReady = data.is_premium_routine_ready === true;
                    
                    console.log(`üîç Verificaci√≥n rutina premium:`);
                    console.log(`   is_premium: ${data.is_premium}`);
                    console.log(`   is_premium_routine_ready: ${data.is_premium_routine_ready}`);
                    console.log(`   ready: ${isReady}`);
                    
                    // Retornar informaci√≥n detallada para el polling
                    return {
                        ready: isReady,
                        isPremium: data.is_premium,
                        hasRoutine: !!data.current_routine,
                        hasDiet: !!(data.current_diet && (
                            (data.current_diet.meals && data.current_diet.meals.length > 0) ||
                            (data.current_diet.comidas && Array.isArray(data.current_diet.comidas) && data.current_diet.comidas.length > 0)
                        )),
                        // üéØ Incluir el flag del backend para referencia expl√≠cita
                        isPremiumRoutineReady: data.is_premium_routine_ready === true
                    };
                } catch (error) {
                    console.error('‚ùå Error verificando rutina:', error);
                    // Si es error de autenticaci√≥n (401), detectarlo
                    if (error.message && error.message.includes('401')) {
                        return { ready: false, reason: 'no_auth' };
                    }
                    return { ready: false, reason: 'error', error: error.message };
                }
            }

            function showPaymentSuccessUI() {
                const container = document.getElementById('main-content') || document.body;
                container.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-black">
                        <div class="text-center max-w-md mx-auto bg-neutral-900/60 border border-lime-500/40 rounded-2xl p-8">
                            <div class="text-4xl mb-4">‚úÖ</div>
                            <h2 class="text-2xl font-bold text-white mb-2">¬°Tu plan est√° listo!</h2>
                            <p class="text-neutral-300 mb-4">Hemos activado tu cuenta premium y generado tu rutina y dieta personalizadas.</p>
                            <p class="text-neutral-500 text-xs mb-6">En unos segundos te llevaremos autom√°ticamente a tu dashboard.</p>
                        </div>
                    </div>
                `;
            }

            function showPaymentTimeoutUI() {
                const container = document.getElementById('main-content') || document.body;
                container.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-black">
                        <div class="text-center max-w-md mx-auto bg-neutral-900 rounded-2xl p-8 border border-yellow-500/30">
                            <div class="text-4xl mb-4">‚è±</div>
                            <h2 class="text-xl font-bold text-white mb-2">Estamos tardando m√°s de lo normal</h2>
                            <p class="text-neutral-300 mb-4">
                                Tu pago est√° confirmado y tu cuenta se est√° activando como premium, 
                                pero la generaci√≥n de tu plan personalizado est√° tardando un poco m√°s.
                            </p>
                            <p class="text-neutral-400 text-sm mb-6">
                                Te llevaremos al dashboard. Si no ves tu plan, podr√°s actualizarlo o regenerarlo desde all√≠.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            /**
             * Muestra overlay de timeout con opci√≥n de refrescar manualmente
             * Reemplaza el contenido del overlay existente
             */
            function showPaymentTimeoutWithRefresh() {
                const overlay = document.getElementById('payment-verification-overlay');
                if (!overlay) {
                    // Si no existe overlay, crear uno nuevo
                    showPaymentLoadingScreen();
                    setTimeout(() => showPaymentTimeoutWithRefresh(), 100);
                    return;
                }
                
                overlay.innerHTML = `
                    <div class="text-center max-w-md mx-auto px-6">
                        <div class="inline-block mb-6">
                            <div class="w-20 h-20 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-4">‚è± Tardando m√°s de lo esperado</h2>
                        <p class="text-neutral-200 text-lg mb-6">
                            Tu pago est√° confirmado y tu cuenta es premium, pero GPT-4o est√° tardando m√°s de lo normal en generar tu plan.
                        </p>
                        <p class="text-neutral-400 text-sm mb-8">
                            Puedes esperar un poco m√°s o refrescar manualmente para verificar si ya est√° listo.
                        </p>
                        
                        <div class="space-y-4">
                            <button 
                                onclick="location.reload()" 
                                class="w-full bg-lime-500 hover:bg-lime-600 text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg"
                                style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s ease; width: 100%; box-shadow: 0 4px 15px rgba(132, 204, 22, 0.3);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(132, 204, 22, 0.5)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(132, 204, 22, 0.3)';"
                            >
                                üîÑ Refrescar Manualmente
                            </button>
                            <button 
                                onclick="window.history.replaceState({}, document.title, '/dashboard.html'); location.reload();" 
                                class="w-full bg-neutral-800 hover:bg-neutral-700 text-neutral-300 font-semibold py-3 px-6 rounded-xl transition-all duration-200"
                                style="background: rgba(38, 38, 38, 0.9); color: #d4d4d4; border: 1px solid rgba(64, 64, 64, 0.5); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%;"
                                onmouseover="this.style.background='rgba(38, 38, 38, 1)'; this.style.borderColor='rgba(100, 100, 100, 0.8)';"
                                onmouseout="this.style.background='rgba(38, 38, 38, 0.9)'; this.style.borderColor='rgba(64, 64, 64, 0.5)';"
                            >
                                Ir al Dashboard
                            </button>
                        </div>
                        
                        <p class="mt-6 text-xs text-neutral-500">
                            Tu plan se seguir√° generando en segundo plano. Puedes recargar m√°s tarde.
                        </p>
                    </div>
                `;
            }

            function showPaymentErrorUI(error) {
                const container = document.getElementById('main-content') || document.body;
                const message = error && error.message ? error.message : 'Error verificando pago';
                container.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-black">
                        <div class="text-center bg-neutral-900 rounded-2xl p-8 max-w-md border border-red-500/20">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <h2 class="text-xl font-bold text-white mb-2">Error verificando pago</h2>
                            <p class="text-neutral-400 mb-6">${message}</p>
                            <button onclick="location.href='/dashboard.html'" class="bg-neutral-800 text-white font-semibold py-2 px-6 rounded-xl hover:bg-neutral-700 transition">
                                Continuar al Dashboard
                            </button>
                        </div>
                    </div>
                `;
            }

            /**
             * Verifica si el usuario viene de un pago exitoso de Stripe
             * y actualiza su estado premium antes de cargar el dashboard.
             * Usa polling para verificar que la rutina est√© generada por GPT (no template free).
             */
            async function checkPaymentSuccess() {
                // AbortController para poder cancelar el polling si el usuario cierra la pesta√±a
                const controller = new AbortController();

                const urlParams = new URLSearchParams(window.location.search);
                const success = urlParams.get('success');
                const sessionId = urlParams.get('session_id');

                if (success === '1' && sessionId) {
                    console.log('üîÑ Pago detectado, verificando con backend (polling)...');
                    console.log(`   Session ID: ${sessionId}`);

                    // Mostrar overlay bloqueante inmediatamente
                    showPaymentLoadingScreen();
                    
                    // Inicializar progreso: 20% - Pago verificado
                    setPaymentProgress(20, 'Pago verificado por Stripe...');

                    try {
                        // Intentar recuperar token (puede estar expirado o no existir)
                        let token = localStorage.getItem('accessToken');
                        let userId = null;
                        
                        if (token) {
                            try {
                                const payload = decodeJwt(token);
                                userId = payload?.user_id || payload?.sub;
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Token inv√°lido, intentando recuperar sesi√≥n...');
                                token = null;
                            }
                        }
                        
                        // Si no hay token, el backend lo generar√° usando el session_id
                        if (!token || !userId) {
                            console.log('üîÑ Sin token v√°lido, el backend generar√° uno usando session_id...');
                        } else {
                            console.log(`‚úÖ User ID obtenido del token: ${userId}`);
                        }

                        // Paso 1: Activar premium (si a√∫n no est√° activado)
                        // El backend puede funcionar con o sin token (usar√° session_id si no hay token)
                        let premiumActivated = false;
                        try {
                            // Actualizar progreso: 40% - Activando premium
                            setPaymentProgress(40, 'Activando acceso Premium...');
                            
                            // Preparar headers: solo incluir Authorization si hay token v√°lido
                            const headers = {
                                'Content-Type': 'application/json'
                            };
                            const authHeaders = getAuthHeaders();
                            if (authHeaders && authHeaders.Authorization) {
                                headers.Authorization = authHeaders.Authorization;
                            }
                            
                            const activateResponse = await fetch(`${API_BASE}/stripe/activate-premium`, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify({ session_id: sessionId }),
                                signal: controller.signal
                            });

                            if (activateResponse.ok) {
                                const activateResult = await activateResponse.json();
                                console.log('‚úÖ Respuesta activate-premium:', activateResult);
                                
                                // Si el backend devolvi√≥ un token y email, guardarlos en localStorage
                                if (activateResult.access_token && activateResult.email) {
                                    console.log('üîë Guardando token y email en localStorage...');
                                    localStorage.setItem('accessToken', activateResult.access_token);
                                    localStorage.setItem('email', activateResult.email);
                                    localStorage.setItem('loginTimestamp', Date.now().toString());
                                    
                                    // Actualizar userId del nuevo token
                                    try {
                                        const payload = decodeJwt(activateResult.access_token);
                                        userId = payload?.user_id || payload?.sub;
                                        console.log(`‚úÖ Sesi√≥n restaurada. User ID: ${userId}`);
                                    } catch (e) {
                                        console.warn('‚ö†Ô∏è Error decodificando nuevo token:', e);
                                    }
                                }
                                
                                updatePaymentProgressUI(activateResult);
                                
                                if (activateResult.success && activateResult.is_premium) {
                                    premiumActivated = true;
                                }
                            } else if (activateResponse.status === 401) {
                                // Si a√∫n falla con 401, puede ser que el session_id no sea v√°lido
                                const errorData = await activateResponse.json().catch(() => ({}));
                                console.error('‚ùå Error 401 activando premium:', errorData);
                                throw new Error('Sesi√≥n expirada o session_id inv√°lido');
                            }
                        } catch (activateErr) {
                            if (activateErr.message === 'Sesi√≥n expirada' || activateErr.message.includes('session_id')) {
                                throw activateErr;
                            }
                            console.warn('‚ö†Ô∏è Error activando premium (continuando):', activateErr);
                        }
                        
                        // Verificar que tenemos userId antes de continuar
                        if (!userId) {
                            console.error('‚ùå No se pudo obtener userId despu√©s de activar premium');
                            throw new Error('No se pudo obtener userId');
                        }

                        // Paso 2: Polling para verificar que la rutina GPT est√© lista
                        // Actualizar progreso: 60% - Iniciando an√°lisis con IA
                        setPaymentProgress(60, 'IA analizando tus datos cient√≠ficos (RAG)...');
                        
                        const maxAttempts = 40; // ~ 40 * 3s = 120s (2 minutos)
                        const intervalMs = 3000;
                        let attempts = 0;

                        return await new Promise((resolve) => {
                            const checkRoutineOnce = async () => {
                                attempts += 1;
                                console.log(`üîÑ Verificando rutina GPT ${attempts}/${maxAttempts}`);
                                
                                // Actualizar barra de progreso
                                updatePaymentProgress(attempts, maxAttempts);

                                try {
                                    const routineCheck = await checkRoutineReady(userId);
                                    
                                    if (routineCheck.ready) {
                                        console.log('üéâ ¬°Rutina GPT generada y lista!');
                                        
                                        // Completar barra de progreso al 100%
                                        setPaymentProgress(100, '¬°Todo listo! Cargando tu plan...');
                                        
                                        // Actualizar UI mostrando todos los pasos completados
                                        const stepAi = document.getElementById('step-ai');
                                        const stepDiet = document.getElementById('step-diet');
                                        
                                        if (stepAi) {
                                            stepAi.classList.remove('pending', 'active');
                                            stepAi.classList.add('completed');
                                            const icon = stepAi.querySelector('.payment-step-icon');
                                            const text = stepAi.querySelector('.payment-step-text');
                                            if (icon) {
                                                icon.classList.remove('pending', 'active');
                                                icon.classList.add('completed');
                                                icon.textContent = '‚úì';
                                            }
                                            if (text) {
                                                text.classList.remove('pending', 'active');
                                                text.classList.add('completed');
                                                text.textContent = 'Rutina GPT-4o generada ‚úì';
                                            }
                                        }
                                        
                                        if (stepDiet) {
                                            stepDiet.classList.remove('pending', 'active');
                                            stepDiet.classList.add('completed');
                                            const icon = stepDiet.querySelector('.payment-step-icon');
                                            const text = stepDiet.querySelector('.payment-step-text');
                                            if (icon) {
                                                icon.classList.remove('pending', 'active');
                                                icon.classList.add('completed');
                                                icon.textContent = '‚úì';
                                            }
                                            if (text) {
                                                text.classList.remove('pending', 'active');
                                                text.classList.add('completed');
                                                text.textContent = 'Plan nutricional creado ‚úì';
                                            }
                                        }
                                        
                                        // Ocultar overlay y mostrar dashboard
                                        hidePaymentLoadingScreen();
                                        
                                        setTimeout(() => {
                                            window.history.replaceState({}, document.title, '/dashboard.html');
                                            // Recargar para mostrar la rutina
                                            location.reload();
                                        }, 1500);
                                        
                                        resolve(true);
                                        return;
                                    }
                                    
                                    // Actualizar progreso seg√∫n estado
                                    if (routineCheck.isPremium && !routineCheck.ready) {
                                        // Usuario es premium pero rutina a√∫n no est√° lista
                                        const stepDiet = document.getElementById('step-diet');
                                        if (stepDiet && !stepDiet.classList.contains('completed')) {
                                            stepDiet.classList.add('active');
                                            const text = stepDiet.querySelector('.payment-step-text');
                                            if (text) {
                                                text.textContent = 'GPT-4o est√° redactando los detalles finales de tu dieta...';
                                                text.classList.remove('pending');
                                                text.classList.add('active');
                                            }
                                            const icon = stepDiet.querySelector('.payment-step-icon');
                                            if (icon && !icon.classList.contains('completed')) {
                                                icon.classList.remove('pending');
                                                icon.classList.add('active');
                                            }
                                        }
                                        
                                        // Tambi√©n actualizar el paso de rutina si est√° generando
                                        const stepAi = document.getElementById('step-ai');
                                        if (stepAi && !stepAi.classList.contains('completed')) {
                                            stepAi.classList.add('active');
                                            const text = stepAi.querySelector('.payment-step-text');
                                            if (text && !text.textContent.includes('‚úì')) {
                                                text.textContent = `Generando rutina con GPT-4o... (${attempts}/${maxAttempts})`;
                                                text.classList.remove('pending');
                                                text.classList.add('active');
                                            }
                                            const icon = stepAi.querySelector('.payment-step-icon');
                                            if (icon && !icon.classList.contains('completed')) {
                                                icon.classList.remove('pending');
                                                icon.classList.add('active');
                                            }
                                        }
                                    }

                                    if (attempts >= maxAttempts) {
                                        console.warn('‚è± Timeout esperando a que se genere la rutina GPT');
                                        
                                        // Mostrar overlay de timeout con bot√≥n de refrescar manualmente
                                        showPaymentTimeoutWithRefresh();
                                        
                                        resolve(true); // Continuar pero mostrar opci√≥n de refrescar
                                        return;
                                    }

                                    // Reintentar tras el intervalo
                                    setTimeout(checkRoutineOnce, intervalMs);
                                } catch (err) {
                                    if (err.name === 'AbortError') {
                                        console.warn('‚èπ Polling abortado:', err);
                                        resolve(false);
                                        return;
                                    }
                                    
                                    // Verificar si es error de autenticaci√≥n
                                    const routineCheckError = await checkRoutineReady(userId).catch(() => ({ reason: 'error' }));
                                    if (err.message === 'Sesi√≥n expirada' || routineCheckError?.reason === 'no_auth') {
                                        console.error('‚ùå Sesi√≥n expirada durante verificaci√≥n');
                                        hidePaymentLoadingScreen();
                                        
                                        const overlayMessage = document.querySelector('#payment-verification-overlay');
                                        if (overlayMessage) {
                                            overlayMessage.innerHTML = `
                                                <div class="text-center max-w-md mx-auto px-6">
                                                    <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                                                    <h2 class="text-2xl font-bold text-white mb-4">Sesi√≥n Expirada</h2>
                                                    <p class="text-neutral-300 mb-6">
                                                        Tu sesi√≥n ha expirado tras el pago.<br>
                                                        Por favor, inicia sesi√≥n para ver tu nueva rutina personalizada.
                                                    </p>
                                                    <p class="text-lime-400 text-sm font-semibold">
                                                        Tu pago fue exitoso. Tu rutina estar√° lista cuando inicies sesi√≥n.
                                                    </p>
                                                </div>
                                            `;
                                        }
                                        
                                        setTimeout(() => {
                                            window.location.href = './login.html?message=Tu pago fue exitoso. Inicia sesi√≥n para ver tu rutina personalizada.';
                                        }, 4000);
                                        
                                        resolve(false);
                                        return;
                                    }

                                    console.error('‚ùå Error verificando rutina:', err);
                                    
                                    // Continuar intentando si no es un error cr√≠tico
                                    if (attempts < maxAttempts) {
                                        setTimeout(checkRoutineOnce, intervalMs);
                                    } else {
                                        hidePaymentLoadingScreen();
                                        setTimeout(() => {
                                            window.history.replaceState({}, document.title, '/dashboard.html');
                                            location.reload();
                                        }, 1000);
                                        resolve(true);
                                    }
                                }
                            };

                            // Cancelar polling si el usuario cierra la pesta√±a
                            window.addEventListener('beforeunload', () => {
                                controller.abort();
                            });

                            // Esperar 2 segundos antes de empezar polling (dar tiempo al webhook)
                            setTimeout(() => {
                                checkRoutineOnce();
                            }, 2000);
                        });
                    } catch (error) {
                        console.error('‚ùå Error en verificaci√≥n de pago:', error);
                        
                        // Si es error de autenticaci√≥n, mostrar mensaje apropiado
                        if (error.message && error.message.includes('Sesi√≥n expirada')) {
                            hidePaymentLoadingScreen();
                            const overlay = document.getElementById('payment-verification-overlay');
                            if (overlay) {
                                overlay.innerHTML = `
                                    <div class="text-center max-w-md mx-auto px-6">
                                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                                        <h2 class="text-2xl font-bold text-white mb-4">Sesi√≥n Expirada</h2>
                                        <p class="text-neutral-300 mb-6">
                                            Tu sesi√≥n ha expirado tras el pago.<br>
                                            Por favor, inicia sesi√≥n para ver tu nueva rutina personalizada.
                                        </p>
                                        <p class="text-lime-400 text-sm font-semibold">
                                            Tu pago fue exitoso. Tu rutina estar√° lista cuando inicies sesi√≥n.
                                        </p>
                                    </div>
                                `;
                            }
                            
                            setTimeout(() => {
                                window.location.href = './login.html?message=Tu pago fue exitoso. Inicia sesi√≥n para ver tu rutina personalizada.';
                            }, 4000);
                            return false;
                        }
                        
                        showPaymentErrorUI(error);
                        setTimeout(() => {
                            window.history.replaceState({}, document.title, '/dashboard.html');
                            location.reload();
                        }, 4000);
                        return false;
                    }
                } else {
                    // No hay par√°metros de pago
                    return false;
                }
            }

            // Freemium helpers (frontend-only)
            // Variable global para cachear el estado isPremium
            let userPremiumStatus = null;
            
            async function checkPremiumStatus() {
                try {
                    // Usar el mismo m√©todo que tarifas.html: /subscription-status con autenticaci√≥n
                    const headers = getAuthHeaders();
                    const response = await fetch(`${API_BASE}/subscription-status`, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üìä Estado del usuario (checkPremiumStatus):', data);
                        
                        // Verificar si es premium: is_premium o plan_type PREMIUM_MONTHLY/YEARLY
                        const isPremium = data.is_premium === true || 
                                        data.plan_type === 'PREMIUM_MONTHLY' || 
                                        data.plan_type === 'PREMIUM_YEARLY' ||
                                        data.plan_type === 'PREMIUM';
                        
                        userPremiumStatus = isPremium;
                        console.log('üíé Usuario premium detectado:', isPremium, '(plan_type:', data.plan_type, ', is_premium:', data.is_premium, ')');
                        return isPremium;
                    } else {
                        console.warn('‚ö†Ô∏è No se pudo obtener status de suscripci√≥n, status:', response.status);
                        // Si falla la autenticaci√≥n, intentar fallback
                    }
                } catch (error) {
                    console.error('‚ùå Error verificando isPremium:', error);
                }
                
                // Fallback: intentar con token JWT
                try {
                    const token = localStorage.getItem('accessToken');
                    if (token) {
                        const payload = decodeJwt(token) || {};
                        if (payload.plan === 'isPremium' || payload.tier === 'isPremium' || payload.isPremium === true) {
                            userPremiumStatus = true;
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn('Fallback JWT fall√≥:', e);
                }
                
                // √öltimo fallback: localStorage
                const storedPlan = localStorage.getItem('plan');
                userPremiumStatus = storedPlan === 'isPremium';
                return userPremiumStatus || false;
            }
            
            function isPremiumUser() {
                // Si ya tenemos el estado, devolverlo
                if (userPremiumStatus !== null) {
                    return userPremiumStatus;
                }
                
                // Si no, usar fallback
                const token = localStorage.getItem('accessToken');
                if (token) {
                    const payload = decodeJwt(token) || {};
                    if (payload.plan === 'premium' || payload.tier === 'premium' || payload.premium === true) {
                        return true;
                    }
                }
                const storedPlan = localStorage.getItem('plan');
                return storedPlan === 'premium';
            }

            // Funci√≥n auxiliar para renderizar un alimento (maneja strings y objetos)
            function renderAlimento(alimento) {
                // CASO 1: String directo
                if (typeof alimento === 'string') {
                    return alimento;
                }
                
                // CASO 2: Objeto - intentar varias estructuras posibles
                if (typeof alimento === 'object' && alimento !== null) {
                    // Opci√≥n A: {nombre, cantidad, calorias}
                    if (alimento.nombre && alimento.cantidad && alimento.calorias) {
                        return `${alimento.cantidad} ${alimento.nombre} - ${alimento.calorias}kcal`;
                    }
                    // Opci√≥n B: {alimento, cantidad}
                    else if (alimento.alimento) {
                        return `${alimento.alimento}${alimento.cantidad ? ' - ' + alimento.cantidad : ''}`;
                    }
                    // Opci√≥n C: {descripcion}
                    else if (alimento.descripcion) {
                        return alimento.descripcion;
                    }
                    // Opci√≥n D: Solo {nombre}
                    else if (alimento.nombre) {
                        return alimento.nombre;
                    }
                    // Fallback: mostrar como JSON
                    else {
                        console.warn('‚ö†Ô∏è Estructura de alimento desconocida:', alimento);
                        return JSON.stringify(alimento);
                    }
                }
                
                // Fallback final
                return String(alimento);
            }

            function getChatUsageKey() {
                const email = localStorage.getItem('email') || 'anonymous';
                return `chat_usage_count_${email}`;
            }

            function getChatUsageCount() {
                const raw = localStorage.getItem(getChatUsageKey());
                const n = parseInt(raw || '0', 10);
                return Number.isFinite(n) ? n : 0;
            }

            function incrementChatUsage() {
                const next = getChatUsageCount() + 1;
                localStorage.setItem(getChatUsageKey(), String(next));
                return next;
            }

            function canUseChat() {
                if (isPremiumUser()) return true;
                return getChatUsageCount() < 2; // 2 prompts for free tier
            }
            
            // Funci√≥n para mostrar modal de premium (MOVIDA FUERA DE initDashboard para scope global)
            function showPremiumModal(options) {
                const modal = document.getElementById('upgradeModal');
                if (!modal) return;
                
                // Actualizar contenido del modal
                const title = modal.querySelector('h2');
                const message = modal.querySelector('p');
                const ctaButton = modal.querySelector('button[onclick*="tarifas.html"]');
                
                if (title) title.textContent = options.title || 'üöÄ Funci√≥n Premium';
                if (message) {
                    message.textContent = options.message || 'Esta funci√≥n es exclusiva para usuarios Premium.';
                }
                if (ctaButton && options.ctaText) {
                    ctaButton.textContent = options.ctaText;
                }
                
                // Mostrar modal
                modal.style.display = 'flex';
            }
            
            // Funci√≥n para cargar datos actuales del usuario (MOVIDA FUERA DE initDashboard)
            async function loadCurrentUserData() {
                try {
                    const headers = getAuthHeaders();
                    const response = await fetch(`${API_BASE}/plan/datos-actuales`, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    } else {
                        console.log('No hay datos previos, formulario vac√≠o');
                        return null;
                    }
                } catch (error) {
                    console.error('Error cargando datos del usuario:', error);
                    return null;
                }
            }
            
            // Funci√≥n para generar el HTML del formulario (MOVIDA FUERA DE initDashboard)
            function generateNewRoutineForm(userData) {
                return `
                    <form id="newRoutineForm" style="color: white;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <!-- Datos B√°sicos -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Altura (cm)</label>
                                <input type="number" id="altura" name="altura" min="100" max="250" required 
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Peso (kg)</label>
                                <input type="number" id="peso" name="peso" min="30" max="200" step="0.1" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Edad</label>
                                <input type="number" id="edad" name="edad" min="13" max="100" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Sexo</label>
                                <select id="sexo" name="sexo" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="hombre">Hombre</option>
                                    <option value="mujer">Mujer</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Experiencia</label>
                                <select id="experiencia" name="experiencia" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="principiante">Principiante</option>
                                    <option value="intermedio">Intermedio</option>
                                    <option value="avanzado">Avanzado</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Objetivo Gym</label>
                                <select id="objetivo_gym" name="objetivo_gym" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="ganar_musculo">Ganar M√∫sculo</option>
                                    <option value="ganar_fuerza">Ganar Fuerza</option>
                                    <option value="perder_grasa">Perder Grasa</option>
                                    <option value="mantener_forma">Mantener Forma</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Objetivo Nutricional</label>
                                <select id="objetivo_nutricional" name="objetivo_nutricional" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="volumen">Volumen</option>
                                    <option value="definicion">Definici√≥n</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                    <option value="recomposicion">Recomposici√≥n</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Nivel de Actividad</label>
                                <select id="nivel_actividad" name="nivel_actividad" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                                    <option value="sedentario">Sedentario</option>
                                    <option value="ligero">Ligero</option>
                                    <option value="moderado">Moderado</option>
                                    <option value="activo">Activo</option>
                                    <option value="muy_activo">Muy Activo</option>
                                </select>
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">D√≠as de Entrenamiento por Semana</label>
                                <select id="dias_entrenamiento" name="dias_entrenamiento" required
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white; margin-bottom: 16px;">
                                    <option value="">Selecciona frecuencia</option>
                                    <option value="3">3 d√≠as/semana</option>
                                    <option value="4">4 d√≠as/semana</option>
                                    <option value="5">5 d√≠as/semana</option>
                                    <option value="6">6 d√≠as/semana</option>
                                </select>
                                
                                <!-- D√≠as espec√≠ficos de entrenamiento -->
                                <div id="specific_days_container" style="margin-top: 16px;">
                                    <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Selecciona los d√≠as espec√≠ficos</label>
                                    <p style="font-size: 12px; color: #999; margin-bottom: 12px;">Debe coincidir con la frecuencia elegida</p>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_lunes" name="training_days" value="lunes" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Lunes</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_martes" name="training_days" value="martes" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Martes</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_miercoles" name="training_days" value="mi√©rcoles" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Mi√©rcoles</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_jueves" name="training_days" value="jueves" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Jueves</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_viernes" name="training_days" value="viernes" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Viernes</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_sabado" name="training_days" value="s√°bado" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">S√°bado</span>
                                        </label>
                                        <label style="display: block; padding: 12px; border: 2px solid #404040; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: #1a1a1a; user-select: none;" 
                                            onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='#84cc16'; this.style.background='rgba(132, 204, 22, 0.05)'" 
                                            onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#404040'; this.style.background='#1a1a1a'">
                                            <input type="checkbox" id="day_domingo" name="training_days" value="domingo" style="display: none;" 
                                                onchange="this.parentElement.style.borderColor=this.checked?'#84cc16':'#404040'; this.parentElement.style.background=this.checked?'rgba(132, 204, 22, 0.15)':'#1a1a1a'; validateTrainingDays();">
                                            <span style="color: white; font-weight: 500; font-size: 14px;">Domingo</span>
                                        </label>
                                    </div>
                                    <p id="days-error" style="display: none; color: #ef4444; font-size: 13px; margin-top: 12px; font-weight: 500;">
                                        ‚ö†Ô∏è Debes seleccionar exactamente <span id="required-days"></span> d√≠as
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campos adicionales -->
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Materiales Disponibles</label>
                            <textarea id="materiales" name="materiales" rows="3" placeholder="Ej: Barra libre, mancuernas, banco plano..."
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Lesiones (opcional)</label>
                            <input type="text" id="lesiones" name="lesiones" placeholder="Ej: Lesi√≥n en rodilla izquierda"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Alergias Alimentarias (opcional)</label>
                            <input type="text" id="alergias" name="alergias" placeholder="Ej: Lactosa, gluten"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 8px; color: #84cc16; font-weight: 600;">Restricciones Diet√©ticas (opcional)</label>
                            <input type="text" id="restricciones_dieta" name="restricciones_dieta" placeholder="Ej: Vegetariano, vegano"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #404040; background: #1a1a1a; color: white;">
                        </div>
                        
                        <!-- Bot√≥n de env√≠o -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" 
                                style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; border: none; padding: 15px 40px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(132, 204, 22, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                Generar Nueva Rutina
                            </button>
                        </div>
                    </form>
                `;
            }
            
            // Funci√≥n para validar d√≠as de entrenamiento
            function validateTrainingDays() {
                const frequency = parseInt(document.getElementById('dias_entrenamiento').value) || 0;
                const selectedDays = document.querySelectorAll('input[name="training_days"]:checked').length;
                const errorMsg = document.getElementById('days-error');
                const requiredDaysSpan = document.getElementById('required-days');
                
                if (frequency === 0) {
                    if (errorMsg) errorMsg.style.display = 'none';
                    return true;
                }
                
                if (selectedDays > frequency) {
                    // Desmarcar el √∫ltimo checkbox
                    const checkboxes = document.querySelectorAll('input[name="training_days"]:checked');
                    if (checkboxes.length > 0) {
                        checkboxes[checkboxes.length - 1].checked = false;
                        const lastLabel = checkboxes[checkboxes.length - 1].parentElement;
                        lastLabel.style.borderColor = '#404040';
                        lastLabel.style.background = '#1a1a1a';
                    }
                    if (errorMsg) {
                        if (requiredDaysSpan) requiredDaysSpan.textContent = frequency;
                        errorMsg.style.display = 'block';
                    }
                    return false;
                } else if (selectedDays === frequency) {
                    if (errorMsg) errorMsg.style.display = 'none';
                    return true;
                } else {
                    if (errorMsg) {
                        if (requiredDaysSpan) requiredDaysSpan.textContent = frequency;
                        errorMsg.style.display = 'none'; // Ocultar hasta que se intente enviar
                    }
                    return selectedDays > 0;
                }
            }
            
            // Funci√≥n para pre-llenar el formulario con datos del usuario (MOVIDA FUERA DE initDashboard)
            function prefillForm(userData) {
                if (!userData) return;
                
                // Pre-llenar campos b√°sicos
                if (userData.altura) document.getElementById('altura').value = userData.altura;
                if (userData.peso) document.getElementById('peso').value = userData.peso;
                if (userData.edad) document.getElementById('edad').value = userData.edad;
                if (userData.sexo) document.getElementById('sexo').value = userData.sexo;
                if (userData.experiencia) document.getElementById('experiencia').value = userData.experiencia;
                if (userData.objetivo_gym) document.getElementById('objetivo_gym').value = userData.objetivo_gym;
                if (userData.objetivo_nutricional) document.getElementById('objetivo_nutricional').value = userData.objetivo_nutricional;
                if (userData.nivel_actividad) document.getElementById('nivel_actividad').value = userData.nivel_actividad;
                
                // Pre-llenar d√≠as de entrenamiento
                const diasEntrenamiento = document.getElementById('dias_entrenamiento');
                if (diasEntrenamiento) {
                    diasEntrenamiento.value = userData.dias_entrenamiento || '';
                    // Limpiar d√≠as seleccionados cuando cambia la frecuencia
                    diasEntrenamiento.addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('input[name="training_days"]');
                        checkboxes.forEach(cb => {
                            cb.checked = false;
                            const label = cb.parentElement;
                            label.style.borderColor = '#404040';
                            label.style.background = '#1a1a1a';
                        });
                        validateTrainingDays();
                    });
                }
                
                // Pre-llenar d√≠as espec√≠ficos si existen
                if (userData.training_days && Array.isArray(userData.training_days)) {
                    userData.training_days.forEach(day => {
                        const checkbox = document.getElementById(`day_${day}`);
                        if (checkbox) {
                            checkbox.checked = true;
                            const label = checkbox.parentElement;
                            label.style.borderColor = '#84cc16';
                            label.style.background = 'rgba(132, 204, 22, 0.15)';
                        }
                    });
                }
                
                if (userData.materiales) document.getElementById('materiales').value = userData.materiales;
                if (userData.lesiones) document.getElementById('lesiones').value = userData.lesiones;
                if (userData.alergias) document.getElementById('alergias').value = userData.alergias;
                if (userData.restricciones_dieta) document.getElementById('restricciones_dieta').value = userData.restricciones_dieta;
            }
            
            // Funci√≥n para cargar el formulario de nueva rutina (MOVIDA FUERA DE initDashboard)
            async function loadNewRoutineForm() {
                const contentDiv = document.getElementById('nuevaRutinaContent');
                if (!contentDiv) return;
                
                // Mostrar loading
                contentDiv.innerHTML = '<p style="color: white; text-align: center; padding: 40px;">Cargando formulario...</p>';
                
                // Cargar datos del usuario
                const userData = await loadCurrentUserData();
                
                // Generar formulario HTML
                const formHTML = generateNewRoutineForm(userData);
                contentDiv.innerHTML = formHTML;
                
                // Si hay datos, pre-llenar formulario
                if (userData) {
                    prefillForm(userData);
                }
                
                // Agregar event listener al formulario
                const form = document.getElementById('newRoutineForm');
                if (form) {
                    form.addEventListener('submit', handleNewRoutineSubmit);
                }
                
                // Agregar event listener al select de frecuencia para limpiar d√≠as cuando cambie
                const diasEntrenamientoSelect = document.getElementById('dias_entrenamiento');
                if (diasEntrenamientoSelect) {
                    diasEntrenamientoSelect.addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('input[name="training_days"]');
                        checkboxes.forEach(cb => {
                            cb.checked = false;
                            const label = cb.parentElement;
                            label.style.borderColor = '#404040';
                            label.style.background = '#1a1a1a';
                        });
                        const errorMsg = document.getElementById('days-error');
                        if (errorMsg) errorMsg.style.display = 'none';
                    });
                }
            }
            
            // Funci√≥n para manejar el env√≠o del formulario (MOVIDA FUERA DE initDashboard)
            async function handleNewRoutineSubmit(event) {
                event.preventDefault();
                
                const form = event.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                
                // Mostrar mensaje de advertencia sobre el tiempo de procesamiento
                const confirmMessage = '‚è≥ La generaci√≥n de tu plan personalizado puede tomar unos minutos. Por favor, no cierres esta ventana.\n\n¬øDeseas continuar?';
                if (!confirm(confirmMessage)) {
                    return; // El usuario cancel√≥
                }
                
                // Deshabilitar bot√≥n y mostrar loading con mensaje m√°s detallado
                submitButton.disabled = true;
                submitButton.textContent = '‚è≥ Generando plan... Esto puede tomar unos minutos';
                
                // Mostrar mensaje informativo en el overlay
                const overlayContent = document.querySelector('#nuevaRutinaOverlay .overlay-content');
                if (overlayContent) {
                    const infoMessage = document.createElement('div');
                    infoMessage.id = 'generation-info-message';
                    infoMessage.style.cssText = 'background: rgba(132, 204, 22, 0.1); border: 1px solid rgba(132, 204, 22, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #84cc16; text-align: center; font-weight: 500;';
                    infoMessage.innerHTML = '‚è≥ <strong>Generando tu plan personalizado...</strong><br>Esto puede tomar unos minutos. Por favor, espera mientras procesamos tu solicitud.';
                    
                    // Insertar al principio del overlay content
                    const firstChild = overlayContent.firstElementChild;
                    if (firstChild) {
                        overlayContent.insertBefore(infoMessage, firstChild);
                    } else {
                        overlayContent.appendChild(infoMessage);
                    }
                }
                
                try {
                    // Recopilar datos del formulario
                    const objetivoGym = document.getElementById('objetivo_gym').value;
                    
                    // Mapear objetivo_gym a objetivo (el schema espera 'objetivo', no 'objetivo_gym')
                    const objetivoMapping = {
                        'ganar_musculo': 'ganar_musculo',
                        'ganar_fuerza': 'ganar_fuerza',
                        'perder_grasa': 'perder_grasa',
                        'mantener_forma': 'mantener_forma'
                    };
                    const objetivo = objetivoMapping[objetivoGym] || objetivoGym;
                    
                    // Validar d√≠as de entrenamiento antes de enviar
                    const frequency = parseInt(document.getElementById('dias_entrenamiento').value);
                    const selectedDaysRaw = Array.from(document.querySelectorAll('input[name="training_days"]:checked')).map(cb => cb.value);
                    
                    if (frequency > 0 && selectedDaysRaw.length !== frequency) {
                        const errorMsg = document.getElementById('days-error');
                        const requiredDaysSpan = document.getElementById('required-days');
                        if (errorMsg) {
                            if (requiredDaysSpan) requiredDaysSpan.textContent = frequency;
                            errorMsg.style.display = 'block';
                        }
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        document.getElementById('dias_entrenamiento').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }
                    
                    // Capitalizar d√≠as correctamente (primera letra may√∫scula)
                    const selectedDays = selectedDaysRaw.length > 0 ? selectedDaysRaw.map(day => {
                        // Capitalizar: "lunes" -> "Lunes", "mi√©rcoles" -> "Mi√©rcoles"
                        return day.charAt(0).toUpperCase() + day.slice(1);
                    }) : null;
                    
                    const formData = {
                        altura: parseInt(document.getElementById('altura').value),
                        peso: parseInt(Math.round(parseFloat(document.getElementById('peso').value))), // Convertir a int
                        edad: parseInt(document.getElementById('edad').value),
                        sexo: document.getElementById('sexo').value,
                        experiencia: document.getElementById('experiencia').value,
                        objetivo: objetivo, // El schema espera 'objetivo', no 'objetivo_gym'
                        materiales: document.getElementById('materiales').value || '',
                        dias_entrenamiento: parseInt(document.getElementById('dias_entrenamiento').value), // Requerido por schema
                        training_days: selectedDays, // D√≠as espec√≠ficos de la semana (capitalizados)
                        lesiones: document.getElementById('lesiones').value || null,
                        alergias: document.getElementById('alergias').value || null,
                        restricciones_dieta: document.getElementById('restricciones_dieta').value || null,
                        idioma: 'es'
                    };
                    
                    console.log('üì§ Datos a enviar:', formData);
                    
                    // Enviar al backend
                    const headers = getAuthHeaders();
                    const response = await fetch(`${API_BASE}/generar-rutina`, {
                        method: 'POST',
                        headers: {
                            ...headers,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('‚ùå Error del servidor:', errorData);
                        
                        // Mejorar el mensaje de error
                        let errorMessage = 'Error al generar rutina';
                        if (errorData.detail) {
                            if (Array.isArray(errorData.detail)) {
                                // Si es un array de errores de validaci√≥n
                                errorMessage = errorData.detail.map(err => {
                                    const field = err.loc ? err.loc.join('.') : 'campo';
                                    return `${field}: ${err.msg}`;
                                }).join(', ');
                            } else {
                                errorMessage = errorData.detail;
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const planData = await response.json();
                    
                    // Cerrar overlay
                    closeOverlay('nuevaRutinaOverlay');
                    
                    // Recargar plan desde servidor para mostrar la nueva rutina
                    await reloadPlanFromServer();
                    
                    // Mostrar notificaci√≥n de √©xito
                    showReloadNotification('¬°Nueva rutina generada exitosamente!');
                    
                } catch (error) {
                    console.error('Error generando rutina:', error);
                    alert('Error al generar la rutina: ' + error.message);
                } finally {
                    // Eliminar mensaje informativo si existe
                    const infoMessage = document.getElementById('generation-info-message');
                    if (infoMessage) {
                        infoMessage.remove();
                    }
                    
                    // Restaurar bot√≥n
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            }
            
            // Funci√≥n principal
            // Variable global para indicar que se est√° procesando un pago
            let isProcessingPayment = false;
            
            async function initDashboard() {
                // ‚ö†Ô∏è PRIORIDAD: Si hay un pago pendiente, mostrar overlay inmediatamente
                const urlParams = new URLSearchParams(window.location.search);
                const hasPaymentPending = urlParams.get('success') === '1' && urlParams.get('session_id');
                
                if (hasPaymentPending) {
                    // üéØ Establecer flag global ANTES de verificar autenticaci√≥n
                    isProcessingPayment = true;
                    window.isProcessingPayment = true; // Tambi√©n como global en window para acceso desde auth.js
                    
                    // Mostrar overlay bloqueante inmediatamente antes de cualquier otra acci√≥n
                    showPaymentLoadingScreen();
                    console.log('üîÑ Overlay de pago mostrado, iniciando verificaci√≥n...');
                    console.log('üí≥ isProcessingPayment = true (autenticaci√≥n ser√° m√°s flexible)');
                    
                    // Intentar verificar autenticaci√≥n (ser√° m√°s flexible si isProcessingPayment = true)
                    let authValid = await checkAuthOrRedirect();
                    if (!authValid) {
                        // Si falla, intentar recuperar token una vez m√°s despu√©s de un breve delay
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Verificar de nuevo si el token fue restaurado (con flexibilidad por pago)
                        const token = localStorage.getItem('accessToken');
                        if (!token || !(await checkAuthOrRedirect())) {
                            // Sesi√≥n definitivamente expirada, actualizar overlay y redirigir
                            const overlay = document.getElementById('payment-verification-overlay');
                            if (overlay) {
                                overlay.innerHTML = `
                                    <div class="text-center max-w-md mx-auto px-6">
                                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                                        <h2 class="text-2xl font-bold text-white mb-4">Sesi√≥n Expirada</h2>
                                        <p class="text-neutral-300 mb-6">
                                            Tu sesi√≥n ha expirado tras el pago.<br>
                                            Por favor, inicia sesi√≥n para ver tu nueva rutina personalizada.
                                        </p>
                                        <p class="text-lime-400 text-sm font-semibold">
                                            Tu pago fue exitoso. Tu rutina estar√° lista cuando inicies sesi√≥n.
                                        </p>
                                    </div>
                                `;
                            }
                            
                            setTimeout(() => {
                                window.location.href = './login.html?message=Tu pago fue exitoso. Inicia sesi√≥n para ver tu rutina personalizada.';
                            }, 3000);
                            return; // No continuar con initDashboard
                        }
                    }
                    
                    // Si llegamos aqu√≠, la autenticaci√≥n est√° OK, continuar normalmente
                    // checkPaymentSuccess() se llamar√° despu√©s y manejar√° el polling
                } else {
                    // No hay pago pendiente, verificar autenticaci√≥n normalmente
                    // Asegurar que isProcessingPayment est√° en false
                    isProcessingPayment = false;
                    window.isProcessingPayment = false;
                    
                    if (!(await checkAuthOrRedirect())) {
                        return; // checkAuthOrRedirect ya redirige a login
                    }
                }
                
                // Verificar estado isPremium al cargar
                await checkPremiumStatus();
            
                const chatMessages = document.getElementById('chatMessages');
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');

                function addMessage(content, isUser = false, showUpgradeButton = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                    
                    if (showUpgradeButton) {
                        messageDiv.innerHTML = `
                            <div style="margin-bottom: 12px;">${content}</div>
                            <button onclick="window.location.href='./tarifas.html'" 
                                    style="background: #84cc16; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#65a30d'; this.style.transform='translateY(-1px)'"
                                    onmouseout="this.style.background='#84cc16'; this.style.transform='translateY(0)'">
                                Mejorar a Pro
                            </button>
                        `;
                    } else {
                    messageDiv.textContent = content;
                    }
                    
                    chatMessages.appendChild(messageDiv);
                    
                    // Auto-scroll al final del chat
                    setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }

                // Funci√≥n para mostrar indicador "IA escribiendo"
                function showTypingIndicator() {
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'typing-indicator';
                    typingDiv.id = 'typingIndicator';
                    typingDiv.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    
                    chatMessages.appendChild(typingDiv);
                    
                    // Auto-scroll al final
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }

                // Funci√≥n para ocultar indicador "IA escribiendo"
                function hideTypingIndicator() {
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                }

                // Funci√≥n para mostrar modal de upgrade
                function showUpgradeModal() {
                    const modal = document.getElementById('upgradeModal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                }

                // Funci√≥n para cerrar modal de upgrade
                function closeUpgradeModal() {
                    const modal = document.getElementById('upgradeModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }

                async function sendMessage() {
                    const message = chatInput.value.trim();
                    if (!message) return;

                    // ‚ö†Ô∏è PRIORIDAD 1: Freemium limit - Comprobar ANTES de cualquier otra validaci√≥n
                    // Esto asegura que el modal siempre salte incluso si el usuario cierra y vuelve a intentar
                    if (!isPremiumUser() && !canUseChat()) {
                        // Mostrar modal de upgrade en lugar de mensaje en el chat
                        showUpgradeModal();
                        return;
                    }

                    // RATE LIMITING: Prevenir env√≠o excesivo de mensajes
                    const now = Date.now();
                    const lastMessageTime = window.lastMessageTime || 0;
                    const timeSinceLastMessage = now - lastMessageTime;
                    
                    if (timeSinceLastMessage < 2000) { // 2 segundos de debounce
                        console.log('‚ö†Ô∏è Rate limit: Espera 2 segundos entre mensajes');
                        return;
                    }
                    
                    // Verificar si ya hay un mensaje proces√°ndose
                    if (window.isProcessingMessage) {
                        console.log('‚ö†Ô∏è Ya hay un mensaje proces√°ndose, espera...');
                        return;
                    }
                    
                    window.lastMessageTime = now;
                    window.isProcessingMessage = true;

                    // Verificar autenticaci√≥n antes de enviar
                    if (!checkAuthOrRedirect()) {
                        window.location.href = './login.html';
                        window.isProcessingMessage = false;
                        return;
                    }

                    addMessage(message, true);
                    chatInput.value = '';
                    autoResizeTextarea();
                    
                    // Mostrar indicador de escritura
                    showTypingIndicator();
                    
                    // Deshabilitar bot√≥n durante el env√≠o
                    sendBtn.disabled = true;
                    sendBtn.classList.remove('active');

                    try {
                        // Preparar payload para logging
                        const userId = getCurrentUserId();
                        const conversationHistory = getConversationHistory();
                        const token = localStorage.getItem('accessToken');
                        
                        const payload = {
                            message: message,
                            user_id: userId,
                            conversation_history: conversationHistory
                        };

                        console.log('=== PAYLOAD ENVIADO ===');
                        console.log('Payload:', JSON.stringify(payload, null, 2));
                        console.log('User ID:', userId);
                        console.log('Message:', message);
                        console.log('Conversation History:', conversationHistory);
                        console.log('Token exists:', !!token);
                        console.log('======================');

                        // Usar nuevo endpoint de function calling
                        const response = await fetch(`${API_BASE}/api/chat/modify`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'X-User-Email': localStorage.getItem('email') // Cabecera requerida por el backend
                            },
                            body: JSON.stringify(payload)
                        });

                        // Logging del error 422
                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('=== ERROR HTTP ===');
                            console.error('Status:', response.status);
                            console.error('Status Text:', response.statusText);
                            console.error('Error detail:', errorData);
                            console.error('================');
                            
                            // Desbloquear bot√≥n de enviar en caso de error
                            window.isProcessingMessage = false;
                            
                            if (response.status === 402) {
                                // L√≠mite gratuito alcanzado - mostrar modal de upgrade
                                console.log('üí≥ L√≠mite gratuito alcanzado, mostrando modal de upgrade');
                                showUpgradeModal();
                                addMessage('üíé Has alcanzado tu l√≠mite gratuito. Mejora a Premium para chat ilimitado.');
                            } else if (response.status === 422) {
                                addMessage(`Error de validaci√≥n: ${JSON.stringify(errorData)}`);
                            } else if (response.status === 401) {
                                addMessage('Sesi√≥n expirada. Redirigiendo al login...');
                                setTimeout(() => {
                                    localStorage.clear();
                                    window.location.href = './login.html';
                                }, 2000);
                            } else {
                                addMessage(`Error del servidor: ${errorData.detail || 'Error desconocido'}`);
                            }
                            return;
                        }

                        const data = await response.json();
                        
                        // DEBUG: Log de la respuesta completa
                        console.log('üîç Respuesta completa del chat:', data);
                        console.log('üîç Campo modified:', data.modified);
                        console.log('üîç Campo changes:', data.changes);
                        console.log('üîç Campo function_used:', data.function_used);

                        // Ocultar indicador de escritura
                        hideTypingIndicator();

                        // A√±adir respuesta del chat
                        addMessage(data.response);
                        
                        // Si se actualiz√≥ el plan, forzar recarga completa
                        if (data.success && data.plan_updated) {
                            console.log('‚úÖ Plan actualizado, recargando p√°gina...');
                            
                            // Mostrar el mensaje de respuesta
                            if (data.response) {
                                addMessage(data.response, 'assistant');
                            }
                            
                            // FORZAR RECARGA INMEDIATA
                            setTimeout(() => {
                                console.log('üîÑ Ejecutando location.reload()...');
                                location.reload(true);
                            }, 1500);
                            
                            return; // No continuar con el flujo normal
                        }
                        
                        // Si se realizaron modificaciones, mostrar notificaci√≥n
                        console.log('üîç Verificando si hay modificaciones...');
                        console.log('üîç data.modified es:', data.modified, 'tipo:', typeof data.modified);
                        
                        if (data.modified) {
                            console.log('‚úÖ Modificaciones detectadas, mostrando notificaci√≥n...');
                            showModificationNotification({
                                modified: true,
                                changes: data.changes || [],
                                function_used: data.function_used || 'unknown'
                            });
                            
                            // A√±adir badge visual al mensaje
                            addModificationBadge();
                            
                            // ‚ú® NUEVO: Recargar plan despu√©s de modificaci√≥n
                            console.log('üîÑ Plan modificado, recargando dashboard...');
                            setTimeout(async () => {
                                console.log('‚è∞ Ejecutando reloadPlanFromServer despu√©s de 1 segundo...');
                                await reloadPlanFromServer();
                            }, 1000); // Esperar 1 segundo para que la IA termine de guardar
                        } else {
                            console.log('‚ùå No se detectaron modificaciones');
                        }
                        
                        if (!isPremiumUser()) {
                            incrementChatUsage();
                        }
                    } catch (error) {
                        console.error('Error en chat:', error);
                        hideTypingIndicator();
                        addMessage('Error de conexi√≥n. Verifica que el servidor est√© funcionando.');
                    } finally {
                        // Resetear rate limiting
                        window.isProcessingMessage = false;
                        updateSendButton();
                    }
                }

                // Funci√≥n para deshabilitar el input cuando se alcanza el l√≠mite
                function disableChatInput() {
                    chatInput.disabled = true;
                    chatInput.placeholder = 'Mejora a Pro para continuar';
                    sendBtn.disabled = true;
                    sendBtn.style.opacity = '0.5';
                    sendBtn.style.cursor = 'not-allowed';
                    autoResizeTextarea();
                }

                // Funci√≥n para habilitar el input (para usuarios isPremium)
                function enableChatInput() {
                    chatInput.disabled = false;
                    chatInput.placeholder = 'Escribe tu mensaje...';
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '';
                    sendBtn.style.cursor = 'pointer';
                    autoResizeTextarea();
                }

                // Manejar el estado del bot√≥n de env√≠o
                function updateSendButton() {
                    // Si el input est√° deshabilitado, no actualizar el bot√≥n
                    if (chatInput.disabled) return;
                    
                    const hasText = chatInput.value.trim().length > 0;
                    if (hasText) {
                        sendBtn.classList.add('active');
                        sendBtn.disabled = false;
                    } else {
                        sendBtn.classList.remove('active');
                        sendBtn.disabled = true;
                    }
                }

                // Funci√≥n para auto-resize del textarea
                function autoResizeTextarea() {
                    const textarea = chatInput;
                    textarea.style.height = 'auto';
                    const scrollHeight = textarea.scrollHeight;
                    const maxHeight = 180; // max-height en px
                    
                    if (scrollHeight <= maxHeight) {
                        textarea.style.height = scrollHeight + 'px';
                        textarea.classList.remove('chat-input-max');
                    } else {
                        textarea.style.height = maxHeight + 'px';
                        textarea.classList.add('chat-input-max');
                    }
                }
                
                // Event listeners b√°sicos y funcionales
                sendBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('input', () => {
                    updateSendButton();
                    autoResizeTextarea();
                });
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Inicializar estado del bot√≥n y altura del textarea
                updateSendButton();
                autoResizeTextarea();

                // No verificar l√≠mites al cargar - permitir escribir hasta intentar enviar

                // Cargar planes del usuario al iniciar
                loadUserPlans();

                // Event listeners para los overlays
                const rutinaBtn = document.getElementById('rutinaDieta');
                const consejosBtn = document.getElementById('consejosEstudios');
                
                if (rutinaBtn) {
                    rutinaBtn.addEventListener('click', () => {
                        openOverlay('rutinaDietaOverlay');
                        loadRoutineAndDietContent();
                    });
                }
                if (consejosBtn) {
                    consejosBtn.addEventListener('click', () => {
                        openOverlay('consejosEstudiosOverlay');
                        loadAdviceAndStudiesContent();
                    });
                }

                // Hacer funciones disponibles globalmente
                window.logout = logout;
                window.closeUpgradeModal = closeUpgradeModal;
            }

            // ‚ú® NUEVA FUNCI√ìN: Recargar plan desde servidor despu√©s de modificaci√≥n
            async function reloadPlanFromServer() {
                try {
                    console.log('üîÑ Recargando plan desde servidor...');
                    
                    const userId = getCurrentUserId();
                    if (!userId) {
                        console.error('‚ùå No se pudo obtener user_id para recargar plan');
                        return;
                    }

                    console.log('üîç User ID obtenido:', userId);
                    console.log('üîç URL de la petici√≥n:', `${API_BASE}/user/current-routine?user_id=${userId}`);

                    // Obtener datos actualizados del servidor
                    const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                        method: 'GET'
                    });

                    console.log('üì° Respuesta del servidor:', response.status, response.statusText);

                    if (!response.ok) {
                        console.error('‚ùå Error obteniendo plan actualizado:', response.status);
                        return;
                    }

                    const data = await response.json();
                    console.log('üìä Datos recibidos del servidor:', data);
                    console.log('üìä current_routine existe:', !!data.current_routine);
                    console.log('üìä current_diet existe:', !!data.current_diet);

                    if (data.success && data.current_routine) {
                        console.log('‚úÖ Datos v√°lidos recibidos, creando objeto plan...');
                        
                        // Crear objeto plan compatible con displayPlan
                        const plan = {
                            rutina: data.current_routine,
                            dieta: data.current_diet,
                            motivacion: "Rutina actualizada din√°micamente"
                        };

                        console.log('üìã Plan creado:', plan);
                        console.log('üìã Dieta en el plan:', plan.dieta);

                        // Actualizar visualizaci√≥n con datos frescos
                        const isPremium = data.is_premium || false;
                        console.log('üé® Actualizando visualizaci√≥n con isPremium:', isPremium);
                        
                        displayPlan(plan, isPremium);
                        
                        console.log('‚úÖ Plan recargado exitosamente');
                        
                        // Mostrar notificaci√≥n de √©xito
                        showReloadNotification('Plan actualizado correctamente');
                    } else {
                        console.error('‚ùå No se pudo obtener plan actualizado');
                        console.error('‚ùå data.success:', data.success);
                        console.error('‚ùå data.current_routine:', !!data.current_routine);
                    }
                } catch (error) {
                    console.error('‚ùå Error recargando plan:', error);
                }
            }

            // ‚ú® NUEVA FUNCI√ìN: Mostrar notificaci√≥n de recarga
            function showReloadNotification(message) {
                // Crear notificaci√≥n temporal
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #39ff14;
                    color: #000000;
                    padding: 15px 25px;
                    border-radius: 8px;
                    font-weight: 700;
                    z-index: 10000;
                    animation: slideInNotification 0.3s ease;
                    box-shadow: 0 4px 12px rgba(57, 255, 20, 0.3);
                    border: 2px solid #000000;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Remover despu√©s de 3 segundos
                setTimeout(() => {
                    notification.style.animation = 'slideOutNotification 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Funci√≥n para cargar planes del usuario - CORREGIDA PARA USAR current_routine
            async function loadUserPlans() {
                try {
                    // Obtener user_id del token
                    const userId = getCurrentUserId();
                    if (!userId) {
                        console.error('No se pudo obtener user_id');
                        return;
                    }

                    console.log(`üîç Frontend: Solicitando rutina para user_id: ${userId}`);

                    // Usar el endpoint corregido que devuelve current_routine
                    const response = await fetch(`${API_BASE}/user/current-routine?user_id=${userId}`, {
                        method: 'GET'
                    });

                    console.log(`üì° Frontend: Respuesta del servidor: ${response.status}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log(`üìä Frontend: Datos recibidos:`, data);
                        
                        console.log('üîç DEBUG COMPLETO DE MACROS:');
                        console.log('   data.current_diet:', data.current_diet);
                        console.log('   data.current_diet.macros:', data.current_diet?.macros);
                        console.log('   data.current_diet.total_kcal:', data.current_diet?.total_kcal);

                        if (data.current_diet?.macros) {
                            // Normalizaci√≥n robusta para logging
                            const macrosDebug = data.current_diet.macros;
                            const proteinaDebug = macrosDebug.proteinas || macrosDebug.proteina || macrosDebug.protein || 0;
                            const carbosDebug = macrosDebug.hidratos || macrosDebug.carbohidratos || macrosDebug.carbs || 0;
                            const grasasDebug = macrosDebug.grasas || macrosDebug.fats || 0;
                            
                            console.log('   üéØ MACROS ENCONTRADOS (normalizados):');
                            console.log('      proteina:', proteinaDebug, '(original:', macrosDebug.proteina || macrosDebug.proteinas, ')');
                            console.log('      carbohidratos:', carbosDebug, '(original:', macrosDebug.carbohidratos || macrosDebug.hidratos, ')');
                            console.log('      grasas:', grasasDebug, '(original:', macrosDebug.grasas || macrosDebug.fats, ')');
                            console.log('      macros completos:', macrosDebug);
                        } else {
                            console.error('   ‚ùå NO HAY MACROS EN current_diet');
                        }
                        
                        console.log(`üîç Frontend: data.success = ${data.success}`);
                        console.log(`üîç Frontend: data.current_routine existe = ${!!data.current_routine}`);
                        if (data.current_routine) {
                            console.log(`üîç Frontend: exercises count = ${data.current_routine.exercises?.length || 0}`);
                        }
                        
                        if (data.success && data.current_routine) {
                            console.log(`‚úÖ Frontend: Rutina encontrada con ${data.current_routine.exercises?.length || 0} ejercicios`);
                            console.log(`üíé Frontend: Usuario premium seg√∫n servidor: ${data.is_premium}`);
                            
                            // Crear un plan compatible con el formato esperado
                            const plan = {
                                rutina: data.current_routine,
                                dieta: data.current_diet || {},
                                motivacion: "Rutina actualizada din√°micamente"
                            };
                            
                            // Guardar en localStorage para futuras consultas
                            localStorage.setItem("userPlan", JSON.stringify(plan));
                            
                            // Usar el estado premium del servidor en lugar del local
                            const isPremium = data.is_premium;
                            
                            console.log(`üéØ Frontend: Mostrando plan para usuario premium: ${isPremium}`);
                            
                            // Mostrar el plan actualizado
                            console.log('üöÄ Llamando displayPlan() con:', { plan, isPremium });
                            displayPlan(plan, isPremium);
                            return;
                        } else {
                            console.log('‚ùå Frontend: No se encontr√≥ rutina en la respuesta');
                            showNoContentMessages();
                        }
                    } else {
                        console.error('Error al cargar rutina actual:', response.status);
                        showNoContentMessages();
                    }
                } catch (error) {
                    console.error('Error al cargar rutina actual:', error);
                    // Si no se pudo cargar, mostrar mensaje
                showNoContentMessages();
                }
            }

            // Funci√≥n auxiliar para reintentar displayPlan cuando el elemento no existe
            function displayPlanRetry(plan, userPremiumStatus, rutinaContent) {
                console.log('üîÑ displayPlanRetry() llamado');
                if (plan.rutina && plan.rutina.exercises) {
                    const exercises = plan.rutina.exercises;
                    const total = exercises.length;
                    const isPremium = userPremiumStatus !== null ? userPremiumStatus : isPremiumUser();
                    const visibles = isPremium ? total : Math.max(3, Math.ceil(total * 0.25));

                    let rutinaHTML = '';

                    // Mostrar ejercicios con censura para usuarios FREE (retry)
                    exercises.forEach((exercise, index) => {
                        const exerciseName = typeof exercise === 'object' ? exercise.name : exercise;
                        const sets = typeof exercise === 'object' ? (exercise.sets || 'N/A') : 'N/A';
                        const reps = typeof exercise === 'object' ? (exercise.reps || 'N/A') : 'N/A';
                        const weight = typeof exercise === 'object' ? (exercise.weight || 'N/A') : 'N/A';
                        const notes = typeof exercise === 'object' ? (exercise.notes || '') : '';
                        
                        // üîí CENSURA: Solo mostrar primeros 2 ejercicios para usuarios FREE (retry)
                        if (!isPremium && index >= 2) {
                            // Ejercicio censurado
                            rutinaHTML += `<div style="margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; position: relative; overflow: hidden; border-left: 4px solid #cbd5e1;">`;
                            rutinaHTML += `<div style="filter: blur(5px); color: #64748b; user-select: none; pointer-events: none;">`;
                            rutinaHTML += `<strong>${exerciseName}</strong><br>`;
                            rutinaHTML += `<span>Series: ${sets} | Reps: ${reps} | Peso: ${weight}</span>`;
                            rutinaHTML += `</div>`;
                            rutinaHTML += `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(132, 204, 22, 0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">PRO</div>`;
                            rutinaHTML += `</div>`;
                            
                            // Mostrar mensaje de upgrade despu√©s del segundo ejercicio censurado
                            if (index === 2) {
                                rutinaHTML += `
                                    <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center;">
                                        <h3 style="color: white; margin-bottom: 10px;">üîí Desbloquea tu rutina completa</h3>
                                        <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">
                                            Accede a tu plan personalizado completo, modificaciones ilimitadas y seguimiento de progreso
                                        </p>
                                        <button onclick="window.location.href='./tarifas.html'" 
                                                style="background: white; color: #667eea; padding: 12px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                            Mejorar a Premium - ‚Ç¨9.99/mes
                                        </button>
                                    </div>
                                `;
                            }
                            return; // No mostrar m√°s ejercicios para usuarios FREE
                        }
                        
                        // Ejercicio visible (premium o primeros 2 para free)
                        rutinaHTML += `<div style="margin-bottom: 15px; padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #84cc16;">`;
                        rutinaHTML += `<strong style="color: #2d5016;">${exerciseName}</strong><br>`;
                        rutinaHTML += `<span style="color: #365314;">Series: ${sets} | Reps: ${reps} | Peso: ${weight}</span>`;
                        if (notes) {
                            rutinaHTML += `<br><em style="color: #84cc16; font-size: 12px;">${notes}</em>`;
                        }
                        rutinaHTML += `</div>`;
                    });

                    console.log('üé® Insertando HTML en DOM (retry)');
                    console.log('   Container found:', !!rutinaContent);
                    console.log('   HTML length:', rutinaHTML.length);
                    
                    if (rutinaContent) {
                        // üî• FORZAR VISIBILIDAD DEL CONTAINER (retry)
                        rutinaContent.style.display = 'block';
                        rutinaContent.style.visibility = 'visible';
                        rutinaContent.style.opacity = '1';
                        rutinaContent.style.zIndex = '10';
                        rutinaContent.style.position = 'relative';
                        
                        // üî• OCULTAR MENSAJES DE ERROR (retry)
                        const noContentMessages = rutinaContent.querySelectorAll('p');
                        noContentMessages.forEach(p => {
                            if (p.textContent.includes('No tienes una rutina generada')) {
                                p.style.display = 'none';
                                console.log('üö´ Ocultando mensaje de error encontrado (retry)');
                            }
                        });
                        
                        // üî• INSERTAR HTML (retry)
                        rutinaContent.innerHTML = rutinaHTML;
                        console.log('‚úÖ HTML insertado correctamente (retry)');
                        console.log('‚úÖ Container forzado a ser visible (retry)');
                    } else {
                        console.error('‚ùå rutinaContent es NULL en retry');
                    }
                }
            }

            // Funci√≥n para mostrar el plan en los overlays - DISE√ëO MINIMALISTA
            function displayPlan(plan, userPremiumStatus = null) {
                console.log('üé® displayPlan() llamado con:', plan);
                console.log('üé® userPremiumStatus:', userPremiumStatus);
                
                const rutinaContent = document.getElementById('rutinaContent');
                const dietaContent = document.getElementById('dietaContent');
                const isPremium = userPremiumStatus !== null ? userPremiumStatus : isPremiumUser();
                
                // Si el elemento no existe, esperar un poco y reintentar
                if (!rutinaContent) {
                    console.log('‚ö†Ô∏è rutinaContent no encontrado, reintentando en 100ms...');
                    setTimeout(() => {
                        const retryRutinaContent = document.getElementById('rutinaContent');
                        if (retryRutinaContent) {
                            console.log('‚úÖ rutinaContent encontrado en reintento');
                            displayPlanRetry(plan, userPremiumStatus, retryRutinaContent);
                        } else {
                            console.error('‚ùå rutinaContent sigue sin existir despu√©s del reintento');
                        }
                    }, 100);
                    return;
                }
                
                if (plan.rutina && plan.rutina.exercises) {
                    // RUTINA - DISE√ëO MINIMALISTA (SIN DUPLICADOS)
                    let rutinaHtml = `
                        <style>
                            #rutinaContent, #dietaContent {
                                background: #000000;
                                color: #ffffff;
                                padding: 40px 35px;
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                                line-height: 1.6;
                            }
                            .section-title {
                                font-size: 28px;
                                font-weight: 700;
                                margin-bottom: 8px;
                                color: #ffffff;
                                letter-spacing: -0.5px;
                            }
                            .section-subtitle {
                                font-size: 15px;
                                color: #999999;
                                margin-bottom: 35px;
                                font-weight: 400;
                                line-height: 1.5;
                            }
                            .day-title {
                                font-size: 18px;
                                font-weight: 600;
                                margin-top: 32px;
                                margin-bottom: 16px;
                                color: #ffffff;
                                padding-bottom: 8px;
                                border-bottom: 2px solid rgba(179, 255, 0, 0.3);
                                letter-spacing: 0.3px;
                            }
                            .exercise-item {
                                font-size: 15px;
                                color: #e0e0e0;
                                margin-left: 0;
                                margin-bottom: 10px;
                                line-height: 1.6;
                                padding: 8px 0;
                                padding-left: 24px;
                                position: relative;
                            }
                            .exercise-item::before {
                                content: "‚Ä¢";
                                position: absolute;
                                left: 8px;
                                color: #b3ff00;
                                font-weight: bold;
                                font-size: 18px;
                            }
                            .meal-title {
                                font-size: 18px;
                                font-weight: 600;
                                margin-top: 32px;
                                margin-bottom: 16px;
                                color: #ffffff;
                                padding-bottom: 8px;
                                border-bottom: 2px solid rgba(179, 255, 0, 0.3);
                                letter-spacing: 0.3px;
                            }
                            .food-item {
                                font-size: 14px; /* Reducido para que quepa en una l√≠nea con calor√≠as */
                                color: #e0e0e0;
                                margin-left: 0;
                                margin-bottom: 12px; /* Aumentado de 10px a 12px para m√°s espacio */
                                line-height: 1.5; /* Ajustado para mejor ajuste en una l√≠nea */
                                padding: 10px 0; /* Aumentado de 8px a 10px */
                                padding-left: 24px;
                                position: relative;
                                font-weight: 500; /* Hacer el texto un poco m√°s grueso */
                            }
                            .food-item::before {
                                content: "‚Ä¢";
                                position: absolute;
                                left: 8px;
                                color: #b3ff00;
                                font-weight: bold;
                                font-size: 18px;
                            }
                            .censored-content {
                                filter: blur(8px);
                                background: rgba(26, 26, 26, 0.8);
                                padding: 20px;
                                margin: 20px 0;
                                border-radius: 8px;
                                pointer-events: none;
                                user-select: none;
                                opacity: 0.6;
                                position: relative;
                            }
                            .upgrade-overlay {
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                padding: 30px;
                                border-radius: 12px;
                                text-align: center;
                                margin: 30px 0;
                            }
                            .upgrade-overlay h3 {
                                color: white;
                                font-size: 24px;
                                margin-bottom: 10px;
                            }
                            .upgrade-overlay p {
                                color: rgba(255,255,255,0.9);
                                font-size: 16px;
                                margin-bottom: 20px;
                            }
                            .upgrade-button {
                                background: white;
                                color: #667eea;
                                padding: 12px 30px;
                                border: none;
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 16px;
                            }
                        </style>
                        <h1 class="section-title">Rutina de entrenamiento</h1>
                        <p class="section-subtitle">${plan.rutina.titulo || 'Plan personalizado'}</p>
                    `;
                    
                    // Agrupar ejercicios por d√≠a
                    const exercisesByDay = {};
                    plan.rutina.exercises.forEach(exercise => {
                        const day = exercise.day || 'Sin d√≠a';
                        if (!exercisesByDay[day]) {
                            exercisesByDay[day] = [];
                        }
                        exercisesByDay[day].push(exercise);
                    });
                    
                    const days = Object.keys(exercisesByDay);
                    let upgradeShown = false;
                    
                    days.forEach((day, index) => {
                        // Primer d√≠a siempre visible
                        if (index === 0) {
                            rutinaHtml += `<div class="day-title">${day}</div>`;
                            exercisesByDay[day].forEach(ej => {
                                rutinaHtml += `<div class="exercise-item">${ej.name} ${ej.sets}x${ej.reps}</div>`;
                            });
                        } 
                        // Resto censurado para FREE
                        else if (!isPremium) {
                            if (index === 1 && !upgradeShown) {
                                rutinaHtml += `
                                    <div class="censored-content">
                                        <div class="day-title">${day}</div>
                                        ${exercisesByDay[day].map(ej => 
                                            `<div class="exercise-item">${ej.name} ${ej.sets}x${ej.reps}</div>`
                                        ).join('')}
                                    </div>
                                `;
                                
                                // Overlay de upgrade despu√©s del primer d√≠a censurado
                                rutinaHtml += `
                                    <div style="
                                        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                                        border: 2px solid #39ff14;
                                        padding: 40px 30px;
                                        border-radius: 16px;
                                        text-align: center;
                                        margin: 30px 0;
                                        box-shadow: 0 0 30px rgba(57, 255, 20, 0.15);
                                    ">
                                        <h3 style="color: #39ff14; font-size: 24px; font-weight: 700; margin-bottom: 12px;">
                                            Desbloquea la Rutina Completa
                                        </h3>
                                        <p style="color: #cccccc; font-size: 15px; margin-bottom: 25px;">
                                            Accede a todos los d√≠as, modificaciones ilimitadas con IA y seguimiento de progreso
                                        </p>
                                        <button onclick="window.location.href='./tarifas.html'" style="
                                            background: #39ff14;
                                            color: #000000;
                                            padding: 14px 40px;
                                            border: none;
                                            border-radius: 10px;
                                            font-weight: 700;
                                            cursor: pointer;
                                            font-size: 16px;
                                            text-transform: uppercase;
                                            letter-spacing: 0.5px;
                                            transition: all 0.3s ease;
                                        ">
                                            Mejorar a Premium - ‚Ç¨9.99/mes
                                        </button>
                                    </div>
                                `;
                                upgradeShown = true;
                            } else if (index > 1) {
                                rutinaHtml += `
                                    <div class="censored-content">
                                        <div class="day-title">${day}</div>
                                        <div class="exercise-item">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà</div>
                                        <div class="exercise-item">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà</div>
                                    </div>
                                `;
                            }
                        }
                        // Todo visible para PREMIUM
                        else {
                            rutinaHtml += `<div class="day-title">${day}</div>`;
                            exercisesByDay[day].forEach(ej => {
                                rutinaHtml += `<div class="exercise-item">${ej.name} ${ej.sets}x${ej.reps}</div>`;
                            });
                        }
                    });
                    
                    // Insertar rutina
                    if (rutinaContent) {
                        rutinaContent.style.display = 'block';
                        rutinaContent.style.visibility = 'visible';
                        rutinaContent.style.opacity = '1';
                        rutinaContent.innerHTML = rutinaHtml;
                        console.log('‚úÖ Rutina insertada con dise√±o minimalista');
                    }
                }
                
                // DIETA - DISE√ëO MINIMALISTA
                console.log('üçΩÔ∏è Verificando dieta:', plan.dieta);
                // Fallback de claves: normalizar meals/comidas
                const meals = plan.dieta?.meals || plan.dieta?.comidas || [];
                console.log('üçΩÔ∏è Tiene meals?', !!plan.dieta?.meals);
                console.log('üçΩÔ∏è Tiene comidas?', !!plan.dieta?.comidas);
                console.log('üçΩÔ∏è Meals normalizado count:', meals.length);
                
                // Validaci√≥n robusta: asegurar que meals es un array v√°lido
                if (dietaContent && plan.dieta && Array.isArray(meals) && meals.length > 0) {
                    const totalKcal = (typeof plan.dieta.total_kcal === 'number')
                        ? plan.dieta.total_kcal
                        : (Array.isArray(meals)
                            ? meals.reduce((acc, m) => acc + (Number(m.kcal) || 0), 0)
                            : 0);
                    // Normalizaci√≥n robusta de macros con fallbacks
                    const macros = plan.dieta?.macros || {};
                    const proteinaVal = macros.proteinas || macros.proteina || macros.protein || 0;
                    const carbosVal = macros.hidratos || macros.carbohidratos || macros.carbs || 0;
                    const grasasVal = macros.grasas || macros.fats || 0;
                    const caloriasVal = macros.calorias || macros.total_kcal || totalKcal || 0;
                    
                    // Logging para depuraci√≥n
                    console.log('üîç Macros normalizados en displayPlan:', {
                        proteina: proteinaVal,
                        carbos: carbosVal,
                        grasas: grasasVal,
                        calorias: caloriasVal,
                        macrosOriginales: macros
                    });
                    
                    let dietaHtml = `
                        <h1 class="section-title" style="margin-top: 50px;">Plan nutricional</h1>
                    `;
                    
                    // Envolver todo el contenido en blur para usuarios free
                    if (!isPremium) {
                        dietaHtml += `<div style="position: relative;">`;
                        dietaHtml += `<div class="blur-content">`;
                    }
                    
                    dietaHtml += `<p class="section-subtitle">Plan personalizado - ${caloriasVal} kcal diarias<br><span style="color:#b3ff00;font-size:14px;font-weight:500;margin-top:8px;display:inline-block;">Prote√≠nas: ${proteinaVal}g | Carbos: ${carbosVal}g | Grasas: ${grasasVal}g</span></p>`;
                    
                    meals.forEach((comida, index) => {
                        console.log(`üçΩÔ∏è Comida ${index}:`, comida);
                        dietaHtml += `<div class="meal-title">${comida.nombre}${comida.kcal ? ` <span style="color: #84cc16; font-size: 0.9em; font-weight: 400;">(${comida.kcal} kcal)</span>` : ''}</div>`;
                        if (comida.alimentos) {
                            // Debug: log del primer alimento para ver estructura
                            if (comida.alimentos.length > 0 && index === 0) {
                                console.log('üçé Estructura del primer alimento:', comida.alimentos[0]);
                                console.log('üîç Tipo:', typeof comida.alimentos[0]);
                            }
                            
                            comida.alimentos.forEach(alimento => {
                                const alimentoText = renderAlimento(alimento);
                                dietaHtml += `<div class="food-item">${alimentoText}</div>`;
                            });
                        }
                    });
                    
                    // Cerrar wrapper de blur y a√±adir badge para usuarios free
                    if (!isPremium) {
                        dietaHtml += `</div>`; // Close blur-content
                        dietaHtml += getPremiumLockHTML("Dieta Completa Bloqueada", "Desbloquea todas las comidas, recetas y ajustes de macros.");
                        dietaHtml += `</div>`; // Close position relative container
                    }
                    
                    // Insertar dieta
                    if (dietaContent) {
                        // üî• LIMPIAR MENSAJES DE ERROR QUE TAPAN LA DIETA
                        const noContentMessages = dietaContent.querySelectorAll('p');
                        noContentMessages.forEach(p => {
                            if (p.textContent.includes('No tienes') || p.textContent.includes('nutricional')) {
                                p.style.display = 'none';
                                p.remove(); // Eliminarlo completamente
                                console.log('üö´ Eliminando mensaje de error que tapa la dieta');
                            }
                        });
                        
                        // üî• FORZAR VISIBILIDAD
                        dietaContent.style.display = 'block';
                        dietaContent.style.visibility = 'visible';
                        dietaContent.style.opacity = '1';
                        dietaContent.style.zIndex = '10';
                        dietaContent.style.position = 'relative';
                        
                        // üî• INSERTAR DIETA
                        dietaContent.innerHTML = dietaHtml;
                        console.log('‚úÖ Dieta insertada con dise√±o minimalista');
                    }
                } else {
                    console.error('‚ùå No se pudo renderizar dieta:');
                    console.error('  - dietaContent existe:', !!dietaContent);
                    console.error('  - plan.dieta existe:', !!plan.dieta);
                    console.error('  - plan.dieta.meals existe:', !!plan.dieta?.meals);
                    console.error('  - plan.dieta.comidas existe:', !!plan.dieta?.comidas);
                    console.error('  - meals normalizado length:', (plan.dieta?.meals || plan.dieta?.comidas || []).length);
                    
                    // Forzar mostrar mensaje de error
                    if (dietaContent) {
                        dietaContent.innerHTML = `
                            <h1 class="section-title" style="margin-top: 50px;">Plan nutricional</h1>
                            <p style="color: #ff4444;">Error: No se pudo cargar el plan nutricional</p>
                            <pre style="color: #888; font-size: 12px;">${JSON.stringify(plan.dieta, null, 2)}</pre>
                        `;
                    }
                }

                // Mostrar consejos (aplicar recorte si es free)
                const consejosContent = document.getElementById('consejosContent');
                if (plan.rutina && plan.rutina.consejos) {
                    const consejos = plan.rutina.consejos;
                    const total = consejos.length;
                    const isPremium = isPremiumUser();
                    const visibles = isPremium ? total : Math.max(2, Math.ceil(total * 0.33)); // Mostrar 33% (m√≠nimo 2)

                    // --- INICIO BLOQUE NUEVO DISE√ëO ---

                    // 1. Inyectar estilos CSS frescos (para evitar cach√© externa)
                    const styleTag = document.createElement('style');
                    styleTag.innerHTML = `
                        .sci-card {
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            margin-bottom: 16px;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                            border-left: 5px solid #4F46E5; /* Indigo Profesional */
                            transition: transform 0.2s;
                        }
                        .sci-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 10px 15px rgba(0,0,0,0.08);
                        }
                        .sci-title {
                            color: #111827;
                            font-weight: 700;
                            font-size: 1.1rem;
                            margin-bottom: 8px;
                            display: flex;
                            align-items: center;
                        }
                        .sci-icon {
                            margin-right: 10px;
                            background: #EEF2FF;
                            color: #4F46E5;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            font-size: 1.2rem;
                        }
                        .sci-text {
                            color: #4B5563;
                            line-height: 1.6;
                            font-size: 0.95rem;
                        }
                        .sci-ref {
                            margin-top: 12px;
                            padding-top: 12px;
                            border-top: 1px solid #F3F4F6;
                            font-size: 0.85rem;
                            color: #6B7280;
                            font-style: italic;
                        }
                    `;
                    document.head.appendChild(styleTag);

                    // 2. Generar el HTML
                    let consejosHTML = '<h3 class="text-2xl font-bold text-gray-800 mb-6">üß¨ Evidencia Cient√≠fica y Consejos</h3>';

                    // Renderizar Consejos de la Dieta (si existen)
                    const consejosArray = plan.dieta?.consejos_finales || plan.dieta?.tips || plan.rutina?.consejos || [];
                    consejosArray.forEach((consejo, index) => {
                        // Limpieza b√°sica del texto
                        let titulo = "Consejo Clave";
                        let cuerpo = consejo;
                        
                        if (typeof consejo === 'string' && consejo.includes(':')) {
                            const partes = consejo.split(':');
                            titulo = partes[0].trim();
                            cuerpo = partes.slice(1).join(':').trim();
                        } else if (typeof consejo === 'string') {
                            cuerpo = consejo;
                        }

                        consejosHTML += `
                        <div class="sci-card">
                            <div class="sci-title">
                                <span class="sci-icon">üí°</span>
                                ${titulo}
                            </div>
                            <div class="sci-text">${cuerpo}</div>
                        </div>`;
                    });

                    // Renderizar Estudios / Metadata (si existen)
                    if (plan.metadata && plan.metadata.contexto_cientifico) {
                         consejosHTML += `
                        <div class="sci-card" style="border-left-color: #059669;"> <div class="sci-title">
                                <span class="sci-icon" style="color:#059669; background:#ECFDF5;">üìö</span>
                                Base Cient√≠fica (RAG)
                            </div>
                            <div class="sci-text text-sm">
                                ${plan.metadata.contexto_cientifico.substring(0, 300)}...
                            </div>
                            <div class="sci-ref">Fuente: An√°lisis de papers deportivos recientes.</div>
                        </div>`;
                    }

                    // --- FIN BLOQUE NUEVO DISE√ëO ---

                    // Safety check: verificar que el elemento existe antes de asignar
                    if (consejosContent) {
                        consejosContent.innerHTML = consejosHTML;
                    } else {
                        console.warn('‚ö†Ô∏è Contenedor consejosContent no encontrado en el DOM');
                    }
                }
            }

            // Funci√≥n para abrir overlays
            function openOverlay(overlayId) {
                const overlay = document.getElementById(overlayId);
                if (!overlay) {
                    console.error('Overlay no encontrado:', overlayId);
                    return;
                }
                
                // Si es el overlay de consejos y estudios, mostrar como p√°gina completa
                if (overlayId === 'consejosEstudiosOverlay') {
                    overlay.style.display = 'block';
                    // Cargar contenido cuando se abre
                    loadAdviceAndStudiesContent();
                } else {
                    overlay.style.display = 'flex';
                }
            }

            // Funci√≥n para cerrar overlays
            function closeOverlay(overlayId) {
                const overlay = document.getElementById(overlayId);
                if (!overlay) {
                    console.error('Overlay no encontrado:', overlayId);
                    return;
                }
                overlay.style.display = 'none';
            }

            // Funci√≥n para cargar contenido de rutina y dieta
            function loadRoutineAndDietContent() {
                const storedPlan = localStorage.getItem('userPlan');
                const isPremium = isPremiumUser();
                
                if (storedPlan) {
                    try {
                        const plan = JSON.parse(storedPlan);
                        displayRoutineContent(plan, isPremium);
                        displayDietContent(plan, isPremium);
                    } catch (e) {
                        console.error('Error parsing stored plan:', e);
                        // Intentar cargar desde la base de datos
                        loadUserPlans();
                    }
                } else {
                    // Intentar cargar desde la base de datos
                    loadUserPlans();
                }
            }

            // Funci√≥n para mostrar contenido de rutina
            function displayRoutineContent(plan, isPremium) {
                const contentArea = document.getElementById('rutinaContent');
                
                if (plan.rutina && plan.rutina.dias) {
                    const dias = plan.rutina.dias;
                    const total = dias.length;
                    const visibles = isPremium ? total : Math.max(1, Math.ceil(total * 0.2)); // 20% para usuarios b√°sicos

                    let routineHTML = '<h2 class="section-title" style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #ffffff;">Rutina de entrenamiento</h2>';
                    
                    // Mostrar d√≠as visibles
                    dias.slice(0, visibles).forEach(dia => {
                        routineHTML += `<div class="routine-item">`;
                        routineHTML += `<div class="routine-day">${dia.dia || dia.nombre}</div>`;
                        (dia.ejercicios || []).forEach(ejercicio => {
                            routineHTML += `<div class="exercise">`;
                            routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                            routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                            routineHTML += `</div>`;
                        });
                        routineHTML += `</div>`;
                    });

                    // Mostrar d√≠as censurados para usuarios no isPremium
                    if (!isPremium && visibles < total) {
                        const ocultos = total - visibles;
                        let lockShown = false;
                        
                        // Agregar d√≠as censurados
                        dias.slice(visibles, visibles + Math.min(ocultos, 2)).forEach((dia, index) => {
                            routineHTML += `<div class="routine-item isPremium-overlay" style="position: relative;">`;
                            routineHTML += `<div class="routine-day">${dia.dia || dia.nombre}</div>`;
                            (dia.ejercicios || []).forEach(ejercicio => {
                                routineHTML += `<div class="exercise">`;
                                routineHTML += `<div class="exercise-name">${ejercicio.nombre}</div>`;
                                routineHTML += `<div class="exercise-details">Series: ${ejercicio.series} | Reps: ${ejercicio.repeticiones} | Descanso: ${ejercicio.descanso}</div>`;
                                routineHTML += `</div>`;
                            });
                            // Mostrar bloqueo solo en el primer d√≠a bloqueado
                            if (!lockShown) {
                                routineHTML += getPremiumLockHTML("Rutina Completa Bloqueada", "Accede a todos los d√≠as de entrenamiento y progresiones.");
                                lockShown = true;
                            }
                            routineHTML += `</div>`;
                        });
                    }

                    contentArea.innerHTML = routineHTML;
                } else {
                    // COMENTADO: No insertar mensaje de error para evitar conflictos con displayPlan()
                    // contentArea.innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
                    console.log('‚ö†Ô∏è No hay rutina para mostrar en funci√≥n alternativa');
                }
            }

            // Funci√≥n para mostrar contenido de dieta
            function displayDietContent(plan, isPremium) {
                const contentArea = document.getElementById('dietaContent');
                
                // Fallback de claves: normalizar meals/comidas
                const meals = plan.dieta?.meals || plan.dieta?.comidas || [];
                
                if (plan.dieta && Array.isArray(meals) && meals.length > 0) {
                    const comidas = meals;
                    const total = comidas.length;
                    const visibles = isPremium ? total : Math.max(2, Math.ceil(total * 0.5)); // 50% para usuarios b√°sicos

                    let dietHTML = '<h2 class="section-title" style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #ffffff;">Plan nutricional</h2>';
                    
                    // Envolver todo el contenido en blur para usuarios free
                    if (!isPremium) {
                        dietHTML += `<div style="position: relative;">`;
                        dietHTML += `<div class="blur-content">`;
                    }
                    
                    // Normalizaci√≥n robusta de macros con fallbacks
                    const macros = plan.dieta?.macros || {};
                    const proteinaVal = macros.proteinas || macros.proteina || macros.protein || 0;
                    const carbosVal = macros.hidratos || macros.carbohidratos || macros.carbs || 0;
                    const grasasVal = macros.grasas || macros.fats || 0;
                    const caloriasVal = macros.calorias || macros.total_kcal || plan.dieta?.kcal_objetivo || 0;
                    
                    // Logging para depuraci√≥n
                    console.log('üîç Macros normalizados en displayDietContent:', {
                        proteina: proteinaVal,
                        carbos: carbosVal,
                        grasas: grasasVal,
                        calorias: caloriasVal,
                        macrosOriginales: macros
                    });
                    
                    // Mostrar macros si est√°n disponibles
                    if (plan.dieta?.macros || proteinaVal || carbosVal || grasasVal) {
                        dietHTML += `<div class="macros-grid">`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${proteinaVal}g</span><span class="macro-label">Prote√≠nas</span></div>`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${carbosVal}g</span><span class="macro-label">Carbohidratos</span></div>`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${grasasVal}g</span><span class="macro-label">Grasas</span></div>`;
                        dietHTML += `<div class="macro-card"><span class="macro-value">${caloriasVal || ''}</span><span class="macro-label">Calor√≠as</span></div>`;
                        dietHTML += `</div>`;
                    }

                    // Mostrar comidas visibles
                    comidas.slice(0, visibles).forEach((comida, index) => {
                        dietHTML += `<div class="meal-card">`;
                        dietHTML += `<div class="meal-header">`;
                        dietHTML += `<span class="meal-time">${comida.kcal ? `${comida.kcal} kcal` : ''}</span>`;
                        dietHTML += `<span class="meal-name">${comida.nombre}</span>`;
                        dietHTML += `</div>`;
                        if (comida.alimentos) {
                            comida.alimentos.forEach(alimento => {
                                dietHTML += `<div class="food-item">`;
                                const alimentoText = renderAlimento(alimento);
                                dietHTML += `<span>${alimentoText}</span>`;
                                dietHTML += `</div>`;
                            });
                        }
                        dietHTML += `</div>`; // Close meal-card
                    });
                    
                    // Cerrar wrapper de blur y a√±adir badge para usuarios free
                    if (!isPremium) {
                        dietHTML += `</div>`; // Close blur-content
                        dietHTML += getPremiumLockHTML("Dieta Completa Bloqueada", "Desbloquea todas las comidas, recetas y ajustes de macros.");
                        dietHTML += `</div>`; // Close position relative container
                    }


                    contentArea.innerHTML = dietHTML;
                } else {
                    // COMENTADO: Conflicto con displayPlan() que inserta la dieta gen√©rica
                    // contentArea.innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
                    console.log('‚ö†Ô∏è No hay dieta en localStorage, pero displayPlan() deber√≠a insertarla');
                }
            }

            // Funci√≥n para cargar contenido de consejos y estudios
            function loadAdviceAndStudiesContent() {
                const contentArea = document.getElementById('consejosEstudiosContent');
                if (!contentArea) {
                    console.error('No se encontr√≥ el contenedor consejosEstudiosContent');
                    return;
                }
                
                // Obtener el estado premium
                const isPremium = window.isPremiumUser ? window.isPremiumUser() : false;
                
                // Estilos por categor√≠a (transparentes con acentos)
                const categoryStyles = {
                    'Entrenamiento': {
                        bg: 'rgba(57, 255, 20, 0.15)',      // Verde ne√≥n transparente
                        text: '#39ff14',    // Verde ne√≥n
                        border: 'rgba(57, 255, 20, 0.3)'   // Borde verde ne√≥n transparente
                    },
                    'Nutrici√≥n': {
                        bg: 'rgba(59, 130, 246, 0.15)',      // Azul transparente
                        text: '#3b82f6',    // Azul brillante
                        border: 'rgba(59, 130, 246, 0.3)'
                    },
                    'Recuperaci√≥n': {
                        bg: 'rgba(167, 139, 250, 0.15)',      // P√∫rpura transparente
                        text: '#a78bfa',    // P√∫rpura claro
                        border: 'rgba(167, 139, 250, 0.3)'
                    },
                    'Suplementaci√≥n': {
                        bg: 'rgba(251, 146, 60, 0.15)',      // Naranja transparente
                        text: '#fb923c',    // Naranja brillante
                        border: 'rgba(251, 146, 60, 0.3)'
                    }
                };
                
                // Array de art√≠culos
                const articulos = [
                    {
                        categoria: 'Entrenamiento',
                        titulo: '¬øPor qu√© no crecen tus m√∫sculos?',
                        contenido: [
                            'La hipertrofia responde a tres mecanismos: tensi√≥n mec√°nica, da√±o muscular y estr√©s metab√≥lico. Las series pesadas de 6-8 repeticiones maximizan la tensi√≥n, mientras que las de 12-15 reps generan mayor estr√©s metab√≥lico. La clave est√° en integrarlos estrat√©gicamente.',
                            'El volumen es crucial: 10-20 series semanales por grupo muscular. La proximidad al fallo tambi√©n importa: las √∫ltimas 5 repeticiones (RIR 1-3) generan el est√≠mulo real. Acumula 10-20 series/m√∫sculo/semana, entrena cada grupo 2-3 veces/semana y termina series a RIR 1-3.'
                        ],
                        referencias: [
                            { titulo: 'The mechanisms of muscle hypertrophy and their application to resistance training', pmid: '20847704' },
                            { titulo: 'Dose-response relationship between weekly resistance training volume and increases in muscle mass', pmid: '28834797' },
                            { titulo: 'A Systematic Review of The Effects of Different Resistance Training Volumes on Muscle Hypertrophy', pmid: '35291645' }
                        ]
                    },
                    {
                        categoria: 'Nutrici√≥n',
                        titulo: 'No ingieras prote√≠na justo al acabar de entrenar',
                        contenido: [
                            'Si solo ingieres prote√≠na post-entreno, tu cuerpo activa la gluconeog√©nesis: convierte los amino√°cidos en glucosa para reponer el gluc√≥geno vac√≠o. El problema: esa prote√≠na que deber√≠a reparar fibras musculares se desv√≠a para fabricar energ√≠a, desaprovechando el recurso m√°s valioso para la hipertrofia.',
                            'La estrategia √≥ptima es combinar carbohidratos + prote√≠na. Los carbohidratos reponen r√°pidamente el gluc√≥geno, mientras que la prote√≠na se destina completamente a la s√≠ntesis proteica. Combina 20-40g de prote√≠na + 40-80g de carbohidratos en tu comida post-entreno (batido con pl√°tano, arroz con pollo, patatas con at√∫n).'
                        ],
                        referencias: [
                            { titulo: 'Carbohydrate and protein co-ingestion augments skeletal muscle glycogen synthesis', pmid: '33507402' },
                            { titulo: 'Impact of Muscle Glycogen Availability on the Capacity for Repeated Exercise in Man', pmid: '29519691' },
                            { titulo: 'Biochemistry, Gluconeogenesis', pmid: '31082163' }
                        ]
                    },
                    {
                        categoria: 'Nutrici√≥n',
                        titulo: 'Prote√≠na: Cantidad, Distribuci√≥n y el Mito de los 30g',
                        contenido: [
                            'Para hipertrofia necesitas 1.6-2.2g/kg/d√≠a seg√∫n Morton (2018). De 0.8 a 1.5g/kg ves mejoras significativas, de 1.5 a 2.0g/kg las mejoras son peque√±as pero presentes, y m√°s all√° de 2.2g/kg no hay beneficios adicionales. En d√©ficit cal√≥rico aumenta a 2.0-2.4g/kg para preservar m√∫sculo. La distribuci√≥n es menos importante: estudios con ayuno intermitente 16/8 muestran ganancias equivalentes a 4-5 comidas. Lo determinante es la prote√≠na total diaria, no el n√∫mero de comidas.',
                            'El mito de "solo absorbes 30g por comida" es falso. Estudios de 2024 demuestran que el cuerpo absorbe y utiliza 100g+ en una comida. La leucina es clave: necesitas 2-3g por comida (equivalente a 20-30g de prote√≠na de calidad) para activar mTOR y maximizar la s√≠ntesis muscular. Estrategia: alcanza 1.6-2.2g/kg diariamente, distribuye en 3-5 comidas o practica ayuno si prefieres, y asegura 20-30g por comida para activar leucina.'
                        ],
                        referencias: [
                            { titulo: 'A systematic review, meta-analysis and meta-regression of the effect of protein supplementation on resistance training-induced gains in muscle mass and strength', pmid: '28698222' },
                            { titulo: 'Evidence-based recommendations for natural bodybuilding contest preparation: nutrition and supplementation', pmid: '24864135' },
                            { titulo: 'How much protein can the body use in a single meal for muscle-building?', pmid: '29497353' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: '¬øCu√°nto debo entrenar?',
                        contenido: [
                            'El volumen √≥ptimo es 12-20 series efectivas semanales por grupo muscular seg√∫n Baz-Valle (2022). Menos de 12 deja ganancias sobre la mesa, m√°s de 20 no produce beneficio adicional. Una serie solo es efectiva si alcanzas RIR 5 o menos (dejar m√°ximo 5 reps en el tanque). El punto dulce es RIR 1-3: suficiente intensidad para maximizar s√≠ntesis proteica sin la fatiga desproporcionada del fallo absoluto.',
                            'Tu capacidad de tolerar volumen depende de tu estado cal√≥rico. En super√°vit puedes operar en el rango alto (16-20 series), en d√©ficit reduce al rango bajo (10-14 series). Principiantes: 6-12 series/semana. Intermedios/Avanzados: 12-20 series/semana. Entrena cada m√∫sculo 2 veces/semana distribuyendo 6-10 series por sesi√≥n. Una vez alcances tu rango √≥ptimo, progresa aumentando carga y esfuerzo, no a√±adiendo m√°s series indefinidamente.'
                        ],
                        referencias: [
                            { titulo: 'Dose-response relationship between weekly resistance training volume and increases in muscle mass', pmid: '27433992' },
                            { titulo: 'A Systematic Review of The Effects of Different Resistance Training Volumes on Muscle Hypertrophy', pmid: '35291645' },
                            { titulo: 'Training volume increases or maintenance: effects on muscular adaptations', pmid: '38970765' },
                            { titulo: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength in Trained Men', pmid: '30153194' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Frecuencia de Entrenamiento: ¬øCu√°ntas Veces por Semana Entrenar Cada M√∫sculo?',
                        contenido: [
                            'La frecuencia no es el driver, es la herramienta. El volumen semanal total (12-20 series efectivas) es lo que impulsa la hipertrofia. Entrenar cada m√∫sculo 2 veces por semana produce significativamente m√°s hipertrofia que 1 vez seg√∫n Schoenfeld (2016, 2019). Existe un l√≠mite pr√°ctico de 10-12 series efectivas por grupo muscular por sesi√≥n. A partir de ese punto, la fatiga degrada la calidad de las series subsecuentes.',
                            'La estrategia ganadora: divide tu volumen semanal objetivo (12-20 series) en 2 sesiones de 6-10 series cada una. Fullbody 3 d√≠as/semana es ideal para principiantes. Upper/Lower 4 d√≠as o PPL 6 d√≠as (frecuencia 2x) es ideal para intermedios/avanzados. El bro-split (1 m√∫sculo/d√≠a) es sub√≥ptimo. Nunca pases de 10-12 series efectivas por grupo muscular en una sola sesi√≥n.'
                        ],
                        referencias: [
                            { titulo: 'Effects of Resistance Training Frequency on Measures of Muscle Hypertrophy: A Systematic Review and Meta-Analysis', pmid: '27102172' },
                            { titulo: 'How many times per week should a muscle be trained to maximize muscle hypertrophy?', pmid: '30558493' },
                            { titulo: 'Dose-response relationship between weekly resistance training volume and increases in muscle mass', pmid: '27433992' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Rango de Repeticiones: El Mito M√°s Grande del Fitness Desacreditado',
                        contenido: [
                            'El continuum tradicional (1-5 reps fuerza, 6-12 hipertrofia, 15+ resistencia) es un mito. El meta-an√°lisis de Schoenfeld (2021) demuestra que todos los rangos de 3-30 reps producen hipertrofia ID√âNTICA cuando el volumen total y la proximidad al fallo se equiparan. Lo que realmente importa es el RIR (Repeticiones en Reserva): series a RIR 0-1 producen 100% de s√≠ntesis proteica m√°xima, RIR 2-3 producen 95-98%.',
                            'El rango 6-12 reps no produce m√°s m√∫sculo pero tiene ventajas pr√°cticas: mejor balance de los 3 mecanismos de hipertrofia, m√°s eficiente en tiempo, t√©cnica se mantiene bien. Si prefieres cargas pesadas: 3-8 reps funciona perfectamente con m√°s series. Si prefieres pump: 15-25 reps es igualmente efectivo con menos series. La clave: lleva las series a RIR 1-3 en cualquier rango.'
                        ],
                        referencias: [
                            { titulo: 'A Re-Examination of the Repetition Continuum', pmid: 'No disponible - Journal ACSM-MSSE 2021' },
                            { titulo: 'Muscular adaptations in response to three different resistance-training regimens', pmid: '12436270' },
                            { titulo: 'Neither load nor systemic hormones determine resistance training-mediated hypertrophy', pmid: '27928218' },
                            { titulo: 'Effects of Low- vs. High-Load Resistance Training on Muscle Strength and Hypertrophy', pmid: '25530577' }
                        ]
                    },
                    {
                        categoria: 'Nutrici√≥n',
                        titulo: 'D√©ficit Cal√≥rico √ìptimo: Perder Grasa Sin Perder M√∫sculo',
                        contenido: [
                            'Cuando creas d√©ficit solo reduciendo calor√≠as, pierdes aproximadamente 24-28% del peso total en forma de m√∫sculo. Si pierdes 10kg solo con dieta, 2.5-3kg ser√°n m√∫sculo. En contraste, cuando combinas d√©ficit moderado por dieta m√°s ejercicio, solo pierdes ~13% en m√∫sculo. La f√≥rmula ganadora: d√©ficit peque√±o por dieta (10-15% bajo TDEE) m√°s gasto cal√≥rico por ejercicio.',
                            'La velocidad √≥ptima es 0.5-0.7% del peso corporal por semana. El estudio de Garthe (2011) compar√≥ d√©ficit lento vs r√°pido: el grupo lento gan√≥ +2.1% de masa muscular mientras perd√≠a grasa. Calcula tu TDEE, aplica d√©ficit del 10-15% por dieta, a√±ade 2-3 sesiones semanales de cardio moderado. CR√çTICO: mant√©n o aumenta el volumen de entrenamiento de fuerza y aumenta prote√≠na a 2.0-2.4g/kg.'
                        ],
                        referencias: [
                            { titulo: 'Exercise-training enhances fat-free mass preservation during diet-induced weight loss', pmid: '8130813' },
                            { titulo: 'Effects of Weight Loss on Lean Mass, Strength, Bone, and Aerobic Capacity', pmid: '27580151' },
                            { titulo: 'Effect of two different weight-loss rates on body composition and strength in elite athletes', pmid: '21558571' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'RIR y Fallo Muscular: La Verdad Que Necesitas Saber',
                        contenido: [
                            'Los meta-an√°lisis de Grgic (2022), Vieira (2021) y Refalo (2023) son contundentes: cuando el volumen total se iguala, NO hay diferencias en hipertrofia entre entrenar al fallo (RIR 0) o cerca del fallo (RIR 1-3). El fallo no es superior pero genera fatiga sist√©mica desproporcionada: tu rendimiento en series siguientes cae, tu volumen total disminuye, y tu recuperaci√≥n se alarga.',
                            'En ejercicios compuestos pesados (sentadilla, press banca, peso muerto), EVITA el fallo. Trabaja a RIR 2-3. En ejercicios de aislamiento (curls, extensiones, elevaciones laterales), es seguro ir al fallo o muy cerca (RIR 0-1). Estrategia √≥ptima: √∫ltima serie al fallo. Haz las series 1-3 a RIR 1-2, y solo la serie final ll√©vala al fallo t√©cnico. Principiantes: NUNCA entrenen al fallo, trabajen a RIR 3-5.'
                        ],
                        referencias: [
                            { titulo: 'Effects of resistance training performed to repetition failure or non-failure on muscular strength and hypertrophy', pmid: 'No disponible - Sci-Space 2022' },
                            { titulo: 'Effects of Resistance Training Performed to Failure or Not to Failure on Muscle Strength, Hypertrophy, and Power Output', pmid: '33555822' },
                            { titulo: 'Influence of Resistance Training Proximity-to-Failure on Skeletal Muscle Hypertrophy', pmid: 'No disponible - Sports Medicine 2023' },
                            { titulo: 'Exploring the Dose-Response Relationship Between Estimated Resistance Training Proximity to Failure', pmid: '38970765' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Selecci√≥n de Ejercicios: La Combinaci√≥n Ganadora para Hipertrofia',
                        contenido: [
                            'Ambos son necesarios: compuestos (multiarticulares) y aislamientos (monoarticulares). Los compuestos son la base: eficientes en tiempo, permiten cargas m√°ximas. Los aislamientos son el complemento: atacan m√∫sculos rezagados, a√±aden volumen con m√≠nima fatiga sist√©mica. Gentil (2018) demostr√≥ que a√±adir aislamientos a un programa de solo compuestos produjo ganancias adicionales significativas. SIEMPRE haz los compuestos al principio cuando tu energ√≠a est√° fresca.',
                            'Para hipertrofia pura, pesos libres y m√°quinas son igual de efectivos. Pero en m√°quinas toda tu energ√≠a se dirige 100% al m√∫sculo objetivo porque la estabilizaci√≥n est√° resuelta. Por eso m√°quinas son superiores para: aislar sin que auxiliares fallen, entrenar al fallo seguro, acumular volumen cuando fatigado. Usa rango de movimiento completo siempre que sea posible. Schoenfeld (2020) confirm√≥ que ROM completo es superior para hipertrofia.'
                        ],
                        referencias: [
                            { titulo: 'Resistance Training with Single vs. Multi-joint Exercises at Equal Total Load Volume', pmid: 'No disponible - Frontiers Physiology 2017' },
                            { titulo: 'Effects of Adding Single Joint Exercises to a Resistance Training Programme in Trained Women', pmid: 'No disponible - MDPI Sports 2018' },
                            { titulo: 'The effects of pre-exhaustion, exercise order, and rest intervals in a full-body resistance training', pmid: 'No disponible - Applied Physiology 2015' },
                            { titulo: 'Effects of range of motion on muscle development during resistance training interventions', pmid: 'PMC6977096' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Sobrecarga Progresiva: El Factor M√°s Importante Para Crecer',
                        contenido: [
                            'Sin progresi√≥n no hay crecimiento. Si haces exactamente lo mismo semana tras semana, tu cuerpo NO tiene raz√≥n para cambiar. McLeod (2024) confirma: la falta de progresi√≥n es el motivo m√°s com√∫n de estancamiento. El m√©todo de doble progresi√≥n: define un rango (ej: 8-12 reps), progresa PRIMERO en repeticiones manteniendo el peso fijo. Cuando llegues al l√≠mite ALTO en TODAS las series, sube el peso y vuelve al l√≠mite BAJO.',
                            'Chaves (2024) compar√≥ progresar en peso vs repeticiones‚Äîambos grupos ganaron m√∫sculo id√©ntico. Ventajas: progresi√≥n m√°s gradual, mejor t√©cnica, menos lesiones, tracking claro. Principiantes pueden progresar casi cada sesi√≥n. Intermedios: progresi√≥n semanal o quincenal. Avanzados: progresi√≥n muy lenta, a veces solo por mesociclo completo. Si te estancas 3-4 semanas: deload (reduce series 30-50%), cambia variable, aumenta descanso, mejora t√©cnica.'
                        ],
                        referencias: [
                            { titulo: 'Effects of Resistance Training Overload Progression Protocols on Strength and Muscle Mass', pmid: '38286426' },
                            { titulo: 'Progressive overload without progressing load? The effects of progressing load vs. repetitions', pmid: 'PMC9528903' },
                            { titulo: 'The influence of resistance exercise training prescription on muscle mass and strength', pmid: 'No disponible - Science Direct 2024' },
                            { titulo: 'Low-Load vs. High-Load Resistance Training: A Systematic Review and Meta-analysis', pmid: '28834797' }
                        ]
                    },
                    {
                        categoria: 'Recuperaci√≥n',
                        titulo: 'Sue√±o y Recuperaci√≥n: El Pilar Olvidado de la Hipertrofia',
                        contenido: [
                            'El m√∫sculo NO crece en el gimnasio. El crecimiento real ocurre durante el sue√±o. El estudio Brasil (2011): Grupo A durmi√≥ 5.5h/noche durante 3 d√≠as y perdi√≥ 60% de masa muscular. Grupo B durmi√≥ 8.5h/noche y gan√≥ 40% en el mismo per√≠odo. Rango no negociable: 7-9 horas por noche. El 60-90% de testosterona se secreta DURANTE LA NOCHE. Una semana de 5h/noche reduce testosterona 15%. Sin sue√±o, el cortisol permanece ALTO (+40-50%), activando prote√≥lisis muscular.',
                            'La MAYOR√çA de s√≠ntesis proteica ocurre mientras duermes, especialmente 12-36h post-entreno. Consumir 20-30g prote√≠na (case√≠na, yogur griego) 30-60min antes de dormir amplifica MPS nocturna. Descanso entre series: 1-2 minutos maximiza hipertrofia. Frecuencia: 2 veces por semana es el sweet spot. Regla 48 horas: espera m√≠nimo 48h entre entrenamientos intensos del mismo m√∫sculo. Se√±ales de sobreentrenamiento: p√©rdida de fuerza persistente, fatiga que no se resuelve con 8h sue√±o, frecuencia card√≠aca reposo +10 latidos.'
                        ],
                        referencias: [
                            { titulo: 'Sleep quality and muscular strength in college students', pmid: '28490639' },
                            { titulo: 'One night of total sleep deprivation impairs implicit learning', pmid: 'No disponible - BioRxiv 2021' },
                            { titulo: 'Sleep and testosterone: effects of sleep deprivation on hormonal balance', pmid: 'No disponible - PubMed 2022' },
                            { titulo: 'The effects of protein supplementation before sleep on muscle mass and strength', pmid: 'No disponible - PubMed 2024' },
                            { titulo: 'Effects of resistance training frequency on measures of muscle hypertrophy', pmid: '27102172' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Adaptaciones Neurales: Por Qu√© Progresas Tan R√°pido Al Principio',
                        contenido: [
                            'El m√∫sculo NO crece las primeras 4-6 semanas de entrenamiento, pero tu fuerza puede duplicarse o triplicarse. Este fen√≥meno se llama newbie gains y tiene una explicaci√≥n: adaptaciones neurales. Durante las primeras semanas, tu cerebro aprende a reclutar unidades motoras que antes estaban dormidas, aumenta la frecuencia de disparo neural, mejora la coordinaci√≥n. Grgic & Schoenfeld (2018) confirman: principiantes mejoran dram√°ticamente el reclutamiento antes de cualquier hipertrofia medible.',
                            'Semanas 1-4: Adaptaciones neurales DOMINAN completamente. Fuerza sube r√°pido, m√∫sculo no crece. Semanas 6-8+: La hipertrofia estructural se vuelve medible. Principiantes pueden a√±adir 2.5-5kg semanal. Avanzados: progresi√≥n extremadamente lenta, tal vez 5-15% en 12 semanas. Memoria muscular: si entrenaste a√±os, paraste 6 meses y perdiste m√∫sculo, recuperar√°s todo mucho m√°s r√°pido. Los mion√∫cleos adicionales permanecen a√±os despu√©s de atrofia completa.'
                        ],
                        referencias: [
                            { titulo: 'The Mechanisms of Muscle Hypertrophy and Their Application to Resistance Training', pmid: '20847704' },
                            { titulo: 'Neural adaptations to resistance training: Mechanisms and recommendations', pmid: 'No disponible - Frontiers Physiology 2018' },
                            { titulo: 'Skeletal muscle memory: myonuclear accretion and their potential role in hypertrophy', pmid: 'No disponible - Frontiers 2013' },
                            { titulo: 'Muscle hypertrophy response to resistance training in trained versus untrained', pmid: 'No disponible - Frontiers 2011' }
                        ]
                    },
                    {
                        categoria: 'Nutrici√≥n',
                        titulo: 'S√≠ntesis Proteica Muscular: C√≥mo Se Construye M√∫sculo A Nivel Biol√≥gico',
                        contenido: [
                            'El m√∫sculo crece cuando la S√≠ntesis de Prote√≠nas Musculares (MPS) supera la Degradaci√≥n (MPB). Balance Proteico Neto = MPS - MPB. Si MPS > MPB ‚Üí ganas m√∫sculo. La MPS puede aumentar 400-500% tras entrenamiento m√°s prote√≠na. Solo la s√≠ntesis MIOFIBRILAR (MyoPS, actina/miosina) correlaciona con hipertrofia funcional y fuerza. El complejo mTORC1 es el nodo central que decide si construyes m√∫sculo. Para encenderlo necesitas 2 se√±ales: tensi√≥n mec√°nica (entrenamiento) y leucina suficiente (2-3g por comida, equivalente a 20-30g prote√≠na de calidad).',
                            'NOVATOS experimentan picos MPS masivos y prolongados (>24-48h), pero esa MPS va principalmente a reparar da√±o muscular. AVANZADOS tienen MPS m√°s corta (12-24h) pero correlaciona CASI PERFECTAMENTE con hipertrofia real. Trommelen et al. (2023) demostraron que 100g prote√≠na de leche (absorci√≥n lenta) mantiene MPS elevada por >12 HORAS sin saturaci√≥n. Con prote√≠na lenta NO HAY L√çMITE SUPERIOR pr√°ctico. Timing peri-entreno es cr√≠tico para avanzados. Post-entreno: 30-40g whey dentro 1-2h. Pre-sue√±o: 30-50g case√≠na para MPS nocturna.'
                        ],
                        referencias: [
                            { titulo: 'The anabolic response to protein ingestion has no upper limit in vivo in humans', pmid: '38118410' },
                            { titulo: 'Resistance training-induced changes in myofibrillar protein synthesis related to hypertrophy after attenuation of muscle damage', pmid: 'No disponible - J Physiology 2016 DOI: 10.1113/JP272472' },
                            { titulo: 'A review of resistance training-induced changes in skeletal muscle protein synthesis', pmid: '25739559' },
                            { titulo: 'Muscle protein synthesis response greater following 40g than 20g whey protein', pmid: 'No disponible - Physiological Reports 2016' },
                            { titulo: 'Ingested protein dose response of muscle and albumin protein synthesis after resistance exercise', pmid: '19056590' },
                            { titulo: 'Evaluating the Leucine Trigger Hypothesis for Post-prandial Regulation of Muscle Protein Synthesis', pmid: 'No disponible - Frontiers Nutrition 2020' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Tipos de Fibras Musculares: C√≥mo Entrenar Cada Una Para M√°xima Hipertrofia',
                        contenido: [
                            'Tu m√∫sculo es un mosaico de 3 tipos de fibras. TIPO I (lentas): alta densidad mitocondrial, queman grasa, inagotables. TIPO IIa (r√°pidas vers√°tiles): LAS M√ÅS PL√ÅSTICAS‚Äîpueden aumentar mitocondrias o hipertrofiarse masivamente seg√∫n est√≠mulo. Dominan (60-80% √°rea) en culturistas. TIPO IIx (explosivas puras): velocidad m√°xima suprema, se agotan en 5-10s. El gen ACTN3 determina tu techo de velocidad: RR tienen mayor % fibras IIx (15-25%), mayor potencia explosiva. XX tienen fibras m√°s eficientes pero menos explosivas.',
                            'TIPO I‚ÄîEstr√©s Metab√≥lico Extremo: cargas 40-50% 1RM, tempo ultra-lento 6-10s/rep, sin relajaci√≥n (tensi√≥n continua 60-90s). Alternativa: BFR (Blood Flow Restriction) con 20-30% 1RM. TIPO IIa‚ÄîTensi√≥n Mec√°nica M√°xima: cargas 70-85% 1RM, 6-12 reps, 3-5 series. TIPO IIx‚ÄîMinimizar Fatiga m√°s VBT: detener serie cuando velocidad cae >10-20% vs primera rep (RIR 3-5). Cargas 85-95%, 1-5 reps, descansos 3-5min. Para hipertrofia m√°xima: combina cargas 70-85% para maximizar IIa (80% volumen) m√°s 1-2 ejercicios BFR para crecer Tipo I.'
                        ],
                        referencias: [
                            { titulo: 'Human Skeletal Muscle Fiber Type Classifications', pmid: 'No disponible - Oxford Academic 2011' },
                            { titulo: 'Effect of ACTN3 Genotype on Sports Performance and Exercise-Induced Muscle Damage', pmid: 'No disponible - MDPI Sports 2019' },
                            { titulo: 'ACTN3 (R577X) genotype is associated with fiber type distribution', pmid: 'No disponible - Physiological Genomics 2007' },
                            { titulo: 'Physiological effects of low intensity strength training without relaxation', pmid: 'No disponible - PubMed 2013' },
                            { titulo: 'Type 1 Muscle Fiber Hypertrophy after Blood Flow-restricted Training in Powerlifters', pmid: 'No disponible - PubMed 2019' },
                            { titulo: 'Effects of velocity loss during resistance training on athletic performance', pmid: 'No disponible - PubMed 2017' }
                        ]
                    },
                    {
                        categoria: 'Entrenamiento',
                        titulo: 'Prevenci√≥n de Lesiones: Calentamiento, Detecci√≥n y Entrenamiento Adaptado',
                        contenido: [
                            'Las 3 lesiones m√°s comunes: (1) HOMBRO (tendinitis manguito rotador), (2) ESPALDA BAJA (distensiones lumbares, hernias), (3) RODILLA (condromalacia, esguinces). Saltar calentamiento eleva riesgo lesi√≥n un 30%. Calentamiento efectivo: (1) General 5-10min‚Äîelevar temperatura. (2) Espec√≠fico‚Äîmovilidad m√°s estiramientos DIN√ÅMICOS. HOMBROS: Rotaciones externas/internas banda el√°stica 15-20 reps/lado, pull-aparts banda 2x15. PIERNAS: Monster walks banda, puentes gl√∫teos 2x15, sentadillas sin peso 2x10-15.',
                            'Se√±ales de alarma: dolor agudo DURANTE entrenamiento = DETENTE INMEDIATAMENTE. Tendinitis hombro: dolor hombro/brazo, p√©rdida movilidad, dolor nocturno. Condromalacia rodilla: dolor FRONTAL rodilla, dolor subir escaleras. Hernia discal (MUY GRAVE): dolor lumbar IRRADIA PIERNA (ci√°tica), entumecimiento, hormigueo. Si tienes lesi√≥n: consulta m√©dico/fisio. Entrena zonas no afectadas, usa ejercicios alternativos, sigue protocolo RICE (Reposo, Hielo, Compresi√≥n, Elevaci√≥n) las primeras 48-72h.'
                        ],
                        referencias: [
                            { titulo: 'C√≥mo evitar lesiones relacionadas con el ejercicio', pmid: 'No disponible - MedlinePlus NIH' },
                            { titulo: 'Ejercicios para el manguito de los rotadores', pmid: 'No disponible - MedlinePlus NIH' },
                            { titulo: 'Esguince: primeros auxilios', pmid: 'No disponible - Mayo Clinic' },
                            { titulo: 'Injury Prevention in the Gym: How To Safely Maximize Your Workouts', pmid: 'No disponible - MS Physical Therapy' },
                            { titulo: 'Lesiones deportivas: c√≥mo volver a entrenar despu√©s', pmid: 'No disponible - Actimove' }
                        ]
                    }
                ];
                
                // Funci√≥n para generar HTML de una card
                function generarCard(articulo, index) {
                    const colors = categoryStyles[articulo.categoria] || { bg: 'rgba(57, 255, 20, 0.15)', text: '#39ff14', border: 'rgba(57, 255, 20, 0.3)' };
                    const isLocked = !isPremium && index >= 3; // Bloquear desde el 4to art√≠culo (√≠ndice 3)
                    
                    return `
                        <div style="
                            background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
                            border: 1px solid #2a2a2a;
                            border-radius: 16px;
                            padding: 32px;
                            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset;
                            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
                            cursor: pointer;
                            width: 100%;
                            display: flex;
                            flex-direction: column;
                            ${isLocked ? 'position: relative;' : ''}
                        " 
                        onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 48px rgba(0, 0, 0, 0.5)'; this.style.borderColor='rgba(57, 255, 20, 0.3)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='#2a2a2a'">
                            
                            <!-- TAG CATEGOR√çA -->
                            <span style="display: inline-block; background: ${colors.bg}; color: ${colors.text}; border: 1px solid ${colors.border}; padding: 4px 10px; border-radius: 8px; font-size: 9px; font-weight: 700; text-transform: capitalize; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-bottom: 12px; align-self: flex-start;">
                                ${articulo.categoria}
                            </span>
                            
                            <!-- T√çTULO -->
                            <h3 style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 12px; margin-top: 0; line-height: 1.3;">
                                ${articulo.titulo}
                            </h3>
                            
                            ${isLocked ? '<div class="blur-content">' : ''}
                            
                            <!-- CONTENIDO -->
                            ${articulo.contenido.map(parrafo => 
                                `<p style="color: #e5e5e5; font-size: 14px; line-height: 1.5; margin-bottom: 10px;">${parrafo}</p>`
                            ).join('')}
                            
                            <!-- REFERENCIAS -->
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2); flex-grow: 1; display: flex; flex-direction: column;">
                                <div style="color: white; font-weight: 600; font-size: 13px; margin-bottom: 10px; letter-spacing: 0.5px; text-transform: uppercase;">
                                    Referencias
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${articulo.referencias.map(ref => `
                                        <a href="https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}/" 
                                        target="_blank"
                                        style="display: block; color: #39ff14; text-decoration: none; font-size: 12px; line-height: 1.4; padding: 8px 10px; background: rgba(0,0,0,0.15); border-radius: 6px; border-left: 3px solid rgba(255,255,255,0.3); transition: all 0.2s ease; font-weight: 600;"
                                        onmouseover="this.style.background='rgba(0,0,0,0.25)'; this.style.color='#ffffff'; this.style.borderLeftColor='rgba(255,255,255,0.5)'; this.style.transform='translateX(4px)'"
                                        onmouseout="this.style.background='rgba(0,0,0,0.15)'; this.style.color='#39ff14'; this.style.borderLeftColor='rgba(255,255,255,0.3)'; this.style.transform='translateX(0)'">
                                            <div style="font-weight: 500; margin-bottom: 3px; font-size: 11px;">${ref.titulo}</div>
                                            <div style="font-size: 10px; color: #cccccc;">PMID: ${ref.pmid}</div>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                            
                            ${isLocked ? '</div>' : ''}
                            
                            ${isLocked ? getPremiumLockHTML("Consejos Cient√≠ficos Pro", "Accede a la base de conocimiento completa y referencias.") : ''}
                            
                        </div>
                    `;
                }
                
                // Generar HTML de todas las cards
                const cardsHTML = articulos.map((articulo, index) => generarCard(articulo, index)).join('');
                
                contentArea.innerHTML = cardsHTML;
            }

            // Funci√≥n para mostrar consejos - Cards Verdes con texto blanco
            function loadAdviceContent(storedPlan, isPremium) {
                const contentArea = document.getElementById('consejosContent');
                
                // Tema: Fundamentos de la Hipertrofia Muscular
                const tema = {
                    title: "¬øPor qu√© no crecen tus m√∫sculos?",
                    category: "Entrenamiento",
                    content: [
                        "¬øPor qu√© tus m√∫sculos crecen? No es solo 'levantar peso'. La hipertrofia responde a tres mecanismos cient√≠ficos: tensi√≥n mec√°nica (la carga que levantas), da√±o muscular (microlesiones que se reparan m√°s grandes) y estr√©s metab√≥lico (acumulaci√≥n de lactato que activa se√±ales anab√≥licas). Entender esto te permite entrenar de forma inteligente, no solo intensa.",
                        "Volumen e Intensidad: Los Factores Decisivos. La ciencia es clara: necesitas 10-20 series semanales por grupo muscular para maximizar hipertrofia. Menos de 10 deja ganancias sobre la mesa, m√°s de 20 puede sobreentrenarte. Y no todas las repeticiones cuentan igual: solo las √∫ltimas 5 reps de cada serie (cerca del fallo muscular) generan el est√≠mulo real. Por eso trabajar a RIR 1-3 (dejar 1-3 reps en el tanque) es la estrategia √≥ptima: suficiente intensidad sin fatiga excesiva.",
                        "Aplicaci√≥n Pr√°ctica. Acumula 10-20 series por m√∫sculo/semana, entrena cada grupo 2-3 veces/semana, termina series a RIR 1-3, y combina rangos: 6-8 reps para tensi√≥n mec√°nica, 10-15 para volumen, 15-20 para estr√©s metab√≥lico. Estos son los fundamentos no negociables del crecimiento muscular."
                    ],
                    references: [
                        {
                            title: "The mechanisms of muscle hypertrophy and their application to resistance training",
                            pmid: "20847704"
                        },
                        {
                            title: "Dose-response relationship between weekly resistance training volume and increases in muscle mass",
                            pmid: "28834797"
                        }
                    ]
                };

                let adviceHTML = '';
                
                // Determinar color del tag seg√∫n categor√≠a
                let tagBgClass = 'bg-lime-700';
                if (tema.category === 'Nutrici√≥n') tagBgClass = 'bg-blue-600';
                else if (tema.category === 'Recuperaci√≥n') tagBgClass = 'bg-purple-600';
                else if (tema.category === 'Suplementaci√≥n') tagBgClass = 'bg-orange-600';
                
                // Tarjeta cient√≠fica moderna
                adviceHTML += `<div class="advice-card" style="max-width: 100%;">`;
                
                // Tag categor√≠a (estilo moderno)
                const categoryColors = {
                    'Entrenamiento': '#009688',
                    'Nutrici√≥n': '#2196F3',
                    'Recuperaci√≥n': '#9C27B0',
                    'Suplementaci√≥n': '#FF9800'
                };
                const categoryColor = categoryColors[tema.category] || '#009688';
                adviceHTML += `<span style="display: inline-block; background: ${categoryColor}; color: white; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 10px; border-radius: 12px; margin-bottom: 16px;">`;
                adviceHTML += tema.category;
                adviceHTML += `</span>`;
                
                // T√≠tulo pregunta
                adviceHTML += `<h3 style="color: #1a1a1a; font-size: 22px; font-weight: 700; margin-bottom: 16px; line-height: 1.3;">`;
                adviceHTML += tema.title;
                adviceHTML += `</h3>`;
                
                // Contenido (todos los p√°rrafos)
                tema.content.forEach((parrafo, index) => {
                    adviceHTML += `<p style="color: #333; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">`;
                    adviceHTML += parrafo;
                    adviceHTML += `</p>`;
                });
                
                // Referencias (estilo cient√≠fico)
                if (tema.references && tema.references.length > 0) {
                    adviceHTML += `<div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">`;
                    adviceHTML += `<div style="color: #666; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">üìö Referencias Cient√≠ficas:</div>`;
                    adviceHTML += `<ul style="list-style: none; padding: 0; margin: 0; space-y: 8px;">`;
                    
                    tema.references.forEach(ref => {
                        const pubmedUrl = `https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}/`;
                        adviceHTML += `<li style="margin-bottom: 10px;">`;
                        adviceHTML += `<a href="${pubmedUrl}" target="_blank" rel="noopener noreferrer" style="color: #009688; font-size: 13px; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: color 0.2s;" onmouseover="this.style.color='#00796B'" onmouseout="this.style.color='#009688'">`;
                        adviceHTML += `<span style="color: #009688;">‚Ä¢</span>`;
                        adviceHTML += `<span style="flex: 1;">${ref.title}</span>`;
                        adviceHTML += `<span style="font-family: monospace; font-size: 11px; color: #999;">(PMID: ${ref.pmid})</span>`;
                        adviceHTML += `<span style="color: #009688;">‚Üí</span>`;
                        adviceHTML += `</a>`;
                        adviceHTML += `</li>`;
                    });
                    
                    adviceHTML += `</ul>`;
                    adviceHTML += `</div>`;
                }
                
                adviceHTML += `</div>`;

                contentArea.innerHTML = adviceHTML;
            }
            
            // Funci√≥n para abrir detalle del art√≠culo (se implementar√° despu√©s)
            function openArticleDetail(articleId) {
                // Por ahora, mostrar el contenido completo en el mismo overlay
                console.log('Abriendo art√≠culo:', articleId);
                // TODO: Implementar vista detallada del art√≠culo
            }

            // Funci√≥n para mostrar estudios (ya no se usa en el nuevo dise√±o, pero se mantiene por compatibilidad)
            function loadStudiesContent() {
                // Los estudios ahora se muestran dentro de cada art√≠culo
                // Esta funci√≥n se puede usar para cargar estudios relacionados si es necesario
            }

            // Funci√≥n para cargar contenido de t√©rminos
            function loadTermsContent() {
                const contentArea = document.getElementById('terminosContent');
                
                const termsHTML = `
                    <h3>1. Aceptaci√≥n de los t√©rminos</h3>
                    <p>YourGains AI es una plataforma de inteligencia artificial que genera planes de entrenamiento y nutrici√≥n personalizados. Al usar este servicio aceptas estos t√©rminos y confirmas que tienes al menos 18 a√±os o utilizas la plataforma bajo la supervisi√≥n de un adulto responsable.</p>
                    
                    <h3>2. Naturaleza del servicio (no es asesoramiento m√©dico)</h3>
                    <p>Los planes de entrenamiento y las recomendaciones nutricionales que ofrece YourGains AI son sugerencias generales basadas en los datos que introduces (peso, altura, experiencia, objetivos, lesiones, etc.).</p>
                    <p>No constituyen asesoramiento m√©dico, ni sustituyen la opini√≥n de un profesional sanitario, nutricionista o entrenador titulado.</p>
                    <p><strong>Antes de comenzar cualquier rutina de ejercicio o dieta, consulta siempre con tu m√©dico, especialmente si tienes patolog√≠as previas, lesiones o tomas medicaci√≥n.</strong></p>
                    
                    <h3>3. Uso permitido de la plataforma</h3>
                    <p>Te comprometes a:</p>
                    <ul>
                        <li>Introducir datos reales y actualizados.</li>
                        <li>No usar la plataforma para actividades ilegales o que puedan da√±ar a terceros.</li>
                        <li>No intentar acceder al c√≥digo, base de datos o sistemas internos de forma no autorizada.</li>
                    </ul>
                    <p>Podremos suspender o cerrar tu cuenta si detectamos un uso fraudulento o abusivo.</p>
                    
                    <h3>4. Limitaci√≥n de responsabilidad</h3>
                    <p>YourGains AI no se hace responsable de:</p>
                    <ul>
                        <li>Lesiones, da√±os f√≠sicos o problemas de salud derivados del uso de los planes generados.</li>
                        <li>Resultados no obtenidos (por ejemplo, no ganar m√∫sculo, no perder grasa, etc.).</li>
                        <li>Errores puntuales en el contenido generado por la IA.</li>
                    </ul>
                    <p>El uso de la plataforma es exclusivamente bajo tu responsabilidad.</p>
                    
                    <h3>5. Cuentas, suscripciones y pagos</h3>
                    <p>Al crear una cuenta, eres responsable de mantener la confidencialidad de tu usuario y contrase√±a.</p>
                    <p>En los planes de pago:</p>
                    <ul>
                        <li>El precio, la moneda y la periodicidad (mensual/anual) se indicar√°n antes de la contrataci√≥n.</li>
                        <li>Las renovaciones son autom√°ticas hasta que canceles tu suscripci√≥n.</li>
                        <li>Puedes cancelar en cualquier momento; el acceso al plan se mantendr√° hasta el final del periodo ya pagado.</li>
                    </ul>
                    
                    <h3>6. Pol√≠tica de Privacidad (resumen)</h3>
                    
                    <h4>Datos que recogemos:</h4>
                    <ul>
                        <li><strong>Datos de registro:</strong> nombre, email, contrase√±a (encriptada).</li>
                        <li><strong>Datos de entrenamiento:</strong> peso, altura, experiencia, objetivos, tipo de cuerpo, materiales disponibles, lesiones, preferencias alimentarias.</li>
                        <li><strong>Datos t√©cnicos b√°sicos:</strong> direcci√≥n IP, dispositivo, uso de la app (para an√°lisis y mejoras).</li>
                    </ul>
                    
                    <h4>Para qu√© usamos tus datos:</h4>
                    <ul>
                        <li>Para generar tus rutinas y dietas personalizadas.</li>
                        <li>Para mostrar tu historial y progresos.</li>
                        <li>Para mejorar la plataforma (estad√≠sticas de uso, detecci√≥n de errores).</li>
                        <li>Para enviarte comunicaciones relacionadas con el servicio (confirmaciones, avisos importantes, etc.).</li>
                    </ul>
                    
                    <h4>Base legal (RGPD y normativa aplicable):</h4>
                    <ul>
                        <li>Ejecuci√≥n del contrato (cuando te damos el servicio que has solicitado).</li>
                        <li>Consentimiento (por ejemplo, env√≠o de comunicaciones comerciales si lo aceptas).</li>
                        <li>Inter√©s leg√≠timo (mejorar la seguridad y el rendimiento del sistema).</li>
                    </ul>
                    
                    <h4>Conservaci√≥n y protecci√≥n:</h4>
                    <ul>
                        <li>Conservamos tus datos mientras mantengas tu cuenta activa.</li>
                        <li>Puedes solicitar la eliminaci√≥n de tu cuenta y de tus datos, salvo los que debamos conservar por obligaci√≥n legal (por ejemplo, facturaci√≥n).</li>
                        <li>Aplicamos medidas razonables de seguridad para proteger tu informaci√≥n.</li>
                    </ul>
                    
                    <h4>Tus derechos:</h4>
                    <ul>
                        <li>Acceder, rectificar y suprimir tus datos.</li>
                        <li>Limitar u oponerte al tratamiento en ciertos casos.</li>
                        <li>Portabilidad de los datos.</li>
                    </ul>
                    <p>Para ejercer tus derechos o resolver dudas sobre privacidad, podr√°s contactar con nosotros en el email de soporte que se muestre en la web.</p>
                    
                    <h3>7. Cambios en los t√©rminos</h3>
                    <p>Podremos actualizar estos t√©rminos y la pol√≠tica de privacidad para adaptarnos a cambios legales o mejoras del servicio.</p>
                    <p>Cuando haya cambios importantes, te lo notificaremos dentro de la plataforma o por email.</p>
                    
                    <p style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #ffffff; font-weight: 600;">
                        Al seguir usando YourGains AI aceptas estos t√©rminos y condiciones de uso.
                    </p>
                `;
                
                contentArea.innerHTML = termsHTML;
            }
            
            // Funci√≥n para cargar contenido de "Qui√©nes somos"
            function loadAboutContent() {
                const contentArea = document.getElementById('aboutContent');
                
                const aboutHTML = `
                    <p>YourGains AI surgi√≥ de la necesidad de llevar el entrenamiento personalizado al alcance de todo tipo de personas. En un mundo de sobreinformaci√≥n, vimos el problema de much√≠sima gente que no sabe por d√≥nde empezar y de otras que quieren acceder a conocimiento de calidad a un precio asequible.</p>
                    
                    <p>Nosotros hemos hecho eso posible haciendo el trabajo por ti: recopilamos y actualizamos la informaci√≥n que necesitas para que sepas qu√© hacer en todo momento con tu entrenamiento y tu nutrici√≥n, sin tener que vivir pegado a foros, v√≠deos o estudios.</p>
                    
                    <p>Nuestra misi√≥n es ayudarte a entrenar de forma inteligente, ahorr√°ndote tiempo y dudas. Combinamos:</p>
                    <ul>
                        <li>Conocimiento de entrenamiento de fuerza, hipertrofia y nutrici√≥n.</li>
                        <li>Modelos de inteligencia artificial que analizan tus datos y generan planes personalizados.</li>
                        <li>Una interfaz sencilla para que entiendas qu√© tienes que hacer cada d√≠a en el gimnasio y en la cocina.</li>
                    </ul>
                    
                    <h3>¬øQu√© hace diferente a YourGains AI?</h3>
                    <ul>
                        <li><strong>Planes adaptados</strong> a tu experiencia, material disponible y puntos d√©biles (por ejemplo, pecho, espalda, piernas, brazos).</li>
                        <li><strong>Dietas personalizadas</strong> con calor√≠as ajustadas, reparto de macros y sugerencias de alimentos realistas.</li>
                        <li><strong>Capacidad de actualizar</strong> tu plan cuando cambias de peso, gimnasio, objetivos o sufres una lesi√≥n.</li>
                        <li><strong>Contenido de "Consejos y estudios"</strong> basado en evidencia, explicado en lenguaje simple.</li>
                    </ul>
                    
                    <p>YourGains AI no pretende sustituir a un entrenador personal humano, sino darte una herramienta potente para organizar tu entrenamiento y tu nutrici√≥n de forma coherente, constante y sostenible.</p>
                    
                    <p>Si tienes dudas, sugerencias o quieres colaborar con el proyecto, encontrar√°s nuestro contacto en la secci√≥n de soporte de la web.</p>
                `;
                
                contentArea.innerHTML = aboutHTML;
            }

            // Funci√≥n para mostrar mensajes de no contenido - COMENTADA PARA EVITAR CONFLICTOS
            function showNoContentMessages() {
                console.log('‚ö†Ô∏è showNoContentMessages() llamada - pero no insertando mensaje de error');
                // COMENTADO: No insertar mensajes de error para evitar conflictos con displayPlan()
                // document.getElementById('rutinaContent').innerHTML = '<p>No tienes una rutina generada. Usa el chat para crear tu plan personalizado.</p>';
                // document.getElementById('dietaContent').innerHTML = '<p>No tienes un plan nutricional generado. Usa el chat para crear tu dieta personalizada.</p>';
            }

            // Hacer funciones globales
            window.openOverlay = openOverlay;
            window.closeOverlay = closeOverlay;
            window.loadTermsContent = loadTermsContent;
            window.loadAboutContent = loadAboutContent;
            window.checkPremiumStatus = checkPremiumStatus;
            window.showPremiumModal = showPremiumModal;
            window.loadNewRoutineForm = loadNewRoutineForm;
            window.validateTrainingDays = validateTrainingDays;
            
            // Funci√≥n para generar el HTML de visualizaci√≥n de datos (solo lectura) - DISE√ëO PREMIUM
            function generateProfileViewHTML(userData) {
                if (!userData) {
                    return `
                        <div style="text-align: center; padding: 80px 20px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: rgba(132, 204, 22, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <h3 style="color: #e5e5e5; font-size: 20px; font-weight: 600; margin-bottom: 12px;">No hay datos disponibles</h3>
                            <p style="color: #999; font-size: 15px; line-height: 1.6;">Genera tu primer plan para ver tus datos aqu√≠</p>
                        </div>
                    `;
                }
                
                // Funci√≥n auxiliar para formatear valores
                const formatValue = (value) => {
                    if (value === null || value === undefined || value === '') return 'No especificado';
                    return value;
                };
                
                // Funci√≥n auxiliar para formatear opciones
                const formatOption = (value, options) => {
                    if (!value) return 'No especificado';
                    const option = options.find(opt => opt.value === value);
                    return option ? option.label : value;
                };
                
                const objetivoGymOptions = [
                    { value: 'ganar_musculo', label: 'Ganar M√∫sculo' },
                    { value: 'ganar_fuerza', label: 'Ganar Fuerza' },
                    { value: 'perder_grasa', label: 'Perder Grasa' },
                    { value: 'mantener_forma', label: 'Mantener Forma' }
                ];
                
                const objetivoNutricionalOptions = [
                    { value: 'volumen', label: 'Volumen' },
                    { value: 'definicion', label: 'Definici√≥n' },
                    { value: 'mantenimiento', label: 'Mantenimiento' },
                    { value: 'recomposicion', label: 'Recomposici√≥n' }
                ];
                
                const experienciaOptions = [
                    { value: 'principiante', label: 'Principiante' },
                    { value: 'intermedio', label: 'Intermedio' },
                    { value: 'avanzado', label: 'Avanzado' }
                ];
                
                const nivelActividadOptions = [
                    { value: 'sedentario', label: 'Sedentario' },
                    { value: 'ligero', label: 'Ligero' },
                    { value: 'moderado', label: 'Moderado' },
                    { value: 'activo', label: 'Activo' },
                    { value: 'muy_activo', label: 'Muy Activo' }
                ];
                
                const sexoOptions = [
                    { value: 'hombre', label: 'Hombre' },
                    { value: 'mujer', label: 'Mujer' }
                ];
                
                // Iconos SVG
                // Altura: monigote humano estilizado (m√°s limpio y proporcionado)
                const iconHeight = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <!-- Cabeza -->
                    <circle cx="12" cy="5" r="2.5"></circle>
                    <!-- Columna -->
                    <path d="M12 7.8v6.2"></path>
                    <!-- Brazos (ligeramente en V) -->
                    <path d="M8.2 10.2L12 9.2l3.8 1"></path>
                    <!-- Piernas -->
                    <path d="M10 14.2L8.7 18.5"></path>
                    <path d="M14 14.2L15.3 18.5"></path>
                </svg>`;
                const iconWeight = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4z"></path><path d="M12 8v8M8 12h8"></path></svg>`;
                const iconAge = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
                const iconGender = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="14" r="8"></circle><path d="M22 2l-8 8M16 2h6v6"></path></svg>`;
                const iconTarget = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`;
                const iconActivity = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>`;
                const iconDays = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;
                const iconEquipment = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><path d="M6 14h12v8H6z"></path></svg>`;
                const iconInjury = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
                const iconAllergy = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`;
                const iconDiet = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4z"></path></svg>`;
                
                return `
                    <style>
                        @keyframes fadeInUp {
                            from {
                                opacity: 0;
                                transform: translateY(20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                        .profile-card {
                            animation: fadeInUp 0.4s ease-out;
                            animation-fill-mode: both;
                        }
                        .profile-card:nth-child(1) { animation-delay: 0.05s; }
                        .profile-card:nth-child(2) { animation-delay: 0.1s; }
                        .profile-card:nth-child(3) { animation-delay: 0.15s; }
                        .profile-card:nth-child(4) { animation-delay: 0.2s; }
                        .profile-card:nth-child(5) { animation-delay: 0.25s; }
                    </style>
                    <div style="color: white; max-width: 1400px; margin: 0 auto;">
                        <!-- Datos F√≠sicos -->
                        <div style="margin-bottom: 48px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 28px;">
                                <div style="width: 4px; height: 32px; background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%); border-radius: 2px;"></div>
                                <h3 style="color: #e5e5e5; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin: 0;">Datos F√≠sicos</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconHeight}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Altura</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatValue(userData.altura)} <span style="font-size: 18px; font-weight: 500; color: #84cc16;">cm</span></div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconWeight}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Peso</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatValue(userData.peso)} <span style="font-size: 18px; font-weight: 500; color: #84cc16;">kg</span></div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconAge}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Edad</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatValue(userData.edad)} <span style="font-size: 18px; font-weight: 500; color: #84cc16;">a√±os</span></div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconGender}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Sexo</div>
                                    </div>
                                    <div style="font-size: 28px; font-weight: 700; color: #e5e5e5; letter-spacing: -0.5px;">${formatOption(userData.sexo, sexoOptions)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Objetivos y Experiencia -->
                        <div style="margin-bottom: 48px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 28px;">
                                <div style="width: 4px; height: 32px; background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%); border-radius: 2px;"></div>
                                <h3 style="color: #e5e5e5; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin: 0;">Objetivos y Experiencia</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconTarget}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Experiencia</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.experiencia, experienciaOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconTarget}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Objetivo Gym</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.objetivo_gym, objetivoGymOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconTarget}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Objetivo Nutricional</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.objetivo_nutricional, objetivoNutricionalOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconActivity}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Nivel de Actividad</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatOption(userData.nivel_actividad, nivelActividadOptions)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconDays}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">D√≠as de Entrenamiento</div>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 600; color: #e5e5e5;">${formatValue(userData.dias_entrenamiento)} <span style="font-size: 16px; font-weight: 500; color: #84cc16;">d√≠as/semana</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preferencias y Restricciones -->
                        <div style="margin-bottom: 48px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 28px;">
                                <div style="width: 4px; height: 32px; background: linear-gradient(180deg, #84cc16 0%, #65a30d 100%); border-radius: 2px;"></div>
                                <h3 style="color: #e5e5e5; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin: 0;">Preferencias y Restricciones</h3>
                            </div>
                            <div style="display: grid; gap: 20px;">
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconEquipment}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Materiales Disponibles</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.materiales)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconInjury}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Lesiones</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.lesiones)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconAllergy}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Alergias Alimentarias</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.alergias)}</div>
                                </div>
                                <div class="profile-card" style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%); border: 1px solid rgba(132, 204, 22, 0.15); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(132, 204, 22, 0.2) inset'; this.style.borderColor='rgba(132, 204, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(132, 204, 22, 0.1) inset'; this.style.borderColor='rgba(132, 204, 22, 0.15)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: rgba(132, 204, 22, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">${iconDiet}</div>
                                        <div style="color: #a3a3a3; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Restricciones Diet√©ticas</div>
                                    </div>
                                    <div style="font-size: 16px; color: #d4d4d4; line-height: 1.7; font-weight: 400;">${formatValue(userData.restricciones_dieta)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bot√≥n para generar nuevo plan -->
                        <div style="text-align: center; margin-top: 56px; padding-top: 40px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                            <button onclick="closeOverlay('verDatosOverlay'); handleNewRoutine();" 
                                style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; border: none; padding: 18px 48px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 16px rgba(132, 204, 22, 0.3); letter-spacing: 0.3px;"
                                onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 24px rgba(132, 204, 22, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(132, 204, 22, 0.3)'">
                                Generar Nuevo Plan
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Funci√≥n para cargar la vista de datos del perfil
            async function loadProfileView() {
                const contentDiv = document.getElementById('verDatosContent');
                if (!contentDiv) return;
                
                // Mostrar loading
                contentDiv.innerHTML = '<p style="color: white; text-align: center; padding: 40px;">Cargando datos...</p>';
                
                // Cargar datos del usuario
                const userData = await loadCurrentUserData();
                
                // Generar HTML de visualizaci√≥n
                const viewHTML = generateProfileViewHTML(userData);
                contentDiv.innerHTML = viewHTML;
            }
            
            // Exponer funciones globalmente
            window.loadProfileView = loadProfileView;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // DETECCI√ìN AUTOM√ÅTICA DE PAGO PREMIUM
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            (async function checkPremiumActivation() {
                console.log('üîç Iniciando detecci√≥n de pago premium...');
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectStatus = urlParams.get('redirect_status');
                    const paymentIntent = urlParams.get('payment_intent');
                    const sessionId = urlParams.get('session_id');

                    console.log('üìã Par√°metros URL:', {
                        redirectStatus,
                        paymentIntent: paymentIntent ? 'presente' : 'ausente',
                        sessionId: sessionId ? 'presente' : 'ausente'
                    });

                    if (redirectStatus !== 'succeeded' || (!paymentIntent && !sessionId)) {
                        console.log('‚ÑπÔ∏è No es un redirect de pago, continuando normal');
                        return;
                    }

                    console.log('üí≥ Detectado pago exitoso - Activando premium autom√°ticamente...');

                    // 1) Intentar localStorage
                    let userId = localStorage.getItem('user_id');
                    console.log('üì¶ user_id en localStorage:', userId);

                    // 2) Desde token JWT
                    if (!userId) {
                        console.log('‚ö†Ô∏è user_id no en localStorage, buscando en token...');
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        if (token) {
                            try {
                                const payload = JSON.parse(atob(token.split('.')[1]));
                                userId = payload.user_id || payload.sub;
                                console.log('üîë user_id obtenido de token JWT:', userId);
                            } catch (e) {
                                console.error('‚ùå Error parseando token:', e);
                            }
                        }
                    }

                    // 3) /user-status como √∫ltimo recurso
                    if (!userId) {
                        try {
                            console.log('üîÑ Intentando obtener user_id desde /user-status...');
                            const statusResp = await fetch('/user-status?user_id=0', { credentials: 'include' });
                            if (statusResp.ok) {
                                const statusData = await statusResp.json();
                                userId = statusData.user_id;
                                console.log('‚úÖ user_id obtenido de /user-status:', userId);
                                if (userId) localStorage.setItem('user_id', userId);
                            }
                        } catch (e) {
                            console.error('‚ùå Error obteniendo /user-status:', e);
                        }
                    }

                    if (!userId) {
                        console.error('‚ùå No se pudo obtener user_id de ninguna fuente');
                        alert('Error: No se pudo verificar tu identidad. Por favor, inicia sesi√≥n.');
                        window.location.href = '/login.html';
                        return;
                    }

                    console.log('‚úÖ user_id confirmado:', userId);

                    // 4) Activar premium
                    console.log('üîÑ Llamando a /stripe/activate-premium...');
                    const resp = await fetch('/stripe/activate-premium', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: parseInt(userId), session_id: sessionId || paymentIntent })
                    });
                    const result = await resp.json();
                    console.log('üìä Resultado activaci√≥n premium:', result);

                    if (result.success) {
                        if (result.is_premium) {
                            console.log(`‚úÖ Premium activado (${result.activated_by})`);
                            localStorage.setItem('is_premium', 'true');
                            localStorage.setItem('user_id', userId);
                            window.history.replaceState({}, document.title, window.location.pathname);
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            console.log('‚ö†Ô∏è Usuario a√∫n no premium, reintentando...');
                            setTimeout(async () => {
                                const retry = await fetch('/stripe/activate-premium', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ user_id: parseInt(userId), session_id: sessionId || paymentIntent })
                                });
                                const retryResult = await retry.json();
                                if (retryResult.success && retryResult.is_premium) {
                                    localStorage.setItem('is_premium', 'true');
                                    localStorage.setItem('user_id', userId);
                                    window.location.href = '/dashboard.html';
                                }
                            }, 2000);
                        }
                    } else {
                        console.error('‚ùå Error activando premium:', result.error);
                    }

                } catch (e) {
                    console.error('‚ùå Error en detecci√≥n autom√°tica de pago:', e);
                }
            })();

            // Inicializar el dashboard cuando se carga la p√°gina
            // PRIMERO mostrar overlay si hay pago, LUEGO verificar pago
            (async function() {
                const urlParams = new URLSearchParams(window.location.search);
                const hasPaymentPending = urlParams.get('success') === '1' && urlParams.get('session_id');
                
                if (hasPaymentPending) {
                    // Si hay pago pendiente, mostrar overlay y luego verificar pago
                    // initDashboard() mostrar√° el overlay inmediatamente
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', async () => {
                            await initDashboard();
                            // Despu√©s de initDashboard (que muestra overlay), verificar pago
                            await checkPaymentSuccess();
                        });
                    } else {
                        await initDashboard();
                        // Despu√©s de initDashboard (que muestra overlay), verificar pago
                        await checkPaymentSuccess();
                    }
                } else {
                    // No hay pago pendiente, continuar normalmente con la inicializaci√≥n
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initDashboard);
                    } else {
                        initDashboard();
                    }
                }
            })();

            // FUNCIONES AUXILIARES PARA FUNCTION CALLING
            // =========================================

            /**
             * Obtiene el ID del usuario actual
             */
            function getCurrentUserId() {
                try {
                    // Buscar token con la clave correcta (accessToken, no token)
                    const token = localStorage.getItem('accessToken');
                    if (!token) {
                        console.error('‚ùå No se encontr√≥ accessToken en localStorage');
                        return null;
                    }
                    
                    // Decodificar JWT para obtener user_id
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const userId = payload.user_id || payload.sub;
                    console.log('‚úÖ User ID obtenido:', userId);
                    return userId;
                } catch (error) {
                    console.error('‚ùå Error obteniendo user ID:', error);
                    return null;
                }
            }

            /**
             * Obtiene el historial de conversaci√≥n actual
             */
            function getConversationHistory() {
                const messages = document.querySelectorAll('.message');
                const history = [];
                
                messages.forEach(msg => {
                    const isUser = msg.classList.contains('user-message');
                    const content = msg.textContent.trim();
                    
                    if (content) {
                        history.push({
                            role: isUser ? 'user' : 'assistant',
                            content: content
                        });
                    }
                });
                
                return history;
            }

            /**
             * A√±ade badge visual a mensaje que gener√≥ modificaciones
             */
            function addModificationBadge() {
                const lastMessage = document.querySelector('.ai-message:last-child');
                if (lastMessage) {
                    const badge = document.createElement('div');
                    badge.style.cssText = `
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                        margin-top: 8px;
                        animation: pulse 2s infinite;
                    `;
                    badge.innerHTML = '‚úì Plan modificado';
                    lastMessage.appendChild(badge);
                }
            }

            // getAuthHeaders ya est√° importado desde auth.js


            // SISTEMA DE NOTIFICACIONES INLINE
            // =================================
            // Evita el error 404 del archivo externo

            // Configuraci√≥n de la API
            const NOTIFICATION_API_BASE = 'http://127.0.0.1:8000';

            // Elementos del DOM
            let notificationContainer = null;

            /**
             * Inicializa el sistema de notificaciones
             */
            function initNotificationSystem() {
                // Crear contenedor de notificaciones si no existe
                if (!notificationContainer) {
                    notificationContainer = document.createElement('div');
                    notificationContainer.id = 'notification-container';
                    notificationContainer.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        max-width: 400px;
                    `;
                    document.body.appendChild(notificationContainer);
                }
            }

            /**
             * Muestra notificaci√≥n de modificaci√≥n de plan
             * @param {Object} result - Resultado de la modificaci√≥n
             * @param {boolean} result.modified - Si se realizaron modificaciones
             * @param {Array} result.changes - Lista de cambios realizados
             * @param {string} result.function_used - Funci√≥n utilizada
             */
            function showModificationNotification(result) {
                if (!result.modified) return;
                
                initNotificationSystem();
                
                // Crear notificaci√≥n
                const notification = document.createElement('div');
                notification.className = 'modification-notification';
                notification.style.cssText = `
                    background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
                    color: #ffffff;
                    padding: 20px;
                    border-radius: 16px;
                    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), 0 4px 16px rgba(0, 0, 0, 0.3);
                    backdrop-filter: blur(0px);
                    border: 2px solid rgba(255, 255, 255, 0.15);
                    animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                    position: relative;
                    overflow: hidden;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-weight: 500;
                    letter-spacing: 0.025em;
                    text-rendering: optimizeLegibility;
                    -webkit-font-smoothing: antialiased;
                    -moz-osx-font-smoothing: grayscale;
                `;
                
                // Contenido de la notificaci√≥n
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <div style="
                            width: 24px;
                            height: 24px;
                            background: rgba(255, 255, 255, 0.2);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 12px;
                            font-size: 14px;
                        ">‚úì</div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">Plan Actualizado</h3>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 18px;
                            cursor: pointer;
                            margin-left: auto;
                            opacity: 0.7;
                            transition: opacity 0.2s;
                        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <p style="margin: 0 0 12px 0; font-size: 15px; color: #e5e5e5; font-weight: 500; line-height: 1.4;">
                            Tu plan ha sido modificado autom√°ticamente:
                        </p>
                        <div id="changes-list-${Date.now()}" style="max-height: 120px; overflow-y: auto;">
                            ${result.changes.map(change => {
                                // Si change es un objeto, convertirlo a string legible
                                const changeText = typeof change === 'object' ? JSON.stringify(change) : String(change);
                                return `
                                <div style="
                                    background: rgba(255, 255, 255, 0.08);
                                    padding: 10px 14px;
                                    margin: 6px 0;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    color: #f0f0f0;
                                    border-left: 3px solid #84cc16;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                                    transition: all 0.2s ease;
                                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'">‚Ä¢ ${changeText}</div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="goToRoutineAndDiet()" style="
                            background: rgba(255, 255, 255, 0.12);
                            border: 2px solid rgba(255, 255, 255, 0.25);
                            color: #ffffff;
                            padding: 12px 20px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            flex: 1;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        " onmouseover="this.style.background='#84cc16'; this.style.borderColor='#84cc16'; this.style.color='#000000'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(132, 204, 22, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                            Ver Rutina
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            background: rgba(255, 255, 255, 0.12);
                            border: 2px solid rgba(255, 255, 255, 0.25);
                            color: #ffffff;
                            padding: 12px 20px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            flex: 1;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        " onmouseover="this.style.background='#ef4444'; this.style.borderColor='#ef4444'; this.style.color='#ffffff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'; this.style.color='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)'">
                            Descartar
                        </button>
                    </div>
                    
                    <div style="
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        height: 3px;
                        background: rgba(255, 255, 255, 0.3);
                        animation: progressBar 8s linear forwards;
                        border-radius: 0 0 12px 12px;
                    "></div>
                `;
                
                // A√±adir al contenedor
                notificationContainer.appendChild(notification);
                
                // Auto-dismiss despu√©s de 8 segundos
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 8000);
                
                // A√±adir animaciones CSS si no existen
                addNotificationStyles();
            }

            /**
             * A√±ade estilos CSS para las animaciones
             */
            function addNotificationStyles() {
                if (document.getElementById('notification-styles')) return;
                
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                    
                    @keyframes progressBar {
                        from {
                            width: 100%;
                        }
                        to {
                            width: 0%;
                        }
                    }
                    
                    @keyframes slideInNotification {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutNotification {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                    
                    .modification-notification {
                        transition: all 0.3s ease;
                    }
                    
                    .modification-notification:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 12px 40px rgba(132, 204, 22, 0.4);
                    }
                `;
                document.head.appendChild(style);
            }

            /**
             * Muestra modal con detalles de los cambios
             * @param {string} functionUsed - Funci√≥n utilizada
             * @param {Array} changes - Lista de cambios
             */
            // Event listener para botones de ver cambios
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-changes-btn')) {
                    const functionUsed = e.target.getAttribute('data-function');
                    const changes = JSON.parse(e.target.getAttribute('data-changes'));
                    showChangesModal(functionUsed, changes);
                }
            });

            // Funciones para recargar secciones de rutina y dieta
            async function reloadRoutineSection() {
                console.log('üîÑ Recargando secci√≥n de rutina...');
                
                try {
                    // Obtener token JWT
                    const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                    if (!token) {
                        console.error('No hay token para recargar rutina');
                        return;
                    }
                    
                    // Fetch nueva rutina desde backend
                    const response = await fetch('http://127.0.0.1:8000/user/current-routine?user_id=' + userId, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        console.error('Error al obtener rutina:', response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('Nueva rutina obtenida:', data);
                    
                    // Buscar contenedor de rutina en el DOM
                    const routineContainer = document.querySelector('#routine-content') || 
                                            document.querySelector('.routine-section') ||
                                            document.querySelector('[data-section="routine"]') ||
                                            document.querySelector('.routine-container');
                    
                    if (routineContainer) {
                        // Renderizar nueva rutina
                        routineContainer.innerHTML = renderRoutine(data.current_routine);
                        console.log('‚úÖ Rutina actualizada en DOM');
                    } else {
                        console.warn('No se encontr√≥ contenedor de rutina');
                        // Si estamos en otra p√°gina, marcar para recargar cuando vuelvan
                        sessionStorage.setItem('routineNeedsReload', 'true');
                    }
                    
                } catch (error) {
                    console.error('Error recargando rutina:', error);
                }
            }

            async function reloadDietSection() {
                console.log('üîÑ Recargando secci√≥n de dieta...');
                
                try {
                    const token = localStorage.getItem('accessToken') || getCookie('access_token') || getCookie('token');
                    if (!token) {
                        console.error('No hay token para recargar dieta');
                        return;
                    }
                    
                    const response = await fetch('http://127.0.0.1:8000/api/user/current-diet', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        console.error('Error al obtener dieta:', response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('Nueva dieta obtenida:', data);
                    
                    const dietContainer = document.querySelector('#diet-content') || 
                                        document.querySelector('.diet-section') ||
                                        document.querySelector('[data-section="diet"]') ||
                                        document.querySelector('.diet-container');
                    
                    if (dietContainer) {
                        dietContainer.innerHTML = renderDiet(data.current_diet);
                        console.log('‚úÖ Dieta actualizada en DOM');
                    } else {
                        console.warn('No se encontr√≥ contenedor de dieta');
                        sessionStorage.setItem('dietNeedsReload', 'true');
                    }
                    
                } catch (error) {
                    console.error('Error recargando dieta:', error);
                }
            }

            // Helper para obtener cookies
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            // Funci√≥n helper para generar HTML de bloqueo premium unificado
            function getPremiumLockHTML(title, subtitle) {
                return `
                    <div class="premium-lock-container">
                        <div class="premium-lock-card">
                            <div class="premium-icon-wrapper">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            </div>
                            <div class="premium-title">${title}</div>
                            <div class="premium-subtitle">${subtitle}</div>
                            <button class="premium-btn-unified" onclick="window.location.href='./tarifas.html'">
                                Desbloquear Premium
                            </button>
                        </div>
                    </div>
                `;
            }

            // Funciones para renderizar rutina y dieta
            function renderRoutine(routine) {
                if (!routine || !routine.exercises) {
                    return '<div class="no-routine">No hay rutina disponible</div>';
                }
                
                let html = '<div class="routine-display">';
                html += '<h3>Tu Rutina Actualizada</h3>';
                
                // Agrupar ejercicios por d√≠a si hay schedule
                if (routine.schedule) {
                    Object.keys(routine.schedule).forEach(day => {
                        html += `<div class="day-section"><h4>${day}</h4>`;
                        routine.schedule[day].forEach(exercise => {
                            html += `<div class="exercise-item">${exercise}</div>`;
                        });
                        html += '</div>';
                    });
                } else {
                    // Mostrar ejercicios sin agrupar
                    routine.exercises.forEach(exercise => {
                        if (typeof exercise === 'object') {
                            html += `<div class="exercise-item">${exercise.name || exercise}</div>`;
                        } else {
                            html += `<div class="exercise-item">${exercise}</div>`;
                        }
                    });
                }
                
                html += '</div>';
                return html;
            }

            function renderDiet(diet) {
                // Fallback de claves: normalizar meals/comidas
                const meals = diet?.meals || diet?.comidas || [];
                
                // Validaci√≥n robusta: asegurar que meals es un array v√°lido
                if (!diet || !Array.isArray(meals) || meals.length === 0) {
                    return '<div class="no-diet">No hay dieta disponible</div>';
                }
                
                // Obtener el estado premium
                const isPremium = window.isPremiumUser ? window.isPremiumUser() : false;
                
                let html = '<div class="diet-display">';
                html += '<h3>Tu Dieta Actualizada</h3>';
                
                // Envolver todo el contenido en blur para usuarios free
                if (!isPremium) {
                    html += `<div style="position: relative;">`;
                    html += `<div class="blur-content">`;
                }
                
                meals.forEach((meal, index) => {
                    html += `<div class="meal-section">`;
                    html += `<h4>${meal.name || meal.nombre || 'Comida'}${meal.kcal ? ` <span style="color: #84cc16; font-size: 0.85em; font-weight: 400;">(${meal.kcal} kcal)</span>` : ''}</h4>`;
                    if (meal.alimentos) {
                        meal.alimentos.forEach(food => {
                            const foodText = renderAlimento(food);
                            html += `<div class="food-item">‚Ä¢ ${foodText}</div>`;
                        });
                    }
                    html += '</div>'; // Close meal-section
                });
                
                // Cerrar wrapper de blur y a√±adir badge para usuarios free
                if (!isPremium) {
                    html += `</div>`; // Close blur-content
                    html += getPremiumLockHTML("Dieta Completa Bloqueada", "Desbloquea todas las comidas, recetas y ajustes de macros.");
                    html += `</div>`; // Close position relative container
                }
                
                html += '</div>';
                return html;
            }

            // Funci√≥n para ir a rutina y dieta
            function goToRoutineAndDiet() {
                console.log('üîÑ Ejecutando goToRoutineAndDiet...');
                
                try {
                    // Remover la notificaci√≥n
                    const notification = document.querySelector('.modification-notification');
                    if (notification) {
                        notification.remove();
                        console.log('‚úÖ Notificaci√≥n removida');
                    }
                    
                    // Recargar las secciones con datos actualizados
                    if (typeof reloadRoutineSection === 'function') {
                        reloadRoutineSection();
                        console.log('‚úÖ Rutina recargada');
                    }
                    
                    if (typeof reloadDietSection === 'function') {
                        reloadDietSection();
                        console.log('‚úÖ Dieta recargada');
                    }
                    
                    // Intentar navegar a las secciones
                    const routineSection = document.getElementById('routine-section');
                    const dietSection = document.getElementById('diet-section');
                    
                    if (routineSection) {
                        console.log('‚úÖ Navegando a secci√≥n de rutina');
                        routineSection.scrollIntoView({ behavior: 'smooth' });
                    } else if (dietSection) {
                        console.log('‚úÖ Navegando a secci√≥n de dieta');
                        dietSection.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        console.log('‚ö†Ô∏è No se encontraron secciones, recargando p√°gina');
                        window.location.reload();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en goToRoutineAndDiet:', error);
                    // Fallback: recargar la p√°gina
                    window.location.reload();
                }
            }

            function showChangesModal(functionUsed, changes) {
                // Crear modal si no existe
                let modal = document.getElementById('changes-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'changes-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 20000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    `;
                    document.body.appendChild(modal);
                }
                
                // Funci√≥n de mapeo de funciones a nombres legibles
                const functionNames = {
                    'modify_routine_injury': 'Adaptaci√≥n por Lesi√≥n',
                    'modify_routine_focus': 'Enfoque en √Årea Espec√≠fica',
                    'adjust_routine_difficulty': 'Ajuste de Dificultad',
                    'adjust_for_menstrual_cycle': 'Adaptaci√≥n Menstrual',
                    'recalculate_diet_macros': 'Rec√°lculo de Macros',
                    'substitute_disliked_food': 'Sustituci√≥n de Alimentos',
                    'generate_meal_alternatives': 'Alternativas de Comidas',
                    'simplify_diet_plan': 'Simplificaci√≥n de Dieta',
                    'revert_last_modification': 'Reversi√≥n de Cambios'
                };
                
                const functionName = functionNames[functionUsed] || functionUsed;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        color: #333;
                        padding: 24px;
                        border-radius: 16px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        transform: scale(0.9);
                        transition: transform 0.3s ease;
                    ">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-right: 16px;
                                color: white;
                                font-size: 18px;
                            ">‚úì</div>
                            <div>
                                <h2 style="margin: 0; font-size: 20px; color: #333;">${functionName}</h2>
                                <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">
                                    Cambios realizados autom√°ticamente
                                </p>
                            </div>
                            <button onclick="closeChangesModal()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                color: #999;
                                cursor: pointer;
                                margin-left: auto;
                                padding: 4px;
                                transition: color 0.2s;
                            " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">Cambios Realizados:</h3>
                            <div style="
                                background: #f8f9fa;
                                border-radius: 8px;
                                padding: 16px;
                                border-left: 4px solid #84cc16;
                            ">
                                ${changes.map(change => `
                                    <div style="
                                        padding: 8px 0;
                                        border-bottom: 1px solid #e9ecef;
                                        font-size: 14px;
                                        color: #333;
                                    ">‚Ä¢ ${change}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeChangesModal()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                                Cerrar
                            </button>
                            <button onclick="revertLastModification(); closeChangesModal();" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                Deshacer Cambios
                            </button>
                        </div>
                    </div>
                `;
                
                // Mostrar modal
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.querySelector('div').style.transform = 'scale(1)';
                }, 10);
            }

            /**
             * Cierra el modal de cambios
             */
            function closeChangesModal() {
                const modal = document.getElementById('changes-modal');
                if (modal) {
                    modal.style.opacity = '0';
                    modal.querySelector('div').style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            }

            /**
             * Revierte la √∫ltima modificaci√≥n
             */
            async function revertLastModification() {
                try {
                    console.log('üîÑ Revirtiendo √∫ltima modificaci√≥n...');
                    
                    // Obtener token JWT
                    const token = localStorage.getItem('accessToken');
                    if (!token) {
                        console.error('No hay token para revertir cambios');
                        return;
                    }
                    
                    const response = await fetch('http://127.0.0.1:8000/api/chat/modify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            message: "deshaz el √∫ltimo cambio",
                            user_id: getCurrentUserId(),
                            conversation_history: []
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success !== false) {
                        console.log('‚úÖ Cambios deshechos correctamente');
                        
                        // Recargar secciones afectadas
                        reloadRoutineSection();
                        reloadDietSection();
                        
                        // Mostrar notificaci√≥n de √©xito
                        alert('Cambios deshechos correctamente');
                    } else {
                        throw new Error(result.message || 'Error deshaciendo cambios');
                    }
                } catch (error) {
                    console.error('Error reverting modification:', error);
                    alert('Error deshaciendo cambios: ' + error.message);
                }
            }

            /**
             * Recarga las secciones afectadas por modificaciones
             */
            async function reloadAffectedSections() {
                try {
                    // Recargar rutina si es necesario
                    await reloadRoutineSection();
                    
                    // Recargar dieta si es necesario
                    await reloadDietSection();
                } catch (error) {
                    console.error('Error reloading sections:', error);
                }
            }


            /**
             * Muestra notificaci√≥n de loading
             */
            function showLoadingNotification(message) {
                showSimpleNotification(message, 'loading');
            }

            /**
             * Muestra notificaci√≥n de √©xito
             */
            function showSuccessNotification(message) {
                showSimpleNotification(message, 'success');
            }

            /**
             * Muestra notificaci√≥n de error
             */
            function showErrorNotification(message) {
                showSimpleNotification(message, 'error');
            }

            /**
             * Muestra notificaci√≥n simple
             */
            function showSimpleNotification(message, type = 'info') {
                initNotificationSystem();
                
                const colors = {
                    loading: '#3b82f6',
                    success: '#10b981',
                    error: '#ef4444',
                    info: '#84cc16'
                };
                
                const icons = {
                    loading: '‚ü≥',
                    success: '‚úì',
                    error: '‚úó',
                    info: 'i'
                };
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: ${colors[type]};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    animation: slideInRight 0.3s ease-out;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                
                notification.innerHTML = `
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span style="font-size: 14px;">${message}</span>
                `;
                
                notificationContainer.appendChild(notification);
                
                // Auto-dismiss despu√©s de 3 segundos (excepto loading)
                if (type !== 'loading') {
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, 3000);
                }
                
                return notification;
            }

            // Verificar si hay cambios pendientes al cargar la p√°gina
            window.addEventListener('load', () => {
                if (sessionStorage.getItem('routineNeedsReload') === 'true') {
                    reloadRoutineSection();
                    sessionStorage.removeItem('routineNeedsReload');
                }
                if (sessionStorage.getItem('dietNeedsReload') === 'true') {
                    reloadDietSection();
                    sessionStorage.removeItem('dietNeedsReload');
                }
            });

            // Inicializar sistema al cargar
            document.addEventListener('DOMContentLoaded', initNotificationSystem);
        </script>
    </body>
    </html>

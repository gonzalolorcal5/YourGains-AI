<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Modal - YourGains AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .payment-modal {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.7);
        }
        .stripe-element {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px;
            color: white;
        }
        .stripe-element:focus {
            border-color: #84cc16;
            box-shadow: 0 0 0 1px #84cc16;
        }
    </style>
</head>
<body class="bg-neutral-950 text-white">
    <!-- Modal de Pago -->
    <div id="paymentModal" class="payment-modal fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-neutral-900 rounded-2xl p-8 max-w-md w-full border border-neutral-800 shadow-2xl">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Mejorar a Pro</h2>
                <button id="closeModal" class="text-neutral-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- Plan Seleccionado -->
            <div id="planInfo" class="mb-6 p-4 bg-neutral-800 rounded-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 id="planName" class="font-semibold text-lg">Pro Mensual</h3>
                        <p id="planDescription" class="text-neutral-400 text-sm">Acceso completo a todas las funciones</p>
                    </div>
                    <div class="text-right">
                        <p id="planPrice" class="text-2xl font-bold text-lime-400">9,99 â‚¬</p>
                        <p id="planPeriod" class="text-neutral-400 text-sm">por mes</p>
                    </div>
                </div>
            </div>

            <!-- Formulario de Pago -->
            <form id="payment-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">InformaciÃ³n de Pago</label>
                    <div id="payment-element" class="stripe-element">
                        <!-- Stripe Elements se cargarÃ¡ aquÃ­ -->
                    </div>
                </div>

                <!-- BotÃ³n de Pago -->
                <button id="submit-payment" class="w-full bg-lime-400 text-black font-bold py-3 px-4 rounded-xl hover:bg-lime-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="button-text">Pagar Ahora</span>
                    <div id="spinner" class="hidden">
                        <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-black"></div>
                    </div>
                </button>
            </form>

            <!-- Mensajes de Error -->
            <div id="payment-message" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
            <div id="paymentError" class="hidden mt-4 p-3 rounded-lg text-sm bg-red-900 text-red-200"></div>

            <!-- Seguridad -->
            <div class="mt-6 text-center">
                <p class="text-xs text-neutral-500">
                    ðŸ”’ Pago seguro procesado por Stripe
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { API_BASE } from "./config.js";
        import { getAuthHeaders } from "./auth.js";

        // Inicializar Stripe - se configurarÃ¡ dinÃ¡micamente
        let stripe;

        let elements;
        let paymentElement;

        // Variables globales para Stripe
        let stripeConfig;

        // Cargar configuraciÃ³n de Stripe de forma segura
        async function loadStripeConfig() {
            try {
                const response = await fetch(`${API_BASE}/stripe-config`);
                if (!response.ok) {
                    throw new Error('Error al cargar configuraciÃ³n de Stripe');
                }
                stripeConfig = await response.json();
                
                // Inicializar Stripe con la clave pÃºblica del servidor
                stripe = Stripe(stripeConfig.publishable_key);
                console.log('Stripe inicializado correctamente');
            } catch (error) {
                console.error('Error al cargar configuraciÃ³n de Stripe:', error);
                showError('Error al cargar configuraciÃ³n de pago. Por favor, recarga la pÃ¡gina.');
            }
        }

        // Cargar configuraciÃ³n al iniciar
        await loadStripeConfig();

        // FunciÃ³n para mostrar errores
        function showError(message) {
            const errorDiv = document.getElementById('paymentError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
            console.error(message);
        }

        // FunciÃ³n para mostrar el modal
        window.showPaymentModal = function(planType = 'monthly') {
            if (!stripe || !stripeConfig) {
                showError('Stripe no estÃ¡ cargado. Por favor, espera un momento e intÃ©ntalo de nuevo.');
                return;
            }

            const modal = document.getElementById('paymentModal');
            
            // Configurar informaciÃ³n del plan
            if (planType === 'monthly') {
                document.getElementById('planName').textContent = 'Pro Mensual';
                document.getElementById('planDescription').textContent = 'Acceso completo a todas las funciones';
                document.getElementById('planPrice').textContent = '9,99 â‚¬';
                document.getElementById('planPeriod').textContent = 'por mes';
            } else {
                document.getElementById('planName').textContent = 'Pro Anual';
                document.getElementById('planDescription').textContent = 'Ahorra mÃ¡s de 35â‚¬ al aÃ±o';
                document.getElementById('planPrice').textContent = '79,99 â‚¬';
                document.getElementById('planPeriod').textContent = 'por aÃ±o';
            }
            
            modal.classList.remove('hidden');
            initializePayment(planType);
        };

        // FunciÃ³n para cerrar el modal
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('paymentModal').classList.add('hidden');
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('paymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'paymentModal') {
                document.getElementById('paymentModal').classList.add('hidden');
            }
        });

        /**
         * Obtiene el ID del usuario actual
         */
        function getCurrentUserId() {
            try {
                // Buscar token con la clave correcta (accessToken, no token)
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('âŒ No se encontrÃ³ accessToken en localStorage');
                    return null;
                }
                
                // Decodificar JWT para obtener user_id
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userId = payload.user_id || payload.sub;
                console.log('âœ… User ID obtenido:', userId);
                return userId;
            } catch (error) {
                console.error('âŒ Error obteniendo user ID:', error);
                return null;
            }
        }

        // Inicializar pago
        async function initializePayment(planType) {
            try {
                if (!stripeConfig) {
                    throw new Error('ConfiguraciÃ³n de Stripe no cargada');
                }

                const priceId = planType === 'monthly' ? stripeConfig.price_ids.monthly : stripeConfig.price_ids.yearly;
                
                // Obtener user_id del token
                const userId = getCurrentUserId();
                if (!userId) {
                    throw new Error('No se pudo obtener el ID del usuario');
                }

                // Crear intent de pago en el backend
                const response = await fetch(`${API_BASE}/create-payment-intent`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        plan_type: planType,
                        price_id: priceId,
                        user_id: parseInt(userId)  // Convertir a int
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Error al crear intent de pago');
                }

                const { client_secret } = await response.json();

                // Crear elementos de Stripe
                elements = stripe.elements({
                    clientSecret: client_secret,
                    appearance: {
                        theme: 'dark',
                        variables: {
                            colorPrimary: '#84cc16',
                            colorBackground: '#1f2937',
                            colorText: '#ffffff',
                            colorDanger: '#ef4444',
                            fontFamily: 'system-ui, sans-serif',
                            spacingUnit: '4px',
                            borderRadius: '8px'
                        }
                    }
                });

                paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

            } catch (error) {
                console.error('Error inicializando pago:', error);
                showMessage(error.message || 'Error al inicializar el pago. IntÃ©ntalo de nuevo.', 'error');
            }
        }

        // Manejar envÃ­o del formulario
        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submit-payment');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            
            // Mostrar loading
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: `${window.location.origin}/dashboard.html`,
                    },
                });

                if (error) {
                    showMessage(error.message, 'error');
                } else {
                    // El pago fue exitoso
                    showMessage('Â¡Pago exitoso! Actualizando tu cuenta...', 'success');
                    
                    // Actualizar estado del usuario a premium
                    await updateUserToPremium();
                    
                    // Cerrar modal y recargar
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                console.error('Error procesando pago:', error);
                showMessage('Error procesando el pago. IntÃ©ntalo de nuevo.', 'error');
            } finally {
                // Restaurar botÃ³n
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        });

        // Actualizar usuario a premium
        async function updateUserToPremium() {
            try {
                const response = await fetch(`${API_BASE}/upgrade-to-premium`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    // Actualizar localStorage
                    localStorage.setItem('plan', 'premium');
                    console.log('Usuario actualizado a premium');
                }
            } catch (error) {
                console.error('Error actualizando usuario:', error);
            }
        }

        // Mostrar mensajes
        function showMessage(message, type) {
            const messageDiv = document.getElementById('payment-message');
            messageDiv.textContent = message;
            messageDiv.className = `mt-4 p-3 rounded-lg text-sm ${type === 'error' ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'}`;
            messageDiv.classList.remove('hidden');
        }

        // Hacer funciones globales
        window.showPaymentModal = showPaymentModal;
    </script>
</body>
</html>



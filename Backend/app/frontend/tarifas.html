<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Planes de Suscripci√≥n ‚Ä¢ YourGains AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .dna-icon {
      width: 45px;
      height: 45px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .dna-icon svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 4px rgba(132, 204, 22, 0.45));
    }
  </style>
  <script type="module">
    import { checkAuthOrRedirect } from "./auth.js";
    checkAuthOrRedirect();
  </script>
</head>
<body class="min-h-screen bg-neutral-950 text-white">
  <header class="border-b border-neutral-800">
    <div class="max-w-5xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="dna-icon">
          <svg viewBox="0 0 800 800" width="45" height="45" xmlns="http://www.w3.org/2000/svg">
            <path transform="translate(237)" d="m0 0h19l10 5 8 6 4 4 4 8v5h1v10h234v-10l1-1 1-6 5-9 5-3 3-5 5-1 7-3h19l12 6 7 7h2l2 5 3 13v38l-2 20-3 15v8l-2 3-1 5h-2l-6 15-2 6-1 2-1 4-9 15-5 7-2 1-1 3-2 1-2 4-2 1-2 4-4 2-2 3-2 4-7 7-4 1-8 8-10 8-1 3-4 1-5 1-20-12-24-12-26-10-4-1v-2l10-4 14-8 10-7 1-1-91-1-16-10-13-11-10-9-6-4-1-4-4-2v-5l1-2 186-1 1-6 6-14 3-10 2-1h-232l2 1 2 6v7l4 5 9 17 5 7 1 3 3 2 1 4 4 2 2 5 10 10 17 13 14 9 23 12 21 8 26 8 22 9 22 11 8 5 5 1v2l12 8 12 9 4 1 3 5 4 1 3 5 15 15 4 2 1 4 5 3 1 3 5 5 7 10 7 11 8 16 1 8 6 18h2l1 7-1 1 3 17 1 14v12l-2 21-2 11 1 4-2 3-2 4-6 17v5l-10 19-12 18-5 5-2 4-4 2-2 5-5 3-15 15-2 4-4 1-15 12-5-2-23-13-23-11-24-9 1-3 19-10 15-10-94-1-14-9-14-11-15-15-4-2-1-4h-2l2-5h184l2-5h2l2-9h2l5-15h-229l1 7 2 1 1 7h2l2 4v5h2l6 10 1 3 5 5 1 3 3 2 1 4 5 3 7 7 2 4 8 6 3 1 2 4 17 11 23 12 21 8 36 12 20 9 21 11 21 14 14 11 11 10 4 1 3 5 4 2 3 3 1 4 4 3 3 2 1 4 3 1 1 3 2 1 1 3 4 4 10 16 1 6 3 1 3 9 2 7h2l1 8 2 4 2 2v8l3 14 2 21v38l-2 9-2 7-2 2-7 6-8 5-5 2h-18l-10-4-8-7-3-1-5-9-1-7h-1v-10h-234v10l-1 1-1 6-5 9-5 3-8 6-8 3h-18l-12-6-7-7h-2l-2-5-3-13v-38l2-21 3-14v-8l3-3 2-8 1-3 2-2 5-15h2l2-8 12-18 2-1 1-3 2-1 1-3 3-1 1-4 5-3 2-3 2-4 10-10 4-1 11-10 11-8 5 1 16 10 26 13 24 9 5 3-3 2-17 9-12 8-2 2 91 1 16 10 13 11 10 9 6 4 1 4 4 2v5l-1 2-184 1-7 15-5 15-2 1h232l-2-1-5-15-8-17-7-10-1-3-3-2-1-4-4-2-2-5-10-10-17-13-14-9-23-12-21-8-29-9-23-10-25-13-6-2v-2l-12-8-13-10-7-5-4-2-2-4-16-16-4-2-2-5-3-1-1-4-3-1-1-3-5-5-12-20-6-12v-5h-2l-1-8-6-20-3-18-1-13v-14l2-20 4-19 5-15v-5h2l1-7 9-17 9-14 6-8 3-1 1-4 3-1 1-4 6-4 16-16 2-4 4-1 3-5 4-1 8-6 5 2 23 13 23 11 24 9-1 3-19 10-15 10 98 1 1 3 13 9 11 9 14 14 4 2 1 4h2l-2 5h-184l-2 5h-2l-2 9h-2l-5 15h230l-5-15h-2l-2-9h-2l-6-10-1-3-5-5-1-3-3-2-1-4-5-3-7-7-2-4-3-2-3-1-1-3-4-1-2-4-17-11-23-12-21-8-36-12-20-9-21-11-21-14-14-11-12-11-5-2-8-8-1-4-4-3-3-2-1-4-3-1-1-3-2-1-1-3-4-4-10-16-1-6-3-1-2-9-3-7h-2l-1-8-2-4-2-2v-8l-3-14-2-21v-38l2-9 2-7 2-2 7-6 8-5zm296 5m-259 8m251 0m-250 1m249 0m-308 1m367 0m-307 1m247 0m-308 1m62 0m245 0m62 0m-306 2 1 2zm243 0 1 2zm-242 2 1 2zm241 0 1 2zm-240 3 1 3zm239 0 1 3zm-238 15v1h238v-1zm3 48m231 0m-230 1 1 3zm229 0 1 3zm-228 4 1 3zm227 0 1 2zm-1 3 1 2zm-1 3 1 2zm-1 2 1 2zm-1 3 1 2zm-219 1m1 1 1 2zm217 1m-291 2 1 3zm75 0m215 0m75 0 1 3zm-289 2m213 0m-212 2m211 0m-210 2m1 1m284 0 1 2zm-283 2m1 2m1 1m19 1m-18 1m19 0m-18 1m1 2m1 1m20 1m-19 1m20 0m-17 4m1 1m-80 5m84 0m-83 1 1 2zm84 0m1 1m253 5m-334 2m333 0m-332 2m331 0m-330 2m329 0m-328 1m327 0m-326 2m325 0m-324 2m323 0m-322 1m321 0m-320 2m319 0m-318 1m317 0m-316 2m315 0m-314 1m216 0m97 0m-312 2m311 0m-310 1m309 0m-306 4m303 0m-300 4m297 0m-293 5m289 0m-288 1m287 0m-280 8m273 0m-272 1m271 0m-270 1m269 0m-268 2m266 0m-264 2m263 0m-261 2m259 0m-25 21m-22 12m-193 20m221 0m-222 1m223 0m-229 5m235 0m-236 1m237 0m-259 22m281 0m-282 1m-1 1m-4 5m293 0m3 4m-300 1m301 0m-302 1m303 0m1 2m-306 1m307 0m-308 1m309 0m-310 2m311 0m-312 1m313 0m-314 1 1 2zm315 1m-316 1m195 0m122 0m-94 1m-224 1m319 0m-320 1m321 0m-322 2m231 0m92 0m-324 1m325 0m-326 2m327 0m-328 2m329 0m-330 1 1 2zm331 1m-332 1m244 0m89 0m-87 1m-247 1m248 0m87 0m-86 1m-250 1m251 0m86 0m-338 2m253 0m86 0m-340 2m341 0m-342 2m343 0m-344 2m262 0m83 0m-346 1 1 2zm264 0m83 1m-348 2 1 2zm349 0 1 2zm-81 1m1 1m1 2m1 1m-18 2m1 1m20 2m1 1m1 2m1 1m-206 2m207 0m-208 2m209 0m-213 8m217 0m-224 21v1h232v-1zm0 45v1h232v-1zm0 2m3 10m4 9m217 0m-216 2 1 2zm3 6m209 0m-208 2m207 0m-206 2m1 1m1 2m1 1m20 2m1 1m-18 2m1 1m1 2m-80 1 1 2zm81 0m268 0 1 2zm-348 3 1 2zm347 0m-264 1m-82 1m83 0m262 0m-344 2m343 0m-342 2m341 0m-340 2m86 0m253 0m-338 2m86 0m251 0m-250 1m-86 1m87 0m248 0m-247 1m-87 1m88 0m245 0m-332 1 1 2zm331 0m-330 2m329 0m-328 2m327 0m-326 2m325 0m-324 1m323 0m-322 2m321 0m-320 1m319 0m-224 1m-94 1m317 0m-316 1m315 0m-314 2m313 0m-312 1m311 0m-310 2m309 0m-308 1m307 0m-1 1m-1 2m-302 1m301 0m-1 1m-296 4m293 0m-289 5m1 1m282 1m-259 22m237 0m-236 1m235 0m-200 26m-42 29m-3 2m255 0m-257 2m-2 2m-2 2m267 0m-268 2m269 0m-270 1m271 0m-272 1m273 0m-280 8m287 0m-288 1m289 0m-293 5m297 0m-300 4m303 0m-306 4m309 0m-310 1m311 0m-312 2m97 0m216 0m-314 1m315 0m-316 2m317 0m-318 1m319 0m-320 2m321 0m-322 1m323 0m-324 2m325 0m-326 2m327 0m-328 1m329 0m-330 2m331 0m-332 2m333 0m-337 7m256 0m85 0m-84 1m-258 1m259 0m84 0m1 2 1 2zm-81 3m82 0m-81 1m-17 4m20 0m-19 1m20 1m1 1m1 2m-18 1m19 0m-18 1m19 1m1 1m1 2m-206 2m207 0m-208 1m209 0m-210 2m211 0m-288 2 1 3zm76 0m213 0m76 0 1 3zm-290 2m215 0m-216 2 1 2zm217 0 1 2zm-218 2m219 0m-220 3 1 2zm221 0 1 2zm-222 2 1 2zm223 0 1 2zm-224 3 1 2zm225 0 1 2zm-226 2 1 3zm227 0 1 3zm-228 4 1 3zm229 0 1 3zm-230 3m231 0m-234 48v1h238v-1zm-1 13 1 3zm239 0 1 3zm-240 4 1 2zm241 0 1 2zm-242 2 1 2zm243 0 1 2z" fill="#84CC16"/>
          </svg>
        </div>
        <div class="text-2xl font-bold">
          <span class="text-white">YourGains</span> <span class="text-lime-400">AI</span>
        </div>
      </div>
      <div class="flex gap-3">
         <a href="./dashboard.html" class="text-2xl text-neutral-400 hover:text-white transition" title="Volver al dashboard">&times;</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold mb-4">Elige tu plan</h1>
      <p class="text-xl text-neutral-400">Desbloquea todo el potencial de YourGains AI</p>
    </div>

    <!-- Loading -->
    <div id="loadingUI" class="text-center py-20">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-lime-400"></div>
        <p class="mt-4 text-neutral-400">Cargando planes...</p>
    </div>

    <!-- Planes Container -->
    <div id="plansContainer" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- ============================================ -->
      <!-- PLAN GRATUITO (Dise√±o del c√≥digo viejo) -->
      <!-- ============================================ -->
      <div class="bg-neutral-900 rounded-2xl p-8 border border-neutral-800 relative opacity-90">
        <div id="badge-free" class="hidden absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-lime-400 text-black px-4 py-1 rounded-full text-sm font-bold">TU PLAN ACTUAL</span>
        </div>
        
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold mb-2">Plan Gratuito</h2>
          <p class="text-4xl font-bold text-white mb-1">0 ‚Ç¨</p>
          <p class="text-neutral-400">Para empezar</p>
        </div>
        
        <ul class="space-y-4 mb-8">
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>2 mensajes de IA por d√≠a</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>25% de tu rutina visible</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>Consejos b√°sicos</span>
          </li>
          <li class="flex items-center text-neutral-500">
            <span class="text-neutral-500 mr-3">‚úó</span>
            <span>Contenido premium censurado</span>
          </li>
        </ul>
        
        <div class="text-center">
          <span id="free-plan-text" class="text-neutral-500 text-sm">Plan b√°sico</span>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- PLAN MENSUAL (Dise√±o del c√≥digo viejo - VERDE LLAMATIVO) -->
      <!-- ============================================ -->
      <div class="bg-gradient-to-br from-lime-500 to-lime-600 rounded-2xl p-8 border-2 border-lime-400 relative transform scale-105">
        <div id="badge-monthly" class="hidden absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-black text-lime-400 px-4 py-1 rounded-full text-sm font-bold">TU PLAN ACTUAL</span>
        </div>
        <div id="badge-popular" class="absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-lime-400 text-black px-4 py-1 rounded-full text-sm font-bold">M√ÅS POPULAR</span>
        </div>
        
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold mb-2 text-black">Pro Mensual</h2>
          <p class="text-4xl font-bold text-black mb-1">9,99 ‚Ç¨</p>
          <p class="text-black/70">por mes</p>
        </div>
        
        <ul class="space-y-4 mb-8">
          <li class="flex items-center">
            <span class="text-black mr-3">‚úì</span>
            <span class="text-black font-medium">Mensajes ilimitados de IA</span>
          </li>
          <li class="flex items-center">
            <span class="text-black mr-3">‚úì</span>
            <span class="text-black font-medium">100% de rutina visible</span>
          </li>
          <li class="flex items-center">
            <span class="text-black mr-3">‚úì</span>
            <span class="text-black font-medium">Todos los consejos premium</span>
          </li>
          <li class="flex items-center">
            <span class="text-black mr-3">‚úì</span>
            <span class="text-black font-medium">Dieta personalizada completa</span>
          </li>
          <li class="flex items-center">
            <span class="text-black mr-3">‚úì</span>
            <span class="text-black font-medium">Soporte prioritario</span>
          </li>
        </ul>
        
        <button id="btn-monthly" onclick="handleMonthlyClick()"
           class="block w-full bg-black text-lime-400 font-bold rounded-xl px-5 py-3 hover:bg-neutral-800 transition text-center">
          Mejorar a Pro
        </button>
      </div>

      <!-- ============================================ -->
      <!-- PLAN ANUAL (Dise√±o del c√≥digo viejo) -->
      <!-- ============================================ -->
      <div class="bg-neutral-900 rounded-2xl p-8 border border-neutral-800 relative">
        <div id="badge-yearly" class="hidden absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-lime-400 text-black px-4 py-1 rounded-full text-sm font-bold">TU PLAN ACTUAL</span>
        </div>
        <div id="badge-save" class="absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-lime-400 text-black px-4 py-1 rounded-full text-sm font-bold">AHORRA 35‚Ç¨</span>
        </div>
        
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold mb-2">Pro Anual</h2>
          <p class="text-4xl font-bold text-lime-400 mb-1">79,99 ‚Ç¨</p>
          <p class="text-neutral-400">por a√±o</p>
          <p class="text-sm text-lime-400 mt-1">6,67 ‚Ç¨/mes</p>
        </div>
        
        <ul class="space-y-4 mb-8">
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>Mensajes ilimitados de IA</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>100% de rutina visible</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>Todos los consejos premium</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>Dieta personalizada completa</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>Soporte prioritario</span>
          </li>
          <li class="flex items-center">
            <span class="text-lime-400 mr-3">‚úì</span>
            <span>Actualizaciones exclusivas</span>
          </li>
        </ul>
        
        <button id="btn-yearly" onclick="handleYearlyClick()"
           class="block w-full bg-lime-400 text-black font-bold rounded-xl px-5 py-3 hover:bg-lime-300 transition text-center">
          Mejorar a Pro
        </button>
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="mt-16">
      <h2 class="text-2xl font-bold text-center mb-8">Preguntas Frecuentes</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-neutral-900 rounded-xl p-6">
          <h3 class="font-semibold mb-2">¬øPuedo cancelar en cualquier momento?</h3>
          <p class="text-neutral-400 text-sm">S√≠, puedes cancelar tu suscripci√≥n en cualquier momento desde el portal de gesti√≥n.</p>
        </div>
        <div class="bg-neutral-900 rounded-xl p-6">
          <h3 class="font-semibold mb-2">¬øQu√© incluye el plan gratuito?</h3>
          <p class="text-neutral-400 text-sm">2 mensajes de IA por d√≠a y acceso al 25% de tu rutina personalizada.</p>
        </div>
        <div class="bg-neutral-900 rounded-xl p-6">
          <h3 class="font-semibold mb-2">¬øC√≥mo funciona el pago?</h3>
          <p class="text-neutral-400 text-sm">Procesamos los pagos de forma segura a trav√©s de Stripe.</p>
        </div>
      </div>
    </div>
  </main>


  <!-- ============================================ -->
  <!-- JAVASCRIPT (Funcionalidad del c√≥digo nuevo) -->
  <!-- ============================================ -->
  <script type="module">
    import { API_BASE } from "./config.js";
    import { getAuthHeaders } from "./auth.js";

    // Variables globales
    let stripe;
    let stripeConfig;
    let userStatus = { plan_type: 'FREE' };

    // ==========================================
    // 1. INICIALIZACI√ìN
    // ==========================================
    async function init() {
        try {
            // Cargar Config Stripe
            const configRes = await fetch(`${API_BASE}/stripe-config`);
            if(!configRes.ok) throw new Error("Error config Stripe");
            stripeConfig = await configRes.json();
            stripe = Stripe(stripeConfig.publishable_key);
            console.log('‚úÖ Stripe inicializado');

            // Cargar Estado Usuario
            await checkUserStatus();

            // Mostrar UI
            document.getElementById('loadingUI').classList.add('hidden');
            document.getElementById('plansContainer').classList.remove('hidden');
            document.getElementById('plansContainer').classList.add('grid');

        } catch (e) {
            console.error('‚ùå Error inicializando:', e);
            document.getElementById('loadingUI').innerHTML = '<p class="text-red-500">Error cargando la p√°gina. Por favor recarga.</p>';
        }
    }

    // ==========================================
    // 2. CHEQUEO DE ESTADO DEL USUARIO
    // ==========================================
    async function checkUserStatus() {
        try {
            const res = await fetch(`${API_BASE}/subscription-status`, { 
                headers: getAuthHeaders() 
            });
            
            if(res.ok) {
                userStatus = await res.json();
                console.log('üìä Estado del usuario:', userStatus);
            } else {
                console.warn('‚ö†Ô∏è No se pudo obtener status, asumiendo FREE');
            }
        } catch(e) { 
            console.error("Error obteniendo status:", e);
        }
        
        updateUI();
    }

    // ==========================================
    // 3. ACTUALIZAR UI SEG√öN PLAN
    // ==========================================
    function updateUI() {
        const plan = userStatus.plan_type; // FREE, PREMIUM_MONTHLY, PREMIUM_YEARLY
        const hasCustomer = userStatus.stripe_customer_id;

        const btnMonthly = document.getElementById('btn-monthly');
        const btnYearly = document.getElementById('btn-yearly');
        
        // Reset todos los badges
        document.getElementById('badge-free').classList.add('hidden');
        document.getElementById('badge-monthly').classList.add('hidden');
        document.getElementById('badge-yearly').classList.add('hidden');
        document.getElementById('badge-popular').classList.remove('hidden');
        document.getElementById('badge-save').classList.remove('hidden');

        // Reset botones a estado inicial
        resetButton(btnMonthly, 'bg-black', 'text-lime-400', 'hover:bg-neutral-800');
        resetButton(btnYearly, 'bg-lime-400', 'text-black', 'hover:bg-lime-300');

        // ==========================================
        // L√ìGICA DE BOTONES Y BADGES
        // ==========================================
        
        if (plan === 'FREE') {
            // Usuario FREE
            console.log('üÜì Usuario FREE');
            
            // Plan Gratuito: Badge "TU PLAN ACTUAL" + texto "Plan b√°sico"
            document.getElementById('badge-free').classList.remove('hidden');
            document.getElementById('free-plan-text').textContent = 'Plan b√°sico';
            
            // Plan Mensual: Bot√≥n verde "Mejorar a Pro"
            btnMonthly.textContent = "Mejorar a Pro";
            btnMonthly.disabled = false;
            btnMonthly.onclick = () => showPaymentModal('monthly');
            
            // Plan Anual: Bot√≥n verde "Mejorar a Pro"
            btnYearly.textContent = "Mejorar a Pro";
            btnYearly.disabled = false;
            btnYearly.onclick = () => showPaymentModal('yearly');

        } else if (plan === 'PREMIUM_MONTHLY') {
            // Usuario tiene plan MENSUAL
            console.log('üíé Usuario con plan MENSUAL');
            
            // Plan Gratuito: Sin cambios (sin badge)
            
            // Plan Mensual: Badge negro "TU PLAN ACTUAL" + Bot√≥n verde "Gestionar Suscripci√≥n"
            document.getElementById('badge-monthly').classList.remove('hidden');
            document.getElementById('badge-popular').classList.add('hidden');
            
            btnMonthly.textContent = "Gestionar Suscripci√≥n";
            btnMonthly.disabled = false;
            btnMonthly.onclick = () => openPortal();
            
            // Plan Anual: Bot√≥n verde "Upgrade a Anual"
            btnYearly.textContent = "Upgrade a Anual";
            btnYearly.disabled = false;
            btnYearly.onclick = () => showPaymentModal('yearly');

        } else if (plan === 'PREMIUM_YEARLY') {
            // Usuario tiene plan ANUAL
            console.log('üíé Usuario con plan ANUAL');
            
            // Plan Gratuito: Sin cambios (sin badge)
            
            // Plan Mensual: Bot√≥n gris desactivado "Cambiar a Mensual"
            btnMonthly.textContent = "Cambiar a Mensual";
            btnMonthly.disabled = true;
            btnMonthly.onclick = null;
            btnMonthly.classList.remove('bg-black', 'text-lime-400', 'hover:bg-neutral-800');
            btnMonthly.classList.add('bg-neutral-800', 'text-neutral-500', 'cursor-not-allowed');
            
            // Plan Anual: Badge verde "TU PLAN ACTUAL" + Bot√≥n verde "Gestionar Suscripci√≥n"
            document.getElementById('badge-yearly').classList.remove('hidden');
            document.getElementById('badge-save').classList.add('hidden');
            document.getElementById('badge-popular').classList.add('hidden');
            
            btnYearly.textContent = "Gestionar Suscripci√≥n";
            btnYearly.disabled = false;
            btnYearly.onclick = () => openPortal();
        }
    }

    // Helper para resetear botones
    function resetButton(btn, ...classes) {
        btn.disabled = false;
        btn.onclick = null;
        btn.classList.remove('bg-neutral-800', 'text-neutral-500', 'cursor-not-allowed');
        btn.classList.add(...classes);
    }

    // Handlers para los botones
    window.handleMonthlyClick = function() {
        const plan = userStatus.plan_type;
        if (plan === 'PREMIUM_MONTHLY') {
            openPortal();
        } else {
            showPaymentModal('monthly');
        }
    };

    window.handleYearlyClick = function() {
        const plan = userStatus.plan_type;
        if (plan === 'PREMIUM_YEARLY') {
            openPortal();
        } else {
            showPaymentModal('yearly');
        }
    };

    // ==========================================
    // 4. REDIRIGIR A CHECKOUT SESSION
    // ==========================================
    window.showPaymentModal = async function(planType) {
        if (!stripe) {
            alert('Stripe no est√° cargado. Por favor, recarga la p√°gina.');
            return;
        }
        
        const priceId = planType === 'monthly' 
            ? stripeConfig.price_ids.monthly 
            : stripeConfig.price_ids.yearly;

        try {
            // Mostrar loading
            const btn = planType === 'monthly' 
                ? document.getElementById('btn-monthly')
                : document.getElementById('btn-yearly');
            
            const originalText = btn.textContent;
            btn.textContent = 'Redirigiendo...';
            btn.disabled = true;

            // Crear Checkout Session
            const response = await fetch(`${API_BASE}/create-checkout-session`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ price_id: priceId })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error creando sesi√≥n de pago');
            }

            const { url } = await response.json();
            
            // Redirigir a Stripe Checkout
            window.location.href = url;

        } catch (error) {
            console.error('‚ùå Error iniciando pago:', error);
            alert('Error: ' + error.message);
            
            // Restaurar bot√≥n
            const btn = planType === 'monthly' 
                ? document.getElementById('btn-monthly')
                : document.getElementById('btn-yearly');
            btn.textContent = originalText;
            btn.disabled = false;
        }
    };

    // ==========================================
    // 7. GESTIONAR SUSCRIPCI√ìN (PORTAL)
    // ==========================================
    window.openPortal = async function() {
        // Determinar qu√© bot√≥n est√° llamando esta funci√≥n
        const plan = userStatus.plan_type;
        let btn;
        if (plan === 'PREMIUM_MONTHLY') {
            btn = document.getElementById('btn-monthly');
        } else if (plan === 'PREMIUM_YEARLY') {
            btn = document.getElementById('btn-yearly');
        } else {
            console.error('‚ùå No se puede abrir portal: usuario no es premium');
            return;
        }

        const originalText = btn.textContent;
        btn.textContent = "Cargando...";
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/create-portal-session`, {
                method: "POST", 
                headers: getAuthHeaders()
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || 'Error abriendo portal');
            }

            const data = await res.json();
            if(data.url) {
                window.location.href = data.url;
            }
        } catch(e) {
            console.error('‚ùå Error portal:', e);
            alert("Error abriendo portal de gesti√≥n: " + e.message);
            btn.textContent = originalText;
            btn.disabled = false;
        }
    };

    // ==========================================
    // HELPERS
    // ==========================================

    // Obtener user_id del JWT
    function getCurrentUserId() {
        try {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                console.error('‚ùå No hay token');
                return null;
            }
            const payload = JSON.parse(atob(token.split('.')[1]));
            return parseInt(payload.user_id || payload.sub);
        } catch(e) {
            console.error('‚ùå Error obteniendo user_id:', e);
            return null;
        }
    }

    // ==========================================
    // MANEJAR REDIRECCI√ìN DE √âXITO/CANCEL
    // ==========================================
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === '1') {
        // Recargar estado del usuario
        checkUserStatus();
        
        // Mostrar mensaje de √©xito
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 right-4 bg-lime-400 text-black px-6 py-4 rounded-xl shadow-2xl z-50';
        successDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚úì</span>
                <div>
                    <p class="font-bold">¬°Pago Exitoso!</p>
                    <p class="text-sm">Ya eres usuario Premium</p>
                </div>
            </div>
        `;
        document.body.appendChild(successDiv);
        
        // Ocultar despu√©s de 5 segundos
        setTimeout(() => {
            successDiv.remove();
            // Limpiar URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 5000);
    }
    
    if (urlParams.get('cancel') === '1') {
        // Usuario cancel√≥ el pago
        const cancelDiv = document.createElement('div');
        cancelDiv.className = 'fixed top-4 right-4 bg-neutral-800 text-white px-6 py-4 rounded-xl shadow-2xl z-50';
        cancelDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚ÑπÔ∏è</span>
                <div>
                    <p class="font-bold">Pago Cancelado</p>
                    <p class="text-sm">Puedes intentarlo de nuevo cuando quieras</p>
                </div>
            </div>
        `;
        document.body.appendChild(cancelDiv);
        
        setTimeout(() => {
            cancelDiv.remove();
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 5000);
    }

    // ==========================================
    // ARRANCAR APP
    // ==========================================
    init();

  </script>
</body>
</html>